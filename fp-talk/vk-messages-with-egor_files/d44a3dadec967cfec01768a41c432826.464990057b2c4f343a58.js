"use strict";(self.webpackChunkvk=self.webpackChunkvk||[]).push([[62182],{130845:(e,t,s)=>{s.d(t,{default:()=>a});var r=Number.isNaN||function(e){return"number"==typeof e&&e!=e};function n(e,t){if(e.length!==t.length)return!1;for(var s=0;s<e.length;s++)if(n=e[s],a=t[s],!(n===a||r(n)&&r(a)))return!1;var n,a;return!0}const a=function(e,t){var s;void 0===t&&(t=n);var r,a=[],o=!1;return function(){for(var n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];return o&&s===this&&t(n,a)||(r=e.apply(this,n),o=!0,s=this,a=n),r}}},968641:()=>{},760398:()=>{},688274:()=>{},380283:()=>{},320428:()=>{},183638:()=>{},100732:()=>{},677749:()=>{},988426:()=>{},774996:()=>{},784256:()=>{},360862:()=>{},58245:()=>{},279478:()=>{},42505:()=>{},932823:()=>{},737968:()=>{},501954:()=>{},883061:()=>{},669721:()=>{},466135:()=>{},516073:()=>{},29354:()=>{},365691:(e,t,s)=>{s.d(t,{default:()=>o});var r=s(667294);var n=function(){function e(e,t){for(var s=0;s<t.length;s++){var r=t[s];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,s,r){return s&&e(t.prototype,s),r&&e(t,r),t}}(),a=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t};const o=function(e){function t(){var e,s,r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var n=arguments.length,o=Array(n),i=0;i<n;i++)o[i]=arguments[i];return s=r=a(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(o))),r._lastRenderedStartIndex=-1,r._lastRenderedStopIndex=-1,r._memoizedUnloadedRanges=[],r._onItemsRendered=function(e){var t=e.visibleStartIndex,s=e.visibleStopIndex;r._lastRenderedStartIndex=t,r._lastRenderedStopIndex=s,r._ensureRowsLoaded(t,s)},r._setRef=function(e){r._listRef=e},a(r,s)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),n(t,[{key:"resetloadMoreItemsCache",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._memoizedUnloadedRanges=[],e&&this._ensureRowsLoaded(this._lastRenderedStartIndex,this._lastRenderedStopIndex)}},{key:"componentDidMount",value:function(){0}},{key:"render",value:function(){return(0,this.props.children)({onItemsRendered:this._onItemsRendered,ref:this._setRef})}},{key:"_ensureRowsLoaded",value:function(e,t){var s=this.props,r=s.isItemLoaded,n=s.itemCount,a=s.minimumBatchSize,o=void 0===a?10:a,i=s.threshold,d=void 0===i?15:i,c=function(e){for(var t=e.isItemLoaded,s=e.itemCount,r=e.minimumBatchSize,n=e.startIndex,a=e.stopIndex,o=[],i=null,d=null,c=n;c<=a;c++)t(c)?null!==d&&(o.push(i,d),i=d=null):(d=c,null===i&&(i=c));if(null!==d){for(var l=Math.min(Math.max(d,i+r-1),s-1),u=d+1;u<=l&&!t(u);u++)d=u;o.push(i,d)}if(o.length)for(;o[1]-o[0]+1<r&&o[0]>0;){var h=o[0]-1;if(t(h))break;o[0]=h}return o}({isItemLoaded:r,itemCount:n,minimumBatchSize:o,startIndex:Math.max(0,e-d),stopIndex:Math.min(n-1,t+d)});(this._memoizedUnloadedRanges.length!==c.length||this._memoizedUnloadedRanges.some((function(e,t){return c[t]!==e})))&&(this._memoizedUnloadedRanges=c,this._loadUnloadedRanges(c))}},{key:"_loadUnloadedRanges",value:function(e){for(var t=this,s=this.props.loadMoreItems||this.props.loadMoreRows,r=function(r){var n=e[r],a=e[r+1],o=s(n,a);null!=o&&o.then((function(){if(function(e){var t=e.lastRenderedStartIndex,s=e.lastRenderedStopIndex,r=e.startIndex,n=e.stopIndex;return!(r>s||n<t)}({lastRenderedStartIndex:t._lastRenderedStartIndex,lastRenderedStopIndex:t._lastRenderedStopIndex,startIndex:n,stopIndex:a})){if(null==t._listRef)return;"function"==typeof t._listRef.resetAfterIndex?t._listRef.resetAfterIndex(n,!0):("function"==typeof t._listRef._getItemStyleCache&&t._listRef._getItemStyleCache(-1),t._listRef.forceUpdate())}}))},n=0;n<e.length;n+=2)r(n)}}]),t}(r.PureComponent)},274061:(e,t,s)=>{s.d(t,{FixedSizeList:()=>M,VariableSizeList:()=>I});var r=s(487462),n=s(497326),a=s(894578),o=s(130845),i=s(667294),d=(s(263366),"object"==typeof performance&&"function"==typeof performance.now?function(){return performance.now()}:function(){return Date.now()});function c(e){cancelAnimationFrame(e.id)}function l(e,t){var s=d();var r={id:requestAnimationFrame((function n(){d()-s>=t?e.call(null):r.id=requestAnimationFrame(n)}))};return r}var u=-1;function h(e){if(void 0===e&&(e=!1),-1===u||e){var t=document.createElement("div"),s=t.style;s.width="50px",s.height="50px",s.overflow="scroll",document.body.appendChild(t),u=t.offsetWidth-t.clientWidth,document.body.removeChild(t)}return u}var p=null;function m(e){if(void 0===e&&(e=!1),null===p||e){var t=document.createElement("div"),s=t.style;s.width="50px",s.height="50px",s.overflow="scroll",s.direction="rtl";var r=document.createElement("div"),n=r.style;return n.width="100px",n.height="100px",t.appendChild(r),document.body.appendChild(t),t.scrollLeft>0?p="positive-descending":(t.scrollLeft=1,p=0===t.scrollLeft?"negative":"positive-ascending"),document.body.removeChild(t),p}return p}var f=function(e,t){return e};function g(e){var t,s=e.getItemOffset,d=e.getEstimatedTotalSize,u=e.getItemSize,p=e.getOffsetForIndexAndAlignment,g=e.getStartIndexForOffset,C=e.getStopIndexForStartIndex,_=e.initInstanceProps,y=e.shouldResetStyleCacheOnItemSizeChange,k=e.validateProps;return t=function(e){function t(t){var r;return(r=e.call(this,t)||this)._instanceProps=_(r.props,(0,n.default)(r)),r._outerRef=void 0,r._resetIsScrollingTimeoutId=null,r.state={instance:(0,n.default)(r),isScrolling:!1,scrollDirection:"forward",scrollOffset:"number"==typeof r.props.initialScrollOffset?r.props.initialScrollOffset:0,scrollUpdateWasRequested:!1},r._callOnItemsRendered=void 0,r._callOnItemsRendered=(0,o.default)((function(e,t,s,n){return r.props.onItemsRendered({overscanStartIndex:e,overscanStopIndex:t,visibleStartIndex:s,visibleStopIndex:n})})),r._callOnScroll=void 0,r._callOnScroll=(0,o.default)((function(e,t,s){return r.props.onScroll({scrollDirection:e,scrollOffset:t,scrollUpdateWasRequested:s})})),r._getItemStyle=void 0,r._getItemStyle=function(e){var t,n=r.props,a=n.direction,o=n.itemSize,i=n.layout,d=r._getItemStyleCache(y&&o,y&&i,y&&a);if(d.hasOwnProperty(e))t=d[e];else{var c=s(r.props,e,r._instanceProps),l=u(r.props,e,r._instanceProps),h="horizontal"===a||"horizontal"===i,p="rtl"===a,m=h?c:0;d[e]=t={position:"absolute",left:p?void 0:m,right:p?m:void 0,top:h?0:c,height:h?"100%":l,width:h?l:"100%"}}return t},r._getItemStyleCache=void 0,r._getItemStyleCache=(0,o.default)((function(e,t,s){return{}})),r._onScrollHorizontal=function(e){var t=e.currentTarget,s=t.clientWidth,n=t.scrollLeft,a=t.scrollWidth;r.setState((function(e){if(e.scrollOffset===n)return null;var t=r.props.direction,o=n;if("rtl"===t)switch(m()){case"negative":o=-n;break;case"positive-descending":o=a-s-n}return o=Math.max(0,Math.min(o,a-s)),{isScrolling:!0,scrollDirection:e.scrollOffset<n?"forward":"backward",scrollOffset:o,scrollUpdateWasRequested:!1}}),r._resetIsScrollingDebounced)},r._onScrollVertical=function(e){var t=e.currentTarget,s=t.clientHeight,n=t.scrollHeight,a=t.scrollTop;r.setState((function(e){if(e.scrollOffset===a)return null;var t=Math.max(0,Math.min(a,n-s));return{isScrolling:!0,scrollDirection:e.scrollOffset<t?"forward":"backward",scrollOffset:t,scrollUpdateWasRequested:!1}}),r._resetIsScrollingDebounced)},r._outerRefSetter=function(e){var t=r.props.outerRef;r._outerRef=e,"function"==typeof t?t(e):null!=t&&"object"==typeof t&&t.hasOwnProperty("current")&&(t.current=e)},r._resetIsScrollingDebounced=function(){null!==r._resetIsScrollingTimeoutId&&c(r._resetIsScrollingTimeoutId),r._resetIsScrollingTimeoutId=l(r._resetIsScrolling,150)},r._resetIsScrolling=function(){r._resetIsScrollingTimeoutId=null,r.setState({isScrolling:!1},(function(){r._getItemStyleCache(-1,null)}))},r}(0,a.default)(t,e),t.getDerivedStateFromProps=function(e,t){return v(e,t),k(e),null};var I=t.prototype;return I.scrollTo=function(e){e=Math.max(0,e),this.setState((function(t){return t.scrollOffset===e?null:{scrollDirection:t.scrollOffset<e?"forward":"backward",scrollOffset:e,scrollUpdateWasRequested:!0}}),this._resetIsScrollingDebounced)},I.scrollToItem=function(e,t){void 0===t&&(t="auto");var s=this.props,r=s.itemCount,n=s.layout,a=this.state.scrollOffset;e=Math.max(0,Math.min(e,r-1));var o=0;if(this._outerRef){var i=this._outerRef;o="vertical"===n?i.scrollWidth>i.clientWidth?h():0:i.scrollHeight>i.clientHeight?h():0}this.scrollTo(p(this.props,e,t,a,this._instanceProps,o))},I.componentDidMount=function(){var e=this.props,t=e.direction,s=e.initialScrollOffset,r=e.layout;if("number"==typeof s&&null!=this._outerRef){var n=this._outerRef;"horizontal"===t||"horizontal"===r?n.scrollLeft=s:n.scrollTop=s}this._callPropsCallbacks()},I.componentDidUpdate=function(){var e=this.props,t=e.direction,s=e.layout,r=this.state,n=r.scrollOffset;if(r.scrollUpdateWasRequested&&null!=this._outerRef){var a=this._outerRef;if("horizontal"===t||"horizontal"===s)if("rtl"===t)switch(m()){case"negative":a.scrollLeft=-n;break;case"positive-ascending":a.scrollLeft=n;break;default:var o=a.clientWidth,i=a.scrollWidth;a.scrollLeft=i-o-n}else a.scrollLeft=n;else a.scrollTop=n}this._callPropsCallbacks()},I.componentWillUnmount=function(){null!==this._resetIsScrollingTimeoutId&&c(this._resetIsScrollingTimeoutId)},I.render=function(){var e=this.props,t=e.children,s=e.className,n=e.direction,a=e.height,o=e.innerRef,c=e.innerElementType,l=e.innerTagName,u=e.itemCount,h=e.itemData,p=e.itemKey,m=void 0===p?f:p,g=e.layout,v=e.outerElementType,C=e.outerTagName,_=e.style,y=e.useIsScrolling,k=e.width,I=this.state.isScrolling,M="horizontal"===n||"horizontal"===g,R=M?this._onScrollHorizontal:this._onScrollVertical,S=this._getRangeToRender(),w=S[0],b=S[1],E=[];if(u>0)for(var U=w;U<=b;U++)E.push((0,i.createElement)(t,{data:h,key:m(U,h),index:U,isScrolling:y?I:void 0,style:this._getItemStyle(U)}));var A=d(this.props,this._instanceProps);return(0,i.createElement)(v||C||"div",{className:s,onScroll:R,ref:this._outerRefSetter,style:(0,r.default)({position:"relative",height:a,width:k,overflow:"auto",WebkitOverflowScrolling:"touch",willChange:"transform",direction:n},_)},(0,i.createElement)(c||l||"div",{children:E,ref:o,style:{height:M?"100%":A,pointerEvents:I?"none":void 0,width:M?A:"100%"}}))},I._callPropsCallbacks=function(){if("function"==typeof this.props.onItemsRendered&&this.props.itemCount>0){var e=this._getRangeToRender(),t=e[0],s=e[1],r=e[2],n=e[3];this._callOnItemsRendered(t,s,r,n)}if("function"==typeof this.props.onScroll){var a=this.state,o=a.scrollDirection,i=a.scrollOffset,d=a.scrollUpdateWasRequested;this._callOnScroll(o,i,d)}},I._getRangeToRender=function(){var e=this.props,t=e.itemCount,s=e.overscanCount,r=this.state,n=r.isScrolling,a=r.scrollDirection,o=r.scrollOffset;if(0===t)return[0,0,0,0];var i=g(this.props,o,this._instanceProps),d=C(this.props,i,o,this._instanceProps),c=n&&"backward"!==a?1:Math.max(1,s),l=n&&"forward"!==a?1:Math.max(1,s);return[Math.max(0,i-c),Math.max(0,Math.min(t-1,d+l)),i,d]},t}(i.PureComponent),t.defaultProps={direction:"ltr",itemData:void 0,layout:"vertical",overscanCount:2,useIsScrolling:!1},t}var v=function(e,t){e.children,e.direction,e.height,e.layout,e.innerTagName,e.outerTagName,e.width,t.instance},C=function(e,t,s){var r=e.itemSize,n=s.itemMetadataMap,a=s.lastMeasuredIndex;if(t>a){var o=0;if(a>=0){var i=n[a];o=i.offset+i.size}for(var d=a+1;d<=t;d++){var c=r(d);n[d]={offset:o,size:c},o+=c}s.lastMeasuredIndex=t}return n[t]},_=function(e,t,s,r,n){for(;r<=s;){var a=r+Math.floor((s-r)/2),o=C(e,a,t).offset;if(o===n)return a;o<n?r=a+1:o>n&&(s=a-1)}return r>0?r-1:0},y=function(e,t,s,r){for(var n=e.itemCount,a=1;s<n&&C(e,s,t).offset<r;)s+=a,a*=2;return _(e,t,Math.min(s,n-1),Math.floor(s/2),r)},k=function(e,t){var s=e.itemCount,r=t.itemMetadataMap,n=t.estimatedItemSize,a=t.lastMeasuredIndex,o=0;if(a>=s&&(a=s-1),a>=0){var i=r[a];o=i.offset+i.size}return o+(s-a-1)*n},I=g({getItemOffset:function(e,t,s){return C(e,t,s).offset},getItemSize:function(e,t,s){return s.itemMetadataMap[t].size},getEstimatedTotalSize:k,getOffsetForIndexAndAlignment:function(e,t,s,r,n,a){var o=e.direction,i=e.height,d=e.layout,c=e.width,l="horizontal"===o||"horizontal"===d?c:i,u=C(e,t,n),h=k(e,n),p=Math.max(0,Math.min(h-l,u.offset)),m=Math.max(0,u.offset-l+u.size+a);switch("smart"===s&&(s=r>=m-l&&r<=p+l?"auto":"center"),s){case"start":return p;case"end":return m;case"center":return Math.round(m+(p-m)/2);default:return r>=m&&r<=p?r:r<m?m:p}},getStartIndexForOffset:function(e,t,s){return function(e,t,s){var r=t.itemMetadataMap,n=t.lastMeasuredIndex;return(n>0?r[n].offset:0)>=s?_(e,t,n,0,s):y(e,t,Math.max(0,n),s)}(e,s,t)},getStopIndexForStartIndex:function(e,t,s,r){for(var n=e.direction,a=e.height,o=e.itemCount,i=e.layout,d=e.width,c="horizontal"===n||"horizontal"===i?d:a,l=C(e,t,r),u=s+c,h=l.offset+l.size,p=t;p<o-1&&h<u;)p++,h+=C(e,p,r).size;return p},initInstanceProps:function(e,t){var s={itemMetadataMap:{},estimatedItemSize:e.estimatedItemSize||50,lastMeasuredIndex:-1};return t.resetAfterIndex=function(e,r){void 0===r&&(r=!0),s.lastMeasuredIndex=Math.min(s.lastMeasuredIndex,e-1),t._getItemStyleCache(-1),r&&t.forceUpdate()},s},shouldResetStyleCacheOnItemSizeChange:!1,validateProps:function(e){e.itemSize}}),M=g({getItemOffset:function(e,t){return t*e.itemSize},getItemSize:function(e,t){return e.itemSize},getEstimatedTotalSize:function(e){var t=e.itemCount;return e.itemSize*t},getOffsetForIndexAndAlignment:function(e,t,s,r,n,a){var o=e.direction,i=e.height,d=e.itemCount,c=e.itemSize,l=e.layout,u=e.width,h="horizontal"===o||"horizontal"===l?u:i,p=Math.max(0,d*c-h),m=Math.min(p,t*c),f=Math.max(0,t*c-h+c+a);switch("smart"===s&&(s=r>=f-h&&r<=m+h?"auto":"center"),s){case"start":return m;case"end":return f;case"center":var g=Math.round(f+(m-f)/2);return g<Math.ceil(h/2)?0:g>p+Math.floor(h/2)?p:g;default:return r>=f&&r<=m?r:r<f?f:m}},getStartIndexForOffset:function(e,t){var s=e.itemCount,r=e.itemSize;return Math.max(0,Math.min(s-1,Math.floor(t/r)))},getStopIndexForStartIndex:function(e,t,s){var r=e.direction,n=e.height,a=e.itemCount,o=e.itemSize,i=e.layout,d=e.width,c=t*o,l="horizontal"===r||"horizontal"===i?d:n,u=Math.ceil((l+s-c)/o);return Math.max(0,Math.min(a-1,t+u-1))},initInstanceProps:function(e){},shouldResetStyleCacheOnItemSizeChange:!0,validateProps:function(e){e.itemSize}})},906978:(e,t,s)=>{s.d(t,{API_ERROR_ACCESS:()=>o,API_ERROR_AUTH:()=>n,API_ERROR_AUTH_VALIDATION:()=>i,API_ERROR_CAPTCHA:()=>a,API_ERROR_LIMITS:()=>l,API_ERROR_MESSAGES_CHAT_DISABLED:()=>g,API_ERROR_MESSAGES_CHAT_MEMBER_NOT_STAFF:()=>_,API_ERROR_MESSAGES_CHAT_NOT_ADMIN:()=>h,API_ERROR_MESSAGES_CHAT_UNSUPPORTED:()=>v,API_ERROR_MESSAGES_CHAT_USER_NO_ACCESS:()=>u,API_ERROR_MESSAGES_CONTACT_NOT_FOUND:()=>m,API_ERROR_MESSAGES_GROUP_PEER_ACCESS:()=>p,API_ERROR_MESSAGES_MEMBER_ACCESS_TO_GROUP_DENIED:()=>C,API_ERROR_MESSAGES_MESSAGE_REQUEST_ALREADY_SENT:()=>f,API_ERROR_PARAM:()=>c,API_ERROR_SECTION_DISABLED:()=>d,API_ERROR_UNKNOWN:()=>r});const r=1,n=5,a=14,o=15,i=17,d=43,c=100,l=103,u=917,h=925,p=932,m=936,f=939,g=945,v=946,C=947,_=967},199195:(e,t,s)=>{s.d(t,{Player:()=>i});var r=s(434788),n=s(302278),a=s(851369);const o="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=";class i extends n.EventEmitter{play(e,t){var s,r;(null==(s=this.state.currentTrackEntity)||null==(r=s.audioTrack)?void 0:r.url)!==e.audioTrack.url?("stopped"!==this.state.status&&this.stopCurrentTrackBeforeStartingNewTrack(),this.startNewTrack(e,t)):"stopped"===this.state.status?this.repeateCurrentTrack(e,t):"paused"===this.state.status?this.resumeTrack(e,t):this.player.currentTime=e.audioTrack.duration*e.audioTrack.progress}playNext(e,t){const{shuffle:s,repeatMode:r}=this.getState(),n=null==t?void 0:t.getNext(e,s,r);n&&this.play(n,t)}playPrev(e,t){const{shuffle:s,repeatMode:r}=this.getState(),n=null==t?void 0:t.getPrev(e,s,r);n&&this.play(n,t)}pause(){const{currentTrackEntity:e,playlist:t,playedTimeAccumulator:s}=this.state,n=null==e?void 0:e.audioTrack;if(n){const{currentTime:o}=this.player,{duration:i}=n,d=(0,r._)({},this.state,{status:"paused",playlist:t,playedTimeAccumulator:s,currentTrackEntity:(0,r._)({},e,{audioTrack:(0,r._)({},n,{progress:o/i})})});this.setState(d),this.player.pause();const c={state:d};this.emit(a.PlayerEventTypes.PAUSE_CURRENT_TRACK,c)}}resume(){const{currentTrackEntity:e,playlist:t}=this.state;(null==e?void 0:e.audioTrack)&&this.resumeTrack(e,t)}resetCurrentTrackState(){const{currentTrackEntity:e,playlist:t,playedTimeAccumulator:s}=this.state,n=null==e?void 0:e.audioTrack;if(n){const a=(0,r._)({},this.state,{status:"stopped",playlist:t,playedTimeAccumulator:s,currentTrackEntity:(0,r._)({},e,{audioTrack:(0,r._)({},n,{progress:0})})});this.setState(a)}}startNewTrack(e,t){const s=this.getState(),n=(0,r._)({},s,{status:"playing",playlist:t,playedTimeAccumulator:{},currentTrackEntity:e});this.setState(n);const o={state:n};this.emit(a.PlayerEventTypes.START_NEW_TRACK,o);const i=e.audioTrack.url,d=e.audioTrack.duration*e.audioTrack.progress;this.playHTML5Player(i,d)}resumeTrack(e,t){var s,n,o,i;const d=this.getState(),c=(0,r._)({},d,{status:"playing",playlist:t,playedTimeAccumulator:d.playedTimeAccumulator,currentTrackEntity:e}),l=null==(s=d.currentTrackEntity)||null==(n=s.audioTrack)?void 0:n.url;let u;this.player.duration!==1/0&&(null==(o=this.state.currentTrackEntity)||null==(i=o.audioTrack)?void 0:i.progress)!==e.audioTrack.progress&&(u=e.audioTrack.duration*e.audioTrack.progress),this.setState(c);const h={state:c};this.emit(a.PlayerEventTypes.RESUME_TRACK,h),this.playHTML5Player(l,u)}repeateCurrentTrack(e,t){this.startNewTrack(e,t)}startNextTrackAutomatically(){const e=this.getState(),{playlist:t,currentTrackEntity:s,repeatMode:n,shuffle:o}=e;let i={state:e};if(!t||!s)return void this.emit(a.PlayerEventTypes.PLAYLIST_ENDED,i);const d="one"===n?(0,r._)({},s,{audioTrack:(0,r._)({},s.audioTrack,{progress:0})}):t.getNext(s,o,n);if(!d)return void this.emit(a.PlayerEventTypes.PLAYLIST_ENDED,i);const c=(0,r._)({},e,{status:"playing",playlist:t,playedTimeAccumulator:{},currentTrackEntity:d});this.setState(c),i={state:c},this.emit(a.PlayerEventTypes.START_NEXT_TRACK_AUTOMATICALLY,i);const l=d.audioTrack.url,u=d.audioTrack.duration*d.audioTrack.progress;this.playHTML5Player(l,u)}stopCurrentTrackAutomatically(){const{currentTrackEntity:e}=this.state;if(e){const e={state:(0,r._)({},this.state)};this.emit(a.PlayerEventTypes.STOP_CURRENT_TRACK_AUTOMATICALLY,e),this.resetCurrentTrackState(),this.player.duration===1/0&&(this.player.src="")}}stopCurrentTrackBeforeStartingNewTrack(){const{currentTrackEntity:e,status:t}=this.state,s=null==e?void 0:e.audioTrack;if(s&&"playing"===t){this.player.pause();const e={state:(0,r._)({},this.state,{status:"stopped"})};this.emit(a.PlayerEventTypes.STOP_CURRENT_TRACK_BEFORE_STARTING_NEW_TRACK,e),this.resetCurrentTrackState()}else s&&"paused"===t&&this.resetCurrentTrackState()}stopCurrentTrackByError(){const{currentTrackEntity:e}=this.state;if(null==e?void 0:e.audioTrack){this.resetCurrentTrackState();const e={state:this.state};this.emit(a.PlayerEventTypes.STOP_CURRENT_TRACK_BY_ERROR,e)}}stopPlayer(){var e;(null==(e=this.state.currentTrackEntity)?void 0:e.audioTrack)&&(this.pause(),this.resetCurrentTrackState(),this.setState((0,r._)({},this.state,{currentTrackEntity:void 0,playlist:void 0})))}seek(e){const t=this.getState(),{currentTrackEntity:s}=t,n=null==s?void 0:s.audioTrack;if(!n)return;const a=(0,r._)({},t,{currentTrackEntity:(0,r._)({},s,{audioTrack:(0,r._)({},n,{progress:e})})});this.player.currentTime=n.duration*e,this.setState(a)}setState(e){this.state=e,this.player.volume=e.volume/100,this.player.muted=e.mute,this.player.playbackRate=e.playbackRate,this.emit("stateupdated",e)}getState(){return(0,r._)({},this.state)}forceUpdate(e){var t,s;this.setState(e),this.player.src=(null==(t=e.currentTrackEntity)||null==(s=t.audioTrack)?void 0:s.url)||o}setVolume(e){const t=(0,r._)({},this.getState(),{mute:!1,volume:e});this.setState(t)}setMute(e){const t=(0,r._)({},this.getState(),{mute:e});this.setState(t)}setShuffle(e){const t=this.getState(),s=(0,r._)({},t,{shuffle:e});this.setState(s)}setRepeatMode(e){const t=this.getState(),s=(0,r._)({},t,{repeatMode:e});this.setState(s)}setPlaybackRate(e){const t=this.getState();this.setState((0,r._)({},t,{playbackRate:e}))}playHTML5Player(e,t){"number"==typeof t&&(this.player.currentTime=t),e&&this.player.src!==e&&(this.player.src=e),this.player.play().then((()=>{"playing"!==this.getState().status&&this.player.pause(),e&&this.player.src!==e&&this.player.pause()})).catch((()=>{this.stopCurrentTrackByError()}))}constructor(e){super(),this.state=e,this.player=document.createElement("audio"),this.player.volume=e.volume/100,this.player.src=o,this.player.playbackRate=e.playbackRate,this.player.addEventListener("ended",(()=>{const{currentTrackEntity:e}=this.state;if(null==e?void 0:e.audioTrack){const e=(0,r._)({},this.state,{status:"ended"});this.setState(e),this.stopCurrentTrackAutomatically(),this.startNextTrackAutomatically()}})),this.player.addEventListener("error",(()=>{this.stopCurrentTrackByError()})),this.player.addEventListener("timeupdate",(()=>{var e;const t=(0,r._)({},this.state);if(null==(e=t.currentTrackEntity)?void 0:e.audioTrack){const{currentTime:e,duration:s}=this.player,{duration:n,progress:a,id:o}=t.currentTrackEntity.audioTrack,i=e/n;i>0&&(t.playedTimeAccumulator[o]=(e=>{const t=e.played;let s=0;for(let e=0;e<t.length;e++)s+=t.end(e)-t.start(e);return s})(this.player)),this.setState((0,r._)({},t,{currentTrackEntity:(0,r._)({},t.currentTrackEntity,{audioTrack:(0,r._)({},t.currentTrackEntity.audioTrack,{progress:i>1?1:i})})})),s===1/0&&(0===i&&0!==a||i>1)&&this.player.dispatchEvent(new Event("ended"))}}))}}},624990:(e,t,s)=>{s.d(t,{PlayerStorage:()=>a,VoicePlayerStorage:()=>o});var r=s(395340),n=s(460554);class a extends r.Storage{getPlaylist(){const e=this.get("reforged_audio_player_playlist");if((0,n.isRestoredConvoAudiosPlaylist)(e))return new n.ConvoAudiosPlaylist(e)}getCurrentTrack(){const e=this.get("reforged_audio_player_track");if((0,n.isConvoAudioTrack)(e))return e}getVolume(){return this.get("reforged_audio_player_volume")}storeVolume(e){this.set("reforged_audio_player_volume",e)}getMute(){return this.get("reforged_audio_player_mute")}storeMute(e){this.set("reforged_audio_player_mute",e)}getShuffle(){return this.get("reforged_audio_player_shuffle")}storeShuffle(e){this.set("reforged_audio_player_shuffle",e)}getRepeatMode(){return this.get("reforged_audio_player_repeat_mode")}storeRepeatMode(e){this.set("reforged_audio_player_repeat_mode",e)}invalidatePlayerStateCache(){const e=this.get("reforged_audio_player_saved")||0;Date.now()-72e5>e&&(this.del("reforged_audio_player_playlist"),this.del("reforged_audio_player_saved"),this.del("reforged_audio_player_track"))}restorePlayerState(){this.invalidatePlayerStateCache();const e=this.getVolume()||100,t=this.getMute()||!1,s=this.getShuffle()||!1,r=this.getRepeatMode()||"none";return{status:"stopped",playedTimeAccumulator:{},currentTrackEntity:this.getCurrentTrack(),playlist:this.getPlaylist(),volume:e,mute:t,shuffle:s,repeatMode:r,playbackRate:1}}storePlayerState(e){const{currentTrackEntity:t,playlist:s,volume:r}=e;this.set("reforged_audio_player_saved",Date.now()),this.set("reforged_audio_player_volume",r),t?this.set("reforged_audio_player_track",t):this.del("reforged_audio_player_track"),s?s instanceof n.ConvoAudiosPlaylist&&this.set("reforged_audio_player_playlist",{meta:s.getPlaylistMeta(),list:s.getConvoAudiosList()}):this.del("reforged_audio_player_playlist")}}class o extends r.Storage{getVolume(){return this.get("reforged_voice_player_volume")}storeVolume(e){this.set("reforged_voice_player_volume",e)}getMute(){return this.get("reforged_voice_player_mute")}storeMute(e){this.set("reforged_voice_player_mute",e)}getPlaybackRate(){return this.get("reforged_voice_player_playback_rate")}storePlaybackRate(e){this.set("reforged_voice_player_playback_rate",e)}restorePlayerState(){return{status:"stopped",playedTimeAccumulator:{},volume:this.getVolume()||100,mute:this.getMute()||!1,shuffle:!1,repeatMode:"none",playbackRate:this.getPlaybackRate()||1}}}},13211:(e,t,s)=>{s.d(t,{BroadcastChannel:()=>n});var r=s(302278);class n extends r.EventEmitter{emit(e){const t=this.connectionId,s=JSON.stringify((e=>({__act:e}))(e));window.localStorage.removeItem(t),window.localStorage.setItem(t,s)}emitLocally(e,t){super.emit(e,t)}constructor(){super(),this.connectionId="queue_connection_events_queue78668286",window.addEventListener("storage",(e=>{try{if(e.key===this.connectionId&&e.newValue){const t=JSON.parse(e.newValue),s=null==t?void 0:t.__act;s&&super.emit(s)}}catch(e){}}))}}},982732:(e,t,s)=>{s.d(t,{ExternalEvents:()=>r});class r{constructor(){this.listeners=[],this.send=(e,t)=>{for(const s of this.listeners)s(e,t)},this.subscribe=e=>(this.listeners.push(e),()=>{this.listeners=this.listeners.filter((t=>t!==e))})}}},277210:(e,t,s)=>{s.d(t,{MEAppMediaMediator:()=>n});var r=s(13211);class n{constructor(){this.broadcastChannel=new r.BroadcastChannel,this.player=null,this.voicePlayer=null,this.videoMessagePlayer=null,this.currentMedia=null,this.prevMedia=null,this.destroy=()=>{this.currentMedia=null,this.prevMedia=null,this.player=null,this.voicePlayer=null,this.videoMessagePlayer=null,this.broadcastChannel.unsubscribe("audio_start",this.pauseCurrentMedia),this.broadcastChannel.unsubscribe("video_message_start",this.pauseCurrentMedia),this.broadcastChannel.unsubscribe("stories_video_start",this.pauseCurrentMedia)},this.pauseCurrentMedia=()=>{var e;(null==(e=this.currentMedia)?void 0:e.isPlaying())&&this.currentMedia.handleMediaMediatorPause()},this.handlePlayerOn=e=>{if(this.broadcastChannel.emit("audio_start"),this.player=e,this.currentMedia){if(this.currentMedia&&this.currentMedia!==this.player){this.currentMedia.isPlaying()?(this.currentMedia.handleMediaMediatorPause(),this.prevMedia=this.currentMedia,this.currentMedia=this.player):(this.prevMedia=null,this.currentMedia=this.player)}}else this.prevMedia=null,this.currentMedia=this.player},this.handleVoicePlayerOn=e=>{if(this.broadcastChannel.emit("audio_start"),this.voicePlayer=e,this.currentMedia){if(this.currentMedia&&this.currentMedia!==this.voicePlayer){this.currentMedia.isPlaying()?(this.currentMedia.handleMediaMediatorPause(),this.prevMedia=this.currentMedia,this.currentMedia=this.voicePlayer):(this.prevMedia=null,this.currentMedia=this.voicePlayer)}}else this.prevMedia=null,this.currentMedia=this.voicePlayer},this.handleVoicePlayerOff=e=>{this.voicePlayer=e,this.currentMedia&&this.currentMedia===this.voicePlayer&&(this.currentMedia=null,this.prevMedia&&(this.prevMedia.handleMediaMediatorResume(),this.currentMedia=this.prevMedia,this.prevMedia=null))},this.handleVideoMessagePlayerOn=e=>{if(this.broadcastChannel.emit("video_message_start"),this.videoMessagePlayer=e,this.currentMedia){if(this.currentMedia&&this.currentMedia!==this.videoMessagePlayer){this.currentMedia.isPlaying()?(this.currentMedia.handleMediaMediatorPause(),this.prevMedia=this.currentMedia,this.currentMedia=this.videoMessagePlayer):(this.prevMedia=null,this.currentMedia=this.videoMessagePlayer)}}else this.prevMedia=null,this.currentMedia=this.videoMessagePlayer},this.handleVideoMessagePlayerOff=e=>{this.videoMessagePlayer=e,this.currentMedia&&this.currentMedia===this.videoMessagePlayer&&(this.currentMedia=null,this.prevMedia&&(this.prevMedia.handleMediaMediatorResume(),this.currentMedia=this.prevMedia,this.prevMedia=null))},this.handleVoiceRecorderOn=()=>{if(this.broadcastChannel.emit("audio_start"),this.currentMedia||this.prevMedia!==this.player)if(this.currentMedia){if(this.currentMedia){this.currentMedia.isPlaying()?(this.currentMedia.handleMediaMediatorPause(),this.prevMedia=this.currentMedia,this.currentMedia=null):(this.prevMedia=null,this.currentMedia=null)}}else this.prevMedia=null,this.currentMedia=null},this.handleVoiceRecorderOff=()=>{this.prevMedia&&this.prevMedia===this.player?(this.prevMedia.handleMediaMediatorResume(),this.currentMedia=this.prevMedia,this.prevMedia=null):(this.currentMedia=null,this.prevMedia=null)},this.broadcastChannel.subscribe("audio_start",this.pauseCurrentMedia),this.broadcastChannel.subscribe("video_message_start",this.pauseCurrentMedia),this.broadcastChannel.subscribe("stories_video_start",this.pauseCurrentMedia)}}},915234:(e,t,s)=>{s.d(t,{MEAppPlayer:()=>c,MEAppVideoMessagePlayer:()=>u,MEAppVoicePlayer:()=>l});var r=s(434788),n=s(199195),a=s(188305),o=s(624990),i=s(851369),d=s(95154);class c extends n.Player{play(e,t){return this.mediaMediator.handlePlayerOn(this),super.play(e,t)}setVolume(e){super.setVolume(e);const{volume:t,mute:s}=this.getState();this.playerStorage.storeVolume(t),this.playerStorage.storeMute(s)}setMute(e){super.setMute(e);const{volume:t,mute:s}=this.getState();this.playerStorage.storeVolume(t),this.playerStorage.storeMute(s)}setShuffle(e){super.setShuffle(e);const{shuffle:t}=this.getState();this.playerStorage.storeShuffle(t)}setRepeatMode(e){super.setRepeatMode(e);const{repeatMode:t}=this.getState();this.playerStorage.storeRepeatMode(t)}stopPlayer(){super.stopPlayer();const e=this.getState();this.playerStorage.storePlayerState((0,r._)({},e,{status:"stopped"}))}isPlaying(){const{status:e}=this.getState();return"playing"===e}handleMediaMediatorResume(){super.resume()}handleMediaMediatorPause(){super.pause()}constructor(e,t){super({status:"stopped",playedTimeAccumulator:{},volume:100,mute:!1,shuffle:!1,repeatMode:"none",playbackRate:1}),this.subscribe(i.PlayerEventTypes.START_NEW_TRACK,(e=>{this.playerStorage.storePlayerState((0,r._)({},e.state,{status:"stopped"}))})),this.subscribe(i.PlayerEventTypes.START_NEXT_TRACK_AUTOMATICALLY,(e=>{this.playerStorage.storePlayerState((0,r._)({},e.state,{status:"stopped"}))})),this.mediaMediator=e,this.playerStorage=new o.PlayerStorage(d.STORAGE_DB_NAME),this.playerStorage.identify(t);const s=this.playerStorage.restorePlayerState();this.forceUpdate(s)}}class l extends n.Player{setVolume(e){var t,s;super.setVolume(e);const{volume:r,mute:n}=this.getState();null==(t=this.playerStorage)||t.storeVolume(r),null==(s=this.playerStorage)||s.storeMute(n)}setMute(e){var t,s;super.setMute(e);const{volume:r,mute:n}=this.getState();null==(t=this.playerStorage)||t.storeVolume(r),null==(s=this.playerStorage)||s.storeMute(n)}setPlaybackRate(e){var t;super.setPlaybackRate(e);const{playbackRate:s}=this.getState();null==(t=this.playerStorage)||t.storePlaybackRate(s)}play(e,t){return this.mediaMediator.handleVoicePlayerOn(this),super.play(e,t)}isPlaying(){const{status:e}=this.getState();return"playing"===e}handleMediaMediatorResume(){super.resume()}handleMediaMediatorPause(){super.pause()}constructor(e,t){super({status:"stopped",playedTimeAccumulator:{},volume:100,mute:!1,shuffle:!1,repeatMode:"none",playbackRate:1}),this.pause=()=>{super.pause(),this.mediaMediator.handleVoicePlayerOff(this)},this.mediaMediator=e,this.subscribe(i.PlayerEventTypes.PLAYLIST_ENDED,(()=>this.mediaMediator.handleVoicePlayerOff(this))),this.playerStorage=new o.VoicePlayerStorage(d.STORAGE_DB_NAME),this.playerStorage.identify(t);const s=this.playerStorage.restorePlayerState();this.forceUpdate(s)}}class u extends a.VideoMessagePlayer{play(e,t){this.mediaMediator.handleVideoMessagePlayerOn(this),super.play(e,t)}resume(){this.mediaMediator.handleVideoMessagePlayerOn(this),super.resume()}stop(){this.mediaMediator.handleVideoMessagePlayerOff(this),super.stop()}destroy(){this.mediaMediator.destroy()}isPlaying(){const{status:e}=this.getState();return"playing"===e}handleMediaMediatorResume(){super.resume()}handleMediaMediatorPause(){super.pause()}constructor(e){super({status:"stopped",settings:{volume:1,playbackRate:1,muted:!1}}),this.pause=()=>{super.pause(),this.mediaMediator.handleVideoMessagePlayerOff(this)},this.mediaMediator=e}}},327320:(e,t,s)=>{s.d(t,{MEAppRecorder:()=>n});var r=s(924222);class n extends r.Recorder{start(){return this.mediaMediator.handleVoiceRecorderOn(),super.start()}pause(){const e=super.pause();return this.mediaMediator.handleVoiceRecorderOff(),e}resume(){return this.mediaMediator.handleVoiceRecorderOn(),super.resume()}stop(){const e=super.stop();return this.mediaMediator.handleVoiceRecorderOff(),e}constructor(e={},t){super(e),this.mediaMediator=t}}},924222:(e,t,s)=>{s.d(t,{Recorder:()=>a});var r=s(434788);const n={bufferLength:4096,encoderApplication:2049,encoderFrameSize:20,encoderSampleRate:48e3,maxFramesPerPage:40,mediaTrackConstraints:!0,monitorGain:0,numberOfChannels:1,recordingGain:1,resampleQuality:3,streamPages:!0,wavBitDepth:16,encoderPath:new URL(s(923562),s.b).href,reuseWorker:!0};class a{initWorklet(){return this.audioContext.audioWorklet?this.audioContext.audioWorklet.addModule(this.config.encoderPath):Promise.resolve()}initEncoder(){this.audioContext.audioWorklet&&(this.encoderNode=new AudioWorkletNode(this.audioContext,"encoder-worklet",{numberOfOutputs:0}),this.encoder=this.encoderNode.port)}storePage(e){this.recordedPages.push(e),this.totalLength+=e.length}streamPage(e){this.onDataAvailable(e)}clearStream(){this.stream&&this.stream.getTracks&&this.stream.getTracks().forEach((e=>e.stop()))}finish(){if(!this.config.streamPages){const e=new Uint8Array(this.totalLength);this.recordedPages.reduce(((t,s)=>(e.set(s,t),t+s.length)),0),this.onDataAvailable(e)}this.onStop()}initWorker(){const e=(this.config.streamPages?this.streamPage:this.storePage).bind(this);return this.recordedPages=[],this.totalLength=0,new Promise((t=>{var s,r,n;const a=({data:s})=>{switch(s.message){case"ready":t();break;case"page":this.encodedSamplePosition=s.samplePosition,e(s.page);break;case"done":var r;null==(r=this.encoder)||r.removeEventListener("message",a),this.finish()}};null==(s=this.encoder)||s.addEventListener("message",a),(null==(r=this.encoder)?void 0:r.start)&&this.encoder.start(),null==(n=this.encoder)||n.postMessage(Object.assign({command:"init",originalSampleRate:this.audioContext.sampleRate,wavSampleRate:this.audioContext.sampleRate},this.config))}))}initSourceNode(){return window.navigator.mediaDevices.getUserMedia({audio:this.config.mediaTrackConstraints}).then((e=>{this.stream=e,this.sourceNode=this.audioContext.createMediaStreamSource(e)}))}start(){return"inactive"===this.state?(this.state="loading",this.encodedSamplePosition=0,this.audioContext.resume().then((()=>this.initialize)).then((()=>Promise.all([this.initSourceNode(),this.initWorker()]))).then((()=>{var e,t,s;this.sourceNode&&this.encoderNode?(this.state="recording",null==(e=this.encoder)||e.postMessage({command:"getHeaderPages"}),null==(t=this.sourceNode)||t.connect(this.monitorGainNode),null==(s=this.sourceNode)||s.connect(this.recordingGainNode),this.monitorGainNode.connect(this.audioContext.destination),this.recordingGainNode.connect(this.encoderNode),this.onStart()):this.state="inactive"})).catch((e=>{throw this.state="inactive",e}))):Promise.resolve()}pause(){return"recording"===this.state?(this.state="paused",this.recordingGainNode.disconnect(),new Promise((e=>{var t,s,r;const n=({data:t})=>{var s;"flushed"===t.message&&(null==(s=this.encoder)||s.removeEventListener("message",n),this.onPause(),e())};null==(t=this.encoder)||t.addEventListener("message",n),null==(s=this.encoder)||s.start(),null==(r=this.encoder)||r.postMessage({command:"flush"})}))):(this.onPause(),Promise.resolve())}resume(){"paused"===this.state&&this.encoderNode&&(this.state="recording",this.recordingGainNode.connect(this.encoderNode),this.onResume())}stop(){return"recording"===this.state?(this.state="inactive",this.monitorGainNode.disconnect(),this.clearStream(),new Promise((e=>{var t,s,r;const n=({data:t})=>{var s;"done"===t.message&&(null==(s=this.encoder)||s.removeEventListener("message",n),e())};null==(t=this.encoder)||t.addEventListener("message",n),null==(s=this.encoder)||s.start(),null==(r=this.encoder)||r.postMessage({command:"done"})}))):(this.onStop(),Promise.resolve())}subscribeToAnalyzer(e){const t=this.sourceNode,s=t.context.createAnalyser();s.fftSize=64,t.connect(s);const r=s.frequencyBinCount,n=new Uint8Array(r);let a=!1;function o(){if(a)return;s.getByteFrequencyData(n);const t=n.reduce(((e,t)=>e+t),0)/r/255;e(t<.1?0:t),requestAnimationFrame(o)}return o(),[()=>{a=!0},()=>{a=!1,o()}]}constructor(e={}){this.state="inactive",this.config=n,this.encodedSamplePosition=0,this.recordedPages=[],this.totalLength=0,this.onDataAvailable=function(e){},this.onStart=function(){},this.onPause=function(){},this.onResume=function(){},this.onStop=function(){},this.config=(0,r._)({},n,e),this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.monitorGainNode=this.audioContext.createGain(),this.monitorGainNode&&this.audioContext&&this.monitorGainNode.gain.setTargetAtTime(this.config.monitorGain,this.audioContext.currentTime,.01),this.recordingGainNode=this.audioContext.createGain(),this.recordingGainNode&&this.audioContext&&this.recordingGainNode.gain.setTargetAtTime(this.config.recordingGain,this.audioContext.currentTime,.01),this.initialize=this.initWorklet().then((()=>this.initEncoder()))}}},395340:(e,t,s)=>{s.d(t,{Storage:()=>a});var r=s(11010),n=s(891047);class a{mapKey(e){if(!this.viewerPeerId)throw new Error("Перед использованием Storage должен быть идентифицирован!");return`${this.dbName}-${this.viewerPeerId}-${e}`}constructor(e){this.idbStoreName="storage",this.identify=e=>{this.viewerPeerId=e},this.get=e=>{const t=this.mapKey(e);try{const e=localStorage.getItem(t);if(!e)return;return JSON.parse(e,i)}catch(e){return}},this.set=(e,t)=>{const s=this.mapKey(e);try{localStorage.setItem(s,JSON.stringify(t,o))}catch(e){}},this.del=e=>{const t=this.mapKey(e);try{localStorage.removeItem(t)}catch(e){}};var t=this;this.getIDB=(0,r._)((function*(e){const s=t.mapKey(e);return yield n.get(s,t.idbStorage)}));var s=this;this.setIDB=(0,r._)((function*(e,t){const r=s.mapKey(e);return yield n.set(r,t,s.idbStorage)}));var a=this;this.updateIDB=(0,r._)((function*(e,t){const s=a.mapKey(e);return n.update(s,t,a.idbStorage)}));var d=this;this.delIDB=(0,r._)((function*(e){const t=d.mapKey(e);return yield n.del(t,d.idbStorage)})),this.dbName=e,this.idbStorage=window.indexedDB&&n.createStore(e,this.idbStoreName)}}function o(e,t){return t instanceof Map?{dataType:"Map",entries:Array.from(t.entries())}:t instanceof Set?{dataType:"Set",values:Array.from(t.values())}:t}function i(e,t){if("object"==typeof t&&null!==t){if("Map"===t.dataType)return new Map(t.entries);if("Set"===t.dataType)return new Set(t.values)}return t}},188305:(e,t,s)=>{s.d(t,{VideoMessagePlayer:()=>i});var r=s(434788),n=s(302278),a=s(851369);const o={volume:1,playbackRate:1};class i extends n.EventEmitter{setVolume(e){this.setState((0,r._)({},this.state,{settings:(0,r._)({},this.state.settings,{muted:!1,volume:e})})),localStorage.setItem("videomessage_settings",JSON.stringify(this.state.settings))}setMuted(e){const t=(0,r._)({},this.state,{settings:(0,r._)({},this.state.settings,{muted:e})});this.setState(t)}setPlaybackRate(e){this.setState((0,r._)({},this.state,{settings:(0,r._)({},this.state.settings,{playbackRate:e})})),localStorage.setItem("videomessage_settings",JSON.stringify(this.state.settings))}stop(){this.setState((0,r._)({},this.state,{status:"stopped",currentVideoMessageTrack:void 0}))}play(e,t){this.setState((0,r._)({},this.state,{status:"playing",convoPeerId:e,currentVideoMessageTrack:t}))}move(e,t=!1){if(!this.state.currentVideoMessageTrack)return;const s=t?e.getPrev(this.state.currentVideoMessageTrack):e.getNext(this.state.currentVideoMessageTrack),{convoPeerId:r}=e.getPlaylistMeta();if(s)return this.play(r,s),this.scrollToMessage(),s;this.stop()}pause(){const{currentVideoMessageTrack:e}=this.state;e&&this.setState((0,r._)({},this.state,{status:"paused"}))}resume(){const{currentVideoMessageTrack:e}=this.state;e&&this.setState((0,r._)({},this.state,{status:"playing"}))}endTrack(e){this.setState((0,r._)({},this.state,{status:"ended"})),e?this.move(e):this.stop()}setProgress(e){const{currentVideoMessageTrack:t}=this.state;t&&this.setState((0,r._)({},this.state,{currentVideoMessageTrack:(0,r._)({},t,{progress:e})}))}scrollToMessage(){this.state.currentVideoMessageTrack&&this.emit(a.VideoMessagePlayerEventTypes.SCROLL_TO_MESSAGE,this.state.currentVideoMessageTrack.id)}stopCurrentTrackByError(e){const{currentVideoMessageTrack:t}=this.state;(null==t?void 0:t.id)===e&&this.setState((0,r._)({},this.state,{status:"stopped",currentVideoMessageTrack:(0,r._)({},t,{progress:0})}))}setState(e){this.state=e,this.emit(a.VideoMessagePlayerEventTypes.STATE_UPDATED,e)}getState(){return this.state}forceUpdate(e){this.setState(e)}constructor(e){super(),this.state=e;const t=localStorage.getItem("videomessage_settings");this.state.settings=t?JSON.parse(t):o}}},785132:(e,t,s)=>{s.d(t,{searchConversations:()=>c,searchMessages:()=>u,searchUsersGlobal:()=>p});var r=s(11010),n=s(434788),a=s(954811),o=s(96190),i=s(481186),d=s(95154);function c(e,t,s,r){return l.apply(this,arguments)}function l(){return(l=(0,r._)((function*(e,t,s,r){const n=yield e("messages.searchConversations",{q:s,count:d.SEARCH_CONVOS_COUNT,extended:1,group_id:r}),{profiles:o,groups:i,items:c,contacts:l}=n;return t({profiles:o,groups:i,conversations:c,contacts:l}),c.reduce(((e,t)=>{const s=(0,a.fromApiConvo)(t);return s&&e.add(s.convo.peerId),e}),new Set)}))).apply(this,arguments)}function u(e,t,s,r){return h.apply(this,arguments)}function h(){return(h=(0,r._)((function*(e,t,s,r){const a=yield e("messages.search",(0,n._)({},r,{extended:1,count:d.SEARCH_MESSAGES_COUNT})),{items:o,count:c,conversations:l,contacts:u,profiles:h,groups:p}=a;s({profiles:h,groups:p,conversations:l,contacts:u});return{results:o.reduce(((e,s)=>{const r=(0,i.fromApiMessage)(s).message;return"Normal"===r.kind?e.push(r):t.error(`Сообщение неожиданного типа вернулось из message.search: ${r.kind}`),e}),[]),count:c,apiItemsCount:o.length}}))).apply(this,arguments)}function p(e,t,s){return m.apply(this,arguments)}function m(){return(m=(0,r._)((function*(e,t,s){const r=yield e("users.search",s),{items:n,count:a}=r;t({profiles:n});return{results:n.map((e=>o.resolveRealId("User",e.id))),count:a}}))).apply(this,arguments)}},663126:(e,t,s)=>{s.d(t,{useApiFetch:()=>d});var r=s(434788),n=s(696023),a=s(667294),o=s(927411),i=s(53416);function d(){const{api:e}=(0,n.useBrowserEnv)(),t=(0,a.useRef)(new Set);return(0,a.useEffect)((()=>()=>{t.current.forEach((s=>{e.dangerouslyAbort(s),t.current.delete(s)}))}),[e]),(0,a.useCallback)(((s,n,a)=>{const d=o.IApi.resolveTrackId(s,(0,i.nanoid)(5));return t.current.add(d),e.fetch(s,n,(0,r._)({},a,{trackId:d}))}),[e])}},955625:(e,t,s)=>{s.d(t,{useConvoOrganiser:()=>d});var r=s(185327),n=s(498928),a=s(999504),o=s(667294),i=s(89131);function d(e,t,s,d){const[c,l]=(0,o.useState)(s),u=(0,o.useMemo)((()=>{let s=[];switch(c.kind){case"filters":{if(!(c.filter in e.filters))throw new Error("Выбрана несуществущая папка");const a=e.filters[c.filter];return s=Array.from(a.peerIds,(e=>r.safeGet(t,e))).sort(n.sorter),{organiser:c,convos:s,hasMore:a.hasMore}}case"folders":{const o=e.folders.find((e=>e.id===c.id));return o?(s=Array.from(o[c.filter].peerIds,(e=>r.safeGet(t,e))).sort(a.sorter),{organiser:c,convos:s,hasMore:o[c.filter].hasMore}):(l({kind:"filters",filter:d}),{organiser:{kind:"filters",filter:d},hasMore:e.filters.all.hasMore,convos:Array.from(e.filters.all.peerIds,(e=>r.safeGet(t,e))).sort(n.sorter)})}default:(0,i.exhaustivenessCheck)(c)}}),[c,e.filters,e.folders,t,d]);return{selectedOrganiser:u.organiser,convos:u.convos,hasMore:u.hasMore,setSelectedOrganiser:l}}},897297:(e,t,s)=>{s.d(t,{useTabListNavigation:()=>a});var r=s(667294);const n=-1;function a(){const[e,t]=(0,r.useState)(n),s=(0,r.useRef)(0),a=(0,r.useCallback)((e=>s.current=e),[]),o=(0,r.useRef)(),i=(0,r.useCallback)((e=>o.current=e),[]),d=(0,r.useCallback)((()=>{t(n)}),[]),c=(0,r.useCallback)(((r,n)=>{if(0!==s.current)switch(r){case"Enter":n(),null==o.current||o.current(e);break;case"ArrowDown":n(),t((e=>e+1<s.current?e+1:0));break;case"ArrowUp":n(),t((e=>e>0?e-1:s.current-1))}}),[e]);return{setTabsCount:a,setSelectHandler:i,indexToSelect:e,onKeyDown:c,resetIndexToSelect:d}}},760802:(e,t,s)=>{s.d(t,{usePicker:()=>a});var r=s(667294),n=s(89131);const a=({selection:e,strategy:t})=>{const[s,a]=(0,r.useState)(e);return"singular"===t&&e.size>1&&n.isDev&&console.error("В режиме выбора одной единицы данных должно быть не более одного элемента по умолчанию"),(0,r.useEffect)((()=>{a(e)}),[e]),{toggleSelection(e){let r;switch(t){case"singular":r=new Map(s.has(e.id)?[[e.id,e.value]]:[]);break;case"multiple":r=new Map(s);break;default:(0,n.exhaustivenessCheck)(t)}r.has(e.id)?r.delete(e.id):r.set(e.id,e.value),a(r)},selection:s}}},686260:(e,t,s)=>{s.d(t,{useConvoSearch:()=>v,useConvoSearchData:()=>y,useMessagesSearchData:()=>I,useSearchHandlers:()=>C,useUsersGlobalSearchData:()=>S});var r=s(11010),n=s(434788),a=s(820224),o=s(667294),i=s(696023),d=s(96190),c=s(821551),l=s(785132),u=s(897297),h=s(546428),p=s(991792),m=s(663126),f=s(95154),g=s(709646);function v({onSelect:e,searchIndex:t,defaultResults:s}){const{setTabsCount:r,setSelectHandler:i,resetIndexToSelect:d,onKeyDown:c,indexToSelect:l}=(0,u.useTabListNavigation)(),h=C(),{query:p,setNavigationParams:m}=h,f=(0,a._)(h,["query","setNavigationParams"]);(0,o.useEffect)((()=>{m({resetIndexToSelect:d,onKeyDown:c})}),[m,d,c]);const{results:g,isLoading:v,isDefault:_}=y({searchIndex:t,defaultResults:s,query:p});var k;const I=(0,o.useMemo)((()=>null!=(k=w(g))?k:[]),[g]),M=(0,o.useCallback)((t=>{const s=I[t];void 0!==s&&e(s)}),[I,e]);return(0,o.useEffect)((()=>{i(M)}),[M,i]),(0,o.useEffect)((()=>{r(I.length)}),[I,r]),(0,n._)({query:p},f,{results:g,isLoading:v,isDefault:_,indexToSelect:l})}function C(){const e=(0,o.useRef)(null),t=(0,o.useCallback)((t=>e.current=t),[]),[s,r]=(0,o.useState)(""),[n,a]=(0,o.useState)(!1),i=(0,o.useCallback)((t=>{var s;r(t),null==(s=e.current)||s.resetIndexToSelect()}),[]),d=(0,o.useCallback)((e=>i(e.target.value)),[i]),c=(0,o.useMemo)((()=>(0,h.onElementKeyDownFactory)(((t,s)=>{var r;if("Escape"===t)s(),i("");null==(r=e.current)||r.onKeyDown(t,s)}))),[i]),l=(0,o.useCallback)((()=>{var t;a(!0),null==(t=e.current)||t.resetIndexToSelect()}),[]),u=(0,o.useCallback)((()=>{var t;a(!1),null==(t=e.current)||t.resetIndexToSelect()}),[]),p=(0,o.useCallback)((()=>{i("")}),[i]),m=(0,o.useRef)(),[f,g]=(0,o.useState)(!1);return(0,o.useLayoutEffect)((()=>{n&&g(!1)}),[n]),(0,o.useLayoutEffect)((()=>{g(!s&&!!m.current),m.current=s}),[s]),{onChange:d,onKeyDown:c,onFocus:l,onBlur:u,reset:p,isFocused:n,becameEmpty:f,setNavigationParams:t,query:s,setQuery:i}}const _=new Set;function y({defaultResults:e=_,searchIndex:t,query:s}){const[a,u]=(0,o.useState)({isLoading:!1,results:e}),h=(0,o.useRef)(!0),{debounced:g,debouncedUpdatesCount:v}=(0,i.useDebounced)(s,f.SEARCH_DEBOUNCE_MS),C=(0,m.useApiFetch)(),y=(0,i.useOwner)(),k=(0,i.useInsertIntoCache)(),I=0===s.length,M=(0,i.usePeers)();(0,o.useEffect)((()=>{I&&(h.current=!0,u({isLoading:!1,results:e}))}),[I,e]),(0,o.useEffect)((()=>{if(I)return;h.current=!1;const e=t?c.search(t,s):new Set;u({isLoading:!0,results:e})}),[s,I]);const R=(0,o.useRef)(s);R.current=s;const S=(0,o.useCallback)((0,r._)((function*(e){if(0!==e.length){u((e=>(0,n._)({},e,{loading:!0})));try{const t=yield(0,l.searchConversations)(C,k,e,(0,p.getOwnerGroupId)(y.id));if(R.current!==e)return;u((e=>{const s=new Set([...e.results.values()]);return t.forEach((e=>{if(d.isContactPeerId(e)){const t=M.get(e);if("Contact"===(null==t?void 0:t.kind)&&t.userId)return}s.has(e)||s.add(e)})),{isLoading:!1,results:s}}))}catch(e){u((e=>(0,n._)({},e,{loading:!1})))}}})),[C,k,y.id,M]);(0,o.useEffect)((()=>{S(g).catch((()=>{}))}),[v,g]);const{isLoading:w,results:b}=a;let E;return E=s&&w&&0===b.size?"loading":s&&!w&&0===b.size?"empty":b,{results:E,isLoading:w,isDefault:h.current}}const k=[];function I({query:e,date:t,peerId:s}){const a=0===e.length&&!t,{logger:d}=(0,i.useBrowserEnv)(),c=(0,i.useOwner)(),u=(0,i.useInsertIntoCache)(),h=(0,m.useApiFetch)(),[f,g]=(0,o.useState)({isLoading:!1,hasMore:!0,results:k}),v=(0,o.useRef)(0),C=(0,o.useRef)(e);C.current=e;const _=(0,o.useCallback)((0,r._)((function*(e){if(!a){g((e=>(0,n._)({},e,{isLoading:!0})));try{const r=yield(0,l.searchMessages)(h,d,u,{q:e,peer_id:s,date:t,offset:v.current,group_id:(0,p.getOwnerGroupId)(c.id)});if(C.current!==e)return;const{results:n,count:a,apiItemsCount:o}=r;v.current+=o,g((e=>({isLoading:!1,hasMore:a>v.current&&o>0,results:[...e.results,...n]})))}catch(e){g((e=>(0,n._)({},e,{isLoading:!1,hasMore:!1})))}}})),[a,s,t,h,u,d,c.id]),{isLoading:y,hasMore:I,results:M}=f,R=(0,o.useCallback)((()=>{I&&!y&&_(e).catch((()=>{}))}),[I,y,_,e]);(0,o.useLayoutEffect)((()=>{v.current=0,a?g({isLoading:!1,hasMore:!1,results:k}):(g({isLoading:!0,hasMore:!0,results:[]}),_(e).catch((()=>{})))}),[a,e,s,t]);return{results:0===M.length&&!y&&!I&&!a?"empty":M,isLoading:y,hasMore:I,loadMore:R}}const M=20,R=[];function S({query:e}){const t=0===e.length,s=(0,m.useApiFetch)(),a=(0,i.useFeatureFlags)(),{profileType:d}=(0,i.useViewer)(),c=!a.vkm_add_non_friends||g.isEdu(d),u=(0,i.useInsertIntoCache)(),[h,p]=(0,o.useState)({isLoading:!1,hasMore:!0,results:R}),f=(0,o.useRef)(0),v=(0,o.useRef)(e);v.current=e;const C=(0,o.useCallback)((0,r._)((function*(e){if(!t){p((e=>(0,n._)({},e,{isLoading:!0})));try{const t=yield(0,l.searchUsersGlobal)(s,u,{q:e,offset:f.current,count:M});if(v.current!==e)return;const{results:r,count:n}=t;f.current+=M,p((e=>({isLoading:!1,hasMore:n>f.current&&0!==r.length,results:[...e.results,...r]})))}catch(e){p((e=>(0,n._)({},e,{isLoading:!1,hasMore:!1})))}}})),[t,s,u]),{isLoading:_,hasMore:y,results:k}=h,I=(0,o.useCallback)((()=>{!y||_||c||C(e).catch((()=>{}))}),[y,_,C,e,c]);(0,o.useLayoutEffect)((()=>{f.current=0,t||c?p({isLoading:!1,hasMore:!1,results:R}):(p({isLoading:!0,hasMore:!0,results:R}),C(e).catch((()=>{})))}),[t,e,c]);return{results:0===k.length&&!_&&!y&&!t?"empty":k,isLoading:_,hasMore:y,loadMore:I}}const w=e=>"empty"===e||"loading"===e?null:Array.from(e.values())},413066:(e,t,s)=>{s.d(t,{AttachCard:()=>l,getExpectedPhotoWidth:()=>u});var r=s(820224),n=(s(760398),s(667294)),a=s(294184),o=s.n(a),i=s(597298),d=s(696023),c=s(772132);const l=e=>{var t,{href:s,attach:a,onClick:l,picture:u,title:h,subtitle:p,alt:m}=e,f=(0,r._)(e,["href","attach","onClick","picture","title","subtitle","alt"]);const{router:g}=(0,d.useBrowserEnv)(),[v,C]=(0,n.useState)(u),_="isInBubble"in f,y="isLongTitle"in f,k=!v&&!!f.picturePlaceholder,I=o()("AttachCard",{"AttachCard--withLongTitle":y,"AttachCard--withBackground":!_,"AttachCard--inBubble":_}),M=n.createElement(n.Fragment,null,n.createElement("figure",{className:o()("AttachCard__pic",{AttachCard__picPlaceholder:k})},"string"==typeof v?n.createElement("img",{src:v,alt:m,className:"AttachCard__img",onError:()=>{C(void 0)}}):v||f.picturePlaceholder),n.createElement("div",{className:"AttachCard__main",style:"background"in f?{backgroundColor:f.background}:{}},n.createElement("div",{className:"AttachCard__content"},n.createElement("h2",{className:"AttachCard__title"},h),"caption"in f&&n.createElement("div",{className:"AttachCard__caption"},f.caption),"Link"===(null==a?void 0:a.kind)?n.createElement(c.AttachLinkMeta,{meta:a.meta}):null,n.createElement("div",{className:"AttachCard__subtitle"},"Link"===(null==a?void 0:a.kind)&&(null==(t=a.meta)?void 0:t.favicon)&&n.createElement("img",{className:"AttachCard__favicon",src:a.meta.favicon,alt:m}),p)))),R=a?{kind:"AttachProxyRoute",attach:a,fallbackUrl:s||void 0}:null;return R&&g.toUrl(R)?n.createElement(i.Link,{to:R,className:I,onClick:l},M):s?n.createElement(i.ExternalLink,{href:s,className:I,onClick:l},M):n.createElement("span",{className:I,onClick:l},M)};function u(e,t){return 16*(e?3.5:4)*(t?"undefined"!=typeof window?window.devicePixelRatio:2:1)}},772132:(e,t,s)=>{s.d(t,{AttachLinkMeta:()=>o});s(688274);var r=s(667294),n=s(20403),a=s(696023);const o=({meta:e})=>{const{lang:t}=(0,a.useBrowserEnv)();return e?r.createElement("div",{className:"AttachLinkMeta"},e.ownerName&&r.createElement("div",{className:"AttachLinkMeta__owner"},e.ownerName),e.rating&&e.reviews&&r.createElement("div",{className:"AttachLinkMeta__rating"},r.createElement(n.Icon12Favorite,null)," ",e.rating,r.createElement("span",null,"·"),r.createElement("span",{className:"AttachLinkMeta__reviews"},t.use("me_reviews_count_text",{num:e.reviews})))):null}},936890:(e,t,s)=>{s.d(t,{Avatar:()=>u});s(380283);var r=s(667294),n=s(294184),a=s.n(n),o=s(696023),i=s(96190),d=s(89131),c=s(83298),l=s(351381);const u=r.memo((function({peer:e,size:t,activityIndicator:s,withOnline:n=!1,withBirthday:d=!1,activeCall:c,className:u}){const p=(0,o.useOnline)(e.id),m=(0,o.usePixelDensity)(),f=function(e,t){if("User"!==e.kind)return"Offline";if(t)switch(e.lastSeen.platform){case"vkme":case"mobile":return"Mobile";case"other":return"Online";default:e.lastSeen.platform;return"Online"}return"Offline"}(e,n&&p),g=!!c,v=d&&function(e){var t;if("User"!==e.kind||!e.bdate)return!1;const s=new Date,r=String(s.getDate()),n=String(s.getMonth()+1),{day:a,month:o}=(null==(t=RegExp("(?<day>\\d+)\\.(?<month>\\d+)").exec(e.bdate))?void 0:t.groups)||{};return a===r&&o===n}(e),C=function(e,t,s){var r;if("Contact"===e.kind)return e.photo50;s&&(t*=2);const n=[{size:50,url:e.photo50},{size:100,url:e.photo100||e.photo50},{size:200,url:e.photo200||e.photo100||e.photo50}];return null==(r=n.find((e=>t<=e.size&&Boolean(e.url))))?void 0:r.url}(e,t,m),[_,y]=(0,r.useState)((()=>{if(!C)return!1;const e=new Image;return e.src=C,e.complete||e.width+e.height>0})),k=(0,r.useMemo)((()=>({width:t,height:t})),[t]),I=function(e,t,s){return`mePeerFrame${e}${t}${s?"c":""}`}(f,t,g||v),M=`url(#${I}Mask${e.id})`,R=a()("MEAvatar",`MEAvatar--size-${t}`,{"MEAvatar--withActivity":!!s,"MEAvatar--emptyCall":"empty"===c},u);return r.createElement("figure",{style:k,className:R},r.createElement("div",{className:"MEAvatar__imgWrapper",style:{clipPath:M}},r.createElement(l.AvatarNoPhoto,{peer:e,size:t}),C&&r.createElement("img",{className:a()("MEAvatar__img",{"MEAvatar__img--ready":_}),alt:i.name(e),src:C,onLoad:()=>y(!0)}),s&&r.createElement("div",{className:"MEAvatar__activityIndicator"},s)),r.createElement(h,{frameType:f}),v&&r.createElement("div",{className:"MEAvatar__upperRightIcon MEAvatar__birthday"},r.createElement("svg",{className:"MEAvatar__upperRightIconSvg"},r.createElement("use",{href:"#meCake10"}))),g&&r.createElement("div",{className:"MEAvatar__upperRightIcon MEAvatar__call"},r.createElement("svg",{className:"MEAvatar__upperRightIconSvg"},r.createElement("use",{href:"#mePhone10"}))),r.createElement("svg",{className:"MEAvatar__svg"},r.createElement("clipPath",{id:I+"Mask"+e.id},r.createElement("use",{href:"#"+I})),r.createElement("use",{href:"#"+I,className:"MEAvatar__shadow",clipPath:M})))}));const h=({frameType:e})=>{switch(e){case"Mobile":return r.createElement("div",{className:"MEAvatar__mobile"},r.createElement(c.Icon12OnlineMobile,null));case"Online":return r.createElement("div",{className:"MEAvatar__online"});case"Offline":return null;default:(0,d.exhaustivenessCheck)(e)}}},377291:(e,t,s)=>{s.d(t,{AvatarFavorites:()=>d});var r=s(667294),n=(s(320428),s(294184)),a=s.n(n),o=s(696023),i=s(999411);const d=({size:e,className:t})=>{const{lang:s}=(0,o.useBrowserEnv)(),n=(0,r.useMemo)((()=>({width:e,height:e})),[e]),i=a()("AvatarFavorites",t);return r.createElement("div",{style:n,className:i,"aria-label":s.use("me_favorites")},c[e])},c={24:r.createElement("svg",{fill:"currentColor",height:"12",width:"12",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true"},r.createElement("path",{d:"M5.55 1.29h.9c.58 0 1.05 0 1.42.03.38.03.71.1 1.01.25.49.24.88.64 1.13 1.12.15.3.21.63.25 1.01.03.38.03.84.03 1.42v3.7c0 .44 0 .8-.03 1.07-.02.27-.08.55-.25.77-.24.3-.61.48-1 .48-.28 0-.53-.12-.76-.27-.23-.15-.51-.36-.85-.63l-.82-.64a1.8 1.8 0 00-.47-.32.43.43 0 00-.22 0 1.8 1.8 0 00-.47.32l-.82.64c-.34.27-.62.48-.85.63-.23.15-.48.28-.76.27-.39 0-.76-.18-1-.48-.17-.22-.23-.5-.25-.77-.03-.28-.03-.63-.03-1.06v-3.7c0-.59 0-1.05.03-1.43.04-.38.1-.71.25-1.01.25-.48.64-.88 1.13-1.12.3-.16.63-.22 1-.25.38-.03.85-.03 1.43-.03zm-1.35.88c-.33.03-.53.08-.7.16-.32.16-.58.43-.74.75-.08.16-.13.36-.16.69-.03.34-.03.77-.03 1.37v3.67c0 .46 0 .77.02 1 .02.24.06.3.07.32.08.1.2.16.34.16.01 0 .09-.01.29-.14.2-.12.44-.32.8-.6l.8-.62.06-.04c.25-.2.46-.37.71-.43.22-.06.46-.06.68 0 .25.06.46.23.71.43l.06.04.8.62c.36.28.6.48.8.6.2.13.28.14.3.14.12 0 .25-.06.33-.16 0-.02.05-.08.07-.32.02-.23.02-.54.02-1V5.14c0-.6 0-1.03-.03-1.37a1.81 1.81 0 00-.16-.7 1.71 1.71 0 00-.75-.74 1.81 1.81 0 00-.69-.16c-.33-.03-.76-.03-1.37-.03h-.86c-.6 0-1.04 0-1.37.03z"})),32:r.createElement("svg",{fill:"currentColor",height:"16",width:"16",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true"},r.createElement("path",{d:"M7.4 1.71h1.2c.78 0 1.4 0 1.9.05.5.04.94.12 1.34.33.65.33 1.17.85 1.5 1.5.2.4.3.83.33 1.34.04.5.04 1.12.04 1.9v4.94c0 .58 0 1.05-.03 1.41-.03.37-.1.74-.34 1.03-.32.4-.8.65-1.33.65-.37 0-.7-.17-1.01-.36-.31-.2-.68-.5-1.14-.84l-1.09-.85a2.4 2.4 0 00-.62-.43.57.57 0 00-.3 0 2.4 2.4 0 00-.62.43l-1.1.85c-.45.35-.82.64-1.13.84-.3.2-.64.36-1.01.36-.52 0-1.01-.24-1.33-.65-.24-.3-.3-.66-.34-1.03-.03-.36-.03-.83-.03-1.4V6.82c0-.78 0-1.4.04-1.9s.13-.94.33-1.34c.33-.65.85-1.17 1.5-1.5.4-.2.83-.3 1.35-.33.5-.05 1.11-.05 1.9-.05zM5.6 2.9c-.44.04-.71.1-.92.22-.43.22-.78.57-1 1-.11.2-.18.48-.21.92a24.9 24.9 0 00-.04 1.83v4.88c0 .61 0 1.03.03 1.34.03.32.08.4.1.42.1.14.26.22.44.22.02 0 .12-.01.38-.19.26-.16.6-.42 1.08-.8l1.07-.83.07-.05c.33-.26.62-.48.95-.57.3-.08.6-.08.9 0 .33.09.62.31.95.57l.07.05 1.07.84c.49.37.82.63 1.08.8.26.17.36.18.38.18.18 0 .34-.08.45-.22.01-.02.06-.1.1-.42.02-.3.02-.73.02-1.34V6.86c0-.81 0-1.39-.04-1.83-.03-.44-.1-.71-.2-.92a2.29 2.29 0 00-1-1c-.22-.11-.49-.18-.93-.22a24.9 24.9 0 00-1.83-.03H7.43c-.81 0-1.38 0-1.83.03z"})),40:r.createElement("svg",{fill:"currentColor",height:"20",width:"20",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true"},r.createElement("path",{d:"M9.25 2.14h1.5c.97 0 1.74 0 2.37.05a4.4 4.4 0 011.68.42c.8.41 1.46 1.07 1.88 1.87.25.5.36 1.05.41 1.69.05.62.05 1.4.05 2.37v6.18c0 .71 0 1.3-.04 1.76-.04.45-.13.92-.42 1.28-.4.51-1.01.8-1.66.81-.47 0-.89-.2-1.27-.45-.39-.25-.85-.6-1.42-1.05L10.96 16a3 3 0 00-.77-.54.71.71 0 00-.38 0 3 3 0 00-.77.54l-1.37 1.06c-.57.44-1.03.8-1.42 1.05-.38.24-.8.46-1.27.45-.65 0-1.26-.3-1.66-.8a2.36 2.36 0 01-.42-1.29c-.04-.46-.04-1.05-.04-1.76V8.54c0-.97 0-1.75.05-2.37a4.4 4.4 0 01.41-1.69A4.29 4.29 0 015.2 2.61a4.4 4.4 0 011.68-.42c.63-.05 1.4-.05 2.37-.05zM7 3.62c-.55.04-.89.13-1.15.26-.54.28-.98.71-1.25 1.25-.14.27-.22.6-.27 1.15-.04.56-.04 1.28-.04 2.3v6.1c0 .76 0 1.29.03 1.67.04.4.1.5.12.52.13.17.34.27.55.28.03 0 .16-.02.5-.23.32-.21.73-.53 1.33-1l1.34-1.04a41 41 0 00.09-.07c.4-.32.77-.6 1.19-.72.37-.1.75-.1 1.12 0 .42.12.78.4 1.2.72l.08.07 1.34 1.04c.6.47 1.01.79 1.34 1 .33.21.46.23.49.23.21 0 .42-.1.55-.27.02-.03.08-.13.12-.53.03-.38.03-.9.03-1.67v-6.1c0-1.02 0-1.74-.04-2.3a3.02 3.02 0 00-.27-1.15 2.86 2.86 0 00-1.25-1.25c-.26-.13-.6-.22-1.15-.26-.56-.05-1.27-.05-2.29-.05H9.3c-1.02 0-1.73 0-2.3.05z"})),44:r.createElement("svg",{fill:"currentColor",height:"22",width:"22",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true"},r.createElement("path",{d:"M10.18 2.36h1.64c1.07 0 1.92 0 2.61.05.7.06 1.3.18 1.85.46.89.45 1.61 1.17 2.06 2.06.28.55.4 1.15.46 1.85.06.7.06 1.54.06 2.61v6.8c0 .79 0 1.44-.05 1.94-.04.5-.14 1-.46 1.4-.44.57-1.12.9-1.83.9a2.6 2.6 0 01-1.4-.5c-.42-.27-.93-.67-1.56-1.15l-1.5-1.17a3.3 3.3 0 00-.85-.59.78.78 0 00-.42 0 3.3 3.3 0 00-.85.59l-1.5 1.17c-.63.48-1.14.88-1.56 1.15-.42.27-.89.5-1.4.5-.71 0-1.39-.33-1.83-.9a2.6 2.6 0 01-.46-1.4c-.05-.5-.05-1.15-.05-1.94v-6.8c0-1.07 0-1.92.06-2.6.06-.7.18-1.3.46-1.86a4.71 4.71 0 012.06-2.06c.55-.28 1.15-.4 1.85-.46.69-.05 1.54-.05 2.61-.05zM7.7 3.98c-.6.05-.98.14-1.27.3-.6.3-1.07.77-1.37 1.36-.15.3-.25.67-.3 1.27-.05.62-.05 1.4-.05 2.52v6.72c0 .84 0 1.41.04 1.84.04.43.11.55.13.57.15.19.38.3.61.3.04 0 .17-.01.54-.25.36-.23.81-.58 1.47-1.1l1.47-1.14.1-.08c.45-.35.85-.66 1.31-.79.4-.1.83-.1 1.24 0 .46.13.86.44 1.3.8l.1.07 1.48 1.14c.66.52 1.11.87 1.47 1.1.37.24.5.25.54.25.23 0 .46-.11.6-.3.03-.02.1-.14.14-.57.03-.43.04-1 .04-1.84V9.43c0-1.11 0-1.9-.06-2.52-.04-.6-.14-.97-.29-1.27-.3-.59-.78-1.07-1.37-1.37-.3-.15-.66-.24-1.27-.29-.61-.05-1.4-.05-2.51-.05H10.2c-1.1 0-1.9 0-2.51.05z"})),46:r.createElement("svg",{fill:"currentColor",height:"24",width:"24",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true"},r.createElement("path",{d:"M11.1 2.57h1.8c1.16 0 2.1 0 2.84.06.77.07 1.42.2 2.02.5.97.5 1.76 1.28 2.25 2.25.3.6.44 1.25.5 2.02.06.75.06 1.68.06 2.85v7.4c0 .87 0 1.58-.05 2.13-.05.54-.16 1.1-.5 1.53-.49.61-1.22.97-2 .98-.56 0-1.06-.25-1.52-.55-.47-.3-1.02-.73-1.7-1.26l-1.64-1.27a3.6 3.6 0 00-.94-.64.86.86 0 00-.44 0 3.6 3.6 0 00-.94.64L9.2 20.48c-.68.53-1.23.97-1.7 1.26-.46.3-.96.55-1.52.55-.78 0-1.51-.37-2-.98-.34-.44-.45-1-.5-1.53-.05-.55-.05-1.26-.05-2.12v-7.41c0-1.17 0-2.1.06-2.85.06-.77.2-1.42.5-2.02a5.14 5.14 0 012.25-2.25c.6-.3 1.25-.43 2.02-.5.75-.06 1.68-.06 2.85-.06zM8.4 4.34c-.66.06-1.07.16-1.39.32-.64.33-1.16.85-1.5 1.5-.16.32-.26.72-.31 1.38-.06.67-.06 1.53-.06 2.75v7.32c0 .92 0 1.55.05 2.01.04.48.12.6.14.63.16.2.4.32.66.33.04 0 .19-.02.59-.28.39-.25.88-.63 1.6-1.2l1.61-1.24.1-.09c.5-.38.93-.72 1.44-.86.44-.12.9-.12 1.34 0 .5.14.94.48 1.43.86l.11.09 1.6 1.24c.73.57 1.22.95 1.61 1.2.4.26.55.28.59.28.26 0 .5-.13.66-.33.02-.03.1-.15.14-.63.05-.46.05-1.09.05-2v-7.33c0-1.22 0-2.08-.06-2.75a3.62 3.62 0 00-.32-1.38 3.43 3.43 0 00-1.5-1.5 3.62 3.62 0 00-1.38-.32c-.67-.05-1.53-.05-2.74-.05h-1.72c-1.21 0-2.07 0-2.74.05z"})),56:r.createElement(i.Icon56BookmarkOutline,{width:36,height:36}),80:r.createElement(i.Icon56BookmarkOutline,null)}},351381:(e,t,s)=>{s.d(t,{AvatarNoPhoto:()=>i,AvatarNoPhotoSimple:()=>d});s(183638);var r=s(667294),n=s(294184),a=s.n(n),o=s(96190);const i=({peer:e,size:t,className:s})=>r.createElement(d,{peerId:e.id,size:t,className:s,text:o.initials(e)}),d=({text:e,peerId:t,size:s,className:n})=>{const i=void 0!==t&&o.isContactPeerId(t)?"AvatarNoPhoto--color-contact":`AvatarNoPhoto--color-${Math.abs((null!=t?t:0)%6)}`;return r.createElement("div",{className:a()("AvatarNoPhoto",`AvatarNoPhoto--size-${s}`,i,n)},e)}},7817:(e,t,s)=>{s.d(t,{AvatarSimple:()=>c});s(100732);var r=s(667294),n=s(96190),a=s(696023),o=s(294184),i=s.n(o),d=s(351381);const c=r.memo((({peer:e,size:t,className:s})=>{const o=(0,a.usePixelDensity)(),c=(0,r.useMemo)((()=>function(e,t,s){if("Contact"===e.kind)return e.photo50;switch(t){case 64:case 72:case 80:return s?e.photo200:e.photo100;default:return s?e.photo100:e.photo50}}(e,t,o)),[e,t,o]),l=i()("AvatarSimple",`AvatarSimple--size-${t}`,s);return r.createElement("div",{className:l},c?r.createElement("img",{className:"AvatarSimple__img",alt:n.name(e),src:c}):r.createElement(d.AvatarNoPhoto,{peer:e,size:t}))}))},814977:(e,t,s)=>{s.d(t,{CasperIcon:()=>c});var r=s(900917),n=s(696023),a=(s(677749),s(943997)),o=s(294184),i=s.n(o),d=s(667294);const c=({className:e})=>{const{lang:t}=(0,n.useBrowserEnv)();return d.createElement("div",{className:i()("CasperIcon__container",e)},d.createElement(a.Tooltip,{content:d.createElement("span",{className:"CasperIcon__tooltip"},t.use("me_casper_chat_info")),position:"top",align:"center"},d.createElement("span",{className:"CasperIcon__icon"},d.createElement(r.Icon16Ghost,null))))}},337400:(e,t,s)=>{s.d(t,{ConvoPicker:()=>y});var r=s(11010),n=s(667294),a=s(696023),o=s(954811),i=s(96190),d=s(185327),c=s(821551),l=s(519478),u=s(4738),h=s(827258),p=(s(988426),s(294184)),m=s.n(p),f=s(991792),g=s(955625),v=s(89131),C=s(95154);const _=[],y=({filter:e="all",selectedPeerIds:t=_,initialQuery:s="",onSelectionChange:p,strategy:y="singular",searchRenderer:k=l.PeerChipsSearchInput,listRenderer:I=u.PeerPickerList,listFilter:M,className:R,withFavorites:S=!1})=>{const{api:w}=(0,a.useBrowserEnv)(),b=(0,a.useDispatch)(),E=(0,a.useInsertIntoCache)(),U=(0,a.useConvosSearchIndex)(),A=(0,a.useOwner)(),P=(0,a.useConvos)(),T=(0,a.useOrganisers)(),{selectedOrganiser:N,convos:F,setSelectedOrganiser:q,hasMore:x}=(0,g.useConvoOrganiser)(T,P,{kind:"filters",filter:e},"all"),O=(0,n.useMemo)((()=>(F||[]).map((e=>e.peerId))),[F]),[L,D]=(0,n.useState)(O),[B,G]=(0,n.useState)(!1),[H,z]=(0,n.useState)(!1),[V,K]=(0,n.useState)(null),j=(0,n.useRef)(null),[W,$]=(0,n.useState)(s),Q=!!W,Y=(0,n.useCallback)((e=>Array.from(c.search(U,e).values())),[U]);(0,n.useEffect)((()=>{q({kind:"filters",filter:e})}),[q,e]);const J=(0,n.useCallback)((e=>{const t=new Map;return e.forEach((e=>{t.set(e.toString(),{kind:"peer",peerId:e})})),t}),[]),[X,Z]=(0,n.useState)(J(t)),ee=e=>{const t=Array.from(e.values()),s=[];for(let e=0;e<t.length;e+=1){const r=t[e];"peer"===(null==r?void 0:r.kind)&&s.push(r.peerId)}return s};(0,n.useEffect)((()=>{const e=ee(X);e.length===(null==t?void 0:t.length)&&e.every((e=>t.includes(e)))||Z(J(t))}),[t,J]);const te=(0,n.useMemo)((()=>(0,v.debounce)((0,r._)((function*(e){try{G(!0),z(!1);const t=yield w.fetch("messages.searchConversations",{q:e,count:C.SEARCH_CONVOS_COUNT,extended:1,group_id:(0,f.getOwnerGroupId)(A.id)});if(j.current!==e)return;const s=t.count,r=t.items,n=t.profiles||[],a=t.groups||[],i=t.contacts||[];E({profiles:n,groups:a,conversations:r,contacts:i});const d=[];r.forEach((e=>{const t=(0,o.fromApiConvo)(e);(null==t?void 0:t.convo.peerId)&&d.push(t.convo.peerId)})),D((e=>{const t=e.slice();return d.forEach((e=>{t.includes(e)||t.push(e)})),t})),K(s),G(!1)}catch(e){z(!0),G(!1)}})),300,!1)),[G,D,K,w,E,A.id]);(0,n.useEffect)((()=>()=>{te.cancel()}),[]),(0,n.useEffect)((()=>{Q||(D(O),G(x))}),[Q,O,x,D,G]);(0,n.useEffect)((()=>{p(ee(X))}),[X]);const se=(0,n.useMemo)((()=>{let t=L;S&&(t=t.filter((e=>!i.isFavorites(e,A.id))),t.unshift(A.id)),(M||"chats"===e)&&(t=t.filter((t=>{const s=d.safeGet(P,t);return!(M&&!M(s))&&!("chats"===e&&!i.isChatPeerId(t))})));return t.map((e=>({kind:"peer",peerId:e})))}),[L,S,M,e,A.id,P]),re=(0,n.useMemo)((()=>Q?null===V?null:se.length:x?null:se.length),[Q,x,se,V]),ne=(0,r._)((function*({query:e,offset:t,count:s}){if(z(!1),j.current=e,!Q&&e&&K(null),e)te(e);else{const e=t+s;se.length<=e&&b({type:"MoreConvosNeeded",organiser:N})}}));return n.createElement(h.Picker,{items:se,total:re,isLoading:B,hasFailed:H,onSelectionChange:e=>{Z(e)},getItemId:function(e){switch(e.kind){case"peer":return e.peerId.toString();case"template":return e.id;default:return(0,v.exhaustivenessCheck)(e)}},search:ne,prefetch:({query:e})=>{if(!e)return;let t=Y(e);D(t),0===t.length&&G(!0)},initialQuery:s,selection:X,listRenderer:I,searchRenderer:k,strategy:y,onQueryChange:$,className:m()("vkmConvoPicker",R)})}},661059:(e,t,s)=>{s.d(t,{ConvoTitle:()=>p});s(774996);var r=s(667294),n=s(354819),a=s(96715),o=s(998901),i=s(96190),d=s(709646),c=s(294184),l=s.n(c),u=s(696023),h=s(814977);const p=r.memo((function({peer:e,isMuted:t,isCasper:s,isShortened:c=!1,isMultiline:p=!1,className:m}){const{lang:f}=(0,u.useBrowserEnv)(),g=(0,u.useOwner)(),v=(0,u.useViewer)(),C=d.isEdu(v.profileType),_=c?i.firstName(e):i.name(e),y=i.isFavorites(e.id,g.id)?f.use("me_favorites"):_,k=l()("ConvoTitle",m,{"ConvoTitle--singleLine":!p,"ConvoTitle--multiLine":p}),I=r.createElement(r.Fragment,null,"Chat"!==e.kind&&"Contact"!==e.kind&&e.isVerified?r.createElement("span",{className:"ConvoTitle__icon ConvoTitle__verifiedIcon"},C&&"User"===e.kind?r.createElement(n.Icon16Education,null):r.createElement(a.Icon16Verified,null)):null,s&&r.createElement(h.CasperIcon,{className:"ConvoTitle__icon"}),t&&r.createElement("span",{className:"ConvoTitle__icon ConvoTitle__mutedIcon"},r.createElement(o.Icon16Muted,null)));return r.createElement("div",{className:k},p?r.createElement("div",{className:"ConvoTitle__title"},y,I):r.createElement(r.Fragment,null,r.createElement("div",{className:"ConvoTitle__title"},y),I))}))},67091:(e,t,s)=>{s.d(t,{FormattedPhoneNumber:()=>o});var r=s(11010),n=s(667294),a=s(15285);const o=({phone:e,className:t})=>{const[s,o]=(0,n.useState)(e);return(0,n.useEffect)((()=>{(0,r._)((function*(){try{const t=yield(0,a.formatPhoneNumber)(e);o(t.international)}catch(t){o(e)}}))().catch((()=>{}))}),[e]),n.createElement("div",{className:t},null!=s?s:e)}},53763:(e,t,s)=>{s.d(t,{IconNote:()=>n});var r=s(667294);s(784256);const n=({icon:e,actions:t,children:s})=>r.createElement("div",{className:"IconNote"},e&&r.createElement("div",{className:"IconNote__icon"},e),r.createElement("div",{className:"IconNote__content"},s),t&&r.createElement("div",{className:"IconNote__actions"},t))},266864:(e,t,s)=>{s.d(t,{ModalInterface:()=>l});s(360862);var r=s(667294),n=s(671324),a=s(874971),o=s(964929),i=s(798855),d=s(234325),c=s(506315);const l=({onClose:e,closeLabel:t,onBack:s,backLabel:l,title:u,contextClass:h,panelClass:p,hasClearBackdrop:m,isHidden:f,portalTarget:g,buttons:v,withCustomLayout:C,children:_,footerHint:y})=>r.createElement(n.ModalView,{onEscape:e,contextClass:h,portalTarget:g,isHidden:f},r.createElement(a.ModalBackdrop,{onClick:e,isClear:m},r.createElement(o.ModalPanel,{className:p},r.createElement(i.ModalHeader,{closeLabel:t,onClose:e,backLabel:l,onBack:s,title:u}),r.createElement(d.ModalBody,{withCustomLayout:C},_),v&&r.createElement(c.ModalFooter,{buttons:v,hint:y}))))},988277:(e,t,s)=>{s.d(t,{NoResults:()=>i});s(58245);var r=s(667294),n=s(194805),a=s(294184),o=s.n(a);const i=r.memo((function({children:e,icon:t=r.createElement(n.Icon56MessagesOutline,null),className:s}){return r.createElement("div",{className:o()("NoResults",s)},r.createElement("span",{className:"NoResults__icon"},t),r.createElement("div",{className:"NoResults__text"},e))}))},282384:(e,t,s)=>{s.d(t,{OnlineStatus:()=>a});var r=s(667294),n=s(696023);const a=r.memo((function({className:e,user:t}){const{lang:s}=(0,n.useBrowserEnv)(),a=(0,n.useOnline)(t.id),o=(0,n.useNow)(6e5);if("Contact"===t.kind){if(t.lastSeen&&["today","recently"].includes(t.lastSeen)){const n={today:s.use("global_online_was_today",{sex:"male"}),recently:s.use("global_online_was_recently",{sex:"male"})}[t.lastSeen];return r.createElement("span",{className:e,role:"status"},n)}return null}if(a)return r.createElement("span",{className:e,role:"status"},s.use("global_online",{sex:t.sex}));if(!t.lastSeen.isVisible)return r.createElement("span",{className:e,role:"status"},s.use("global_online_was_recently",{sex:t.sex}));if(!t.lastSeen.at)return null;if(t.lastSeen.isVisible)return r.createElement("span",{className:e,role:"status"},s.formatDate(t.lastSeen.at,{now:o,variant:"time-ago"}));const i=864e5,d=6048e5,c=o-t.lastSeen.at;let l;switch(!0){case c<i:l="global_online_was_recently";break;case c<d:l="global_online_was_week";break;case c<24192e5:l="global_online_this_month";break;default:l="global_online_long_ago"}return r.createElement("span",{role:"status",className:e},s.use(l,{sex:t.sex}))}))},863994:(e,t,s)=>{s.d(t,{PeerChip:()=>l});var r=s(667294),n=s(96190),a=s(790932),o=(s(279478),s(294184)),i=s.n(o),d=s(696023),c=s(7817);const l=({peerId:e,onRemove:t,className:s})=>{const{lang:o}=(0,d.useBrowserEnv)(),l=(0,d.usePeers)(),u=n.safeGet(l,e);return r.createElement("div",{className:i()("PeerChip",s)},r.createElement("div",{className:"PeerChip__content"},r.createElement(c.AvatarSimple,{peer:u,size:20}),r.createElement("div",{className:"PeerChip__name"},n.firstName(u))),t&&r.createElement("button",{"aria-label":o.use("me_remove"),className:"PeerChip__remove",onClick:t},r.createElement(a.Icon16Cancel,null)))}},519478:(e,t,s)=>{s.d(t,{PeerChipsSearchInput:()=>c});var r=s(667294),n=s(24087),a=(s(42505),s(696023)),o=s(863994),i=s(966430),d=s(966933);const c=({onQueryChange:e,onRemove:t,selection:s,placeholder:c})=>{const{lang:l}=(0,a.useBrowserEnv)(),u=(0,r.useRef)(null),h=(0,r.useRef)(null),[p,m]=(0,r.useState)(""),f=(0,a.usePrevious)(s),{isTouchOnly:g}=(0,d.useDeviceData)();(0,r.useEffect)((()=>{f&&f.size<s.size&&m("")}),[f,s.size]);(0,r.useEffect)((()=>{e(p)}),[p]),(0,r.useEffect)((()=>{const e=h.current;e&&(f&&f.size>=s.size||e.scrollIntoView({block:"nearest"}))}),[f,s]),(0,r.useEffect)((()=>{h.current&&(g||h.current.focus())}),[s,g]);const v=(0,r.useMemo)((()=>Array.from(s.values())),[s]),C=(0,r.useMemo)((()=>{const e=[];for(let t=0;t<v.length;t+=1){const s=v[t];"peer"===(null==s?void 0:s.kind)&&e.push(s.peerId)}return e}),[v]);return r.createElement("div",{className:"PeerChipsSearchInput","data-testid":"PeerChipsSearchInput"},r.createElement(n.default,{style:{maxHeight:134},ref:u},r.createElement("div",{className:"PeerChipsSearchInput__content",onMouseDown:e=>{const t=h.current;t&&document.activeElement===t&&e.stopPropagation()},onClick:e=>{e.currentTarget===e.target&&h.current&&h.current.focus()}},0===C.length&&r.createElement("div",{className:"PeerChipsSearchInput__icon"},r.createElement(i.Icon20Search,null)),C.length>0&&C.map((e=>r.createElement(o.PeerChip,{key:e,peerId:e,className:"PeerChipsSearchInput__item",onRemove:()=>(e=>{const s=v.find((t=>"peer"===t.kind&&t.peerId===e));s&&(null==t||t(s))})(e)}))),r.createElement("div",{className:"PeerChipsSearchInput__inputContainer"},r.createElement("input",{"data-testid":"PeerChipsSearchInput__input",className:"PeerChipsSearchInput__input",ref:h,onChange:e=>{m(e.currentTarget.value)},value:p,placeholder:(()=>{if(!(C.length>0))return c||l.use("me_picker_peer_search_placeholder")})()})))))}},4738:(e,t,s)=>{s.d(t,{PeerPickerList:()=>m});var r=s(434788),n=s(820224),a=s(667294),o=s(537090),i=(s(932823),s(684709)),d=s(414831),c=s(126528),l=s(53763),u=s(988277),h=s(696023),p=s(89131);const m=e=>{var{controlType:t,controlSide:s,descriptive:m=!0,loaderNode:f,errorNode:g,emptyNode:v,itemRenderer:C,itemHeight:_=56}=e,y=(0,n._)(e,["controlType","controlSide","descriptive","loaderNode","errorNode","emptyNode","itemRenderer","itemHeight"]);const{lang:k}=(0,h.useBrowserEnv)(),I=(0,a.useCallback)((e=>{switch(e.item.kind){case"peer":return a.createElement(d.PeerPickerListItem,{isGlobal:e.item.isGlobal,controlType:t,controlSide:s,descriptive:m,selected:e.selected,disabled:e.disabled,peerId:e.item.peerId,onSelection:()=>e.onSelection({id:e.id,value:e.item})});case"template":return e.item.node;default:return(0,p.exhaustivenessCheck)(e.item)}}),[m,t,s]),M=e=>a.createElement("div",{className:"PeerPickerList__content"},e);return a.createElement(i.PickerList,(0,r._)({},y,{itemRenderer:C||I,itemHeight:_,loaderNode:M(f||a.createElement(c.OptimizedSpinner,null)),errorNode:M(g||a.createElement(l.IconNote,{icon:a.createElement(o.Icon56ErrorOutline,null)},a.createElement("div",{className:"PeerPickerList__error"},k.use("me_picker_peer_list_error")))),emptyNode:M(v||a.createElement(u.NoResults,null,k.use("me_picker_peer_list_empty")))}))}},414831:(e,t,s)=>{s.d(t,{PeerPickerListItem:()=>p});var r=s(667294),n=s(96190),a=s(185327),o=s(760540),i=s(696023),d=(s(737968),s(7817)),c=s(377291),l=s(248390),u=s(661059),h=s(953614);const p=({selected:e=!1,disabled:t=!1,peerId:s,onSelection:p,controlType:m="check",controlSide:f="left",descriptive:g=!0,isGlobal:v=!1})=>{const C=(0,i.usePeers)(),_=(0,i.useConvos)(),y=n.safeGet(C,s),k=(0,i.useOwner)(),I="Chat"===y.kind?a.safeGet(_,y.id):null,M=n.isFavorites(y.id,k.id);return r.createElement(o.PickerItem,{selected:e,disabled:t,onSelection:p,controlType:m,controlSide:f,className:"PeerPickerListItem__item"},r.createElement("div",{className:"PeerPickerListItem","data-testid":"PeerPickerListItem"},r.createElement("div",{className:"PeerPickerListItem__avatar"},M?r.createElement(c.AvatarFavorites,{size:40}):r.createElement(d.AvatarSimple,{peer:y,size:40})),r.createElement("div",{className:"PeerPickerListItem__content"},r.createElement("div",{className:"PeerPickerListItem__name"},"User"===y.kind?r.createElement(l.PeerTitle,{peer:y,isFavorites:M}):r.createElement(u.ConvoTitle,{peer:y,isMuted:!1,isCasper:null!==I&&a.isCasper(I)})),!M&&g&&r.createElement(h.PeerSubhead,{className:"PeerPickerListItem__info",peer:y,convo:I,showScreenName:v}))))}},953614:(e,t,s)=>{s.d(t,{PeerSubhead:()=>c});var r=s(667294),n=s(696023),a=s(282384),o=s(86894),i=s(89131),d=s(67091);const c=({peer:e,convo:t,showScreenName:s,className:c})=>{const{lang:l}=(0,n.useBrowserEnv)();return r.createElement(o.Subhead,{className:c,Component:"span",weight:"3"},(()=>{if(s&&("User"===e.kind||"Group"===e.kind)&&e.screenName)return r.createElement(r.Fragment,null,"@",e.screenName);switch(e.kind){case"User":return r.createElement(a.OnlineStatus,{user:e});case"Chat":return"ChatConvo"!==(null==t?void 0:t.kind)||"in"!==t.state?"":l.use("me_group_members_count",{num:t.membersCount,formatted:"short"});case"Group":return l.use("me_group_members_count",{num:e.memberCount,formatted:"short"});case"Contact":return r.createElement(d.FormattedPhoneNumber,{phone:e.phone});default:(0,i.exhaustivenessCheck)(e)}})())}},248390:(e,t,s)=>{s.d(t,{PeerTitle:()=>h});s(501954);var r=s(667294),n=s(354819),a=s(96715),o=s(20403),i=s(96190),d=s(294184),c=s.n(d),l=s(696023),u=s(709646);const h=r.memo((function({peer:e,isShortened:t=!1,isAdmin:s=!1,isFavorites:d=!1,className:h}){const{lang:p}=(0,l.useBrowserEnv)(),m=(0,l.useViewer)(),f=u.isEdu(m.profileType);let g;switch(!0){case d:g=p.use("me_favorites");break;case t:g=i.firstName(e);break;default:g=i.name(e)}return r.createElement("div",{className:c()("PeerTitle",{"PeerTitle--vkAdmin":i.isVkAdministration(e.id)},h)},r.createElement("div",{className:"PeerTitle__title"},g),"Chat"!==e.kind&&"Contact"!==e.kind&&e.isVerified?r.createElement("span",{className:"PeerTitle__icon PeerTitle__verifiedIcon"},f&&"User"===e.kind?r.createElement(n.Icon16Education,{width:12,height:12}):r.createElement(a.Icon16Verified,null)):null,s&&r.createElement("span",{className:"PeerTitle__icon PeerTitle__adminIcon"},r.createElement(o.Icon12Favorite,null)))}))},827258:(e,t,s)=>{s.d(t,{Picker:()=>d});var r=s(667294),n=s(294184),a=s.n(n),o=(s(883061),s(760802));const i=new Map,d=({strategy:e="singular",onSelectionChange:t,searchRenderer:s,listRenderer:n,selection:d=i,items:c,total:l,search:u,prefetch:h,isLoading:p=!1,isPristine:m=!1,hasFailed:f=!1,checkDisabledItem:g,initialQuery:v,getItemId:C,className:_,onQueryChange:y,onLoadMore:k})=>{const[I,M]=(0,r.useState)(v);(0,r.useEffect)((()=>{null==h||h({query:I}),u({query:I,offset:0,count:50})}),[I]);const{toggleSelection:R,selection:S}=(0,o.usePicker)({strategy:e,selection:d});(0,r.useEffect)((()=>{t(S)}),[S]);const w=(0,r.useMemo)((()=>c.map((e=>{const t=C(e);return{id:t,item:e,selected:S.has(t),disabled:!!g&&g(e)}}))),[C,g,c,S]),b=k||(({offset:e,count:t})=>{u({offset:e,count:t,query:I})});return r.createElement("div",{className:a()("Picker",_)},r.createElement(s,{items:c,onQueryChange:e=>{M(e),y(e)},selection:S,onRemove:e=>{R({id:C(e),value:e})}}),r.createElement(n,{items:w,total:l,onItemSelection:R,loadMore:b,loading:p,pristine:m,failed:f}))}},760540:(e,t,s)=>{s.d(t,{PickerItem:()=>h});var r=s(434788),n=s(820224),a=s(667294),o=s(354943),i=s(856335),d=s(29157),c=s(294184),l=s.n(c),u=(s(669721),s(89131));const h=e=>{var{controlType:t="check",controlSide:s="left",selected:c,disabled:h,onSelection:p,children:m,className:f}=e,g=(0,n._)(e,["controlType","controlSide","selected","disabled","onSelection","children","className"]);const v=(0,a.useCallback)((()=>{h||p()}),[h,p]),C=(0,a.useMemo)((()=>{switch(t){case"arrow":return a.createElement(o.Icon24ChevronCompactRight,{className:"PickerItem__arrow"});case"check":return c?a.createElement(i.Icon20CheckCircleOn,null):a.createElement(d.Icon20CheckCircleOff,null);default:(0,u.exhaustivenessCheck)(t)}}),[t,c]),_=(0,a.useCallback)((e=>{"Enter"===e.key&&v()}),[v]);return a.createElement("div",(0,r._)({},g,{className:l()("PickerItem",`PickerItem--${s}`,{"PickerItem--disabled":h},{"PickerItem--selected":c},f),tabIndex:0,role:"checkbox","aria-checked":c,onClick:v,onKeyDown:_}),a.createElement("button",{type:"button",className:"PickerItem__button",tabIndex:-1},C),a.createElement("div",{className:"PickerItem__content"},m))}},684709:(e,t,s)=>{s.d(t,{PickerList:()=>c});var r=s(11010),n=s(434788),a=s(667294),o=s(24087),i=(s(466135),s(274061)),d=s(365691);const c=({items:e,total:t,loading:s,failed:c,pristine:l,onItemSelection:u,itemRenderer:h,itemHeight:p,loaderNode:m,emptyNode:f,errorNode:g,loadMore:v,header:C,footer:_})=>{const y=(0,a.useRef)(null),[k,I]=(0,a.useState)(null),M=(0,a.useRef)(null),R=(0,a.useRef)(null),S=(0,a.useRef)(null),[,w]=(0,a.useState)({}),b=null===t||t>e.length,E=(0,a.useCallback)((({index:e,style:t,data:{loaderNode:s,loading:r,items:o}})=>{const i=o[e];return i?a.createElement("div",{style:t,key:i.id,className:"PickerList__item"},a.createElement(h,(0,n._)({},i))):e===o.length&&r&&s?a.createElement("div",{style:t,className:"PickerList__item"},s):null}),[h]);(0,a.useEffect)((()=>{if(!k)return;R.current=k.offsetHeight;const e=new ResizeObserver((e=>{if(0===e.length)return;if(e.forEach((e=>{const t=e.contentRect;R.current&&(S.current=R.current),R.current=t.height})),!(S.current&&R.current&&M.current&&y.current))return;const t=S.current-R.current;y.current.scrollTo(M.current.scrollTop+t),w({})}));return e.observe(k),()=>e.disconnect()}),[k,M,y,w]);const U=(0,a.useCallback)((t=>!!e[t]),[e]),A=(0,a.useCallback)((0,r._)((function*(e,t){v({offset:e,count:t-e})})),[v]);if(0===(null==e?void 0:e.length))return a.createElement(a.Fragment,null,C,s?m:l?null:c?g:f||null,_);const P={loaderNode:m,loading:s,items:e.map((e=>(0,n._)({},e,{onSelection:u})))};return a.createElement("div",{ref:e=>I(e),className:"PickerList"},C,a.createElement("div",{className:"PickerList__container"},a.createElement(d.default,{isItemLoaded:U,loadMoreItems:A,itemCount:b?t||e.length+20:e.length},(({onItemsRendered:r,ref:n})=>a.createElement(o.default,{style:{width:"100%",height:"100%"}},(({scrollableNodeRef:o,contentNodeRef:d})=>(M.current=o.current,a.createElement(i.FixedSizeList,{ref:e=>{y.current=e,n(e)},direction:"ltr",onItemsRendered:r,height:R.current||0,width:"100%",overscanCount:25,itemSize:p,itemData:P,outerRef:o,className:"PickerList__list",innerRef:d,itemCount:null!==t?s?e.length+1:t:e.length+1},E))))))),_)}},740779:(e,t,s)=>{s.d(t,{SortableList:()=>a,useSortable:()=>i});var r=s(667294);const n=r.createContext(null),a=({children:e,items:t,disabled:s,onChange:a})=>{const[o,i]=(0,r.useState)(null),[d,c]=(0,r.useState)(null),l=(0,r.useMemo)((()=>o?t.indexOf(o):-1),[o,t]),u=(0,r.useMemo)((()=>({items:t,active:o,activeIndex:l,hover:d,disabled:!0===s,setActive:i,setHover:c,onChange:a})),[t,o,l,d,s,a]);return r.createElement(n.Provider,{value:u},e)};function o(e,t,s){return e>=t&&e<=s}function i({id:e,lockAxis:t}){const s=(0,r.useContext)(n);if(!s)throw new Error("Сортируемые элементы должны быть обёрнуты в SortableList");const{active:a,disabled:o,activeIndex:i,hover:c,items:l,setActive:u,setHover:h,onChange:p}=s,m=(0,r.useMemo)((()=>l.indexOf(e)),[e,l]),f=(0,r.useRef)(null),[g,v]=(0,r.useState)({transform:"translate(0, 0)"}),C=(0,r.useMemo)((()=>({"data-item-id":e})),[e]),_=(0,r.useCallback)((()=>{o||(u(e),v({pointerEvents:"none",touchAction:"none"}),document.body.style.overscrollBehavior="contain")}),[o,e,u]),y=(0,r.useCallback)((()=>{if(c){const t=[...l],s=t.indexOf(c.id);let r=s;r=1===(i<s?1:-1)?"top"===c.side?s-1:s:"top"===c.side?s:s-1,void 0!==e&&(t.splice(i,1),t.splice(r,0,e),null==p||p(t))}v({transform:"translate(0, 0)"}),u(null),h(null),document.body.style.overscrollBehavior="auto"}),[i,c,e,l,p,u,h]),k=(0,r.useCallback)((({shiftX:e,shiftY:s,originalEvent:r})=>{let n,o,i="";switch(t){case"x":i=`translateX(${e}px)`;break;case"y":i=`translateY(${s}px)`;break;default:i=`translate(${e}px, ${s}px)`}v({transform:i,pointerEvents:"none",touchAction:"none",position:"relative",zIndex:99999});const{touches:d}=r;d&&d[0]?(({clientX:n,clientY:o}=d[0]),r.preventDefault(),r.stopPropagation()):(n=r.clientX,o=r.clientY);const l=document.elementFromPoint(n,o);if(l){const e=l.closest("[data-item-id]"),t=(null==e?void 0:e.dataset.itemId)?parseInt(null==e?void 0:e.dataset.itemId):null;if(e&&null!==a&&a!==t){const s=e.getBoundingClientRect(),r=s.top+s.height/2<o?"bottom":"top";(null==c?void 0:c.id)===t&&(null==c?void 0:c.side)===r||h({id:t,side:r})}}}),[a,c,t,h]);return(0,r.useEffect)((()=>{if(null!==a){if(a!==e&&c&&f.current){const t=l.indexOf(e),s=l.indexOf(c.id),r=d(t,i,s,c.side,f.current.offsetHeight);v({transform:`translateY(${r}px)`,transition:"transform 150ms"})}}else v({transform:"translateY(0px)",transition:""})}),[a,i,c,e,l]),{index:m,setNodeRef:f,active:e===a,isDragging:null!==a,styles:g,attrs:C,disabled:o,onStart:_,onEnd:y,onMove:k}}const d=(e,t,s,r,n)=>{if(null===t||null===s||null===n||t===e)return 0;if(!(t>s?o(e,s,t):o(e,t,s)))return 0;if(1===(t<s?1:-1)){if("top"===r&&e<s)return-1*n;if("bottom"===r)return-1*n}else{if("bottom"===r&&e>s)return n;if("top"===r)return n}return 0}},545443:(e,t,s)=>{s.d(t,{Symbols:()=>n});s(516073);var r=s(667294);const n=()=>r.createElement("svg",{className:"Symbols"},r.createElement("defs",null,r.createElement("symbol",{id:"mePhone10"},r.createElement("path",{d:"M6.17 6.8c1.1-1.09 2.32-.5 3.3.33 1.15.97.26 2.7-1.08 2.83-1.82.24-3.72-.63-5.72-2.63-2-2-2.88-3.91-2.63-5.73C.16.27 1.91-.62 2.87.52c.82.98 1.41 2.2.32 3.3-.9.9-.16 1.55.64 2.35s1.45 1.53 2.34.64z"})),r.createElement("symbol",{id:"meExpand"},r.createElement("path",{d:"M15.7688 13.7067L11.906 10L15.7688 6.29326C16.0771 5.99741 16.0771 5.51774 15.7688 5.22189C15.4605 4.92604 14.9606 4.92604 14.6523 5.22189L10.2312 9.46431C9.92292 9.76017 9.92292 10.2398 10.2312 10.5357L14.6523 14.7781C14.9606 15.074 15.4605 15.074 15.7688 14.7781C16.0771 14.4823 16.0771 14.0026 15.7688 13.7067Z"}),r.createElement("path",{d:"M9.76877 13.7067L5.90596 10L9.76877 6.29326C10.0771 5.99741 10.0771 5.51774 9.76877 5.22189C9.46046 4.92604 8.96059 4.92604 8.65228 5.22189L4.23123 9.46431C3.92292 9.76017 3.92292 10.2398 4.23123 10.5357L8.65228 14.7781C8.96059 15.074 9.46046 15.074 9.76877 14.7781C10.0771 14.4823 10.0771 14.0026 9.76877 13.7067Z"})),r.createElement("symbol",{id:"meCake10"},r.createElement("path",{d:"M9.16667 8.07392C8.33947 8.29895 7.41292 8.1867 6.66667 7.73385C5.66596 8.34111 4.33404 8.34111 3.33333 7.73385C2.58708 8.1867 1.66053 8.29895 0.833333 8.07392V9.09126C0.833333 9.59314 1.20643 10 1.66667 10H8.33333C8.79357 10 9.16667 9.59314 9.16667 9.09126V8.07392Z"}),r.createElement("path",{d:"M0 5.00191C0 4.50003 0.373096 4.09317 0.833333 4.09317H9.16667C9.6269 4.09317 10 4.50003 10 5.00191C10 6.36503 9.16667 6.8194 8.33333 6.8194C7.08333 6.8194 6.66667 5.91065 6.66667 5.91065C6.66667 5.91065 6.25 6.8194 5 6.8194C3.75 6.8194 3.33333 5.91065 3.33333 5.91065C3.33333 5.91065 2.91667 6.8194 1.66667 6.8194C0.833333 6.8194 0 6.36503 0 5.00191Z"}),r.createElement("path",{d:"M7.83935 0.0492567C7.87234 -0.0164189 7.96099 -0.0164189 7.99398 0.0492567C8.38334 0.824332 8.75 1.16164 8.75 1.82131C8.75 2.32319 8.3769 2.73005 7.91667 2.73005C7.45643 2.73005 7.08333 2.32319 7.08333 1.82131C7.08333 1.16164 7.44999 0.824332 7.83935 0.0492567Z"}),r.createElement("path",{d:"M2.00602 0.0492567C2.03901 -0.0164189 2.12766 -0.0164189 2.16065 0.0492567C2.55001 0.824332 2.91667 1.16164 2.91667 1.82131C2.91667 2.32319 2.54357 2.73005 2.08333 2.73005C1.6231 2.73005 1.25 2.32319 1.25 1.82131C1.25 1.16164 1.61665 0.824332 2.00602 0.0492567Z"}),r.createElement("path",{d:"M4.92268 0.0492567C4.95568 -0.0164189 5.04432 -0.0164189 5.07732 0.0492567C5.46668 0.824332 5.83333 1.16164 5.83333 1.82131C5.83333 2.32319 5.46024 2.73005 5 2.73005C4.53976 2.73005 4.16667 2.32319 4.16667 1.82131C4.16667 1.16164 4.53332 0.824332 4.92268 0.0492567Z"}))),r.createElement("circle",{id:"mePeerFrameOffline20",cx:"10",cy:"10",r:"10"}),r.createElement("path",{id:"mePeerFrameMe24",d:"M20 10a12 12 0 10-9.9 9.9 7 7 0 019.9-9.9z"}),r.createElement("circle",{id:"mePeerFrameOffline24",cx:"12",cy:"12",r:"12"}),r.createElement("path",{id:"mePeerFrameOnline24",d:"M23.57 15.18A12.02 12.02 0 0012 0a12 12 0 103.18 23.57 6 6 0 018.4-8.4z"}),r.createElement("path",{id:"mePeerFrameMobile24",d:"M14.08 23.82a12 12 0 119.9-12.29 3.98 3.98 0 00-1.98-.53h-4a4 4 0 00-4 4v8c0 .28.03.56.08.82z"}),r.createElement("path",{id:"mePeerFrameMe24",d:"M23.84 13.95a12 12 0 10-9.9 9.9 7 7 0 019.9-9.9z"}),r.createElement("circle",{id:"mePeerFrameOffline32",cx:"16",cy:"16",r:"16"}),r.createElement("path",{id:"mePeerFrameOnline32",d:"M30.72 22.29a16 16 0 10-8.43 8.43 6 6 0 018.43-8.43z"}),r.createElement("path",{id:"mePeerFrameMobile32",d:"M21 31.2a16 16 0 1110.52-11.3A3.98 3.98 0 0029 19h-4a4 4 0 00-4 4v8.2z"}),r.createElement("path",{id:"mePeerFrameMe32",d:"M31.1 21.32a16 16 0 10-9.77 9.77 7 7 0 019.77-9.77z"}),r.createElement("path",{id:"mePeerFrameMe32c",d:"M18.1533 0.143651C17.449 0.0489165 16.7302 0 16 0C7.16344 0 0 7.16344 0 16C0 24.8366 7.16344 32 16 32C17.8656 32 19.6565 31.6807 21.3213 31.0938C20.4899 29.9426 20 28.5285 20 27C20 24.8923 20.9316 23.0021 22.4054 21.7188C17.0253 20.533 13 15.7366 13 10C13 5.91761 15.0386 2.31134 18.1533 0.143651ZM30.2451 20.796C30.5411 20.9512 30.8247 21.1269 31.0938 21.3213C31.2337 20.9244 31.3584 20.5204 31.4672 20.1099C31.0749 20.3614 30.6669 20.5907 30.2451 20.796Z"}),r.createElement("path",{id:"mePeerFrameMobile32c",d:"M18.1533 0.143651C17.449 0.0489165 16.7302 0 16 0C7.16344 0 0 7.16344 0 16C0 24.8366 7.16344 32 16 32C17.748 32 19.4305 31.7197 21.005 31.2016C21.0017 31.1348 21 31.0676 21 31V23C21 22.4411 21.1146 21.9089 21.3217 21.4257C16.4937 19.8727 13 15.3443 13 10C13 5.91761 15.0386 2.31134 18.1533 0.143651Z"}),r.createElement("path",{id:"mePeerFrameOffline32c",d:"M31.47 20.11A12 12 0 0118.16.14a16 16 0 1013.31 19.97z"}),r.createElement("path",{id:"mePeerFrameOnline32c",d:"M18.1533 0.143651C17.449 0.0489165 16.7302 0 16 0C7.16344 0 0 7.16344 0 16C0 24.8366 7.16344 32 16 32C18.2328 32 20.3588 31.5426 22.2893 30.7165C21.4819 29.6945 21 28.4035 21 27C21 24.8726 22.1072 23.0038 23.7767 21.9384C17.7239 21.3256 13 16.2145 13 10C13 5.91761 15.0386 2.31134 18.1533 0.143651ZM28.9655 21.3293C29.6052 21.551 30.1958 21.8779 30.7165 22.2893C31.0169 21.5873 31.2686 20.8594 31.4672 20.1099C30.6899 20.6082 29.8514 21.0192 28.9655 21.3293Z"}),r.createElement("circle",{id:"mePeerFrameOffline40",cx:"20",cy:"20",r:"20"}),r.createElement("path",{id:"mePeerFrameOnline40",d:"M29.29 37.72a20 20 0 118.43-8.43 5.99 5.99 0 10-8.43 8.43z"}),r.createElement("path",{id:"mePeerFrameMobile40",d:"M28.2 38.25a20 20 0 1110.78-11.92A3.99 3.99 0 0036 25h-4a4 4 0 00-4 4v8a4 4 0 00.2 1.25z"}),r.createElement("path",{id:"mePeerFrameMe40",d:"M28.31 38.2a20 20 0 119.89-9.89 7 7 0 10-9.89 9.89z"}),r.createElement("path",{id:"mePeerFrameMe40c",d:"M33 22c2.61 0 5.03-.83 7-2.25V20c0 2.97-.65 5.78-1.8 8.31a7 7 0 10-9.89 9.89A20 20 0 1125.38.73 12 12 0 0033 22z"}),r.createElement("path",{id:"mePeerFrameMobile40c",d:"M33 22c2.61 0 5.03-.83 7-2.25V20c0 2.21-.36 4.34-1.02 6.33A3.99 3.99 0 0036 25h-4a4 4 0 00-4 4v8a4 4 0 00.2 1.25A20 20 0 1125.38.73 12 12 0 0033 22z"}),r.createElement("path",{id:"mePeerFrameOffline40c",d:"M40 19.75A12 12 0 0125.38.73 20.02 20.02 0 000 20a20 20 0 1040-.25z"}),r.createElement("path",{id:"mePeerFrameOnline40c",d:"M33 22c2.61 0 5.03-.83 7-2.25V20c0 3.35-.83 6.51-2.28 9.29a5.99 5.99 0 10-8.43 8.43A20 20 0 1125.38.74 12 12 0 0033 22z"}),r.createElement("circle",{id:"mePeerFrameOffline44",cx:"22",cy:"22",r:"22"}),r.createElement("path",{id:"mePeerFrameOnline44",d:"M41.21 32.73a22 22 0 10-8.49 8.49 6 6 0 018.49-8.49z"}),r.createElement("path",{id:"mePeerFrameMobile44",d:"M31.13 42.02a22 22 0 1111.1-11.37A4 4 0 0039 29h-4a4 4 0 00-4 4v8c0 .35.05.7.13 1.02z"}),r.createElement("path",{id:"mePeerFrameMe44",d:"M41.7 31.81a22 22 0 10-9.89 9.89 7 7 0 019.89-9.89z"}),r.createElement("path",{id:"mePeerFrameOffline44c",d:"M43.97 20.77A12 12 0 0129.78 1.41a22 22 0 1014.19 19.36z"}),r.createElement("path",{id:"mePeerFrameOnline44c",d:"M29.78 1.41a22 22 0 102.95 39.8 6 6 0 018.49-8.49 21.9 21.9 0 002.75-11.95A12 12 0 0129.78 1.41z"}),r.createElement("path",{id:"mePeerFrameMobile44c",d:"M43.97 20.77A12 12 0 0129.78 1.41a22 22 0 101.35 40.6 4 4 0 01-.13-1.01v-8a4 4 0 014-4h4a4 4 0 013.24 1.65 21.93 21.93 0 001.73-9.88z"}),r.createElement("path",{id:"mePeerFrameMe44c",d:"M29.78 1.41A22 22 0 1031.8 41.7a7 7 0 019.89-9.89 21.91 21.91 0 002.27-11.03A12 12 0 0129.78 1.41z"}),r.createElement("circle",{id:"mePeerFrameOffline46",cx:"23",cy:"23",r:"23"}),r.createElement("path",{id:"mePeerFrameOnline46",d:"M42.94 34.47a23 23 0 10-8.47 8.47 6 6 0 018.47-8.47z"}),r.createElement("path",{id:"mePeerFrameMobile46",d:"M33.06 43.69A23 23 0 1144 32.37 3.99 3.99 0 0041 31h-4a4 4 0 00-4 4v8c0 .24.02.47.06.69z"}),r.createElement("path",{id:"mePeerFrameMe46",d:"M43.43 33.58a23 23 0 10-9.85 9.85 7 7 0 019.85-9.85z"}),r.createElement("path",{id:"mePeerFrameOffline46c",d:"M45.9 20.82A12 12 0 0131.5 1.62a23 23 0 1014.39 19.2z"}),r.createElement("path",{id:"mePeerFrameOnline46c",d:"M31.5 1.63a23 23 0 102.96 41.31 6 6 0 018.47-8.47 22.9 22.9 0 002.97-13.65A12 12 0 0131.5 1.62z"}),r.createElement("path",{id:"mePeerFrameMobile46c",d:"M45.9 20.82A12 12 0 0131.5 1.62a23 23 0 101.55 42.06A4.03 4.03 0 0133 43v-8a4 4 0 014-4h4c1.2 0 2.28.53 3.01 1.37a22.92 22.92 0 001.89-11.55z"}),r.createElement("path",{id:"mePeerFrameMe46c",d:"M31.5 1.63a23 23 0 102.07 41.8 7 7 0 019.85-9.85 22.9 22.9 0 002.48-12.76A12 12 0 0131.5 1.62z"}),r.createElement("circle",{id:"mePeerFrameOffline72",cx:"37",cy:"37",r:"37"}),r.createElement("circle",{id:"mePeerFrameOffline92",cx:"46",cy:"46",r:"46"}),r.createElement("circle",{id:"mePeerFrameOffline96",cx:"48",cy:"48",r:"48"}),r.createElement("path",{id:"meUsersStack16",d:"M14 2.715A8 8 180 008 0 8 8 180 008 16 8 8 180 0014 13.285 8 8 180 0114 2.715"}),r.createElement("path",{id:"meUsersStack18",d:"M 16 14 A 9 9 90 0 1 9 18 A 9 9 90 0 1 9 0 A 9 9 90 0 1 16 4 A 9 9 90 0 0 16 14"}),r.createElement("path",{id:"meUsersStack24",d:"M22 18.6A12 12 0 0112 24 12 12 0 0112 0 12 12 0 0122 5.4 12 12 0 0022 18.6"}),r.createElement("path",{id:"meUsersStack32",d:"M30 23.8A16 16 0 0116 32 16 16 0 0116 0 16 16 0 0130 8.3 16 16 0 0030 23.8"}),r.createElement("path",{id:"meUsersStack40",d:"M37.5 29.8A20 20 90 0120 40 20 20 90 0120 0 20 20 90 0137.5 10.4 20 20 90 0037.5 29.8"}),r.createElement("path",{id:"meUsersStack44",d:"M41.3 32.7A22 22 90 0122 44 22 22 90 0122 0 22 22 90 0141.3 11.4 22 22 90 0041.3 32.7"}),r.createElement("path",{id:"meUsersStack46",d:"M43.1 34.2A23 23 90 0123 46 23 23 90 0123 0 23 23 90 0143.1 11.9 23 23 90 0043.1 34.2"}))},546428:(e,t,s)=>{s.d(t,{onElementKeyDownFactory:()=>n});var r=s(65970);const n=(e,t=!1)=>s=>{const n=(0,r.getKeyCombo)(s);!t&&(0,r.isGlobalKeyCombo)(n)||(0,r.isModuleKeyCombo)(n)&&(s.stopPropagation(),e(n,s.preventDefault.bind(s)))}},709646:(e,t,s)=>{s.d(t,{VIEWER_DEFAULT_PUSH_SETTINGS:()=>r,hasEduAccount:()=>a,isEdu:()=>n});const r={userConvo:{isEnabled:!0,withMessageText:!0},chatConvo:{isEnabled:!0,withMessageText:!0},groupConvo:{isEnabled:!0,withMessageText:!0},mention:"every-mention",messageReaction:{isEnabled:!0,withMessageText:!0}};function n(e){return"edu"===e}function a(e){return e.accounts.some((e=>n(e.profileType)))}},698057:(e,t,s)=>{s.d(t,{fromApiChatMembers:()=>n});var r=s(96190);function n(e){return e.reduce(((e,t)=>{const s=r.resolveId(t.member_id);if(!r.isUserPeerId(s)&&!r.isGroupPeerId(s)&&!r.isContactPeerId(s))return e;const n={isAdmin:Boolean(t.is_admin),canKick:Boolean(t.can_kick),isMessageRequest:Boolean(t.is_message_request),peerId:s};return t.is_message_request&&t.request_date&&(n.requestDate=1e3*t.request_date),e.members.push(n),r.isContactPeerId(s)||(t.is_admin&&e.adminIds.push(s),t.is_owner&&(e.ownerId=s)),e}),{members:[],adminIds:[]})}},851828:(e,t,s)=>{s.d(t,{fromApiComment:()=>u});var r=s(434788),n=s(866358),a=s(96190),o=s(86144),i=s(839963),d=s(434425),c=s(504698),l=s(694788);function u(e){var t,s,h,p,m;const f={cmid:n.resolveCmid(e.id),postCmid:o.resolveCmid(e.post_id||0),channelId:i.resolveId(e.owner_id||0),canEdit:Boolean(e.can_edit),rootCmid:(null==(t=e.parents_stack)?void 0:t[0])?n.resolveCmid(e.parents_stack[0]):void 0,replies:{count:(null==e||null==(s=e.thread)?void 0:s.count)||0,history:((null==(h=e.thread)?void 0:h.items)||[]).map(u)},sentAt:1e3*e.date};return e.deleted?(0,r._)({kind:"Deleted"},f):(0,r._)({kind:"Normal"},f,{chunks:e.text?c.fromServerText(e.text):[],attaches:(0,l.fromApiWallReplyAttach)(e.attachments||[]),likes:{count:(null==(p=e.likes)?void 0:p.count)||0,reactionId:Boolean(null==(m=e.likes)?void 0:m.user_likes)?d.resolveId(0):void 0,availableReactionIds:[],peerIds:new Set},peerId:a.resolveId(e.from_id)})}},597990:(e,t,s)=>{s.d(t,{fromApiProfileType:()=>o,fromApiViewerAccount:()=>n,fromApiViewerProfileInfo:()=>a});var r=s(96190);function n(e){var t,s;return{id:r.resolveRealId("User",e.id),profileType:o(e.profile_type),firstName:null!=(t=e.first_name)?t:"",lastName:null!=(s=e.last_name)?s:"",photo:e.photo_100}}function a(e){const{screen_name:t,phone:s,id:n,photo_200:a,first_name:o,last_name:i}=e;return{screenName:t,phoneNumber:s,id:r.resolveRealId("User",n),avatarPhoto:a,firstName:o,lastName:i}}function o(e){var t;return null!=(t={0:"normal",2:"edu"}[null!=e?e:0])?t:"normal"}},906e3:(e,t,s)=>{s.d(t,{Engine:()=>i});var r=s(11010),n=s(434788),a=s(89131),o=s(95154);class i{constructor(e,t){this.isWorking=!1,this.empty=()=>({kind:"Buffer",buffer:[]}),this.queued=this.empty(),this.connect=e=>{if(this.isWorking)return;this.isWorking=!0,this.queued=this.empty();var t=this;(0,r._)((function*(){for(;t.isWorking;){if("Buffer"===t.queued.kind){if(t.queued.buffer.reduce(((e,t)=>"Batch"===t.kind?e+t.updates.length:e+1),0)>=1e3)return t.isWorking=!1,void t.dispatch({kind:"Failure"})}try{const s=`https://${e.server}?version=${t.version}&mode=682`,r=new AbortController,a=setTimeout((()=>r.abort()),3e4),o=yield t.request(s,{act:"a_check",key:e.key,ts:e.ts,wait:25},r.signal).finally((()=>clearTimeout(a)));if("failed"in o)throw o;e.ts=o.ts,e.pts=o.pts,t.dispatch((0,n._)({kind:"Batch"},o))}catch(e){t.logger.info("[ENGINE] Error",e),t.isWorking=!1,t.dispatch({kind:"Failure"})}}}))().catch((e=>{this.isWorking=!1,this.logger.error("[ENGINE] Drain error",e)})),this.logger.info("[ENGINE] Connected")},this.dispatch=e=>{if("Callback"===this.queued.kind)return this.queued.resolve(e),void(this.queued=this.empty());switch(e.kind){case"Failure":return void this.queued.buffer.push(e);case"Batch":{const t=this.queued.buffer[this.queued.buffer.length-1];return void(t&&"Failure"!==t.kind&&t.pts===e.pts?(t.ts=e.ts,t.pts=e.pts,t.updates.push(...e.updates)):this.queued.buffer.push(e))}default:(0,a.exhaustivenessCheck)(e)}},this.poll=()=>{if("Callback"===this.queued.kind)return this.queued.reject("Engine.poll вызван повторно до обработки первого вызова!"),new Promise(((e,t)=>{this.queued={kind:"Callback",resolve:e,reject:t}}));const e=this.queued.buffer.shift();return e?Promise.resolve(e):this.isWorking?new Promise(((e,t)=>{this.queued={kind:"Callback",resolve:e,reject:t}})):Promise.reject("Engine.connect еще не был вызван!")},this.isConnected=()=>this.isWorking,this.logger=e,this.request=t,this.version=o.ENGINE_VERSION}}},302278:(e,t,s)=>{s.d(t,{EventEmitter:()=>r});class r{subscribe(e,t){var s;Array.isArray(this.subscriptions[e])?null==(s=this.subscriptions[e])||s.push(t):this.subscriptions[e]=[t]}unsubscribe(e,t){var s;Array.isArray(this.subscriptions[e])&&(this.subscriptions[e]=(null==(s=this.subscriptions[e])?void 0:s.filter((e=>e!==t)))||[])}emit(e,t){var s;Array.isArray(this.subscriptions[e])&&(null==(s=this.subscriptions[e])||s.forEach((e=>e(t))))}constructor(){this.subscriptions={}}}},927411:(e,t,s)=>{var r;s.d(t,{IApi:()=>r}),function(e){e.resolveTrackId=function(e,t){if(0===t.length)throw new Error("Нельзя отдавать пустую строку в IApi.resolveTrackId");return`${e}-${t}`};class t extends Error{constructor(e){super(e),Object.setPrototypeOf(this,t.prototype)}}e.TimeoutError=t;class s extends Error{constructor(e){super(e),Object.setPrototypeOf(this,s.prototype)}}e.AbortError=s;class r extends Error{constructor(e,t,s){super(t),this.code=e,this.payload=s,Object.setPrototypeOf(this,r.prototype)}}e.RequestError=r;class n extends Error{constructor(e){super(String(e[0].error_code)),this.list=e.map((e=>({code:e.error_code,message:e.error_msg}))),Object.setPrototypeOf(this,n.prototype)}}e.ExecuteErrors=n}(r||(r={}))},851369:(e,t,s)=>{var r,n;s.d(t,{PlayerEventTypes:()=>r,VideoMessagePlayerEventTypes:()=>n}),function(e){e.STATE_UPDATED="stateupdated",e.START_NEW_TRACK="startNewTrack",e.START_NEXT_TRACK="startNextTrack",e.START_PREV_TRACK="startPrevTrack",e.RESUME_TRACK="resumeTrack",e.START_NEXT_TRACK_AUTOMATICALLY="startNextTrackAutomatically",e.STOP_CURRENT_TRACK_AUTOMATICALLY="stopCurrentTrackAutomatically",e.PLAYLIST_ENDED="playlistEnded",e.STOP_CURRENT_TRACK_BEFORE_STARTING_NEW_TRACK="stopCurrentTrackBeforeStartingNewTrack",e.STOP_CURRENT_TRACK_BY_ERROR="stopCurrentTrackByError",e.PAUSE_CURRENT_TRACK="pauseCurrentTrack"}(r||(r={})),function(e){e.SCROLL_TO_MESSAGE="scrollToMessage",e.STATE_UPDATED="stateUpdated"}(n||(n={}))},166916:(e,t,s)=>{var r;s.d(t,{IUploader:()=>r}),function(e){class t extends Error{constructor(e="Aborted"){super(e),Object.setPrototypeOf(this,t.prototype)}}e.AbortError=t;class s extends Error{constructor(e="Timeout"){super(e),Object.setPrototypeOf(this,s.prototype)}}e.TimeoutError=s}(r||(r={}))},790351:(e,t,s)=>{s.d(t,{AUDIO_TYPES:()=>m,IMAGE_TYPES:()=>h,Uploader:()=>I,VIDEO_TYPES:()=>p,areAudios:()=>U,areImages:()=>S,areVideos:()=>b,isChannelUpload:()=>x,isConvoUpload:()=>O,isImage:()=>R,preloadImage:()=>A});var r=s(11010),n=s(434788),a=s(694788),o=s(166916),i=s(89131),d=s(95154),c=s(96190),l=s(839963),u=s(453934);const h=["image/png","image/gif","image/jpeg","image/webp"],p=["video/x-msvideo","video/mp4","video/mpeg","video/3gpp","video/quicktime","video/x-flv","video/x-ms-wmv"],m=["audio/mp3","audio/ogg","audio/wav","audio/mpeg","audio/flac","audio/aac","audio/m4a","audio/mp4","audio/x-m4a"],f=e=>"image"===e.kind,g=e=>"video"===e.kind,v=e=>"audio"===e.kind,C=e=>"doc"===e.kind;class _{getUploadServer(e,t){let s=this.cache.get(e);if(!s)return s=t().then((t=>(this.cache.set(e,{url:t,timestamp:Date.now()}),t))),this.cache.set(e,s),s;if(s instanceof Promise)return s;return this.validateCache(s.timestamp)?Promise.resolve(s.url):(this.cache.delete(e),this.getUploadServer(e,t))}dropCache(){0!==this.cache.size&&Array.from(this.cache.entries()).forEach((([e,t])=>{if(t instanceof Promise)return;this.validateCache(t.timestamp)||this.cache.delete(e)}))}validateCache(e){return Date.now()-e<=5e3}constructor(){this.cache=new Map,setInterval((()=>{this.dropCache.call(this)}),6e4)}}class y{uploadImage(e,t){var s=this;return(0,r._)((function*(){const r={peer_id:t.viewerId,group_id:t.groupId&&c.toRealId(t.groupId),upload_v2:0},n=()=>s.api.fetch("photos.getMessagesUploadServer",r).then((({upload_url:e})=>e)),o=new FormData;return o.append("photo",e.file),s.uploadRequest((()=>s.photosUploadUrlCache.getUploadServer(JSON.stringify(r),n)),o,e.trackId,(({data:{server:e,hash:t,photo:r}})=>s.api.fetch("photos.saveMessagesPhoto",{server:e,hash:t,photo:r}).then((e=>{if(0===e.length||void 0===e[0])throw new Error("Метод photos.saveMessagesPhoto не вернул фотографию");const t=(0,a.fromApiPhoto)(e[0]);if(void 0===t)throw new Error("Не удалось конвертировать фотографию с сервера");return t}))))}))()}uploadVideo(e,t){var s=this;return(0,r._)((function*(){const r={target:t,preview:1,no_comments:1},n=new FormData;return n.append("video_file",e.file),s.uploadRequest((()=>s.api.fetch("video.save",r).then((({upload_url:e})=>{if(!e)throw new Error("В методе video.save не вернулся upload_url");return e}))),n,e.trackId,(({data:{video_id:e,owner_id:t}})=>Promise.resolve({kind:"Video",id:e,ownerId:t,image:[{url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAA1JREFUGFdjYGBg+A8AAQQBAHAgZQsAAAAASUVORK5CYII=",width:1,height:1}],views:0})))}))()}uploadAudio(e){var t=this;return(0,r._)((function*(){const s={},r=new FormData;return r.append("file",e.file),t.uploadRequest((()=>t.api.fetch("audio.getUploadServer",s).then((({upload_url:e})=>e))),r,e.trackId,(({data:{server:e,audio:s,hash:r}})=>t.api.fetch("audio.save",{server:e,audio:s,hash:r}).then((e=>(0,a.fromApiAudio)(e)))))}))()}uploadDoc(e){var t=this;return(0,r._)((function*(){const s=()=>t.api.fetch("docs.getUploadServer",{}).then((({upload_url:e})=>e)),r=new FormData;return r.append("file",e.file),t.uploadRequest((()=>t.docsUploadUrlCache.getUploadServer("docsUploadServer",s)),r,e.trackId,(({data:{file:e}})=>t.api.fetch("docs.save",{file:e}).then((e=>{if(!e.doc)throw new Error("Метод doc.save не вернул документ");const t=(0,a.fromApiDoc)(e.doc);if(!t)throw new Error("Не удалось конвертировать документ (нет поля url)");return t}))))}))()}uploadWallDoc(e,t){var s=this;return(0,r._)((function*(){const t={group_id:0},r=()=>s.api.fetch("docs.getWallUploadServer",t).then((({upload_url:e})=>e)),n=new FormData;return n.append("file",e.file),s.uploadRequest((()=>s.wallDocsUploadUrlCache.getUploadServer(JSON.stringify(t),r)),n,e.trackId,(({data:{file:e}})=>s.api.fetch("docs.save",{file:e,group_id:0}).then((e=>{if(!e.doc)throw new Error("Метод doc.save не вернул документ");const t=(0,a.fromApiDoc)(e.doc);if(!t)throw new Error("Не удалось конвертировать документ (нет поля url)");return t}))))}))()}uploadVoice(e,t){var s=this;return(0,r._)((function*(){const r={type:"audio_message",peer_id:t.targetPeerId},n=new FormData;return n.append("file",e.file),s.uploadRequest((()=>s.api.fetch("docs.getMessagesUploadServer",r).then((({upload_url:e})=>e))),n,e.trackId,(({data:{file:e}})=>s.api.fetch("docs.save",{file:e}).then((e=>{if(!e.audio_message)throw new Error("Метод doc.save не вернул аудиосообщение");return(0,a.fromApiVoice)(e.audio_message)}))))}))()}uploadChatPhoto(e,t){var s=this;return(0,r._)((function*(){if(!t.targetPeerId||!c.isChatPeerId(t.targetPeerId))throw new Error("Для обновления аватара чата targetPeerId обязательно должен быть ChatId");const r=yield(n=e,new Promise((e=>{const t=new Image,s=URL.createObjectURL(n.file);t.onload=()=>{const s=Math.min(t.width,t.height),r=Math.floor((t.width-s)/2),n=Math.floor((t.height-s)/2);e({x:r,y:n,width:s})},t.src=s})));var n;const a={chat_id:c.toRealId(t.targetPeerId),crop_x:r.x,crop_y:r.y,crop_width:r.width},o=new FormData;return o.append("photo",e.file),s.uploadRequest((()=>s.api.fetch("photos.getChatUploadServer",a).then((({upload_url:e})=>e))),o,e.trackId,(({data:{response:e}})=>s.api.fetch("messages.setChatPhoto",{file:e,user_id:c.toRealId(t.viewerId)}).then((()=>{}))))}))()}uploadOwnerPhoto(e,t){var s=this;return(0,r._)((function*(){const r={owner_id:t.viewerId},n=new FormData;return n.append("photo",e.file),s.uploadRequest((()=>s.api.fetch("photos.getOwnerPhotoUploadServer",r).then((({upload_url:e})=>e))),n,e.trackId,(({data:{hash:e,photo:r,server:n}})=>s.api.fetch("photos.saveOwnerPhoto",{owner_id:t.viewerId,server:n,hash:e,photo:r}).then((()=>{}))))}))()}uploadWallImage(e,t){var s=this;return(0,r._)((function*(){const r={group_id:l.toRealGroupId(t.targetPeerId),upload_v2:0},n=()=>s.api.fetch("photos.getWallUploadServer",r).then((({upload_url:e})=>e)),o=new FormData;return o.append("photo",e.file),s.uploadRequest((()=>s.wallPhotosUploadUrlCache.getUploadServer(JSON.stringify(r),n)),o,e.trackId,(({data:{server:e,hash:r,photo:n}})=>s.api.fetch("photos.saveWallPhoto",{group_id:l.toRealGroupId(t.targetPeerId),server:e,hash:r,photo:n}).then((e=>{if(0===e.length||void 0===e[0])throw new Error("Метод photos.saveWallPhoto не вернул фотографию");const t=(0,a.fromApiPhoto)(e[0]);if(void 0===t)throw new Error("Не удалось конвертировать фотографию с сервера");return t}))))}))()}convoUpload(e,t){var s=this;return(0,r._)((function*(){return f(e)?s.uploadImage(e,t):g(e)?s.uploadVideo(e,"messages"):v(e)?s.uploadAudio(e):C(e)?s.uploadDoc(e):"voice"===e.kind?s.uploadVoice(e,t):(e=>"chat-photo"===e.kind)(e)?s.uploadChatPhoto(e,t):(e=>"owner-photo"===e.kind)(e)?s.uploadOwnerPhoto(e,t):Promise.reject()}))()}channelsUpload(e,t){var s=this;return(0,r._)((function*(){return f(e)?s.uploadWallImage(e,t):g(e)?s.uploadVideo(e,"wall"):v(e)?s.uploadAudio(e):C(e)?s.uploadWallDoc(e,t):Promise.reject()}))()}upload(e,t){var s=this;return(0,r._)((function*(){return q(t)?s.channelsUpload(e,t):function(e){return!q(e)}(t)?s.convoUpload(e,t):Promise.reject()}))()}uploadRequest(e,t,s,n){const a=s,i=new AbortController;var d=this;const c=(0,r._)((function*(){return function(e,t,s={}){return new Promise(((r,n)=>{const{method:a="POST",signal:i,onUploadProgress:d,headers:c={},timeout:l}=s;if(null==i?void 0:i.aborted)return n(new o.IUploader.AbortError);const u=new XMLHttpRequest,h=()=>u.abort();i&&(i.addEventListener("abort",h),u.addEventListener("readystatechange",(()=>{const{readyState:e}=u;e===L&&i.removeEventListener("abort",h)}))),u.addEventListener("abort",(()=>{n(new o.IUploader.AbortError)})),u.addEventListener("error",n),u.addEventListener("timeout",(()=>{n(new o.IUploader.TimeoutError)})),u.upload.addEventListener("progress",(e=>{e.lengthComputable&&(null==d||d(e))})),u.addEventListener("loadend",(()=>{const{readyState:e,status:t,responseText:s}=u;let a;try{a=JSON.parse(s)}catch(e){return n(e)}return e===L&&t===D?r({data:a}):n(a)})),u.open(a,e,!0),Object.entries(c).forEach((([e,t])=>{u.setRequestHeader(e,t)})),l&&(u.timeout=l),u.send(t)}))}(yield e(),t,{signal:i.signal,timeout:d.requestTimeout,headers:{Accept:"application/json, text/plain, */*"},onUploadProgress:e=>{d.emitter.emit(a,{loaded:e.loaded,total:e.total})}}).then((e=>(d.emitter.removeListener(a),n(e)))).then((e=>(d.release(),e))).catch((e=>(d.release(),Promise.reject(e))))}));return this.lock()?{abort:()=>i.abort(),trackId:s,response:c()}:{abort:()=>i.abort(),trackId:s,response:new Promise(((e,t)=>{this.waiting.push((()=>c().then(e).catch(t)))}))}}trackProgress(e,t){this.emitter.addListener(e,t)}constructor(e){this.emitter=new M,this.requestTimeout=0,this.freeResources=5,this.waiting=[],this.photosUploadUrlCache=new _,this.wallPhotosUploadUrlCache=new _,this.docsUploadUrlCache=new _,this.wallDocsUploadUrlCache=new _,this.lock=()=>0!==this.freeResources&&(this.freeResources=Math.max(this.freeResources-1,0),!0),this.release=()=>{setTimeout((()=>{this.freeResources=Math.min(this.freeResources+1,5);const e=this.waiting.shift();e&&e()}),d.API_RATE_LIMIT_WINDOW+50)},this.api=e}}class k{subscribe(e,t){return this.emitter.addListener(e,t),()=>{this.emitter.removeListener(e)}}get(e){return this.attaches.get(e)}filterMissing(e){return e.filter((e=>!this.attaches.has(e)))}update(e,t){const s=this.attaches.get(e),r="function"==typeof t?t(s):t;r&&(this.attaches.set(e,r),this.emitter.emit(e,r))}remove(e){new Set(e).forEach((e=>{this.attaches.delete(e),this.emitter.removeListener(e)}))}constructor(){this.attaches=new Map,this.emitter=new M}}class I extends y{uploadFiles(e,t,s,r={}){e.forEach((e=>{this.toUploaderFileInfo(e,t).then((e=>{this.doUpload(e,s,r)})).catch((()=>{null==r.onError||r.onError()}))}))}abortUpload(e){const t=this.uploads.get(e);t&&(t.process.abort(),null==t.handlers.onUploadAbort||t.handlers.onUploadAbort(e),this.uploads.delete(e));const s=this.failedUploads.get(e);s&&(null==s.handlers.onUploadAbort||s.handlers.onUploadAbort(e),this.failedUploads.delete(e)),this.state.remove([e])}retryUpload(e){const t=this.failedUploads.get(e);if(t){this.failedUploads.delete(e);const{file:s,messengerData:r,handlers:a}=t;this.doUpload(s,r,a),this.state.update(s.trackId,(e=>{if(e)return(0,n._)({},e,{error:!1,abortable:!1})}))}}getOrphans(e){return this.state.filterMissing(e)}subscribe(e,t){if(0===e.length)return()=>{};t(this.getState(e));const s=e.map((s=>this.state.subscribe(s,(()=>{t(this.getState(e))}))));return t=>{s.forEach((e=>e())),t(e)}}getState(e){if(0===e.length)return{};const t=e.reduce(((e,t)=>{const s=this.state.get(t);return s&&e.push(s),e}),[]);return this.buildOptimisticAttachments(t)}doUpload(e,t,s){const{trackId:r}=e;null==s.onUploadStart||s.onUploadStart([r]),this.upload(e,t).then((e=>(this.uploads.set(r,{process:e,handlers:s}),this.trackProgress(r,(({loaded:e,total:t})=>this.updateAttachProgress(r,{loaded:e,total:t,error:!1,abortable:e!==t},s))),Promise.resolve(e.response).then((e=>{const t=this.modifyUploadedAttach(r,e),n=new Map(t?[[r,t]]:[]);null==s.onUploadFinish||s.onUploadFinish(n),this.state.remove([r])})).catch((e=>e instanceof o.IUploader.AbortError?Promise.resolve():Promise.reject(e))).finally((()=>{this.uploads.delete(r)}))))).catch((n=>{console.error("[UPLOADER] Ошибка загрузки",n),null==s.onError||s.onError(),this.failedUploads.set(r,{file:e,messengerData:t,handlers:s}),this.updateAttachProgress.call(this,r,{loaded:0,total:0,error:!0,abortable:!1},s)}))}toUploaderFileInfo(e,{asFiles:t,asVoice:s,asChatPhoto:r,asOwnerPhoto:n}){if(!(e instanceof File)){if(!s)throw new Error("Загрузить аудиосообщения можно только с флагом asVoice");const{blob:t,duration:r,waveform:n}=e,a=new File([t],"voice_recording",{type:"audio/ogg"}),o=I.toFileInfo(a,"voice");return function(e,t,s,r){return Promise.resolve({kind:"OptimisticVoice",id:e.trackId,blob:t,duration:s,waveform:r,loaded:0,total:e.file.size})}(o,t,r,n).then((e=>(this.state.update(o.trackId,e),o)))}const a=e;if(r){const e=I.toFileInfo(a,"chat-photo");return Promise.resolve(e)}if(n){const e=I.toFileInfo(a,"owner-photo");return Promise.resolve(e)}if(!t&&R(a)){const e=I.toFileInfo(a,"image");return function(e){return T.apply(this,arguments)}(e).then((t=>(this.state.update(e.trackId,t),e)))}if(!t&&w(a)){const e=I.toFileInfo(a,"video");return function(e){return N.apply(this,arguments)}(e).then((t=>(this.state.update(e.trackId,t),e)))}if(!t&&E(a)){const e=I.toFileInfo(a,"audio");return(o=e,new Promise((e=>{const t=new Audio,s=URL.createObjectURL(o.file);t.addEventListener("loadedmetadata",(()=>{e({kind:"OptimisticAudio",id:o.trackId,duration:t.duration,artist:"",title:o.file.name,loaded:0,total:o.file.size})})),t.src=s}))).then((t=>(this.state.update(e.trackId,t),e)))}var o;const i=I.toFileInfo(a,"doc");return function(e){return F.apply(this,arguments)}(i).then((e=>(this.state.update(i.trackId,e),i)))}modifyUploadedAttach(e,t){if(!t)return null;const s=this.state.get(e);let r=t;return"Video"===t.kind&&"OptimisticVideo"===(null==s?void 0:s.kind)&&s&&(r=(0,n._)({},t,{duration:s.duration,image:[s.image]})),r}updateAttachProgress(e,t,{onUploadProgressUpdate:s}){this.state.update(e,(e=>{if(e){switch(e.kind){case"OptimisticPhoto":null==s||s("photo");break;case"OptimisticVideo":null==s||s("video");break;case"OptimisticDoc":null==s||s("file")}return(0,n._)({},e,t)}}))}buildOptimisticAttachments(e){return e.reduce(((e,t)=>{const s=[],r=[],n=[],a=[];switch(t.kind){case"OptimisticPhoto":s.push(t);break;case"OptimisticVideo":r.push(t);break;case"OptimisticAudio":n.push(t);break;case"OptimisticDoc":a.push(t);break;case"OptimisticVoice":e.voice=t}return s.length&&(e.photos=[...e.photos||[],...s]),r.length&&(e.videos=[...e.videos||[],...r]),n.length&&(e.audios=[...e.audios||[],...n]),a.length&&(e.docs=[...e.docs||[],...a]),e}),{})}static clearOptimisticAttachments(e,t){t.forEach((t=>{if("photos"in e){if(!e.photos)return;const s=(0,i.toNonEmpty)(e.photos.filter((({id:e})=>e!==t)));s?e.photos=s:delete e.photos}if("videos"in e){if(!e.videos)return;const s=(0,i.toNonEmpty)(e.videos.filter((({id:e})=>e!==t)));s?e.videos=s:delete e.videos}if("audios"in e){if(!e.audios)return;const s=(0,i.toNonEmpty)(e.audios.filter((({id:e})=>e!==t)));s?e.audios=s:delete e.audios}if("docs"in e){if(!e.docs)return;const s=(0,i.toNonEmpty)(e.docs.filter((({id:e})=>e!==t)));s?e.docs=s:delete e.docs}"voice"in e&&delete e.voice}))}static buildAttachments(e){return e.reduce(((e,t)=>(0,u.produce)(e,(s=>{let r=null,n=null,a=null,o=null;switch(t.kind){case"Photo":r=(0,i.toNonEmpty)([t]);break;case"Video":n=(0,i.toNonEmpty)([t]);break;case"Audio":a=(0,i.toNonEmpty)([t]);break;case"Doc":o=(0,i.toNonEmpty)([t]);break;case"Voice":s.voice=t}(null==r?void 0:r.length)&&(s.photos=[...e.photos||[],...r]),(null==n?void 0:n.length)&&(s.videos=[...e.videos||[],...n]),(null==a?void 0:a.length)&&(s.audios=[...e.audios||[],...a]),(null==o?void 0:o.length)&&(s.docs=[...e.docs||[],...o])}))),{})}static hash(){return Math.floor(1e8*Math.random()+1e8).toString(16)}static resolveTrackId(e,t){if(0===t.length)throw new Error("Нельзя отдавать пустую строку в Uploader.resolveTrackId");return`${e}-${t}`}static toFileInfo(e,t){switch(t){case"image":return{kind:"image",trackId:I.resolveTrackId("image",I.hash()),file:e};case"video":return{kind:"video",trackId:I.resolveTrackId("video",I.hash()),file:e};case"audio":return{kind:"audio",trackId:I.resolveTrackId("audio",I.hash()),file:e};case"doc":return{kind:"doc",trackId:I.resolveTrackId("doc",I.hash()),file:e};case"voice":return{kind:"voice",trackId:I.resolveTrackId("voice",I.hash()),file:e};case"chat-photo":return{kind:"chat-photo",trackId:I.resolveTrackId("chat-photo",I.hash()),file:e};case"owner-photo":return{kind:"owner-photo",trackId:I.resolveTrackId("owner-photo",I.hash()),file:e};default:(0,i.exhaustivenessCheck)(t)}}constructor(...e){super(...e),this.uploads=new Map,this.failedUploads=new Map,this.state=new k}}class M{addListener(e,t){this.map.set(e,[...this.map.get(e)||[],t])}removeListener(e){this.map.delete(e)}emit(e,t){var s;null==(s=this.map.get(e))||s.forEach((e=>e(t)))}constructor(){this.map=new Map}}function R(e){return!(e instanceof DataTransferItem&&"file"!==e.kind)&&Boolean(e.type&&h.includes(e.type))}function S(e){return e.every(R)}function w(e){return!(e instanceof DataTransferItem&&"file"!==e.kind)&&Boolean(e.type&&p.includes(e.type))}function b(e){return e.every(w)}function E(e){return!(e instanceof DataTransferItem&&"file"!==e.kind)&&Boolean(e.type&&m.includes(e.type))}function U(e){return e.every(E)}function A(e){const t=URL.createObjectURL(e);return new Promise(((e,s)=>{const r=new Image;r.onload=()=>{e({url:t,width:r.width,height:r.height})},r.onerror=s,r.src=t}))}function P(e){return new Promise(((t,s)=>{const r=document.createElement("video");r.volume=0,r.preload="metadata",r.onloadedmetadata=()=>t(r),r.onerror=s,r.src=e}))}function T(){return(T=(0,r._)((function*(e){const t=yield A(e.file);return{kind:"OptimisticPhoto",id:e.trackId,image:t,loaded:0,total:e.file.size}}))).apply(this,arguments)}function N(){return(N=(0,r._)((function*(e){const t=yield(s=e.file,P(URL.createObjectURL(s)));var s;const n=(yield function(e){function t(e,t){return new Promise(((s,r)=>{e.onseeked=()=>{e.videoWidth&&e.videoHeight||s(void 0);const t=document.createElement("canvas");t.width=e.videoWidth,t.height=e.videoHeight;const r=t.getContext("2d");r?(r.drawImage(e,0,0),s(t.toDataURL("image/jpeg"))):s(void 0)},e.onerror=r,e.currentTime=t}))}return t(e,.5*e.duration).catch((0,r._)((function*(s){var r,n;if("string"==typeof s)return Promise.reject(s);const a=null==(r=s.composedPath())?void 0:r[0];return a instanceof HTMLVideoElement&&4===(null==a||null==(n=a.error)?void 0:n.code)?t(yield P(e.src),Math.min(e.duration,1)):Promise.reject(s)})))}(t))||"";return{kind:"OptimisticVideo",id:e.trackId,duration:Math.floor(t.duration),loaded:0,total:e.file.size,image:{url:n,width:t.videoWidth,height:t.videoHeight}}}))).apply(this,arguments)}function F(){return(F=(0,r._)((function*(e){const t=/\.([0-9a-z]+)$/i.exec(e.file.name),s={kind:"OptimisticDoc",id:e.trackId,title:e.file.name,size:e.file.size,ext:(null==t?void 0:t[1])||"",loaded:0,total:e.file.size};if(R(e.file)){const t=yield A(e.file);return(0,n._)({},s,{image:t})}return s}))).apply(this,arguments)}function q(e){return!!e.targetPeerId&&l.isChannelId(e.targetPeerId)&&!!e.isChannel}function x(e,t){return!!e&&l.isChannelId(e)&&!!t}function O(e,t){return!!e&&!l.isChannelId(e)||!t}const L=4,D=200},397384:(e,t,s)=>{s.d(t,{handler:()=>a});var r=s(991792),n=s(96190);const a=(e,t)=>{const{profiles:s,groups:a,conversations:o,mutualFriends:i,contacts:d}=t;if((0,r.insertConvos)(e,o||[]),(0,r.insertPeers)(e,{apiUsers:s||[],apiGroups:a||[],apiContacts:d||[]}),i){const t=e.peers.get(n.resolveId(i.peerId));t&&n.updateMutualFriends(t,i.hint.map(n.resolveId),i.count)}return[]}},664061:(e,t,s)=>{s.d(t,{handler:()=>f});var r=s(11010),n=s(434788),a=s(991792),o=s(89131),i=s(83062),d=s(452788),c=s(839963),l=s(86144),u=s(96190),h=s(54965),p=s(95154);const m=1e3,f=(e,t)=>{switch(t.type){case"ChannelEngineBatchReceived":switch(t.variant.kind){case"FromChannelEngine":return g(e,t.variant);case"FromChannelEngineWithMissingData":return function(e,t){const{next:s,response:[r,n]}=t;r&&(0,a.insertChannels)(e,{apiChannels:r.items||[],apiGroups:r.groups||[],dangerouslyMerge:!0});(n||r)&&(0,a.insertPeers)(e,{apiUsers:[...n||[],...(null==r?void 0:r.profiles)||[]],apiGroups:(null==r?void 0:r.groups)||[],apiContacts:[]});return g(e,{kind:"FromChannelEngine",isRetry:!0,next:s})}(e,t.variant);case"FromChannelEngineApiHistory":return function(e,t){const{ts:s,history:r,posts:n}=t,a=new Map;for(const e of n){let t=a.get(e.channel_id);t||(t=new Map,a.set(e.channel_id,t)),t.set(e.cmid,e)}return g(e,{kind:"FromChannelEngine",next:{kind:"Batch",ts:s,updates:r.reduce(((e,t)=>{switch(t[0]){case 70001:case 70002:{var s;const r=null==(s=a.get(t[1]))?void 0:s.get(t[2]);return r?(e.push([...t,r]),e):e}default:return e.push(t),e}}),[])}})}(e,t.variant);default:return(0,o.exhaustivenessCheck)(t.variant)}case"ComposerDraftsUpdateNeeded":return[];default:return(0,o.exhaustivenessCheck)(t)}};function g(e,t){const{isRetry:s,next:a}=t;if("Failure"===a.kind){e.channelConn.status="resyncing";const{ts:t}=e.channelConn;return[(f=(0,r._)((function*({api:e,channelEngine:s}){if(!s)return{type:"Noop"};let r;yield(0,o.sleep)(m);try{r=yield e.fetch("channels.getLongPollHistory",{lp_version:s.version,ts:t,limit:1e3,extended:1},{retries:1/0,timeout:p.CHANNELS_GLPH_TIMEOUT})}catch(e){return{type:"Noop"}}return s.connect((0,n._)({},r.credentials,{ts:r.new_ts})),{type:"ChannelEngineBatchReceived",variant:{kind:"FromChannelEngineApiHistory",ts:r.new_ts,history:r.history,posts:r.messages||[]}}})),function(e){return f.apply(this,arguments)})]}var f,g;if(!s){const t=function(e,t){const s=new Set,r=new Set;function n(t){switch(t[0]){case 70001:{var a,o,i,d;const[,n,,,l]=t,h=c.resolveId(n);if(e.channels.has(h)||s.add(h),null==(a=null==(o=l.attachments)||null==(i=o[0])?void 0:i.wall.copy_history)||null==(d=a[0])?void 0:d.from_id){const e=u.resolveId(l.attachments[0].wall.copy_history[0].from_id);if(u.isUserPeerId(e)){r.add(e);break}if(u.isGroupPeerId(e)){s.add(c.resolveId(e));break}}break}case 70002:case 70003:case 70004:case 70010:case 70007:case 70008:break;case 70005:{const[,e,r]=t;if(r){const t=c.resolveId(e);s.add(t)}break}case 70009:{const[,e,r]=t;if(r){const t=c.resolveId(e);s.add(t)}break}case 70011:for(const e of t[1])n(e);break;default:}}for(const e of t.updates)n(e);return{channelIds:s,userIds:r}}(e,a);if(t.channelIds.size>0||t.userIds.size>0)return[(g=(0,r._)((function*({api:e}){try{const s=yield e.fetchMany([t.channelIds.size>0&&{method:"channels.getById",params:{channel_ids:Array.from(t.channelIds).join(","),extended:1}},t.userIds.size>0&&{method:"users.get",params:{user_ids:Array.from(t.userIds).map(u.toRealId).join(","),extended:1}}],{retries:1/0});return{type:"ChannelEngineBatchReceived",variant:{kind:"FromChannelEngineWithMissingData",next:a,response:s}}}catch(e){return{type:"Noop"}}})),function(e){return g.apply(this,arguments)})]}e.channelConn.status="running",e.channelConn.ts=a.ts;const v=t=>{switch(t[0]){case 70001:return function(e,t){const[,s,,r,n]=t,a=c.resolveId(s),o=e.channels.get(a);if(!o)return[];c.setSortId(o,{minorSortId:r});const{post:d,reactions:l}=(0,h.fromApiPost)(n);for(const t of l)e.reactions.set(t.id,t);c.appendPost(o,d),i.refreshChannels(e.organisers,o),e.locks.channelsCleanup.has(a)||c.cleanup(o);return[]}(e,t);case 70002:return function(e,t){const[,s,,n]=t,a=c.resolveId(s),o=e.channels.get(a);if(!o)return[];const{post:i,reactions:d}=(0,h.fromApiPost)(n);for(const t of d)e.reactions.set(t.id,t);return c.replacePost(o,i),[(0,r._)((function*(){return{type:"ComposerDraftsUpdateNeeded",foreignKind:"post",itemsToReplace:[i]}}))]}(e,t);case 70003:return function(e,t){const[,s,n,a]=t,o=c.resolveId(s),i=l.resolveCmid(n),d=e.channels.get(o);if(!d)return[];return c.setSortId(d,{minorSortId:a}),c.deletePost(d,i,!1),[(0,r._)((function*(){return{type:"ComposerDraftsUpdateNeeded",foreignKind:"post",cmidsToDelete:[i]}}))]}(e,t);case 70004:return function(e,t){const[,s,r,n]=t,a=c.resolveId(s),o=l.resolveCmid(r),i=e.channels.get(a);if(!i)return[];return c.readUntil(i,o,n),[]}(e,t);case 70005:return function(e,t){const[,s,r,n]=t,a=c.resolveId(s),o=e.channels.get(a);if(!o)return[];return c.setArchived(o,!r),d.updateCounters(e.organisers.channelFilters,{archiveTotal:n}),i.refreshChannels(e.organisers,o),[]}(e,t);case 70007:return function(e,t){const[,s,r]=t,n=c.resolveId(s),a=e.channels.get(n);if(!a)return[];return c.setMuted(a,0!==r),[]}(e,t);case 70008:return function(e,t){const[,s]=t;return d.updateCounters(e.organisers.channelFilters,{unread:s}),[]}(e,t);case 70009:return function(e,t){const[,s,r]=t,n=c.resolveId(s),a=e.channels.get(n);if(!a)return[];return c.setMembership(a,Boolean(r)),i.refreshChannels(e.organisers,a),[]}(e,t);case 70010:return function(e,t){const[,s,,,r]=t,n=c.resolveId(s),a=e.channels.get(n);if(!a)return[];const{post:o}=(0,h.fromApiPost)(r);"Normal"===o.kind&&c.restorePost(a,o.cmid,o);return[]}(e,t);case 70011:return t[1].flatMap(v);default:return[]}};return[...a.updates.flatMap(v),(C=(0,r._)((function*({channelEngine:e}){return e?{type:"ChannelEngineBatchReceived",variant:{kind:"FromChannelEngine",next:yield e.poll()}}:{type:"Noop"}})),function(e){return C.apply(this,arguments)})];var C}},967819:(e,t,s)=>{s.d(t,{handler:()=>i});var r=s(11010),n=s(89131),a=s(452788),o=s(991792);const i=(e,t)=>{switch(t.type){case"ChannelsOnboardingDone":return 0===t.pickedChannelsIds.length?(a.push(e.organisers.channelFilters,"all",[],!1),[(0,r._)((function*({api:e}){return yield e.fetch("account.hideHelpHint",{hint_id:"im:channels_onboarding"},{retries:1/0}),{type:"Noop"}}))]):[(0,r._)((function*({api:e}){try{return{type:"ChannelsOnboardingDone_RequestSucceeded",responseChannels:yield e.fetch("channels.unarchive",{channel_ids:t.pickedChannelsIds.join(",")||"",extended:1})}}catch(e){return{type:"ChannelsOnboardingDone_RequestFailed"}}}))];case"ChannelsOnboardingDone_RequestSucceeded":{const s=(0,o.insertChannels)(e,{apiChannels:t.responseChannels.succeeded||[],apiGroups:t.responseChannels.groups||[]});return a.push(e.organisers.channelFilters,"all",s,!1),[(0,r._)((function*({api:e}){return yield e.fetch("account.hideHelpHint",{hint_id:"im:channels_onboarding"},{retries:1/0}),{type:"Noop"}}))]}case"ChannelsOnboardingDone_RequestFailed":return[];default:(0,n.exhaustivenessCheck)(t)}}},500156:(e,t,s)=>{s.d(t,{handler:()=>w});var r=s(11010),n=s(434788),a=s(453934),o=s(991792),i=s(877740),d=s(481186),c=s(83062),l=s(498928),u=s(96190),h=s(185327),p=s(777634),m=s(999504),f=s(197934),g=s(651285),v=s(168465),C=s(89131),_=s(95154),y=s(954811),k=s(233300),I=s(171949),M=s(927411);const R=1e3,S=200,w=(e,t,s)=>{switch(t.type){case"EngineBatchReceived":{const{variant:n}=t;switch(n.kind){case"FromEngine":return b(s,e,n);case"FromEngineWithMissingData":return function(e,t,s){const{apiConvos:r,apiMessages:n,apiUsers:a,apiGroups:i,apiContacts:d}=s,c=E(n,r);return(0,o.insertConvos)(t,r.map((e=>({conversation:e,last_message:c.messages_legacy.get(e.last_message_id)}))),{dangerouslyMerge:!0}),(0,o.insertPeers)(t,{apiUsers:a,apiGroups:i,apiContacts:d}),b(e,t,{kind:"FromEngine",next:s.skippedBatch},c)}(s,e,n);case"FromApiEngineHistory":return function(e,t,s){var n;const{next:a,apiMessages:i,apiConvos:d,apiUsers:c,apiGroups:u,apiContacts:h,apiCounters:p}=s,f=E(i,d);(0,o.insertConvos)(t,d.map((e=>({conversation:e,last_message:f.messages_legacy.get(e.last_message_id)}))),{dangerouslyMerge:!0}),(0,o.insertPeers)(t,{apiUsers:c,apiGroups:u,apiContacts:h},{dangerouslyOverwrite:!0}),t.activeCallsCount=p.calls||0,l.updateCounters(t.organisers.filters,{unread:p.messages||0,unreadUnmuted:p.messages_unread_unmuted||0,headerNotMutedUnread:0,archive:p.messages_archive_unread||0,archiveMentions:p.messages_archive_mentions_count||0,archiveTotal:p.messages_archive||0,messageRequests:p.message_requests||0}),null==(n=p.messages_folders)||n.forEach((e=>{m.setUnreadCounters(t.organisers.folders,m.resolveId(e.folder_id),e.total_count,e.unmuted_count)}));const{unreadUnmutedCount:g}=t.organisers.filters.unread;return[...b(e,t,{kind:"FromEngine",next:a},f),function(){var e=(0,r._)((function*({notification:e}){return e.setCounters({unread:g}),{type:"Noop"}}));function t(t){return e.apply(this,arguments)}return t}()]}(s,e,n);default:return(0,C.exhaustivenessCheck)(n)}}case"EngineBatchReceived_TypingsTimedOut":{const{peerId:s,typingType:r,timestamp:n}=t,a=e.typings.get(s);if(!a)return[];const o=a[r];return o?(o.updatedAt<=n&&delete a[r],0===Object.keys(a).length&&e.typings.delete(s),[]):[]}case"UpdateMessageRequestsCounter":return[(0,r._)((function*({api:e}){try{const t=M.IApi.resolveTrackId("account.getCounters","message_requests");e.dangerouslyAbort(t);const{message_requests:s}=yield e.fetch("account.getCounters",{filter:"message_requests"},{trackId:t});return{type:"UpdateMessageRequestsCounter_RequestCompleted",count:null!=s?s:0}}catch(e){return{type:"Noop"}}}))];case"UpdateMessageRequestsCounter_RequestCompleted":return l.updateCounters(e.organisers.filters,{messageRequests:t.count}),[];case"TemporaryHackForResync":case"LoadChatMembers":case"LoadChatInfo":case"ComposerDraftsUpdateNeeded":return[];default:return(0,C.exhaustivenessCheck)(t)}};function b(e,t,s,f){const{next:M}=s;if("Failure"===M.kind){t.convoConn.status="resyncing";const e=t.convoConn.pts,s=t.ownerId;return[(w=(0,r._)((function*({api:t,engine:r,queue:a}){var i;let d,c;yield(0,C.sleep)(R);try{[d,c]=yield t.fetchSeq([{method:"messages.getLongPollHistory",params:{lp_version:r.version,credentials:1,pts:e,msgs_limit:1100,events_limit:1100,last_n:1e3,extended:1,group_id:(0,o.getOwnerGroupId)(s)}},{method:"account.getCounters",params:{filter:"all"}}],{retries:1/0})}catch(e){return{type:"Noop"}}if(e<(d.from_pts||0))return a.disconnect(),console.error("Выполняется полный ресинк"),{type:"TemporaryHackForResync"};if(!d.credentials||!d.credentials.pts)throw new Error("В ответе getLongPollHistory отсутствуют новые креды!");return yield r.connect((0,n._)({},d.credentials,{pts:d.credentials.pts})),{type:"EngineBatchReceived",variant:{kind:"FromApiEngineHistory",apiMessages:(null==(i=d.messages)?void 0:i.items)||[],apiConvos:d.conversations||[],apiUsers:d.profiles||[],apiGroups:d.groups||[],apiContacts:d.contacts||[],apiCounters:c,next:{kind:"Batch",pts:d.credentials.pts,ts:d.credentials.ts,updates:d.history||[]}}}})),function(e){return w.apply(this,arguments)})]}var w;if(!(void 0!==f)&&function(e,t){for(const s of t.updates){if(i.IEngine.isIncompleteUpdate(s))return!0;switch(s[0]){case 20:case 21:{const[,t]=s,r=u.resolveId(t);if(!e.convos.has(r))return!0;break}case 52:{const[,t,r,n]=s,a=u.resolveId(r),o=e.convos.get(a);if(!o)break;switch(t){case i.IEngine.ChatUpdateType.FlagsChanged:case i.IEngine.ChatUpdateType.TitleChanged:case i.IEngine.ChatUpdateType.AvatarChanged:case i.IEngine.ChatUpdateType.BannerChanged:case i.IEngine.ChatUpdateType.MessageRequestChanged:case i.IEngine.ChatUpdateType.MessageRequestCanceled:case i.IEngine.ChatUpdateType.MessageRequestAccepted:case i.IEngine.ChatUpdateType.MessageRequestRejected:case i.IEngine.ChatUpdateType.CallInProgressChanged:case i.IEngine.ChatUpdateType.ContactConverted:case i.IEngine.ChatUpdateType.ContactJoined:case i.IEngine.ChatUpdateType.DescriptionChanged:return!0;case i.IEngine.ChatUpdateType.UserJoined:case i.IEngine.ChatUpdateType.UserLeft:case i.IEngine.ChatUpdateType.UserKicked:{const s=u.resolveId(n);if(!e.peers.has(s))return!0;if(t===i.IEngine.ChatUpdateType.UserJoined&&s===e.ownerId)return!0;break}case i.IEngine.ChatUpdateType.Pinned:{const[,,,e]=s;if(0===e)break;const t=p.resolveCmid(e),{status:r}=h.findHistoryNodeByCmid(o,t);return"NotLoaded"===r}case i.IEngine.ChatUpdateType.CopyFlagChanged:case i.IEngine.ChatUpdateType.AdminGrated:case i.IEngine.ChatUpdateType.AdminKicked:case i.IEngine.ChatUpdateType.KeyboardChanged:case i.IEngine.ChatUpdateType.BusinessNotifyDataChanged:case i.IEngine.ChatUpdateType.DonUnsubscribed:case i.IEngine.ChatUpdateType.DonSubscribed:case i.IEngine.ChatUpdateType.IsNewChange:case i.IEngine.ChatUpdateType.StyleChanged:case i.IEngine.ChatUpdateType.ShortPollReactionsChanged:break;default:}break}case 10013:{const[,t]=s,r=u.resolveId(t);return e.convos.has(r)}case 63:case 64:case 65:case 66:case 67:case 68:case 1:case 2:case 3:case 6:case 7:case 10:case 11:case 12:case 80:case 114:case 115:case 119:case 501:case 502:case 503:case 504:case 505:case 506:case 507:case 508:case 602:case 10001:case 10002:case 10006:case 10007:break;case 10003:{const[,,t,r]=s;if(i.IEngine.isIncompleteUpdate(s))break;const n=u.resolveId(r),a=e.convos.get(n);if(!a)break;const{isDeleted:o,isSpam:d}=p.convertFlags(t);if((o||d)&&a)return!0;break}case 4:case 10004:{const[,,,,t,,,r,n]=s,a=u.resolveId(t),o=e.convos.get(a);if(!o)return!0;const i=U(o);if(A(n,i))return!0;if(r.has_template)return!0;const{message:c}=(0,d.fromEngineMessage)(s,e.ownerId,i);if(!e.peers.has(c.peerId)||!e.peers.has(c.authorId))return!0;if(u.isUserPeerId(c.authorId)&&c.peerId===c.authorId&&!e.onlines.has(c.authorId))return!0;break}case 5:case 18:case 10005:case 10018:{const[,t,r,n,,,,a,,,o]=s,i=u.resolveId(n),d=e.convos.get(i);if(!d)break;const c=p.resolveCmid(t),l=h.findMessageByCmid(d,c);if(!l)break;if(A(a,U(d)))return!0;if(p.convertFlags(r).hasReactions&&"Normal"===l.kind&&l.updatedAt!==1e3*o)return!0;break}case 19:case 10019:return!0;case 601:{const[,t,r,n]=s;if(1!==t&&2!==t)break;const a=e.convos.get(u.resolveId(r));if(!a||"NotLoaded"===v.findNodeByCmid(a.history,p.resolveCmid(n)).status)return!0;break}default:}}return!1}(t,M))return[(E=t.convoConn.pts,N=M,F=t.ownerId,b=(0,r._)((function*({api:e,engine:t}){var s;let r;try{r=yield e.fetch("messages.getLongPollHistory",{pts:E,lp_version:t.version,extended:1,group_id:(0,o.getOwnerGroupId)(F)},{retries:1/0})}catch(e){return{type:"Noop"}}return{type:"EngineBatchReceived",variant:{kind:"FromEngineWithMissingData",apiConvos:r.conversations||[],apiMessages:(null==(s=r.messages)?void 0:s.items)||[],apiUsers:r.profiles||[],apiGroups:r.groups||[],skippedBatch:N,apiContacts:r.contacts||[]}}})),function(e){return b.apply(this,arguments)})];var b,E,N,F;t.convoConn.status="running",t.convoConn.pts=M.pts;const q=M.updates.flatMap((e=>{switch(e[0]){case 1:case 2:case 3:return function(e,t,s){const[r,n,a,o]=t,i=u.resolveId(o),d=p.resolveId(n),c=e.convos.get(i);if(!c)return[];const l=h.findMessageById(c,d);if(!l)return[];return P(e,[{1:10001,2:10002,3:10003}[r],l.cmid,a,o],s)}(t,e,f);case 4:case 5:case 18:case 19:return function(e,t,s){const[,r]=t,n=null==s?void 0:s.messages_legacy.get(r);let a;switch(t[0]){case 4:{if(i.IEngine.isIncompleteUpdate(t)){if(!n)return[];const[,,e,s]=t;a=[10004,n.conversation_message_id,e,s,n.peer_id];break}const[,,e,s,o,d,c,l,u,h,p,m]=t;a=[10004,p,e,s,o,d,c,l,u,h,r,m];break}case 5:{if(i.IEngine.isIncompleteUpdate(t)){if(!n)return[];const[,,e]=t;a=[10005,n.conversation_message_id,e,n.peer_id];break}const[,,e,s,o,d,c,l,u,h,p]=t;a=[10005,h,e,s,o,d,c,l,u,r,p];break}case 18:{if(i.IEngine.isIncompleteUpdate(t)){if(!n)return[];const[,,e]=t;a=[10018,n.conversation_message_id,e,n.peer_id];break}const[,,e,s,o,d,c,l,u,h,p]=t;a=[10018,h,e,s,o,d,c,l,u,r,p];break}case 19:if(!n)return[];a=[10019,n.conversation_message_id,n.peer_id];break;default:(0,C.exhaustivenessCheck)(t)}return T(e,a,s)}(t,e,f);case 6:case 7:return function(e,t,s){var r;const[n,a]=t,o=u.resolveId(a),i=e.convos.get(o);if(!i)return[];const d=null==s?void 0:s.convos.get(a),l=d&&(null==(r=(0,y.fromApiConvo)(d))?void 0:r.convo);if(!l)return[];return 6===n?h.readInUntil(i,l.inReadBy,l.unreadCount):h.readOutUntil(i,l.outReadBy),c.refresh(e.organisers,i),[]}(t,e,f);case 10:case 11:case 12:return function(e,t){const[s,r,n]=t,a=u.resolveId(r),o=e.convos.get(a);if(!o)return[];const i={10:"unset",11:"replace",12:"set"}[s];return h.updateFlags(o,i,n),c.refresh(e.organisers,o),[]}(t,e);case 20:return function(e,t){const[,s,r]=t,n=u.resolveId(s),a=e.convos.get(n);if(!a)return[];return h.updateSortId(a,{majorSortId:r}),c.refresh(e.organisers,a),[]}(t,e);case 21:return function(e,t){const[,s,n]=t,a=u.resolveId(s),o=e.convos.get(a);if(!o)return[];h.updateSortId(o,{minorSortId:n}),c.refresh(e.organisers,o);const i=n<=0,d=e.organisers.filters.messageRequest.totalCount>0;if(i&&d)return[(0,r._)((function*(){return{type:"UpdateMessageRequestsCounter",peerId:a}}))];return[]}(t,e);case 52:return function(e,t,s,n){const[,a,o,d]=t,l=u.resolveId(o),m=e.convos.get(l);if(!m)return[];const f=null==n?void 0:n.convos.get(o),g=f&&(0,y.fromApiConvo)(f);switch(a){case i.IEngine.ChatUpdateType.CopyFlagChanged:case i.IEngine.ChatUpdateType.TitleChanged:case i.IEngine.ChatUpdateType.AvatarChanged:return[];case i.IEngine.ChatUpdateType.FlagsChanged:return"ChatConvo"!==m.kind||"ChatConvo"!==(null==g?void 0:g.convo.kind)||(m.isService=g.convo.isService,m.permissions=g.convo.permissions,m.acl=g.convo.acl,m.inviteLinks=g.convo.inviteLinks),[];case i.IEngine.ChatUpdateType.Pinned:{if("ChatConvo"!==m.kind)return[];const t=d,s=p.resolveCmid(t);if(m.pinnedMessage){const e=h.findMessageByCmid(m,m.pinnedMessage.cmid);"Normal"===(null==e?void 0:e.kind)&&p.unpinMessage(e)}if(e.hiddenPinnedMessages.delete(l),(null==g?void 0:g.convo.kind)===m.kind)return g.convo.pinnedMessage&&h.pinMessage(m,g.convo.pinnedMessage),[];if(0===s)h.unpinMessage(m);else{const e=h.findMessageByCmid(m,s);"Normal"===(null==e?void 0:e.kind)&&h.pinMessage(m,p.toPinned(e))}return[]}case i.IEngine.ChatUpdateType.ContactJoined:return[];case i.IEngine.ChatUpdateType.UserJoined:{if("ChatConvo"!==m.kind)return[];const t=u.resolveId(d);if(!u.isUserPeerId(t)&&!u.isGroupPeerId(t))return[];if(m.members){const s={peerId:t,isAdmin:m.adminIds.has(t),canKick:m.adminIds.has(e.viewer.id),isMessageRequest:!1};h.addMembers(m,[s])}return t===e.ownerId?(h.changeUserState(m,"in"),h.allowWrite(m),e.locks.getConversationMembers.add(l),[u.isChatPeerId(l)&&(0,r._)((function*(){return{type:"LoadChatMembers",peerId:l}})),u.isChatPeerId(l)&&(0,r._)((function*(){return{type:"LoadChatInfo",peerId:l}}))]):[]}case i.IEngine.ChatUpdateType.UserLeft:{if("ChatConvo"!==m.kind)return[];const t=u.resolveId(d);return u.isUserPeerId(t)||u.isGroupPeerId(t)?(t===e.ownerId&&h.changeUserState(m,"left"),h.removeMember(m,t),[]):[]}case i.IEngine.ChatUpdateType.UserKicked:{if("ChatConvo"!==m.kind)return[];const t=u.resolveId(d);if(!u.isUserPeerId(t)&&!u.isGroupPeerId(t))break;t===e.ownerId&&(h.changeUserState(m,"kicked"),h.restrictWrite(m,"kicked")),h.removeMember(m,t);break}case i.IEngine.ChatUpdateType.KeyboardChanged:return[];case i.IEngine.ChatUpdateType.CallInProgressChanged:return"ChatConvo"===m.kind&&(null==g?void 0:g.convo.kind)===m.kind&&h.updateActiveCall(m,g.convo.activeCall),[];case i.IEngine.ChatUpdateType.IsNewChange:return h.updateIsNew(m,!!d),[];case i.IEngine.ChatUpdateType.MessageRequestChanged:{const t=d;switch(t){case i.IEngine.MRStatus.Accepted:{if("MessageRequestChatConvo"!==m.kind&&"MessageRequestUserConvo"!==m.kind||"pending"!==m.MRStatus){c.refresh(e.organisers,m);break}const t=h.fromAcceptedMessageRequest(m,null==g?void 0:g.convo);e.convos.set(l,t),c.refresh(e.organisers,t);break}case i.IEngine.MRStatus.New:var v;(null==g?void 0:g.convo)&&e.convos.set(l,null==g?void 0:g.convo),c.refresh(e.organisers,null!=(v=null==g?void 0:g.convo)?v:m);break;case i.IEngine.MRStatus.Deleted:if("MessageRequestChatConvo"!==m.kind&&"MessageRequestUserConvo"!==m.kind&&"UserConvo"!==m.kind)break;const t=h.fromCancelledMessageRequest(m);e.convos.set(l,t),c.refresh(e.organisers,t);break;case i.IEngine.MRStatus.Rejected:if(h.isRejectedMR(m)){c.refresh(e.organisers,m);break}if("MessageRequestChatConvo"!==m.kind&&"MessageRequestUserConvo"!==m.kind&&"UserConvo"!==m.kind)break;const s=h.fromRejectedMessageRequest(m);e.convos.set(l,s),c.refresh(e.organisers,s);break;default:}return[(0,r._)((function*(){return{type:"UpdateMessageRequestsCounter",peerId:l}}))]}case i.IEngine.ChatUpdateType.AdminGrated:{const e=u.resolveId(d);return"ChatConvo"!==m.kind||!u.isUserPeerId(e)&&!u.isGroupPeerId(e)||m.adminIds.add(e),[]}case i.IEngine.ChatUpdateType.AdminKicked:{const e=u.resolveId(d);return"ChatConvo"!==m.kind||!u.isUserPeerId(e)&&!u.isGroupPeerId(e)||m.adminIds.delete(e),[]}case i.IEngine.ChatUpdateType.ContactConverted:{const t=u.resolveId(d),s=e.convos.get(t),r=e.peers.get(t);return r&&s&&"Contact"===r.kind&&u.isUserPeerId(l)?(u.convertContact(r,l),h.updateSortId(s,{minorSortId:0}),[]):[]}case i.IEngine.ChatUpdateType.BannerChanged:return"UserConvo"!==m.kind||(null==g?void 0:g.convo.kind)!==m.kind||(m.convoBanner=null==g?void 0:g.convo.convoBanner),[];case i.IEngine.ChatUpdateType.DescriptionChanged:return"ChatConvo"!==m.kind||(null==g?void 0:g.convo.kind)!==m.kind||(m.description=g.convo.description),[];case i.IEngine.ChatUpdateType.ShortPollReactionsChanged:return"ChatConvo"!==m.kind||(m.shouldShortPollReactions=Boolean(d)),[];case i.IEngine.ChatUpdateType.BusinessNotifyDataChanged:case i.IEngine.ChatUpdateType.MessageRequestAccepted:case i.IEngine.ChatUpdateType.MessageRequestCanceled:case i.IEngine.ChatUpdateType.MessageRequestRejected:case i.IEngine.ChatUpdateType.DonSubscribed:case i.IEngine.ChatUpdateType.DonUnsubscribed:case i.IEngine.ChatUpdateType.StyleChanged:return[];default:}return[]}(t,e,0,f);case 63:case 64:case 65:case 66:case 67:case 68:return function(e,t){const[s,a,o,i,d]=t,c=u.resolveId(a),l=new Set(o.map((e=>u.resolveId(e))));l.delete(e.viewer.id);const h=e.convos.get(c);if(!h)return[];const p={63:"text",64:"voice",65:"photo",66:"video",67:"file",68:"videomessage"}[s],m=(0,n._)({},e.typings.get(c)||{},{[p]:{peerIds:l,updatedAt:d,totalCount:i}});return e.typings.set(c,m),[function(){var e=(0,r._)((function*(){return yield(0,C.sleep)(_.TYPING_EXPIRATION_TIME),{type:"EngineBatchReceived_TypingsTimedOut",peerId:c,typingType:p,timestamp:d}}));function t(){return e.apply(this,arguments)}return t}()]}(t,e);case 80:return function(e,t){const[,s,n,,a,,o,i,,d]=t;return l.updateCounters(e.organisers.filters,{unread:s,headerNotMutedUnread:o,unreadUnmuted:n,archive:i,archiveMentions:d,businessNotify:a}),[function(){var e=(0,r._)((function*({notification:e}){return e.setCounters({unreadIdle:o,unread:n}),{type:"Noop"}}));function t(t){return e.apply(this,arguments)}return t}()]}(t,e);case 114:return function(e,t){const[,{peer_id:s}]=t,r=u.resolveId(s),n=e.convos.get(r);if(!n)return[];const a=(0,y.fromLongpollPushSettings)(t);return h.updatePush(n,a),[]}(t,e);case 115:return function(e,t){const[,s]=t;return[(0,r._)((function*(e){var t;return null==(t=e.calls)||t.showIncomingCall(s),{type:"Noop"}}))]}(0,e);case 119:return function(e,t){const[,s]=t,r=u.resolveId(s.peer_id),n=u.resolveId(s.owner_id),a=e.convos.get(r),o=e.peers.get(r),i=e.peers.get(n),d=a&&o&&i?(0,k.fromApiMessageEvent)(o,i,s):void 0;return e.botKeyboardEvent=d,[]}(t,e);case 501:return function(e,t){const[,s,r]=t;return(0,o.insertFolders)(e,[{id:s,name:r}]),[]}(t,e);case 502:return function(e,t){const[,s]=t,r=m.resolveId(s);m.deleteFolder(e.organisers.folders,r);for(const t of e.convos.values())h.removeFolder(t,r);return[]}(t,e);case 503:return function(e,t){const[,s,r]=t,n=m.resolveId(s),a=e.organisers.folders.find((e=>e.id===n));if(!a)return[];return m.setName(a,r),[]}(t,e);case 504:return function(e,t){const[,s,...r]=t,n=m.resolveId(s),a=(0,o.getConvosByIds)(e,r),i=e.organisers.folders.find((e=>e.id===n));if(!i)return[];return(0,o.addConvosToFolder)(e,n,a),[]}(t,e);case 505:return function(e,t){const[,s,...r]=t,n=m.resolveId(s),a=(0,o.getConvosByIds)(e,r),i=e.organisers.folders.find((e=>e.id===n));if(!i)return[];return(0,o.removeConvosFromFolder)(e,n,a),[]}(t,e);case 506:return function(e,t){const[,...s]=t;return m.reorderFolders(e.organisers.folders,s.map((e=>m.resolveId(e)))),[]}(t,e);case 507:return function(e,t){const[,...s]=t;for(const t of s){if(t.length<3)continue;const s=m.resolveId(t[0]);m.setUnreadCounters(e.organisers.folders,s,t[1],t[2])}return[]}(t,e);case 508:return function(e,t){const[,s]=t,r=m.resolveId(s),n=e.organisers.folders.find((e=>e.id===r));if(!n)return[];return m.replaceFolder(e.organisers.folders,(0,I.fromApiFolder)({id:r,name:n.name})),[]}(t,e);case 601:return function(e,t,s){const[,n,o,i]=t,c=u.resolveId(o),l=p.resolveCmid(i);let m,f=0,v=[];switch(n){case 1:{const[,,,,e,s,...r]=t;f=s,v=r,m=g.resolveId(e);break}case 2:case 3:case 4:{const[,,,,e,...s]=t;f=e,v=s;break}default:return[]}const C=[];let _=0;for(let e=0;e<f;e++){const e=v[_];if(!e)return[];const t=v.slice(_+1,_+1+e);_+=1+e;const[s,r,n]=t.slice(0,3);if(void 0===s||void 0===r||void 0===n)return[];const a=t.slice(3,3+n).map(u.resolveId);C.push({reactionId:g.resolveId(s),count:r,peerIds:new Set(a)})}const y=e.convos.get(c);if(!y)return[];var k;const I=null!=(k=v[_])?k:0,M=v.slice(_+1,_+1+Math.min(3,null!=I?I:0)).map((e=>u.resolveId(e)));let R;R=h.findMessageByCmid(y,l),"Normal"===(null==R?void 0:R.kind)&&(1!==n&&3!==n||p.setCurrentUserReaction(R,m),p.setReactions(R,C));if(R)R=(0,a.isDraft)(R)?(0,a.current)(R):R;else{var w;const e=null==(w=null==s?void 0:s.messagesByPeerId.get(c))?void 0:w.get(l);if(R=e&&(0,d.fromApiMessage)(e).message,!R)return[]}const b=`${c}-${l}`;var E;const U=null!=(E=e.messageReactedPeers.get(b))?E:new Set;let A=[];switch(n){case 2:A=M.filter((e=>!U.has(e))),e.messageReactedPeers.set(b,new Set([...U,...A]));break;case 4:const t=new Set([...U].filter((e=>!M.includes(e))));if(0===t.size){e.messageReactedPeers.delete(b);break}e.messageReactedPeers.set(b,t)}if(e.messageReactedPeers.size>S){const t=e.messageReactedPeers.keys(),s=e.messageReactedPeers.size-S;for(let r=0;r<s;r++)e.messageReactedPeers.delete(t.next().value)}let P=A.map((t=>{const s=e.peers.get(u.resolveId(t)),r=(0,a.isDraft)(s)?(0,a.current)(s):s;return null!=r?r:null})).filter((e=>null!==e));const T=!h.isMuted(y)&&e.viewer.settings.push.messageReaction.isEnabled,N=C.some((t=>!e.messageReactions.has(t.reactionId)));return[function(){var e=(0,r._)((function*({notification:e}){if("Normal"!==(null==R?void 0:R.kind))return{type:"Noop"};const t=R.sentAt<Date.now()-432e5,s=[...R.reactions.values()].reduce(((e,t)=>e+t.count),0);return T&&R.isOut&&2===n&&!t&&s<8&&e.notify({kind:"reaction",message:R,reactedPeers:P,reactedCount:I}),{type:"Noop"}}));function t(t){return e.apply(this,arguments)}return t}(),N&&(0,r._)((function*(){return{type:"InvalidateMessageReactions",force:!0}}))]}(t,e,f);case 602:return function(e,t){const[,s,...r]=t,n=u.resolveId(s),a=e.convos.get(n);if(!a)return[];const o=r[0];if(void 0===o)return[];const i=r.slice(1,o+1).map(p.resolveCmid);return h.replaceUnreadReactions(a,i),[]}(t,e);case 10001:case 10002:case 10003:return P(t,e,f);case 10004:case 10005:case 10018:case 10019:return T(t,e,f);case 10006:case 10007:return function(e,t){const[s,r,n,a]=t,o=u.resolveId(r),i=p.resolveCmid(n),d=e.convos.get(o);if(!d)return[];10006===s?(h.readInUntil(d,i,a),u.isFavorites(d.peerId,e.ownerId)&&h.readOutUntil(d,i)):h.readOutUntil(d,i);return c.refresh(e.organisers,d),[]}(t,e);case 10013:return function(e,t,s){const[,n,a]=t,o=u.resolveId(n),i=p.resolveCmid(a),d=e.convos.get(o);if(!d)return[];if(v.lastCmid(d.history)!==i)return[];const l=null==s?void 0:s.convos.get(n),h=l&&(0,y.fromApiConvo)(l);if(!h)return[function(){var e=(0,r._)((function*({logger:e}){return e.error("[EngineBatchReceived]",new Error(`В ${t[0]} отсутствует дозагруженная беседа`)),{type:"Noop"}}));function s(t){return e.apply(this,arguments)}return s}()];e.convos.set(h.convo.peerId,h.convo),h.peer&&e.peers.set(h.peer.id,h.peer);return c.refresh(e.organisers,d),[]}(t,e,f);default:return[]}}));return[function(){var e=(0,r._)((function*({engine:e}){return{type:"EngineBatchReceived",variant:{kind:"FromEngine",next:yield e.poll()}}}));return function(t){return e.apply(this,arguments)}}(),...q]}function E(e,t){const s=new Map;for(const t of e){let e=s.get(t.peer_id);e||(e=new Map,s.set(t.peer_id,e)),e.set(t.conversation_message_id,t)}return{messages_legacy:new Map(e.map((e=>[e.id,e]))),messagesByPeerId:s,convos:new Map(t.map((e=>[e.peer.id,e])))}}function U(e){return function(t){const s=h.findMessageByCmid(e,t);return"Normal"===(null==s?void 0:s.kind)?s:void 0}}function A(e,t){if(e.fwd&&!e.reply)return!0;if(e.reply){const s=JSON.parse(e.reply);if(!t(p.resolveCmid(s.conversation_message_id)))return!0}if(e.geo)return!0;if(e.attachments&&e.attach1_type&&!e.attach2_type)try{const t=JSON.parse(e.attachments);if(Array.isArray(t)&&t[0].type===e.attach1_type)return!1}catch(e){return!0}return!!e.attach1_type}function P(e,t,s){const[n,a,o,i]=t,c=p.resolveCmid(a),l=u.resolveId(i),m=e.convos.get(l);if(!m)return[];const f=p.convertFlags(o);if(10003===n){const{isDeleted:e,isSpam:t}=f;if((e||t)&&a){var g;const e=null==(g=null==s?void 0:s.messagesByPeerId.get(i))?void 0:g.get(a);if(e){const t=(0,d.fromApiMessage)(e);h.restoreMessage(m,t.message,t.mentions.hasDirect||t.mentions.hasMass)}}}const v={10001:"replace",10002:"set",10003:"unset"}[n],{status:C}=h.findHistoryNodeByCmid(m,c);return"NotLoaded"===C?[]:(h.updateMessageFlags(m,c,v,o),[(0,r._)((function*(){if(10002!==n)return{type:"Noop"};const{isDeleted:e,isDeletedForAll:t}=f;return e||t?{type:"ComposerDraftsUpdateNeeded",peerId:l,foreignKind:"message",cmidsToDelete:[c]}:{type:"Noop"}}))])}function T(e,t,s){var n;const[,a]=t;let l;switch(t[0]){case 10004:l=t[4];break;case 10005:case 10018:l=t[3];break;case 10019:l=t[2];break;default:(0,C.exhaustivenessCheck)(t)}const m=u.resolveId(l),g=e.convos.get(m);if(!g)return[];const v=null==(n=null==s?void 0:s.messagesByPeerId.get(l))?void 0:n.get(a);let _,y,I;if(v){var M;const e=(0,d.fromApiMessage)(v);_=e.message,y=e.mentions;const t=null==(M=null==s?void 0:s.convos.get(m))?void 0:M.current_keyboard;if(t){const e=(0,k.fromApiKeyboard)(t,m);if("InputKeyboard"===e.kind){JSON.stringify(g.currentKeyboard)!==JSON.stringify(e)&&(I={kind:"InputKeyboardUpsertEvent",keyboard:e})}}else I={kind:"InputKeyboardDeleteEvent"}}else{if(i.IEngine.isIncompleteUpdate(t)||10019===t[0])return[];const s=(0,d.fromEngineMessage)(t,e.ownerId,U(g));_=s.message,y=s.mentions,I=s.keyboardEvent}switch(t[0]){case 10004:{var R;const s=e.typings.get(g.peerId);if(s)for(const t of o.TypingVariants){const r=s[t];r&&r.peerIds.has(_.authorId)&&(r.peerIds.delete(_.authorId),r.totalCount--,0===r.totalCount&&delete s[t],0===Object.keys(s).length&&e.typings.delete(g.peerId))}const n=t[3],a=y.hasDirect||y.hasMass;"ChatConvo"===g.kind?h.appendMessage(g,_,n,a,I):h.appendMessage(g,_,n,!1,I),c.refresh(e.organisers,g),e.locks.convosCleanup.has(g.peerId)||h.cleanup(g),"InputKeyboardUpsertEvent"===(null==I?void 0:I.kind)&&e.hiddenBotKeyboards.delete(g.peerId);const i=p.convertFlags(t[2]),d=h.isMessageUnread(g,_),{browserNotifications:l,soundNotifications:v,push:C}=e.viewer.settings,k=!_.isOut&&!i.noPush&&d&&!h.isMuted(g)&&v&&!_.isSilent;let M,b=null;switch(g.kind){case"UserConvo":b=C.userConvo;break;case"ChatConvo":b=C.chatConvo;break;case"GroupConvo":b=C.groupConvo}switch(!0){case _.isOut:case!d:case"nothing"===g.push.mode||"nothing"===C.mention:case null!==b&&!b.isEnabled:case!l:case i.noPush:M=!1;break;case!h.isMuted(g):M=!0;break;case"direct-mention"===g.push.mode||"direct-mention"===C.mention:M=y.hasDirect;break;case"every-mention"===g.push.mode&&"every-mention"===C.mention:M=a;break;default:M=!0}const E=u.isMarusia(m)&&"Normal"===_.kind&&{type:"add_message",payload:{randomId:Number(_.randomId),text:p.toRawText(_),isOutbound:_.isOut,local:!1,payload:null==(R=t[7])?void 0:R.payload,attachIds:f.ids(_.attaches)}};return[(w=(0,r._)((function*({notification:e}){return M&&e.notify({kind:"message",message:_},m),k&&e.playSound(),{type:"Noop"}})),function(e){return w.apply(this,arguments)}),E&&(S=(0,r._)((function*({marusia:e}){return null==e||e.handleAction(E),{type:"Noop"}})),function(e){return S.apply(this,arguments)})]}case 10005:case 10018:case 10019:return h.replaceMessage(g,_,y.hasDirect||y.hasMass),"Expired"===_.kind&&h.replaceExpiredReplies(g,_.cmid),[(0,r._)((function*(){return{type:"ComposerDraftsUpdateNeeded",peerId:m,foreignKind:"message",cmidsToDelete:"Expired"===_.kind?[_.cmid]:void 0,itemsToReplace:"Normal"===_.kind?[_]:void 0}}))];default:return(0,C.exhaustivenessCheck)(t)}var S,w}},553977:(e,t,s)=>{s.d(t,{handler:()=>n});var r=s(991792);const n=(e,t)=>((0,r.insertPeers)(e,{apiUsers:t.profile?[t.profile]:[],apiContacts:[t.contact],apiGroups:[]},{dangerouslyOverwrite:!0}),(0,r.insertContacts)(e,[t.contact]),[])},972284:(e,t,s)=>{s.d(t,{handler:()=>d});var r=s(11010),n=s(434788),a=s(89131),o=s(651285);const i=864e5,d=(e,t)=>{switch(t.type){case"InvalidateMessageReactions":{const{force:n}=t,{locks:{invalidateMessageReactions:a}}=e;return a?[]:(e.locks.invalidateMessageReactions=!0,[(s=(0,r._)((function*({api:e,storage:t}){try{const s=yield function(e){return c.apply(this,arguments)}({api:e,storage:t,force:Boolean(n)});return{type:"InvalidateMessageReactions_RequestCompleted",hasFailed:null===s,response:s}}catch(e){return{type:"InvalidateMessageReactions_RequestCompleted",hasFailed:!0,response:null}}})),function(e){return s.apply(this,arguments)})])}case"InvalidateMessageReactions_RequestCompleted":{const{response:s,hasFailed:r}=t;return r||!s||(e.locks.invalidateMessageReactions=!1,e.messageReactions=s.assets.reduce(((e,t)=>{var r,n;const a=null!=(n=null==(r=s.override_assets)?void 0:r.find((e=>e.reaction_id===t.reaction_id)))?n:t;return e.set(o.resolveId(a.reaction_id),{id:o.resolveId(a.reaction_id),image:a.links.static,animationSmall:a.links.small_animation,animationBig:a.links.big_animation,name:""}),e}),new Map)),[]}default:(0,a.exhaustivenessCheck)(t)}var s};function c(){return(c=(0,r._)((function*({api:e,storage:t,force:s=!1}){const r=t.get("message-reactions-assets"),a=(new Date).getTime(),o=!r||r.expiresAt<a;let d=null;if(o||s)try{var c;d=yield e.fetch("messages.getReactionsAssets",{client_version:null!=(c=null==r?void 0:r.response.version)?c:void 0},{retries:3})}catch(e){d=(null==r?void 0:r.response)||null}else d=(null==r?void 0:r.response)||null;const l=d?(0,n._)({},d,{assets:[...(null==r?void 0:r.response.assets)||[],...d.assets],override_assets:d.override_assets||[]}):null;return(o||s)&&l&&t.set("message-reactions-assets",{response:l,expiresAt:a+i}),l}))).apply(this,arguments)}},735130:(e,t,s)=>{s.d(t,{handler:()=>c});var r=s(11010),n=s(434788),a=s(89131),o=s(185327),i=s(991792),d=s(954811);const c=(e,t)=>{switch(t.type){case"LoadChatInfo":{const{peerId:n}=t,a=(0,i.getOwnerGroupId)(e.ownerId);return e.locks.getConversationInfo.has(n)?[]:(e.locks.getConversationInfo.add(n),[(s=(0,r._)((function*({api:e}){try{const t=yield e.fetch("messages.getConversationsById",{peer_ids:n.toString(),group_id:a,extended:0});return{type:"LoadChatInfo_RequestComplete",peerId:n,convo:t.items[0],hasFailed:!t.items[0]}}catch(e){return{type:"LoadChatInfo_RequestComplete",peerId:n,hasFailed:!0}}})),function(e){return s.apply(this,arguments)})])}case"LoadChatInfo_RequestComplete":{const{peerId:s,convo:r,hasFailed:a}=t;e.locks.getConversationInfo.delete(s);const i=e.convos.get(s);if("ChatConvo"!==(null==i?void 0:i.kind)||a||!r)return[];const c=(0,d.fromApiConvo)(r);return"ChatConvo"!==(null==c?void 0:c.convo.kind)||(o.updateAcl(i,(0,n._)({},c.convo.acl)),o.updateMembersCount(i,c.convo.membersCount)),[]}default:(0,a.exhaustivenessCheck)(t)}var s}},339962:(e,t,s)=>{s.d(t,{handler:()=>d});var r=s(11010),n=s(89131),a=s(185327),o=s(991792),i=s(698057);const d=(e,t)=>{switch(t.type){case"LoadChatMembers":{const{peerId:n}=t,a=(0,o.getOwnerGroupId)(e.ownerId);return[(s=(0,r._)((function*({api:e}){try{return{type:"LoadChatMembers_RequestComplete",peerId:n,response:yield e.fetch("messages.getConversationMembers",{peer_id:n,extended:1,group_id:a},{retries:1}),hasFailed:!1}}catch(e){return{type:"LoadChatMembers_RequestComplete",peerId:n,hasFailed:!0}}})),function(e){return s.apply(this,arguments)})]}case"LoadChatMembers_RequestComplete":{const{peerId:s,response:r,hasFailed:n}=t;e.locks.getConversationMembers.delete(s);const d=e.convos.get(s);if("ChatConvo"!==(null==d?void 0:d.kind)||n||!r)return[];const{members:c,adminIds:l,ownerId:u}=(0,i.fromApiChatMembers)(r.items);return a.addMembers(d,c),l.forEach((e=>{a.addAdmin(d,e)})),u&&a.setOwner(d,u),(0,o.insertPeers)(e,{apiUsers:r.profiles||[],apiGroups:r.groups||[],apiContacts:r.contacts||[]}),[]}default:(0,n.exhaustivenessCheck)(t)}var s}},427418:(e,t,s)=>{s.d(t,{handler:()=>o});var r=s(11010),n=s(89131),a=s(991792);const o=(e,t)=>{switch(t.type){case"LoadContactList":return e.locks.contactList?[]:(e.locks.contactList=!0,[(s=(0,r._)((function*({api:e}){try{const s=yield e.fetch("account.getContactList",{extended:1,offset:t.offset},{retries:1});return{type:"LoadContactList_RequestCompleted",contacts:s.contacts||[],profiles:s.profiles||[],items:s.items||[]}}catch(e){return{type:"LoadContactList_RequestCompleted",contacts:[],profiles:[],items:[]}}})),function(e){return s.apply(this,arguments)})]);case"LoadContactList_RequestCompleted":return e.locks.contactList=!1,(0,a.insertContacts)(e,t.contacts),(0,a.insertContactItems)(e,t.items,t.profiles),e.contacts.hasMore=!1,[];default:(0,n.exhaustivenessCheck)(t)}var s}},61448:(e,t,s)=>{s.d(t,{getImportantMessageKey:()=>d,handler:()=>i});var r=s(11010),n=s(89131),a=s(481186),o=s(991792);const i=(e,t)=>{switch(t.type){case"LoadImportantMessages":{const t=20*Math.floor(e.importantMessages.messages.size/20),s=e.ownerId;return[(c=(0,r._)((function*({api:e}){try{return{type:"LoadImportantMessages_RequestCompleted",hasFailed:!1,response:yield e.fetch("messages.getImportantMessages",{count:20,offset:t,extended:1,group_id:(0,o.getOwnerGroupId)(s)})}}catch(e){return{type:"Noop"}}})),function(e){return c.apply(this,arguments)})]}case"LoadImportantMessages_RequestCompleted":{var s,i;const{response:{messages:r,profiles:n,groups:c,conversations:l}}=t;return((null==(s=r.items)?void 0:s.length)||0)<20&&(e.importantMessages.hasMore=!1),(0,o.insertConvos)(e,l||[]),(0,o.insertPeers)(e,{apiUsers:n||[],apiGroups:c||[],apiContacts:[]}),null==(i=r.items)||i.forEach((t=>{const{message:s}=(0,a.fromApiMessage)(t);"Normal"===s.kind&&e.importantMessages.messages.set(d(s.peerId,s.cmid),s)})),[]}case"UserClosedImportantMessages":return e.importantMessages.messages.clear(),e.importantMessages.hasMore=!0,[];default:return(0,n.exhaustivenessCheck)(t)}var c},d=(e,t)=>`${e}-${t}`},261740:(e,t,s)=>{s.d(t,{IMPORTANT_USERS_COUNT:()=>i,handler:()=>d});var r=s(11010),n=s(89131),a=s(991792),o=s(954811);const i=10,d=(e,t)=>{switch(t.type){case"LoadImportantUsers":{if(e.locks.getImportantUsers||null!==e.importantUsers)return[];e.locks.getImportantUsers=!0;const t=(0,a.getOwnerGroupId)(e.ownerId);return[(s=(0,r._)((function*({api:e}){try{return{type:"LoadImportantUsers_RequestCompleted",hasFailed:!1,response:yield e.fetch("messages.searchConversations",{q:" ",count:i,extended:1,group_id:t},{retries:2})}}catch(e){return{type:"LoadImportantUsers_RequestCompleted",hasFailed:!0}}})),function(e){return s.apply(this,arguments)})]}case"LoadImportantUsers_RequestCompleted":if(e.locks.getImportantUsers=!1,t.hasFailed)return[];const{profiles:d,groups:c,items:l,contacts:u}=t.response;(0,a.insertConvos)(e,l),(0,a.insertPeers)(e,{apiUsers:d||[],apiGroups:c||[],apiContacts:u||[]});const h=l.reduce(((e,t)=>{const s=(0,o.fromApiConvo)(t);return s&&e.add(s.convo.peerId),e}),new Set);return e.importantUsers=h,[];default:(0,n.exhaustivenessCheck)(t)}var s}},228153:(e,t,s)=>{s.d(t,{handler:()=>o});var r=s(11010),n=s(89131),a=s(986727);const o=(e,t)=>{switch(t.type){case"LoadStickers":{const{stickers:s,locks:{loadStickers:n}}=e,a=t.stickerIds.filter((e=>!n.has(e)&&!s.has(e)));return a.length?(e.locks.loadStickers=new Set([...n,...a]),[(0,r._)((function*({api:e}){try{return{type:"LoadStickers_RequestCompleted",response:yield e.fetch("store.getStickers",{sticker_ids:a.join()})}}catch(e){}return{type:"LoadStickers_RequestCompleted",hasFailed:!0}}))]):[]}case"LoadStickers_RequestCompleted":{const{response:s,hasFailed:r}=t;if(r||!s)return[];const{stickers:n}=e;return s.forEach((e=>{const t=(0,a.fromApiSticker)(e);t&&n.set(t.id,t)})),[]}default:(0,n.exhaustivenessCheck)(t)}}},382379:(e,t,s)=>{s.d(t,{handler:()=>c});var r=s(11010),n=s(434788),a=s(991792),o=s(95154),i=s(452788),d=s(89131);const c=(e,t)=>{switch(t.type){case"MoreChannelsNeeded":{const{organiser:a}=t,{filter:d}=a,c=i.getLockId(d);if(e.locks.getChannels[c]||!e.organisers.channelFilters[d].hasMore)return[];const{minorSortId:l,channelId:u}=e.organisers.channelFilters[d].boundary;e.locks.getChannels[c]=!0;const h=o.CHANNELS_PER_PAGE+1,p=i.isLoaded(e.organisers.channelFilters[d])?l:void 0;return[(s=(0,r._)((function*({api:e}){try{var s;const r=yield e.fetch("channels.get",{count:h,offset_minor_sort_id:p,offset_channel_id:u,filter:i.snakeCaseId(a.filter),extended:1},{retries:3});return(0,n._)({},t,{type:"MoreChannelsNeeded_RequestCompleted",hasFailed:!1,response:r,hasMore:((null==(s=r.items)?void 0:s.length)||0)>=h})}catch(e){return(0,n._)({},t,{type:"MoreChannelsNeeded_RequestCompleted",hasFailed:!0,hasMore:!1})}})),function(e){return s.apply(this,arguments)})]}case"MoreChannelsNeeded_RequestCompleted":{const{hasFailed:s,organiser:r,hasMore:n}=t;let o="";if("channelFilters"===r.kind)o=i.getLockId(r.filter);else(0,d.exhaustivenessCheck)(r.kind);if(e.locks.getChannels[o]=!1,s)return[];const{response:c}=t;if(c){const t=(0,a.insertChannels)(e,{apiChannels:c.items||[],apiGroups:c.groups||[]});if((0,a.insertPeers)(e,{apiUsers:c.profiles||[],apiGroups:c.groups||[],apiContacts:[]}),"channelFilters"===r.kind)i.push(e.organisers.channelFilters,r.filter,t,n);else(0,d.exhaustivenessCheck)(r.kind)}return[]}default:(0,d.exhaustivenessCheck)(t)}var s}},203677:(e,t,s)=>{s.d(t,{handler:()=>l});var r=s(11010),n=s(434788),a=s(991792),o=s(95154),i=s(498928),d=s(89131),c=s(999504);const l=(e,t)=>{switch(t.type){case"MoreConvosNeeded":{const{organiser:l}=t,u=e.ownerId;let h,p="";switch(l.kind){case"filters":{const{filter:t}=l;if(p=i.getLockId(t),e.locks.getConversations[p]||!e.organisers.filters[t].hasMore)return[];h={start_message_id:i.isLoaded(e.organisers.filters[t])?e.organisers.filters[t].boundary.minorSortId:void 0,filter:i.snakeCaseId(t),extended:1,group_id:(0,a.getOwnerGroupId)(u)};break}case"folders":{const{id:t,filter:s}=l;p=c.getLockId(t,s);const r=e.organisers.folders.find((e=>e.id===t));if(!r)throw new Error("Не найдена папка");if(e.locks.getConversations[p]||c.isLoaded(r,s)&&!r[s].hasMore)return[];h={start_message_id:c.isLoaded(r,s)?r[s].boundaryMinorId:void 0,folder_id:r.id,filter:s,extended:1,group_id:(0,a.getOwnerGroupId)(u)};break}default:(0,d.exhaustivenessCheck)(l)}return e.locks.getConversations[p]=!0,[(s=(0,r._)((function*({api:e}){try{if(!h)throw new Error("Нет параметров запроса");const s=o.CONVOS_PER_PAGE,r=yield e.fetch("messages.getConversations",(0,n._)({},h,{count:s}),{retries:3});return(0,n._)({},t,{type:"MoreConvosNeeded_RequestCompleted",hasFailed:!1,requestedCount:s,hasMore:r.items.length>=s,response:r})}catch(e){return(0,n._)({},t,{type:"MoreConvosNeeded_RequestCompleted",hasMore:!1,hasFailed:!0})}})),function(e){return s.apply(this,arguments)})]}case"MoreConvosNeeded_RequestCompleted":{const{hasFailed:s,organiser:r,hasMore:n}=t;let o="";switch(r.kind){case"filters":o=i.getLockId(r.filter);break;case"folders":o=c.getLockId(r.id,r.filter);break;default:(0,d.exhaustivenessCheck)(r)}if(e.locks.getConversations[o]=!1,s)return[];const{response:l}=t;if(l){const t=(0,a.insertConvos)(e,l.items,{dangerouslyMerge:!0});switch((0,a.insertPeers)(e,{apiUsers:l.profiles||[],apiGroups:l.groups||[],apiContacts:l.contacts||[]}),r.kind){case"filters":i.push(e.organisers.filters,r.filter,t,n);break;case"folders":if(!e.organisers.folders.find((e=>e.id===r.id)))return[];c.push(e.organisers.folders,r.id,r.filter,t,n);break;default:(0,d.exhaustivenessCheck)(r)}}return[]}default:(0,d.exhaustivenessCheck)(t)}var s}},38872:(e,t,s)=>{s.d(t,{handler:()=>l});var r=s(11010),n=s(89131),a=s(777634),o=s(185327),i=s(168465),d=s(991792),c=s(858289);const l=(e,t,s)=>{if(!s.vkm_reactions)return[];switch(t.type){case"PollConvoReactions":{const{peerId:s,fromCmid:n,toCmid:a}=t,o=e.convos.get(s);if(!o)return[];const c=i.around(o.history,n);if(void 0===c)return[];const u=null!=a?a:i.lastCmid(o.history),h=c.nodes.reduce(((e,t)=>{const s="Node"===t.kind?t.item.cmid:void 0;return void 0!==s&&s>=n&&(void 0===u||s<=u)&&e.push(s),e}),[]).slice(-100),p=e.ownerId;return[(l=(0,r._)((function*({api:e}){try{const t=yield e.fetch("messages.getMessagesReactions",{peer_id:s,cmids:h.join(","),extended:1,group_id:(0,d.getOwnerGroupId)(p)});return{type:"PollConvoReactions_RequestSucceed",peerId:s,cmids:h,apiResponse:t}}catch(e){}return{type:"Noop"}})),function(e){return l.apply(this,arguments)})]}case"PollConvoReactions_RequestSucceed":{const{peerId:s,apiResponse:n,cmids:i}=t;(0,d.insertPeers)(e,{apiUsers:n.profiles||[],apiGroups:n.groups||[],apiContacts:n.contacts||[]});const l=e.convos.get(s);if(!l)return[];const u=new Set(n.items.map((e=>a.resolveCmid(e.cmid))));let h=!1;i.filter((e=>!u.has(e))).forEach((e=>{const t=o.findMessageByCmid(l,a.resolveCmid(e));"Normal"===(null==t?void 0:t.kind)&&0!==t.reactions.size&&a.setReactions(t,[])}));for(const{cmid:t,counters:s}of n.items){const r=o.findMessageByCmid(l,a.resolveCmid(t));if("Normal"!==(null==r?void 0:r.kind))continue;const n=(0,c.fromApiMessageReactions)(s);a.setReactions(r,Array.from(n.values())),h||(h=Array.from(n.keys()).some((t=>!e.messageReactions.has(t))))}return h?[(0,r._)((function*(){return{type:"InvalidateMessageReactions",force:!0}}))]:[]}default:(0,n.exhaustivenessCheck)(t)}var l}},192241:(e,t,s)=>{s.d(t,{handler:()=>i});var r=s(11010),n=s(434788),a=s(96190),o=s(882670);const i=(e,t)=>{const{next:s}=t;if("Reconnecting"===s.kind)return[(i=(0,r._)((function*({queue:e}){return{type:"QueueBatchReceived",next:yield e.poll()}})),function(e){return i.apply(this,arguments)})];var i;if("Disconnected"===s.kind){if("manual"===s.reason)return[];const t=e.viewer.id;return[function(){var e=(0,r._)((function*({queue:e,api:s}){const r=yield s.fetch("queue.subscribe",{queue_ids:`onlfriends_${t},accountcounters_${t}`},{retries:1/0});return e.connect((0,n._)({user_id:a.toRealId(t)},r)),{type:"QueueBatchReceived",next:yield e.poll()}}));return function(t){return e.apply(this,arguments)}}()]}for(const t of s.events)switch(t.entity_type){case"online":const s=a.resolveId(t.data.user_id);if(!a.isUserPeerId(s))break;t.data.online?e.onlines.add(s):e.onlines.delete(s);const r=e.peers.get(s);if(!r||"User"!==r.kind)break;a.updateLastSeen(r,{at:1e3*t.data.last_seen,platform:(0,o.convertPlatform)(t.data.platform,t.data.app_id)});break;case"accountcounters":if("calls"===t.data.type)e.activeCallsCount=t.data.count;else{t.data.type}break;default:}return[function(){var e=(0,r._)((function*({queue:e}){return{type:"QueueBatchReceived",next:yield e.poll()}}));return function(t){return e.apply(this,arguments)}}()]}},939903:(e,t,s)=>{s.d(t,{handler:()=>i});var r=s(11010),n=s(89131),a=s(498928),o=s(991792);const i=(e,t)=>{switch(t.type){case"ResetUpdatesCounter":{const t=e.ownerId;return[(0,r._)((function*({api:e}){try{return{type:"ResetUpdatesCounter_RequestCompleted",hasFailed:!(yield e.fetch("messages.resetUpdatesCounter",{group_id:(0,o.getOwnerGroupId)(t)}))}}catch(e){return{type:"ResetUpdatesCounter_RequestCompleted",hasFailed:!0}}}))]}case"ResetUpdatesCounter_RequestCompleted":{const{hasFailed:n}=t;return n?[]:(a.updateCounters(e.organisers.filters,{headerNotMutedUnread:0}),[(s=(0,r._)((function*({notification:e}){return e.setCounters({unreadIdle:0}),{type:"Noop"}})),function(e){return s.apply(this,arguments)})])}default:(0,n.exhaustivenessCheck)(t)}var s}},526025:(e,t,s)=>{s.d(t,{handler:()=>a});var r=s(11010),n=s(89131);const a=(e,t)=>{const{type:s}=t;switch(s){case"SettingThemeUpdated":{e.locks.settings.add("theme");const s=e.viewer.settings.theme;return e.viewer.settings.theme=t.value,[(a=(0,r._)((function*(e){try{return e.storage.set("theme",t.value),{type:"SettingThemeUpdated_RequestCompleted",hasFailed:!1,previousValue:s}}catch(e){return{type:"SettingThemeUpdated_RequestCompleted",hasFailed:!0,previousValue:s}}})),function(e){return a.apply(this,arguments)})]}case"SettingThemeUpdated_RequestCompleted":return e.locks.settings.delete("theme"),t.hasFailed&&(e.viewer.settings.theme=t.previousValue),[];default:(0,n.exhaustivenessCheck)(s)}var a}},695247:(e,t,s)=>{s.d(t,{handler:()=>a});var r=s(11010),n=s(89131);const a=(e,t)=>{const{type:s}=t;switch(s){case"UserChangedBrowserNotifications":{e.locks.settings.add("browserNotifications");const s=e.viewer.settings.browserNotifications;return e.viewer.settings.browserNotifications=t.value,[(a=(0,r._)((function*(e){try{return e.storage.set("settings-browser-notifications-on",t.value),{type:"UserChangedBrowserNotifications_RequestCompleted",hasFailed:!1,previousValue:s}}catch(e){return{type:"UserChangedBrowserNotifications_RequestCompleted",hasFailed:!0,previousValue:s}}})),function(e){return a.apply(this,arguments)})]}case"UserChangedBrowserNotifications_RequestCompleted":return e.locks.settings.delete("browserNotifications"),t.hasFailed&&(e.viewer.settings.browserNotifications=t.previousValue),[];default:(0,n.exhaustivenessCheck)(s)}var a}},584781:(e,t,s)=>{s.d(t,{handler:()=>c});var r=s(11010),n=s(89131),a=s(839963),o=s(83062);const i={archive:"archive",unarchive:"unarchive",join:"join",leave:"join",mute:"mute",unmute:"unmute",mark_read:"mark_read"},d={archive:"unarchive",unarchive:"archive",join:"leave",leave:"join",mute:"unmute",unmute:"mute"},c=(e,t,s)=>{const{type:i}=t;switch(i){case"UserChangedChannel":{const{channelId:s,userAction:i}=t,d=l(t.userAction,s);if(e.locks.channelActions.has(d))return[];e.locks.channelActions.add(d);const c=e.channels.get(s);if(!c)return[];let h;switch(i){case"archive":a.setArchived(c,!0),o.refreshChannels(e.organisers,c),h=e=>e.fetch("channels.archive",{channel_ids:String(s)}).then((e=>Boolean(e)));break;case"unarchive":a.setArchived(c,!1),o.refreshChannels(e.organisers,c),h=e=>e.fetch("channels.unarchive",{channel_ids:String(s),extended:1}).then((e=>Boolean(e)));break;case"join":a.setMembership(c,!0),o.refreshChannels(e.organisers,c),h=e=>e.fetch("channels.join",{channel_id:s,extended:1}).then((e=>Boolean(e)));break;case"leave":a.setMembership(c,!1),o.refreshChannels(e.organisers,c),h=e=>e.fetch("channels.leave",{channel_id:s});break;case"mute":a.setMuted(c,!0),h=e=>e.fetch("channels.setNotificationMode",{channel_id:s,mode:"disabled"}).then((e=>Boolean(e)));break;case"unmute":a.setMuted(c,!1),h=e=>e.fetch("channels.setNotificationMode",{channel_id:s,mode:"enabled"}).then((e=>Boolean(e)));break;case"mark_read":{const e=a.lastPost({channel:c,withPending:!1});if(e){const t=e.cmid;c.inReadCmid=t,h=e=>e.fetch("channels.markAsRead",{last_read_cmid:t,channel_id:s})}break}default:(0,n.exhaustivenessCheck)(i)}return[(u=(0,r._)((function*({api:e}){try{let t=!1;return h&&(t=!(yield h(e))),{type:"UserChangedChannel_RequestCompleted",channelId:s,hasFailed:t,userAction:i}}catch(e){return{type:"UserChangedChannel_RequestCompleted",channelId:s,hasFailed:!0,userAction:i}}})),function(e){return u.apply(this,arguments)})]}case"UserChangedChannel_RequestCompleted":{const{channelId:r,userAction:n,hasFailed:a}=t,o=l(n,r);e.locks.channelActions.delete(o);const i=d[n];return a&&i&&(c(e,{type:"UserChangedChannel",userAction:i,channelId:r},s),e.locks.channelActions.delete(o)),[]}default:(0,n.exhaustivenessCheck)(i)}var u},l=(e,t)=>`${i[e]}-${t.toString()}`},637467:(e,t,s)=>{s.d(t,{handler:()=>c});var r=s(11010),n=s(434788),a=s(559360),o=s(89131),i=s(453934),d=s(29064);const c=(e,t)=>{const{channelId:s}=t;var c;const l=null!=(c=e.channelComposerDrafts[s])?c:a.empty();let u=a.empty();switch(t.type){case"UserChangedChannelComposerDraft":switch(t.kind){case"text":{const{text:e,visibility:s,donutDelay:r,topic:a,date:o,sendOptions:i,resetSendOptions:d}=t;u=(0,n._)({},l,{text:null!=e?e:l.text,visibility:s||l.visibility,donutDelay:r||l.donutDelay,topic:a||l.topic,date:o,sendOptions:i||l.sendOptions,resetSendOptions:d||l.resetSendOptions});break}case"addAttaches":case"removeAttach":case"removeVoice":case"startUploading":case"removeUploads":case"rearrangeAttaches":const e=(0,d.applyAttachmentActions)(l,t);u=(0,n._)({},l,e);break;default:(0,o.exhaustivenessCheck)(t)}break;case"UserClearedChannelComposerDraft":break;default:(0,o.exhaustivenessCheck)(t)}!u.text&&0===Object.keys(u.attaches).length&&0===u.uploadsTrackIds.size&&"all"===u.visibility&&"no_theme"===u.topic&&void 0===u.date&&-1===u.donutDelay&&0===u.sendOptions.selected.length&&0===u.sendOptions.disabled.length&&0===u.resetSendOptions.length?delete e.channelComposerDrafts[s]:e.channelComposerDrafts[s]=u;const h=(0,i.current)(e.channelComposerDrafts);return[(0,r._)((function*({storage:e}){return e.set("channels-drafts",h),{type:"Noop"}}))]}},12190:(e,t,s)=>{s.d(t,{handler:()=>c});var r=s(11010),n=s(89131),a=s(839963),o=s(168465);const i={delete:"delete",restore:"restore"},d={restore:"delete",delete:"restore"},c=(e,t,s)=>{const{type:i}=t;switch(i){case"UserChangedChannelPost":{const{channelId:s,cmid:i,userAction:d}=t,c=l(t.userAction,s,i);if(e.locks.channelPostActions.has(c))return[];e.locks.channelPostActions.add(c);const h=e.channels.get(s);if(!h)return[];const p=o.findNodeByCmid(h.history,i);if("NotLoaded"===p.status)return[];let m;switch(d){case"delete":if("Deleted"===p.status)break;a.deletePost(h,i,!0),m=e=>e.fetch("wall.delete",{owner_id:s,post_id:i}).then((e=>Boolean(e)));break;case"restore":if("Deleted"!==p.status)break;a.restorePost(h,i),m=e=>e.fetch("wall.restore",{owner_id:s,post_id:i}).then((e=>Boolean(e)));break;default:(0,n.exhaustivenessCheck)(d)}return[(u=(0,r._)((function*({api:e}){try{let t=!1;return m&&(t=!(yield m(e))),{type:"UserChangedChannelPost_RequestCompleted",channelId:s,cmid:i,hasFailed:t,userAction:d}}catch(e){return{type:"UserChangedChannelPost_RequestCompleted",channelId:s,cmid:i,hasFailed:!0,userAction:d}}})),function(e){return u.apply(this,arguments)})]}case"UserChangedChannelPost_RequestCompleted":{const{channelId:r,cmid:n,userAction:a,hasFailed:o}=t,i=l(a,r,n);e.locks.channelPostActions.delete(i);const u=d[a];return o&&u&&(c(e,{type:"UserChangedChannelPost",userAction:u,channelId:r,cmid:n},s),e.locks.channelPostActions.delete(i)),[]}default:(0,n.exhaustivenessCheck)(i)}var u},l=(e,t,s)=>`${i[e]}-${t.toString()}-${s}`},623022:(e,t,s)=>{s.d(t,{handler:()=>c});var r=s(11010),n=s(89131),a=s(96190),o=s(185327),i=s(197934),d=s(991792);const c=(e,t)=>{const{type:s}=t;switch(s){case"UserChangedChatTitle":{const{peerId:s,title:n}=t,o=a.toRealId(s),i=e.peers.get(s),c=e.ownerId;if(!i||"Chat"!==i.kind)return[];const l=i.title;return a.updateChatInfo(i,{title:n}),[(h=(0,r._)((function*({api:e}){try{const t=yield e.fetch("messages.editChat",{chat_id:o,title:n,group_id:(0,d.getOwnerGroupId)(c)},{retries:1});return{type:"UserChangedChatTitle_RequestCompleted",hasFailed:1!==t,peerId:s,title:1!==t?l:n}}catch(e){return{type:"UserChangedChatTitle_RequestCompleted",hasFailed:!0,peerId:s,title:l}}})),function(e){return h.apply(this,arguments)})]}case"UserChangedChatTitle_RequestCompleted":{const{peerId:s,title:r,hasFailed:n}=t,o=e.peers.get(s);return o&&"Chat"===o.kind&&n?(a.updateChatInfo(o,{title:r}),[]):[]}case"UserChangedChatDescription":{const{peerId:s,description:n}=t,i=a.toRealId(s),c=e.convos.get(s),l=e.ownerId;if(!c||"ChatConvo"!==c.kind&&"GroupConvo"!==c.kind)return[];const u=c.description;return o.setDescription(c,n),[function(){var e=(0,r._)((function*({api:e}){try{const t=yield e.fetch("messages.editChat",{chat_id:i,description:n,group_id:(0,d.getOwnerGroupId)(l)},{retries:1});return{type:"UserChangedChatDescription_RequestCompleted",hasFailed:1!==t,peerId:s,description:1!==t?u:n}}catch(e){return{type:"UserChangedChatDescription_RequestCompleted",hasFailed:!0,peerId:s,description:u}}}));return function(t){return e.apply(this,arguments)}}()]}case"UserChangedChatDescription_RequestCompleted":{const{peerId:s,description:r,hasFailed:n}=t,a=e.convos.get(s);return!a||"ChatConvo"!==a.kind&&"GroupConvo"!==a.kind?[]:n?(o.setDescription(a,r),[]):[]}case"UserSetChatPhoto":{var c,l,u;const{peerId:s,photo:r}=t,n=e.peers.get(s);return n&&"Chat"===n.kind?(a.updateChatInfo(n,{photo50:null==(c=i.preview(r,50,50))?void 0:c.url,photo100:null==(l=i.preview(r,100,100))?void 0:l.url,photo200:null==(u=i.preview(r,200,200))?void 0:u.url}),[]):[]}case"UserRemovedChatPhoto":{const{peerId:s}=t,n=e.ownerId,o=a.toRealId(s),i=e.peers.get(s);return i&&"Chat"===i.kind?(a.updateChatInfo(i,{photo50:void 0,photo100:void 0,photo200:void 0}),[function(){var e=(0,r._)((function*({api:e}){try{return yield e.fetch("messages.deleteChatPhoto",{chat_id:o,group_id:(0,d.getOwnerGroupId)(n)},{retries:1}),{type:"UserRemovedChatPhoto_RequestCompleted",hasFailed:!1,peerId:s}}catch(e){return{type:"UserRemovedChatPhoto_RequestCompleted",hasFailed:!0,peerId:s}}}));return function(t){return e.apply(this,arguments)}}()]):[]}case"UserRemovedChatPhoto_RequestCompleted":return[];case"UserChangedChatSettings":{const{peerId:s,isService:n,permissions:o}=t,i=a.toRealId(s),c=e.ownerId;return[function(){var e=(0,r._)((function*({api:e}){try{return{type:"UserChangedChatSettings_RequestCompleted",hasFailed:1!==(yield e.fetch("messages.editChat",{chat_id:i,is_service:n?1:0,permissions:JSON.stringify(o),group_id:(0,d.getOwnerGroupId)(c)},{retries:1})),permissions:o,peerId:s,isService:n}}catch(e){return{type:"UserChangedChatSettings_RequestCompleted",hasFailed:!0,permissions:o,peerId:s,isService:n}}}));return function(t){return e.apply(this,arguments)}}()]}case"UserChangedChatSettings_RequestCompleted":{const{peerId:s,isService:r,permissions:n,hasFailed:a}=t;if(a)return[];const i=e.convos.get(s);return i&&"ChatConvo"===i.kind?(o.setChatPermissions(i,n,r),[]):[]}default:(0,n.exhaustivenessCheck)(s)}var h}},541222:(e,t,s)=>{s.d(t,{handler:()=>d});var r=s(11010),n=s(89131),a=s(96190),o=s(185327),i=s(991792);const d=(e,t)=>{switch(t.type){case"UserChangedChatMember":{const{peerId:o,memberId:d,userAction:c}=t;if(!e.convos.get(o))return[];const l=function(e,t){const{userAction:s,peerId:r,memberId:o}=t;switch(s){case"promote":return({api:e})=>e.fetch("messages.setMemberRole",{member_id:o,peer_id:r,role:"admin"});case"demote":return({api:e})=>e.fetch("messages.setMemberRole",{member_id:o,peer_id:r,role:"member"});case"cancel_invitation":case"remove":return({api:t})=>t.fetch("messages.removeChatUser",{chat_id:a.toRealId(r),member_id:o,group_id:(0,i.getOwnerGroupId)(e)});default:return(0,n.exhaustivenessCheck)(s)}}(e.ownerId,t);return[(s=(0,r._)((function*(e){try{return{type:"UserChangedChatMember_RequestCompleted",hasFailed:1!==(yield l(e)),peerId:o,memberId:d,userAction:c}}catch(e){return{type:"UserChangedChatMember_RequestCompleted",hasFailed:!0,peerId:o,memberId:d,userAction:c}}})),function(e){return s.apply(this,arguments)})]}case"UserChangedChatMember_RequestCompleted":{const{peerId:s,memberId:r,userAction:n,hasFailed:i}=t,d=e.convos.get(s);return i||"ChatConvo"!==(null==d?void 0:d.kind)?[]:("cancel_invitation"===n&&o.removeMember(d,r),a.isContactPeerId(r)||("promote"===n&&o.addAdmin(d,r),"demote"===n&&o.removeAdmin(d,r),"remove"===n&&o.removeMember(d,r)),[])}default:return(0,n.exhaustivenessCheck)(t)}var s}},601289:(e,t,s)=>{s.d(t,{handler:()=>l});var r=s(11010),n=s(434788),a=s(89131),o=s(86144),i=s(866358),d=s(168465);const c={delete:"delete",restore:"delete"},l=(e,t,s)=>{const{type:c,channelId:h,postCmid:p,commentCmid:m,replyCmid:f,userAction:g}=t,v=u(g,h,p,f||m);let C;const _=e.channels.get(h),y=_&&d.findNodeByCmid(_.history,p).node,k="Node"===(null==y?void 0:y.kind)&&y.item,I=k&&o.findCommentByCmid(k,m);if(!I)return[];if(f){const e=i.findReplyByCmid(I,f);if(!e||"Deleted"===e.kind)return[];C=e}else C=I;switch(c){case"UserDeleteComment":{if(e.locks.commentActions.has(v)||"Normal"!==C.kind)return[];e.locks.commentActions.add(v);const s=i.markDeleted(C);return f?i.replaceReply(I,s):o.replaceComment(k,s),[(R=(0,r._)((function*({api:e}){try{const r=yield e.fetch("wall.deleteComment",{owner_id:h,comment_id:s.cmid});return(0,n._)({},t,{type:"UserDeleteComment_RequestCompleted",hasFailed:!Boolean(r),deletedComment:s})}catch(e){return(0,n._)({},t,{type:"UserDeleteComment_RequestCompleted",hasFailed:!0,deletedComment:s})}})),function(e){return R.apply(this,arguments)})]}case"UserRestoreComment":{if(e.locks.commentActions.has(v)||"MarkedDeleted"!==C.kind)return[];e.locks.commentActions.add(v);const s=i.restoreDeleted(C);return f?i.replaceReply(I,s):o.replaceComment(k,s),[(M=(0,r._)((function*({api:e}){try{const r=yield e.fetch("wall.restoreComment",{owner_id:h,comment_id:s.cmid});return(0,n._)({},t,{type:"UserRestoreComment_RequestCompleted",hasFailed:!Boolean(r)})}catch(e){return(0,n._)({},t,{type:"UserRestoreComment_RequestCompleted",hasFailed:!0})}})),function(e){return M.apply(this,arguments)})]}case"UserDeleteComment_RequestCompleted":case"UserRestoreComment_RequestCompleted":{const{hasFailed:r}=t;return e.locks.commentActions.delete(v),r&&l(e,(0,n._)({},t,"delete"===g?{type:"UserRestoreComment",userAction:"restore"}:{type:"UserDeleteComment",userAction:"delete"}),s),e.locks.commentActions.delete(v),[]}default:(0,a.exhaustivenessCheck)(t)}var M,R},u=(e,t,s,r)=>`${c[e]}-${t}-${s}-${r}`},29064:(e,t,s)=>{s.d(t,{applyAttachmentActions:()=>f,handler:()=>m});var r=s(11010),n=s(434788),a=s(400681),o=s(777634),i=s(197934),d=s(89131),c=s(453934),l=s(991792),u=s(481186),h=s(54965),p=s(851828);const m=(e,t)=>{const{peerId:s}=t;var i;const m=null!=(i=void 0!==s?e.composerDrafts[s]:null)?i:(0,c.castDraft)(a.empty());let g=a.empty();switch(t.type){case"UserChangedComposerDraft":switch(t.kind){case"text":{const{text:e}=t;g=(0,n._)({},m,{text:null!=e?e:m.text});break}case"addAttaches":case"removeAttach":case"removeVoice":case"startUploading":case"removeUploads":case"rearrangeAttaches":const e=f(m,t);g=(0,n._)({},m,e);break;case"editing":{const{editing:e}=t;g={editing:e,text:o.toRawText(e),attaches:e.attaches,uploadsTrackIds:m.uploadsTrackIds,forward:e.forwardedMessages&&{kind:"message",items:e.forwardedMessages},reply:e.replyMessage};break}case"forward":{const{forward:e,isForwardAuthorHidden:s}=t;g=(0,n._)({},e&&m.editing?a.empty():m,{reply:void 0,forward:e,isForwardAuthorHidden:null!=s?s:a.DEFAULT_FORWARD_AUTHOR_HIDDEN});break}case"reply":{const{reply:e}=t;g=(0,n._)({},e&&m.editing?a.empty():m,{forward:void 0,reply:e});break}default:(0,d.exhaustivenessCheck)(t)}break;case"UserClearedComposerDraft":break;case"ComposerDraftsUpdateNeeded":{const{cmidsToDelete:s,itemsToReplace:r,foreignKind:n}=t,{editing:a,reply:o}=m;if("message"===n){if(void 0!==a&&(null==s?void 0:s.includes(a.cmid)))break;if(void 0===a&&void 0!==o)if(null==s?void 0:s.includes(o.cmid))m.reply=void 0;else{const e=null==r?void 0:r.find((e=>e.cmid===o.cmid));void 0!==e&&(m.reply=e)}}[m,...Object.values(e.composerDrafts)].forEach((e=>{const{forward:t,editing:a}=e;if(void 0===a&&void 0!==t&&t.kind===n){const n=(e=[],s=[])=>(0,d.toNonEmpty)([...t.items].reduce(((t,r)=>{const n=s.find((e=>e.cmid===r.cmid));return void 0!==n?(t.push(n),t):(e.includes(r.cmid)||t.push(r),t)}),[])),a=n(s,r),o=null!==a?{kind:t.kind,items:a}:void 0;e.forward=o}})),g=m;break}case"ActualizeComposerDraft":{const t=e.ownerId,n=(0,c.isDraft)(m)?(0,c.current)(m):m;return[(0,r._)((function*({api:e}){const{reply:r,forward:a}=n,o=[...r?[r]:[],..."message"===(null==a?void 0:a.kind)?a.items:[]].reduce(((e,t)=>("Foreign"!==t.kind&&"ForeignExpired"!==t.kind&&e.push(t),e)),[]);if(o.length>0&&o[0]){const s=o[0].peerId,r=o.reduce(((e,t)=>{if(t.peerId!==s){if(d.isDev)throw new Error("Перессылаемые сообщения не из одного чата");return e}return e.push(t.cmid),e}),[]);try{const n=yield e.fetch("messages.getByConversationMessageId",{peer_id:s,conversation_message_ids:r.join(","),extended:1,group_id:(0,l.getOwnerGroupId)(t)});return{type:"ActualizeComposerDraft_RequestCompleted",peerId:s,foreignKind:"message",foreignCmids:r,response:n}}catch(e){}}if("post"===(null==a?void 0:a.kind)){const{channelId:t}=a.items[0],r=a.items.reduce(((e,s)=>{if(s.channelId!==t){if(d.isDev)throw new Error("Перессылаемые посты не из одного канала");return e}return e.push(s.cmid),e}),[]);try{const n=yield e.fetch("channels.getMessagesById",{channel_id:t,cmids:r.join(","),extended:1});return{type:"ActualizeComposerDraft_RequestCompleted",peerId:s,foreignKind:"post",foreignCmids:r,response:n}}catch(e){}}if("comment"===(null==a?void 0:a.kind)){const{channelId:t,postCmid:r}=a.items[0],n=[...a.items].reduce(((e,s)=>{if(s.channelId!==t||s.postCmid!==r){if(d.isDev)throw new Error("Пересылаемые комменты не из одного поста или даже не из одного канала");return e}return e.push(s.cmid),e}),[]);try{const a=yield e.fetchMany(n.map((e=>({method:"wall.getComments",params:{owner_id:t,post_id:r,start_comment_id:e,count:1,offset:0,extended:1}}))));return{type:"ActualizeComposerDraft_RequestCompleted",peerId:s,foreignKind:"comment",foreignCmids:n,response:a}}catch(e){}}return{type:"Noop"}}))]}case"ActualizeComposerDraft_RequestCompleted":{const{response:n,foreignKind:a,foreignCmids:o}=t;switch(a){case"message":{const{profiles:t,groups:a,contacts:i}=n;(0,l.insertPeers)(e,{apiUsers:t||[],apiGroups:a||[],apiContacts:i||[]});const d=n.items.reduce(((e,t)=>{if(t.deleted)return e;const s=(0,u.fromApiMessage)(t).message;return"Normal"===s.kind&&e.push(s),e}),[]),c=o.filter((e=>{const t=d.find((t=>(null==t?void 0:t.cmid)===e));return"Normal"!==(null==t?void 0:t.kind)}));return c.length>0?[(0,r._)((function*(){return{type:"ComposerDraftsUpdateNeeded",foreignKind:"message",cmidsToDelete:c,itemsToReplace:d,peerId:s}}))]:[]}case"post":{const{profiles:t,groups:a,items:i}=n;var v;(0,l.insertPeers)(e,{apiUsers:t||[],apiGroups:a||[],apiContacts:[]});const d=null!=(v=null==i?void 0:i.map((e=>(0,h.fromApiPost)(e).post)))?v:[],c=o.filter((e=>void 0===d.find((t=>t.cmid===e))));return c.length>0?[(0,r._)((function*(){return{type:"ComposerDraftsUpdateNeeded",foreignKind:"post",cmidsToDelete:c,itemsToReplace:d,peerId:s}}))]:[]}case"comment":{const t=n.reduce(((t,s)=>{const{profiles:r,groups:n,items:a}=s;return(0,l.insertPeers)(e,{apiUsers:r||[],apiGroups:n||[],apiContacts:[]}),a.forEach((e=>{const s=(0,p.fromApiComment)(e);"Normal"===s.kind&&t.push(s)})),t}),[]),a=o.filter((e=>void 0===t.find((t=>t.cmid===e))));return a.length>0?[(0,r._)((function*(){return{type:"ComposerDraftsUpdateNeeded",foreignKind:"comment",cmidsToDelete:a,itemsToReplace:t,peerId:s}}))]:[]}default:return(0,d.exhaustivenessCheck)(a)}}default:(0,d.exhaustivenessCheck)(t)}const C=!(g.text||g.forward||g.reply||g.editing||0!==Object.keys(g.attaches).length||0!==g.uploadsTrackIds.size);void 0!==s&&(C?delete e.composerDrafts[s]:e.composerDrafts[s]=g);const _=(0,c.current)(e.composerDrafts);return[(0,r._)((function*({storage:e}){return e.set("drafts",_),{type:"Noop"}}))]};function f(e,t){switch(t.kind){case"addAttaches":{const{attaches:s,trackIds:r}=t;let n=e.attaches;s&&(n=(0,c.produce)(n,(e=>{i.addAttach(e,s)})));let a=e.uploadsTrackIds;return(null==r?void 0:r.length)&&(a=(0,c.produce)(a,(e=>{r.forEach((t=>{e.delete(t)}))}))),{attaches:n,uploadsTrackIds:a}}case"removeAttach":{const{attach:s}=t;let r=e.attaches;return s&&(r=(0,c.produce)(r,(e=>{i.removeAttach(e,s)}))),{attaches:r}}case"removeVoice":return{attaches:(0,c.produce)(e.attaches,(e=>{e.voice&&delete e.voice}))};case"startUploading":{const{trackIds:s}=t;return{uploadsTrackIds:new Set([...e.uploadsTrackIds,...s])}}case"removeUploads":{const{trackIds:s}=t;return{uploadsTrackIds:(0,c.produce)(e.uploadsTrackIds,(e=>{s.forEach((t=>{e.delete(t)}))}))}}case"rearrangeAttaches":{const{key:s,currentPosition:r,newPosition:n}=t;let a=e.attaches;return-1!==n&&n!==r&&(a=(0,c.produce)(a,(e=>{i.rearrangeAttaches(e,{currentPosition:r,newPosition:n},s)}))),{attaches:a}}default:(0,d.exhaustivenessCheck)(t)}}},598801:(e,t,s)=>{s.d(t,{handler:()=>p});var r=s(11010),n=s(185327),a=s(96190),o=s(83062),i=s(777634),d=s(89131),c=s(453934),l=s(991792);const u={mute:"mute",unmute:"mute",mute_until:"mute_until",pin:"pin",unpin:"pin",mark_read:"mark_read",mark_unread:"mark_read",archive:"archive",unarchive:"archive",clear:"clear",leave:"leave",leave_and_clear:"leave_and_clear",show_pinned_message:"show_pinned_message",hide_pinned_message:"show_pinned_message",show_bot_keyboard:"show_bot_keyboard",hide_bot_keyboard:"hide_bot_keyboard",pin_message_for_all:"pin_message_for_all",unpin_message_for_all:"pin_message_for_all",ban:"ban",unban:"unban",return_to_chat:"return_to_chat",business_notify_enable:"business_notify_enable",business_notify_disable:"business_notify_enable"},h={pin:"unpin",unpin:"pin",mark_read:"mark_unread",mark_unread:"mark_read",archive:"unarchive",unarchive:"archive",show_pinned_message:"hide_pinned_message",hide_pinned_message:"show_pinned_message",show_bot_keyboard:"hide_bot_keyboard",hide_bot_keyboard:"show_bot_keyboard"},p=(e,t,s)=>{const{type:u}=t;switch(u){case"UserChangedConvo":{const{peerId:s,userAction:i}=t,{organisers:c}=e,u=e.viewer.id,h=m(t.userAction,s);if(e.locks.convoActions.has(h))return[];e.locks.convoActions.add(h);const p=e.convos.get(s),f=e.peers.get(s),v=e.ownerId;if(!p||!f)return[];let C;switch(i){case"pin":C=e=>e.fetch("messages.pinConversation",{peer_id:s});break;case"unpin":C=e=>e.fetch("messages.unpinConversation",{peer_id:s});break;case"mark_read":p.isMarkedUnread=!1,C=e=>e.fetch("messages.markAsRead",{peer_id:s,mark_conversation_as_read:1,group_id:(0,l.getOwnerGroupId)(v)});break;case"mark_unread":p.isMarkedUnread=!0,C=e=>e.fetch("messages.markAsUnreadConversation",{peer_id:s,group_id:0});break;case"archive":case"unarchive":p.isArchived="archive"===i,o.refresh(c,p),C=e=>e.fetch("archive"===i?"messages.archiveConversation":"messages.unarchiveConversation",{peer_id:s});break;case"hide_pinned_message":"ChatConvo"===p.kind&&p.pinnedMessage&&e.hiddenPinnedMessages.set(t.peerId,p.pinnedMessage.cmid);break;case"show_pinned_message":e.hiddenPinnedMessages.delete(t.peerId);break;case"hide_bot_keyboard":e.hiddenBotKeyboards.add(t.peerId);break;case"show_bot_keyboard":e.hiddenBotKeyboards.delete(t.peerId);break;case"clear":C=e=>e.fetch("messages.deleteConversation",{peer_id:s,group_id:(0,l.getOwnerGroupId)(v)}).then((({last_deleted_id:e})=>Boolean(e)));break;case"leave":case"leave_and_clear":{if("ChatConvo"!==p.kind)break;C=e=>e.fetch("messages.removeChatUser",{chat_id:a.toRealId(s),user_id:a.toRealId(u),group_id:(0,l.getOwnerGroupId)(v)});const t=e.peers.get(s);if(!t||"Chat"!==t.kind)break;n.clearChatDataOnLeave(p),a.clearChatDataOnLeave(t);break}case"ban":if(!("User"===f.kind&&"UserConvo"===p.kind||"Group"===f.kind&&"GroupConvo"===p.kind))break;a.updateIsPeerBlacklistedByMe(f,!0),"UserConvo"===p.kind&&n.restrictWrite(p,"peer_blacklisted_by_me"),C=a.isGroupPeerId(v)?e=>e.fetch("groups.ban",{owner_id:s,group_id:(0,l.getOwnerGroupId)(v)}):a.isGroupPeerId(s)?e=>e.fetch("messages.denyMessagesFromGroup",{group_id:a.toRealId(s)}):e=>e.fetch("account.ban",{owner_id:s});break;case"unban":if(!("User"===f.kind&&"UserConvo"===p.kind||"Group"===f.kind&&"GroupConvo"===p.kind))break;a.updateIsPeerBlacklistedByMe(f,!1),"UserConvo"===p.kind&&n.allowWrite(p),C=a.isGroupPeerId(v)?e=>e.fetch("groups.unban",{owner_id:s,group_id:(0,l.getOwnerGroupId)(v)}):a.isGroupPeerId(s)?e=>e.fetch("messages.allowMessagesFromGroup",{group_id:a.toRealId(s)}):e=>e.fetch("account.unban",{owner_id:s});break;case"return_to_chat":C=e=>e.fetch("messages.addChatUser",{chat_id:a.toRealId(s),user_id:a.toRealId(u)}).then((({result:e})=>Boolean(e)));break;default:(0,d.exhaustivenessCheck)(i)}return[(g=(0,r._)((function*({api:e}){try{let t=!1;return C&&(t=!(yield C(e))),{type:"UserChangedConvo_RequestCompleted",hasFailed:t,userAction:i,peerId:s}}catch(e){return{type:"UserChangedConvo_RequestCompleted",hasFailed:!0,userAction:i,peerId:s}}})),function(e){return g.apply(this,arguments)})]}case"UserChangedConvo_RequestCompleted":{const{peerId:a,userAction:o,hasFailed:c}=t,l=m(o,a);e.locks.convoActions.delete(l);const u=h[o];if(c&&u)return p(e,{type:"UserChangedConvo",userAction:u,peerId:a},s),[];if(c)return[];switch(o){case"clear":case"pin":case"unpin":case"mark_read":case"mark_unread":case"unarchive":case"show_pinned_message":case"hide_pinned_message":case"show_bot_keyboard":case"hide_bot_keyboard":case"ban":case"unban":return[];case"archive":{const t=e.convos.get(a);if(!t||"ChatConvo"!==t.kind||!t.unreadMentions.size)return[];const s=i.resolveCmid(Math.max(...t.unreadMentions));return[(f=(0,r._)((function*({storage:e}){const t=e.get("archive-mentions-map");return t&&s?(t[a]=s,e.set("archive-mentions-map",t),{type:"Noop"}):{type:"Noop"}})),function(e){return f.apply(this,arguments)})]}case"leave":{const t=e.convos.get(a);return"ChatConvo"===(null==t?void 0:t.kind)&&n.setConvoState(t,"left"),[]}case"leave_and_clear":{const t=e.convos.get(a);return"ChatConvo"!==(null==t?void 0:t.kind)?[]:(n.setConvoState(t,"left"),p(e,{type:"UserChangedConvo",userAction:"clear",peerId:a},s))}case"return_to_chat":{const t=e.convos.get(a);return"ChatConvo"===(null==t?void 0:t.kind)&&n.setConvoState(t,"in"),[]}default:return(0,d.exhaustivenessCheck)(t)}}case"UserChangedMute":{const{peerId:s,timer:n,userAction:a}=t,o=m(t.userAction,s);if(e.locks.convoActions.has(o))return[];const i=e.convos.get(s);if(!i)return[];let c;switch(a){case"mute":i.push={mode:"every-mention",disabledUntil:1/0},c=-1;break;case"unmute":i.push={mode:"everything",disabledUntil:0},c=0;break;case"mute_until":i.push={mode:"every-mention",disabledUntil:Date.now()+1e3*n},c=n;break;default:(0,d.exhaustivenessCheck)(a)}return[function(){var e=(0,r._)((function*({api:e}){try{return{type:"UserChangedMute_RequestCompleted",hasFailed:1!==(yield e.fetch("account.setSilenceMode",{time:c,peer_id:s,sound:"unmute"===a?1:0})),userAction:a,peerId:s}}catch(e){return{type:"UserChangedMute_RequestCompleted",hasFailed:!0,userAction:a,peerId:s}}}));return function(t){return e.apply(this,arguments)}}()]}case"UserChangedMute_RequestCompleted":{const{peerId:r,userAction:n,hasFailed:a}=t,o=m(n,r);e.locks.convoActions.delete(o);const i={mute:"unmute",unmute:"mute",mute_until:"unmute"}[n];return a&&i?(p(e,{type:"UserChangedMute",userAction:i,peerId:r,timer:0},s),[]):[]}case"UserPinMessage":{const{peerId:s,cmid:a,userAction:o}=t,d=m(t.userAction,s);if(e.locks.convoActions.has(d))return[];e.locks.convoActions.add(d);const u=e.convos.get(s),h=e.ownerId;if(!u||"ChatConvo"!==u.kind)return[];const p=u.pinnedMessage&&(0,c.current)(u.pinnedMessage),f=n.findMessageByCmid(u,a);return"Normal"===(null==f?void 0:f.kind)&&n.pinMessage(u,i.toPinned(f)),[function(){var e=(0,r._)((function*({api:e}){try{return yield e.fetch("messages.pin",{peer_id:s,cmid:a,group_id:(0,l.getOwnerGroupId)(h)}),{type:"UserPinMessage_RequestCompleted",hasFailed:!1,userAction:o,peerId:s,cmid:a}}catch(e){return{type:"UserPinMessage_RequestCompleted",hasFailed:!0,userAction:o,pinnedMessage:p,peerId:s,cmid:a}}}));return function(t){return e.apply(this,arguments)}}()]}case"UserPinMessage_RequestCompleted":{const{peerId:s,hasFailed:r,pinnedMessage:a,userAction:o}=t,i=m(o,s);e.locks.convoActions.delete(i);const d=e.convos.get(s);return d&&"ChatConvo"===d.kind?(r&&(n.unpinMessage(d),a&&n.pinMessage(d,a)),[]):[]}case"UserUnpinMessage":{const{peerId:s,userAction:a}=t,o=m(t.userAction,s);if(e.locks.convoActions.has(o))return[];const i=e.convos.get(s),d=e.ownerId;if(!i||"ChatConvo"!==i.kind)return[];const u=(0,c.current)(n.unpinMessage(i));return[function(){var e=(0,r._)((function*({api:e}){try{return yield e.fetch("messages.unpin",{peer_id:s,group_id:(0,l.getOwnerGroupId)(d)}),{type:"UserUnpinMessage_RequestCompleted",hasFailed:!1,userAction:a,peerId:s}}catch(e){return{type:"UserUnpinMessage_RequestCompleted",hasFailed:!0,userAction:a,prevPinnedMessage:u,peerId:s}}}));return function(t){return e.apply(this,arguments)}}()]}case"UserUnpinMessage_RequestCompleted":{const{peerId:s,hasFailed:r,prevPinnedMessage:a,userAction:o}=t,i=m(o,s);e.locks.convoActions.delete(i);const d=e.convos.get(s);return d&&"ChatConvo"===d.kind?(r&&a&&n.pinMessage(d,a),[]):[]}case"UserChangedBusinessNotify":{const{userAction:s,peerId:n}=t,o=m(t.userAction,n);if(e.locks.convoActions.has(o))return[];const i=e.peers.get(n);return"Group"!==(null==i?void 0:i.kind)||i.isBlacklistedByMe&&"business_notify_disable"===s||!i.isBlacklistedByMe&&"business_notify_enable"===s?[]:(a.updateIsPeerBlacklistedByMe(i,"business_notify_disable"===s),[function(){var e=(0,r._)((function*({api:e}){try{return{type:"UserChangedBusinessNotify_RequestCompleted",hasFailed:1!==(yield e.fetch("business_notify_disable"===s?"messages.denyMessagesFromGroup":"messages.allowMessagesFromGroup",{group_id:a.toRealId(n)})),userAction:s,peerId:n}}catch(e){return{type:"UserChangedBusinessNotify_RequestCompleted",hasFailed:!0,userAction:s,peerId:n}}}));return function(t){return e.apply(this,arguments)}}()])}case"UserChangedBusinessNotify_RequestCompleted":{const{userAction:s,peerId:r,hasFailed:n}=t,o=m(s,r);e.locks.convoActions.delete(o);const i=e.peers.get(r);return"Group"!==(null==i?void 0:i.kind)||n&&a.updateIsPeerBlacklistedByMe(i,!i.isBlacklistedByMe),[]}default:(0,d.exhaustivenessCheck)(t)}var f,g},m=(e,t)=>`${u[e]}-${t.toString()}`},708807:(e,t,s)=>{s.d(t,{handler:()=>o});var r=s(11010),n=s(96190),a=s(89131);const o=(e,t)=>{switch(t.type){case"UserChangedFriendship":{const a=e.peers.get(t.userId);if("User"!==(null==a?void 0:a.kind)||e.locks.updateFriendshipOrMembership.has(a.id))return[];const o=a.friendship;return n.updateFriendship(a,t.change),o===a.friendship?[]:(e.locks.updateFriendshipOrMembership.add(a.id),[(s=(0,r._)((function*({api:e}){let s=!1;try{yield e.fetch(`friends.${t.change}`,{user_id:n.toRealId(t.userId)})}catch(e){s=!0}return{type:"UserChangedFriendship_RequestCompleted",userId:t.userId,change:t.change,hasFailed:s}})),function(e){return s.apply(this,arguments)})])}case"UserChangedFriendship_RequestCompleted":{e.locks.updateFriendshipOrMembership.delete(t.userId);const s=e.peers.get(t.userId);return"User"!==(null==s?void 0:s.kind)||t.hasFailed&&n.updateFriendship(s,{add:"delete",delete:"add"}[t.change]),[]}default:return(0,a.exhaustivenessCheck)(t)}var s}},959630:(e,t,s)=>{s.d(t,{handler:()=>o});var r=s(11010),n=s(96190),a=s(89131);const o=(e,t)=>{switch(t.type){case"UserChangedGroupMembership":{const a=e.peers.get(t.groupId);if("Group"!==(null==a?void 0:a.kind)||e.locks.updateFriendshipOrMembership.has(a.id))return[];const o=a.membership;return n.updateMembership(a,t.change),o===a.membership?[]:(e.locks.updateFriendshipOrMembership.add(a.id),[(s=(0,r._)((function*({api:e}){const s=`groups.${t.change}`;let r=!1;try{yield e.fetch(s,{group_id:-t.groupId})}catch(e){r=!0}return{type:"UserChangedGroupMembership_RequestCompleted",groupId:t.groupId,change:t.change,hasFailed:r}})),function(e){return s.apply(this,arguments)})])}case"UserChangedGroupMembership_RequestCompleted":{e.locks.updateFriendshipOrMembership.delete(t.groupId);const s=e.peers.get(t.groupId);return"Group"!==(null==s?void 0:s.kind)||t.hasFailed&&n.updateMembership(s,{join:"leave",leave:"join"}[t.change]),[]}default:return(0,a.exhaustivenessCheck)(t)}var s}},115804:(e,t,s)=>{s.d(t,{handler:()=>p});var r=s(11010),n=s(777634),a=s(185327),o=s(168465),i=s(89131),d=s(61448),c=s(991792),l=s(453934);const u={mark_important:"unmark_important",unmark_important:"mark_important"},h={delete:"delete",restore:"restore",mark_important:"mark_important",unmark_important:"mark_important"},p=(e,t,s)=>{const{type:h}=t;switch(h){case"UserChangedMessage":{const{peerId:s,userAction:n,cmids:o,ids:c}=t;for(let t=0;t<o.length;t+=1){const r=o[t];if(!r)return[];const a=m(n,s,r);if(e.locks.messageActions.has(a))return[];e.locks.messageActions.add(a)}const u=e.convos.get(s);let h;switch(n){case"mark_important":case"unmark_important":o.forEach((t=>{if(u){const e=(0,l.castDraft)(a.findMessageByCmid(u,t));"Normal"===(null==e?void 0:e.kind)&&(e.isImportant="mark_important"===n)}const r=e.importantMessages.messages.get((0,d.getImportantMessageKey)(s,t));r&&(r.isImportant="mark_important"===n)})),h=e=>e.fetch("messages.markAsImportant",{message_ids:`${c.join(",")}`,important:"mark_important"===n?1:0}).then((e=>Boolean(e[0])));break;default:(0,i.exhaustivenessCheck)(n)}return[(f=(0,r._)((function*({api:e}){try{let t=!1;return h&&(t=!(yield h(e))),{type:"UserChangedMessage_RequestCompleted",hasFailed:t,userAction:n,ids:c,cmids:o,peerId:s}}catch(e){return{type:"UserChangedMessage_RequestCompleted",hasFailed:!0,userAction:n,ids:c,cmids:o,peerId:s}}})),function(e){return f.apply(this,arguments)})]}case"UserChangedMessage_RequestCompleted":{const{peerId:r,userAction:n,hasFailed:a,cmids:o,ids:i}=t;o.forEach((t=>{const s=m(n,r,t);e.locks.messageActions.delete(s)}));const d=u[n];return a&&d&&p(e,{type:"UserChangedMessage",userAction:d,ids:i,peerId:r,cmids:o},s),[]}case"UserDeleteMessage":{const{deleteType:s,peerId:o,userAction:d,messages:l}=t,u=e.ownerId,h=e.convos.get(o);if(!h)return[];const p=[];for(let t=0;t<l.length;t+=1){const r=l[t];if(!r||"Normal"!==r.kind)return[];const c=m(d,o,r.cmid);if(e.locks.messageActions.has(c))return[];e.locks.messageActions.add(c),p.push(r);const u=a.isCasper(h)||n.isCall(r);switch(s){case"local":case"spam":if(u){a.deleteMessage(h,r,{isRestorable:!1});break}a.deleteMessage(h,r,{isRestorable:!0,isSpam:"spam"===s});break;case"for_all":a.deleteMessage(h,r,{isRestorable:!1});break;default:(0,i.exhaustivenessCheck)(s)}}return[function(){var e=(0,r._)((function*({api:e}){try{var t;const r=yield e.fetch("messages.delete",{message_ids:l.map((e=>e.id)).join(","),peer_id:o,delete_for_all:"for_all"===s?1:0,spam:"spam"===s?1:0,group_id:(0,c.getOwnerGroupId)(u)});return{type:"UserDeleteMessage_RequestCompleted",hasFailed:!Boolean(null==(t=r[0])?void 0:t.response),userAction:d,deleteType:s,peerId:o,messages:l,deletedMessages:p}}catch(e){return{type:"UserDeleteMessage_RequestCompleted",hasFailed:!0,userAction:d,deleteType:s,peerId:o,messages:l,deletedMessages:p}}}));return function(t){return e.apply(this,arguments)}}()]}case"UserDeleteFailedMessage":{const{peerId:s,randomId:r}=t,n=e.convos.get(s);return n?(a.removePending(n,r),[]):[]}case"UserDeleteAllFailedMessage":{const{peerId:s}=t,r=e.convos.get(s);if(!r)return[];return a.allQueuedMessages(r).filter((e=>e.hasFailed)).forEach((e=>{a.removePending(r,e.randomId)})),[]}case"UserDeleteMessage_RequestCompleted":{const{peerId:s,userAction:n,messages:o,hasFailed:i,deletedMessages:d}=t,c=e.convos.get(s);return i&&c&&d.forEach((e=>{a.restoreMessage(c,e,!1)})),o.forEach((({cmid:t})=>{const r=m(n,s,t);e.locks.messageActions.delete(r)})),[(0,r._)((function*(){return{type:"Noop"}}))]}case"UserRestoreMessage":{const{peerId:s,userAction:n,cmid:i,messageId:d}=t,l=m(n,s,i);if(e.locks.messageActions.has(l))return[];e.locks.messageActions.add(l);const u=e.convos.get(s);if(!u)return[];const h=e.ownerId,p=o.findNodeByCmid(u.history,i).node;return"DeletedNode"===(null==p?void 0:p.kind)&&a.restoreMessage(u,p.restorable,!1),[function(){var e=(0,r._)((function*({api:e}){try{const t=yield e.fetch("messages.restore",{message_id:d,group_id:(0,c.getOwnerGroupId)(h)});return{type:"UserRestoreMessage_RequestCompleted",hasFailed:!Boolean(t),userAction:n,messageId:d,peerId:s,cmid:i}}catch(e){return{type:"UserRestoreMessage_RequestCompleted",hasFailed:!0,userAction:n,messageId:d,peerId:s,cmid:i}}}));return function(t){return e.apply(this,arguments)}}()]}case"UserRestoreMessage_RequestCompleted":{const{peerId:r,userAction:n,cmid:o,hasFailed:i}=t,d=m(n,r,o);e.locks.messageActions.delete(d);const c=e.convos.get(r);if(void 0===c)return[];const l=a.findMessageByCmid(c,o);return i&&"Normal"===(null==l?void 0:l.kind)&&p(e,{type:"UserDeleteMessage",messages:[l],deleteType:"local",peerId:r,userAction:"delete"},s),[]}default:(0,i.exhaustivenessCheck)(t)}var f},m=(e,t,s)=>`${h[e]}-${t.toString()}-${s.toString()}`},623267:(e,t,s)=>{s.d(t,{handler:()=>i});var r=s(11010),n=s(481186),a=s(89131),o=s(185327);const i=(e,t)=>{switch(t.type){case"UserChangedMessageAttachment":return[(0,r._)((function*({api:e}){try{const s=(yield e.fetch("messages.getByConversationMessageId",{peer_id:t.peerId,conversation_message_ids:t.cmid.toString(),extended:1,group_id:t.groupId||0},{retries:3})).items[0];return s?{type:"UserChangedMessageAttachment_RequestCompleted",hasFailed:!1,peerId:t.peerId,apiMessage:s}:{type:"UserChangedMessageAttachment_RequestCompleted",hasFailed:!0}}catch(e){return{type:"UserChangedMessageAttachment_RequestCompleted",hasFailed:!0}}}))];case"UserChangedMessageAttachment_RequestCompleted":{if(t.hasFailed)return[];const{message:s,mentions:r}=(0,n.fromApiMessage)(t.apiMessage),a=e.convos.get(t.peerId);return a?(o.replaceMessage(a,s,r.hasDirect||r.hasMass),[]):[]}default:(0,a.exhaustivenessCheck)(t)}}},395911:(e,t,s)=>{s.d(t,{handler:()=>c});var r=s(11010),n=s(89131),a=s(96190),o=s(185327),i=s(83062),d=s(453934);const c=(e,t)=>{const{type:s}=t,{viewer:c}=e,l=c.id;switch(s){case"UserAcceptedChatMessageRequest":{const{peerId:s}=t;return e.locks.changeMessageRequest.has(s)?[]:(e.locks.changeMessageRequest.add(s),[(0,r._)((function*({api:e}){try{return yield e.fetch("messages.acceptMessageRequest",{peer_id:s,user_id:a.toRealId(l)}),{type:"UserAcceptedChatMessageRequest_RequestCompleted",peerId:s}}catch(e){return{type:"UserAcceptedChatMessageRequest_RequestCompleted",peerId:s}}}))])}case"UserRejectedMessageRequest":{const{peerId:s,isSpam:n}=t;if(e.locks.changeMessageRequest.has(s))return[];e.locks.changeMessageRequest.add(s);const c=e.convos.get(s),u=(0,d.current)(c);if(void 0!==c&&("MessageRequestChatConvo"===c.kind||"MessageRequestUserConvo"===c.kind||"UserConvo"===c.kind)){const t=o.fromRejectedMessageRequest(c);e.convos.set(s,t),i.refresh(e.organisers,t)}return[(0,r._)((function*({api:e}){try{return{type:"UserRejectedChatMessageRequest_RequestCompleted",hasFailed:1!==(yield e.fetch("messages.rejectMessageRequest",{peer_id:s,user_id:a.toRealId(l),spam:n?1:0})),peerId:s,prevConvo:u}}catch(e){return{type:"UserRejectedChatMessageRequest_RequestCompleted",hasFailed:!0,peerId:s,prevConvo:u}}}))]}case"UserAcceptedChatMessageRequest_RequestCompleted":{const{peerId:s}=t;return e.locks.changeMessageRequest.delete(s),[]}case"UserRejectedChatMessageRequest_RequestCompleted":{const{prevConvo:s,hasFailed:r,peerId:n}=t;return e.locks.changeMessageRequest.delete(n),r&&void 0!==s&&(e.convos.set(n,s),i.refresh(e.organisers,s)),[]}default:(0,n.exhaustivenessCheck)(s)}}},573610:(e,t,s)=>{s.d(t,{handler:()=>i});var r=s(11010),n=s(89131),a=s(839963),o=s(54965);const i=(e,t)=>{switch(t.type){case"UserChangedPostAttachment":{const{channelId:e,cmid:n}=t;return[(s=(0,r._)((function*({api:t}){try{var s;const r=null==(s=(yield t.fetch("channels.getMessagesById",{channel_id:e,cmids:n.toString(),extended:1},{retries:3})).items)?void 0:s[0];return r?{type:"UserChangedPostAttachment_RequestCompleted",hasFailed:!1,channelId:e,apiPost:r}:{type:"UserChangedPostAttachment_RequestCompleted",hasFailed:!0}}catch(e){return{type:"UserChangedPostAttachment_RequestCompleted",hasFailed:!0}}})),function(e){return s.apply(this,arguments)})]}case"UserChangedPostAttachment_RequestCompleted":{if(t.hasFailed)return[];const{apiPost:s,channelId:r}=t,n=e.channels.get(r);if(!n)return[];const{post:i,reactions:d}=(0,o.fromApiPost)(s);for(const t of d)e.reactions.set(t.id,t);return a.replacePost(n,i),[]}default:(0,n.exhaustivenessCheck)(t)}var s}},446869:(e,t,s)=>{s.d(t,{handler:()=>o});var r=s(11010),n=s(89131),a=s(453934);const o=(e,t)=>{switch(t.type){case"UserChangedPushSetting":{const{setting:n,value:o}=t;e.viewer.settings.push[n]=o;const i=(0,a.current)(e.viewer.settings.push);return[(s=(0,r._)((function*({storage:e}){return e.set("settings-push",i),{type:"UserChangedPushSetting_RequestCompleted",hasFailed:!1,setting:n,value:o}})),function(e){return s.apply(this,arguments)})]}case"UserChangedPushSetting_RequestCompleted":return t.hasFailed,[];default:(0,n.exhaustivenessCheck)(t)}var s}},490469:(e,t,s)=>{s.d(t,{handler:()=>o});var r=s(11010),n=s(89131),a=s(927411);const o=(e,t)=>{const{type:s}=t;switch(s){case"UserChangedSetting":{const s=t.setting;e.locks.settings.add(s);const i=e.viewer.settings[t.setting];return e.viewer.settings[t.setting]=t.value,[(o=(0,r._)((function*(e){try{const s=yield function(e,t,s){const{api:r,storage:o}=e;switch(t){case"ctrSubmit":{const e=a.IApi.resolveTrackId("account.setInfo","messages_multiline_input");return r.dangerouslyAbort(e),r.fetch("account.setInfo",{name:"messages_multiline_input",value:String(Number(s))},{trackId:e})}case"soundNotifications":return o.set("settings-sound-notifications-on",s),Promise.resolve(1);case"showRecommendations":{const e=a.IApi.resolveTrackId("account.setInfo","messages_recommendation_list_hidden");return r.dangerouslyAbort(e),r.fetch("account.setInfo",{name:"messages_recommendation_list_hidden",value:String(Number(!s))},{trackId:e})}case"countOnlyNotMuted":{const e=a.IApi.resolveTrackId("account.setInfo","show_only_not_muted_messages");return r.dangerouslyAbort(e),r.fetch("account.setInfo",{name:"show_only_not_muted_messages",value:String(Number(s))},{trackId:e})}case"autoUnarchive":{const e=a.IApi.resolveTrackId("account.setInfo","messages_auto_unarchive");return r.dangerouslyAbort(e),r.fetch("account.setInfo",{name:"messages_auto_unarchive",value:String(Number(s))},{trackId:e})}case"transcriptAutoShow":{const e=a.IApi.resolveTrackId("account.setInfo","messages_transcript_auto_show");return r.dangerouslyAbort(e),r.fetch("account.setInfo",{name:"messages_transcript_auto_show",value:String(Number(s))},{trackId:e})}case"verticalFoldersView":return o.set("folders-view-vertical",s),Promise.resolve(1);case"messageReactionAnimation":return o.set("message-reactions-animation",s),Promise.resolve(1);case"messageActionsContextMenu":return o.set("settings-message-actions-context-menu",s),Promise.resolve(1);default:(0,n.exhaustivenessCheck)(t)}}(e,t.setting,t.value);return"transcriptAutoShow"===t.setting&&1===s&&e.stats.logEvent({type:"type_action",type_action:{type:"type_settings_changes_item",type_settings_changes_item:{type:"general",name:"voice_transcription_autoshow",value_old:String(Number(i)),value_new:String(Number(t.value)),screen:"im_web_settings"}}}),{type:"UserChangedSetting_RequestCompleted",hasFailed:1!==s,setting:t.setting,previousValue:i}}catch(e){return{type:"UserChangedSetting_RequestCompleted",hasFailed:!0,setting:t.setting,previousValue:i}}})),function(e){return o.apply(this,arguments)})]}case"UserChangedSetting_RequestCompleted":{const s=t.setting;return e.locks.settings.delete(s),t.hasFailed&&(e.viewer.settings[t.setting]=t.previousValue),[]}default:(0,n.exhaustivenessCheck)(s)}var o}},694598:(e,t,s)=>{s.d(t,{handler:()=>d});var r=s(11010),n=s(999504),a=s(89131),o=s(991792),i=s(927411);const d=(e,t)=>{switch(t.type){case"UserCreatedFolder":{const{name:a,peerIds:o}=t;return e.locks.newFolder?[]:(e.locks.newFolder=!0,[(s=(0,r._)((function*({api:e}){try{const t=yield e.fetch("messages.createFolder",{name:a,included_peer_ids:o.join(",")});return{type:"UserCreatedFolder_CreateRequestCompleted",hasFailed:!1,peerIds:o,name:a,folderId:n.resolveId(t.folder_id)}}catch(e){let t;return e instanceof i.IApi.RequestError&&(t=e.code),{type:"UserCreatedFolder_CreateRequestCompleted",hasFailed:!0,name:a,error:t}}})),function(e){return s.apply(this,arguments)})])}case"UserCreatedFolder_CreateRequestCompleted":{const{hasFailed:s}=t;if(e.locks.newFolder=!1,s){if(t.error);else if(a.isDev)throw new Error("Не удалось создать папку");return[]}const r=(0,o.insertFolders)(e,[{id:t.folderId,name:t.name}]),i=(0,o.getConvosByIds)(e,t.peerIds);return(0,o.addConvosToFolder)(e,t.folderId,i),r[0]&&n.setHasMore(r[0],"all",!1),[]}default:(0,a.exhaustivenessCheck)(t)}var s}},351447:(e,t,s)=>{s.d(t,{handler:()=>i});var r=s(11010),n=s(999504),a=s(185327),o=s(89131);const i=(e,t)=>{switch(t.type){case"UserDeletedFolder":{const{folderId:o}=t;if(e.locks.deleteFolder.has(o))return[];e.locks.deleteFolder.add(o),n.deleteFolder(e.organisers.folders,o);for(const t of e.convos.values())a.removeFolder(t,o);return[(s=(0,r._)((function*({api:e}){try{return{type:"UserDeletedFolder_DeleteRequestCompleted",hasFailed:1!==(yield e.fetch("messages.deleteFolder",{folder_id:o})),folderId:o}}catch(e){return{type:"UserDeletedFolder_DeleteRequestCompleted",hasFailed:!0,folderId:o}}})),function(e){return s.apply(this,arguments)})]}case"UserDeletedFolder_DeleteRequestCompleted":{const{hasFailed:s,folderId:r}=t;if(e.locks.deleteFolder.delete(r),s&&o.isDev)throw new Error("Не удалось удалить папку");return[]}default:(0,o.exhaustivenessCheck)(t)}var s}},791175:(e,t,s)=>{s.d(t,{handler:()=>o});var r=s(11010),n=s(498928),a=s(89131);const o=(e,t)=>{switch(t.type){case"UserHideFilter":return"businessNotify"===t.kind?e.organisers.filters.businessNotify.unreadCount>0?[]:[(s=(0,r._)((function*({storage:e}){return e.set("business-notify-manually-hidden",!0),{type:"UserHideFilter_Completed",kind:"businessNotify"}})),function(e){return s.apply(this,arguments)})]:"all"===t.kind||"unread"===t.kind||"chats"===t.kind||"messageRequest"===t.kind||"archive"===t.kind?[]:(0,a.exhaustivenessCheck)(t.kind);case"UserHideFilter_Completed":return"businessNotify"===t.kind?(n.toggleBusinessNotifyVisibility(e.organisers.filters,!1),[]):"all"===t.kind||"unread"===t.kind||"chats"===t.kind||"messageRequest"===t.kind||"archive"===t.kind?[]:(0,a.exhaustivenessCheck)(t.kind);case"UserUndoHideFilter":return"businessNotify"===t.kind?(n.toggleBusinessNotifyVisibility(e.organisers.filters,!0),[(0,r._)((function*({storage:e}){return e.set("business-notify-manually-hidden",!1),{type:"Noop"}}))]):"all"===t.kind||"unread"===t.kind||"chats"===t.kind||"messageRequest"===t.kind||"archive"===t.kind?[]:(0,a.exhaustivenessCheck)(t.kind);case"UserActualizeHideFilter":if("businessNotify"===t.kind){const t=e.organisers.filters.businessNotify.unreadCount,{isHidden:s}=e.organisers.filters.businessNotify;return[(0,r._)((function*({storage:e}){const r=e.get("business-notify-manually-hidden");return r&&!s?{type:"UserHideFilter",kind:"businessNotify"}:!r&&s?{type:"UserUndoHideFilter",kind:"businessNotify"}:0===t?{type:"Noop"}:{type:"UserUndoHideFilter",kind:"businessNotify"}}))]}return"all"===t.kind||"unread"===t.kind||"chats"===t.kind||"messageRequest"===t.kind||"archive"===t.kind?[]:(0,a.exhaustivenessCheck)(t.kind);default:(0,a.exhaustivenessCheck)(t)}var s}},109424:(e,t,s)=>{s.d(t,{handler:()=>i});var r=s(11010),n=s(89131),a=s(197934),o=s(991792);const i=(e,t)=>{switch(t.type){case"UserHitEdit":{const{mid:n,text:i,attaches:d,peerId:c,keepForwarded:l,keepSnippets:u}=t,h=e.convos.get(c),p=e.ownerId;if(!h)return[];e.locks.edit.add(c);const m=a.ids(d).join(",");return[(s=(0,r._)((function*({api:e}){let t=!1;try{var s,r;yield e.fetch("messages.edit",{message_id:n,peer_id:c,message:i,attachment:0===m.length?void 0:m,group_id:(0,o.getOwnerGroupId)(p),keep_forward_messages:l?1:0,keep_snippets:u?1:0,lat:null==(s=d.geo)?void 0:s.coordinates.latitude,long:null==(r=d.geo)?void 0:r.coordinates.longitude})}catch(e){t=!0}return{type:"UserHitEdit_RequestCompleted",peerId:c,hasFailed:t}})),function(e){return s.apply(this,arguments)})]}case"UserHitEdit_RequestCompleted":{const{peerId:s,hasFailed:r}=t;e.locks.edit.delete(s);e.convos.get(s);return[]}default:return(0,n.exhaustivenessCheck)(t)}var s}},978758:(e,t,s)=>{s.d(t,{handler:()=>c});var r=s(11010),n=s(197934),a=s(168465),o=s(86144),i=s(559360),d=s(89131);const c=(e,t)=>{switch(t.type){case"UserHitPostSend":{const{text:s,attaches:d,channelId:c,publishAt:u,topic:h,options:p,visibility:m,donutDelay:f,onComplete:g,onFail:v}=t,C=e.channels.get(c);if(!C)return[];const _=n.ids(d).join(",");if(!s&&!_)return[];let y;return void 0===u&&(y=o.newPending({channelId:c,attaches:d,sentAt:+new Date},s),a.appendPending(C.history,y)),[(0,r._)((function*({api:e}){try{g();const t=yield e.fetch("channels.sendMessage",{channel_id:c,message:s,attachments:_,publish_date:u&&Math.floor(u.getTime()/1e3),from_group:1,topic_id:i.getPostThemeIdFromKey(h),close_comments:l(p.has("close_comments")),mark_as_ads:l(p.has("mark_as_ads")),mute_notifications:l(p.has("mute_notifications")),signed:l(p.has("signed")),donut_paid_duration:"all"===m?void 0:-1===f?f:86400*f});return{type:"UserHitPostSend_RequestCompleted",hasFailed:!1,randomId:y.randomId,cmid:o.resolveCmid(t),channelId:c}}catch(e){return v(e),{type:"UserHitPostSend_RequestCompleted",hasFailed:!0,randomId:y.randomId,channelId:c}}}))]}case"UserHitPostSend_RequestCompleted":{const{hasFailed:s,randomId:r,channelId:n}=t,o=e.channels.get(n);if(!o)return[];if(s)return void 0!==r&&a.removePending(o.history,r),[];if(void 0!==r){const e=a.findPendingNode(o.history,r);void 0!==e&&(e.item.cmid=t.cmid)}return[]}default:(0,d.exhaustivenessCheck)(t)}},l=e=>void 0!==e?Number(e)&&1:e},273971:(e,t,s)=>{s.d(t,{handler:()=>m});var r=s(11010),n=s(434788),a=s(453934),o=s(89131),i=s(777634),d=s(96190),c=s(185327),l=s(168465),u=s(197934),h=s(991792),p=s(95154);const m=(e,t,s)=>{switch(t.type){case"UserHitSend":{const{peerId:s}=t,n=e.convos.get(s);return n?function(e,t){const{text:s,attaches:r,peerId:n,timestamp:a,expireTTL:o,deleteTTL:d,entrypoint:c,extra:l,reply:u,forwarded:h}=e,m=function(e){const t=e.length;if(t<p.MAX_MESSAGE_SIZE)return[e];const s=[];let r=0;for(let n=0;n<Math.ceil(t/p.MAX_MESSAGE_SIZE);n++){const n=e.substring(r,r+p.MAX_MESSAGE_SIZE).lastIndexOf(" "),a=-1===n?p.MAX_MESSAGE_SIZE:n,o=t-r<=p.MAX_MESSAGE_SIZE?e.substring(r):e.substring(r,r+a);r+=o.length,s.push(o)}return s.map((e=>e.trim()))}(s),f=function(e){const t=Object.values(e).flat(),s=Object.fromEntries(Object.entries(e).map((([e,t])=>Array.isArray(t)?[t[0].kind,{key:e,isArray:!0}]:[t.kind,{key:e,isArray:!1}])));if(t.length<=p.MAX_MESSAGE_ATTACHES)return[e];return t.reduce(((e,t,r)=>{var n;const a=Math.floor(r/p.MAX_MESSAGE_ATTACHES),o=s[t.kind];return o?(e[a][o.key]=o.isArray?(null==(n=e[a][o.key])?void 0:n.concat(t))||[t]:t,e):e}),Array.from({length:Math.ceil(t.length/p.MAX_MESSAGE_ATTACHES)},(()=>Object())))}(r),g=m.length+f.length-1,v=[];for(let e=0;e<g;e++){const s=m[e]||"",r=f[e-m.length+1]||{},p=i.newQueued({peerId:n,text:s,isOut:!0,sentAt:a+e,authorId:t,attaches:r,expireTTL:o,deleteTTL:d,extra:l,entrypoint:c},0===e?u:void 0,e===g-1?h:void 0);v.push(p)}return v}(t,e.ownerId).flatMap((t=>{var s,a;c.appendQueuedMessage(n,t);const o=e.locks.sendQueue.get(n.peerId);return o?(o.add(t.randomId),[]):(e.locks.sendQueue.set(n.peerId,new Set([t.randomId])),[f(t.peerId,t.randomId,t.text,u.ids(t.attaches),t.extra,t.entrypoint,t.attaches.geo,(0,h.getOwnerGroupId)(e.ownerId),null!=(l=null==(s=t.replyMessage)?void 0:s.id)?l:null,null!=(p=null==(a=t.forwardedMessages)?void 0:a.map((e=>e.id)))?p:null),d.isMarusia(t.peerId)&&(m=(0,r._)((function*({marusia:e}){return null==e||e.handleAction({type:"add_message",payload:{randomId:Number(t.randomId),text:i.toRawText(t),isOutbound:t.isOut,local:!0,payload:t.extra.botPayload,attachIds:u.ids(t.attaches)}}),{type:"Noop"}})),function(e){return m.apply(this,arguments)})]);var l,p,m})):[]}case"UserHitSend_RequestCompleted":{var n,g,v;const{peerId:s,randomId:r,hasFailed:o}=t,i=e.convos.get(s),d=e.ownerId;if(!i)return e.locks.sendQueue.delete(s),[];o&&c.updateSendingFail(i,r,o);const p=e.locks.sendQueue.get(i.peerId);if(!p)return[];p.delete(r);const m=[...p][0];if(!m)return e.locks.sendQueue.delete(s),[];const y=null==(n=l.findPendingNode(i.history,m))?void 0:n.item;if(!y)return[];const k=(0,a.current)(y);var C,_;return[f(s,k.randomId,k.text,u.ids(k.attaches),k.extra,k.entrypoint,k.attaches.geo,(0,h.getOwnerGroupId)(d),null!=(C=null==(g=k.replyMessage)?void 0:g.id)?C:null,null!=(_=null==(v=k.forwardedMessages)?void 0:v.map((e=>e.id)))?_:null)]}case"UserHitResendFailedMessage":{var y,k,I;const{randomId:s,peerId:r,entrypoint:n}=t,o=e.convos.get(r),i=e.ownerId;if(!o)return[];const d=null==(y=l.findPendingNode(o.history,s))?void 0:y.item;if(!d)return[];c.updateSendingFail(o,s,!1),c.changeQueuedMessageEntrypoint(o,s,n);const p=e.locks.sendQueue.get(o.peerId);if(p)return p.add(d.randomId),[];e.locks.sendQueue.set(o.peerId,new Set([d.randomId]));const m=(0,a.current)(d);var M,R;return[f(r,m.randomId,m.text,u.ids(m.attaches),m.extra,n,m.attaches.geo,(0,h.getOwnerGroupId)(i),null!=(M=null==(k=m.replyMessage)?void 0:k.id)?M:null,null!=(R=null==(I=m.forwardedMessages)?void 0:I.map((e=>e.id)))?R:null)]}case"UserHitResendAllFailedMessages":{const{peerId:r,entrypoint:n}=t,a=e.convos.get(r);if(!a)return[];return c.allQueuedMessages(a).filter((e=>e.hasFailed)).flatMap((t=>m(e,{type:"UserHitResendFailedMessage",peerId:r,randomId:t.randomId,entrypoint:n||t.entrypoint},s)))}case"ResendAllFailedMessages":return Array.from(e.convos.values()).flatMap((t=>m(e,{type:"UserHitResendAllFailedMessages",peerId:t.peerId},s)));case"UserHitSendWidget":{const{peerId:r,text:n,timestamp:a,entrypoint:o,extra:d}=t;if(e.convos.get(r))return m(e,{type:"UserHitSend",attaches:{},extra:d,entrypoint:o,text:n,peerId:r,timestamp:a},s);const c=i.newQueued({peerId:r,text:n,isOut:!0,sentAt:a,authorId:e.ownerId,attaches:{},extra:d,entrypoint:o});return[f(c.peerId,c.randomId,c.text,u.ids(c.attaches),c.extra,c.entrypoint,c.attaches.geo,(0,h.getOwnerGroupId)(e.ownerId),null,null)]}default:return(0,o.exhaustivenessCheck)(t)}};function f(e,t,s,a,o,i,d,c,l,u){return h=(0,r._)((function*({api:r}){let h=!1,p={};o.sticker&&(p.sticker_id=o.sticker.id,p.sticker_referrer=o.sticker.referrer),o.botPayload&&(p.payload=o.botPayload),o.silent&&(p.silent=1),o.expiresIn&&(p.expire_ttl=o.expiresIn),d&&(p.lat=d.coordinates.latitude,p.long=d.coordinates.longitude);try{var m;yield r.fetch("messages.send",(0,n._)({},p,{peer_id:e,random_id:t,message:s,reply_to:null!=l?l:void 0,forward_messages:null!=(m=null==u?void 0:u.join(","))?m:void 0,attachment:0===a.length?void 0:a.join(","),entrypoint:i,group_id:c}))}catch(e){h=!0}return{type:"UserHitSend_RequestCompleted",peerId:e,randomId:t,hasFailed:h}})),function(e){return h.apply(this,arguments)};var h}},43109:(e,t,s)=>{s.d(t,{handler:()=>p});var r=s(11010),n=s(434788),a=s(89131),o=s(86144),i=s(866358),d=s(96190),c=s(168465),l=s(95154),u=s(991792);const h={UserChangedLike:"UserChangedLike",UserChangedLike_RequestCompleted:"UserChangedLike",UserLoadedLikes:"UserLoadedLikes",UserLoadedLikes_RequestCompleted:"UserLoadedLikes"},p=(e,t,s)=>{let f,g,v;switch(t.kind){case"comment":{const{channelId:s,postCmid:r,commentCmid:n,replyCmid:a}=t,d=e.channels.get(s),l=d&&c.findNodeByCmid(d.history,r).node,u="Node"===(null==l?void 0:l.kind)&&o.findCommentByCmid(l.item,n);if(!u||"Normal"!==u.kind)break;if(f=u.channelId,a){const e=i.findReplyByCmid(u,a);if(!e||"Normal"!==e.kind)break;v=e,g=e.cmid;break}v=u,g=u.cmid;break}case"post":{const{channelId:s,postCmid:r}=t,n=e.channels.get(s),a=n&&c.findNodeByCmid(n.history,r).node,o="Node"===(null==a?void 0:a.kind)&&a.item;if(!o)break;f=o.channelId,g=o.cmid,v=o;break}default:(0,a.exhaustivenessCheck)(t)}if(!v||!f||!g)return[];const C=m(h[t.type],t.kind,f,g);switch(t.type){case"UserLoadedLikes":{if(e.locks.likeActions.has(C))return[];let s;switch(e.locks.likeActions.add(C),t.kind){case"comment":case"post":s=v.likes.peerIds.size;break;default:(0,a.exhaustivenessCheck)(t)}const o=0===v.likes.peerIds.size?l.LIKE_PEERS_FIRST_LOAD:l.LIKE_PEERS_PER_PAGE;return[(y=(0,r._)((function*({api:e}){try{const r=yield e.fetch("likes.getList",{type:t.kind,owner_id:f,item_id:g,extended:1,skip_own:1,count:o,offset:s});return(0,n._)({},t,{type:"UserLoadedLikes_RequestCompleted",response:r,hasFailed:!1})}catch(e){return(0,n._)({},t,{type:"UserLoadedLikes_RequestCompleted",hasFailed:!0})}})),function(e){return y.apply(this,arguments)})]}case"UserLoadedLikes_RequestCompleted":{const{hasFailed:s,response:r}=t;if(e.locks.likeActions.delete(C),s||!r)return[];const n=r.items.filter((e=>"profile"===e.type)),o=r.items.filter((e=>"group"===e.type)),i=r.items.map((e=>d.resolveId(e.id)));switch((0,u.insertPeers)(e,{apiUsers:n,apiGroups:o,apiContacts:[]}),t.kind){case"comment":case"post":i.forEach((e=>null==v?void 0:v.likes.peerIds.add(e)));break;default:(0,a.exhaustivenessCheck)(t)}return[]}case"UserChangedLike":{const{reactionId:s}=t;let a=v.likes.reactionId;if(a===s)return[];const o=void 0!==a;return e.locks.likeActions.has(C)?[]:(e.locks.likeActions.add(C),void 0===s?v.likes.count-=1:o||(v.likes.count+=1),v.likes.reactionId=s,[(_=(0,r._)((function*({api:e}){try{const r=yield e.fetch(o&&void 0===s?"likes.delete":"likes.add",{type:t.kind,owner_id:f,item_id:g||0,reaction_id:s});return(0,n._)({},t,{type:"UserChangedLike_RequestCompleted",response:r,hasFailed:!1})}catch(e){return(0,n._)({},t,{type:"UserChangedLike_RequestCompleted",hasFailed:!0,prevReactionId:a})}})),function(e){return _.apply(this,arguments)})])}case"UserChangedLike_RequestCompleted":{const{hasFailed:r,response:a,prevReactionId:o}=t;return e.locks.likeActions.delete(C),r||!a?(p(e,(0,n._)({},t,{type:"UserChangedLike",reactionId:o}),s),e.locks.likeActions.delete(C),[]):(v.likes.count=a.likes,[])}default:(0,a.exhaustivenessCheck)(t)}var _,y},m=(e,t,s,r)=>`${e}-${t}-${s}-${r}`},464474:(e,t,s)=>{s.d(t,{getCommentsHistoryLockKey:()=>p,handler:()=>h});var r=s(11010),n=s(89131),a=s(86144),o=s(866358),i=s(168465),d=s(991792),c=s(95154),l=s(851828),u=s(453934);const h=(e,t)=>{switch(t.type){case"UserLoadedCommentsHistory":{const{channelId:o,postCmid:d,startCmid:l,commentCmid:u,order:h}=t,m=p(o,d,u);if(e.locks.getPostCommentsHistory.has(m))return[];e.locks.getPostCommentsHistory.add(m);const f=e.channels.get(o);if(!f)return[];const g=i.findNodeByCmid(f.history,d).node,v="Node"===(null==g?void 0:g.kind)&&g.item;if(!v)return[];if(u&&!a.findCommentByCmid(v,u))return[];let C;switch(h){case"interesting":C="smart";break;case"new":C="desc";break;case"old":C="asc";break;default:(0,n.exhaustivenessCheck)(h)}return[(s=(0,r._)((function*({api:e}){try{const t=yield e.fetch("wall.getComments",{owner_id:o,post_id:d,count:c.COMMENTS_PER_PAGE,sort:C,thread_items_count:c.THREAD_COMMENTS_COUNT,need_likes:1,extended:1,start_comment_id:l,comment_id:u||void 0,offset:l?1:0});return{type:"UserLoadedCommentsHistory_RequestSucceed",channelId:o,response:t,postCmid:d,order:h,commentCmid:u}}catch(e){return{type:"UserLoadedCommentsHistory_RequestFailed",channelId:o,postCmid:d,commentCmid:u,hasFailed:!0}}})),function(e){return s.apply(this,arguments)})]}case"UserLoadedCommentsHistory_RequestSucceed":{const{response:s,channelId:r,postCmid:n,commentCmid:c,order:h}=t;e.locks.getPostCommentsHistory.delete(p(r,n,c));const m=e.channels.get(r);if(!m)return[];const f=(0,u.castDraft)(i.findNodeByCmid(m.history,n).node),g="Node"===(null==f?void 0:f.kind)&&f.item;if(!g)return[];const v=s.items.map((e=>(0,l.fromApiComment)(e)));if(h!==g.comments.order&&a.changeCommentsOrder(g,h),c){const e=a.findCommentByCmid(g,c);if(!e)return[];o.insertReplies(e,v),e.replies.count=s.current_level_count||e.replies.count}else a.insertComments(g,v,s.current_level_count||0),g.comments.count=s.count,g.comments.oneLevelCount=s.current_level_count||g.comments.oneLevelCount;return(0,d.insertPeers)(e,{apiUsers:s.profiles||[],apiGroups:s.groups||[],apiContacts:[]}),[]}case"UserLoadedCommentsHistory_RequestFailed":{const{channelId:s,postCmid:r,commentCmid:n}=t;return e.locks.getPostCommentsHistory.delete(p(s,r,n)),[]}default:return(0,n.exhaustivenessCheck)(t)}var s},p=(e,t,s)=>`${e}-${t}-${s||""}`},708315:(e,t,s)=>{s.d(t,{handler:()=>l});var r=s(11010),n=s(906978),a=s(839963),o=s(83062),i=s(89131),d=s(927411),c=s(991792);const l=(e,t)=>{switch(t.type){case"UserOpenedChannel":{const{channelId:s}=t,n=e.locks.channelsCleanup.get(s)||0;e.locks.channelsCleanup.set(s,n+1);return e.channels.get(s)?[]:[(0,r._)((function*({api:e}){try{const t=yield e.fetch("channels.getById",{channel_ids:s.toString(),extended:1},{retries:2});return{type:"UserOpenedChannel_ChannelRequestCompleted",channelId:s,response:t,hasFailed:!1}}catch(e){return{type:"UserOpenedChannel_ChannelRequestCompleted",channelId:s,hasFailed:!0,errCode:e instanceof d.IApi.RequestError?e.code:void 0}}}))]}case"UserOpenedChannel_ChannelRequestCompleted":{const{hasFailed:a,channelId:d,response:l,errCode:u}=t;if(a&&u===n.API_ERROR_ACCESS)return[(s=(0,r._)((function*({router:e}){return e.replace({kind:"ChannelRoute",channelId:d,accessDenied:!0}),{type:"Noop"}})),function(e){return s.apply(this,arguments)})];if(!l)return[];(0,c.insertChannels)(e,{apiChannels:l.items||[],apiGroups:l.groups||[]});const h=e.channels.get(d);if(!h){if(i.isDev)throw new Error("Диалог не был найден");return[]}return h.isMember&&o.refreshChannels(e.organisers,h),[]}case"UserClosedChannel":{const{channelId:s}=t,r=e.locks.channelsCleanup.get(s);if(r&&r>1)return e.locks.channelsCleanup.set(s,r-1),[];e.locks.channelsCleanup.delete(s);const n=e.channels.get(s);return n?(a.cleanup(n),[]):[]}default:return(0,i.exhaustivenessCheck)(t)}var s}},733835:(e,t,s)=>{s.d(t,{handler:()=>u});var r=s(11010),n=s(991792),a=s(96190),o=s(185327),i=s(83062),d=s(71568),c=s(89131),l=s(986727);const u=(e,t,s)=>{switch(t.type){case"LoadChatMembers":case"LoadStickers":case"ActualizeComposerDraft":return[];case"UserOpenedConvo":{const{peerId:a}=t,o=e.convos.get(a),i=e.locks.convosCleanup.get(a)||0;e.locks.convosCleanup.set(a,i+1);const d=(0,n.getOwnerGroupId)(e.ownerId);return o?u(e,{type:"UserOpenedConvo_ConvoRequestCompleted",peerId:a,hasFailed:!1},s):[(0,r._)((function*({api:e}){try{const t=yield e.fetch("messages.getConversationsById",{peer_ids:a.toString(),group_id:d,extended:1},{retries:3});return{type:"UserOpenedConvo_ConvoRequestCompleted",peerId:a,hasFailed:!1,profiles:t.profiles,groups:t.groups,conversations:t.items,contacts:t.contacts}}catch(e){return{type:"UserOpenedConvo_ConvoRequestCompleted",peerId:a,hasFailed:!0}}}))]}case"UserOpenedConvo_ConvoRequestCompleted":{const{peerId:l,conversations:u,profiles:p,groups:y,contacts:k,hasFailed:I}=t;if(I){if(c.isDev)throw new Error("Не удалось загрузить диалог");return[(0,r._)((function*({router:e}){return e.replace({kind:"MainRoute"}),{type:"Noop"}}))]}(0,n.insertConvos)(e,u||[]),(0,n.insertPeers)(e,{apiUsers:p||[],apiGroups:y||[],apiContacts:k||[]});const M=e.convos.get(l);if(!M){if(c.isDev)throw new Error("Диалог не был найден");return[]}const R=M.isMarkedUnread&&0===M.unreadCount;R&&o.markRead(M),i.refresh(e.organisers,M);const S="ChatConvo"===M.kind&&void 0===M.members&&o.canReadMembers(M)&&!e.locks.getConversationMembers.has(l);S&&e.locks.getConversationMembers.add(l);const w=(0,n.getOwnerGroupId)(e.ownerId),b=Object.values(s.me_sticker_packs).flat().map((e=>d.resolveStickerId(e))).filter((t=>!e.stickers.has(t))),E=b.length>0,U=!e.locks.loadStickerPacks;return U&&(e.locks.loadStickerPacks=!0),[S&&a.isChatPeerId(l)&&(_=(0,r._)((function*(){return{type:"LoadChatMembers",peerId:l}})),function(){return _.apply(this,arguments)}),E&&(C=(0,r._)((function*(){return{type:"LoadStickers",stickerIds:b}})),function(){return C.apply(this,arguments)}),U&&(v=(0,r._)((function*({api:e}){try{return{type:"UserOpenedConvo_StickerPacksRequestCompleted",response:yield e.fetch("store.getProducts",{type:"stickers",filters:"active",extended:1},{retries:10})}}catch(e){return{type:"UserOpenedConvo_StickerPacksRequestCompleted"}}})),function(e){return v.apply(this,arguments)}),(g=(0,r._)((function*({api:e,storage:t}){try{const r=yield function(e){return h.apply(this,arguments)}({api:e,storage:t,featureFlags:s});return{type:"UserOpenedConvo_StickersKeywordsRequestCompleted",response:r}}catch(e){return{type:"UserOpenedConvo_StickersKeywordsRequestCompleted"}}})),function(e){return g.apply(this,arguments)}),R&&(f=(0,r._)((function*({api:e}){try{yield e.fetch("messages.markAsRead",{peer_id:l,mark_conversation_as_read:1,group_id:w})}catch(e){}return{type:"Noop"}})),function(e){return f.apply(this,arguments)}),(m=(0,r._)((function*(){return{type:"ActualizeComposerDraft",peerId:l}})),function(){return m.apply(this,arguments)})]}case"UserClosedConvo":{const s=e.locks.convosCleanup.get(t.peerId);if(s&&s>1)return e.locks.convosCleanup.set(t.peerId,s-1),[];e.locks.convosCleanup.delete(t.peerId);const r=e.convos.get(t.peerId);return r?(o.cleanup(r),[]):[]}case"UserOpenedConvo_StickersKeywordsRequestCompleted":{const{response:s}=t;return s&&(e.stickersKeywords=(0,l.fromApiStickersKeywords)(s)),[]}case"UserOpenedConvo_StickerPacksRequestCompleted":{var p;const{response:s}=t;return s?(null==(p=s.items)||p.forEach((t=>{var s;null==(s=t.stickers)||s.forEach((t=>{e.stickers.set(d.resolveStickerId(t.sticker_id),(0,l.fromApiSticker)(t))}))})),[]):[]}default:return(0,c.exhaustivenessCheck)(t)}var m,f,g,v,C,_};function h(){return(h=(0,r._)((function*({api:e,storage:t,featureFlags:s}){const r=yield t.getIDB("stickers-keywords"),n=Math.round((new Date).getTime()/1e3),a=r&&r.expiresAt>n,o=a?r.response:yield e.fetch("store.getStickersKeywords",{need_stickers:0,all_products:s.vkm_send_promoted_stickers?1:0},{retries:3,timeout:3e4});return a||(yield t.setIDB("stickers-keywords",{response:o,expiresAt:n+86400}).catch((()=>{}))),o}))).apply(this,arguments)}},666840:(e,t,s)=>{s.d(t,{handler:()=>l});var r=s(11010),n=s(434788),a=s(96190),o=s(89131),i=s(991792),d=s(185327),c=s(863536);const l=(e,t,s)=>{switch(t.type){case"LoadChatMembers":return[];case"UserOpenedConvoProfile":{const{peerId:n,isLinkWithHistory:a}=t,o=e.convos.get(n),d=e.ownerId;return o?l(e,{type:"UserOpenedConvoProfile_ConvoRequestCompleted",peerId:n,hasFailed:!1,isLinkWithHistory:a},s):[(0,r._)((function*({api:e}){try{let t;return o||(t=yield e.fetch("messages.getConversationsById",{peer_ids:n.toString(),extended:1,group_id:(0,i.getOwnerGroupId)(d)},{retries:3})),{type:"UserOpenedConvoProfile_ConvoRequestCompleted",peerId:n,hasFailed:!1,convoResponse:t,isLinkWithHistory:a}}catch(e){return{type:"UserOpenedConvoProfile_ConvoRequestCompleted",peerId:n,hasFailed:!0,isLinkWithHistory:a}}}))]}case"UserOpenedConvoProfile_ConvoRequestCompleted":{const{peerId:s,convoResponse:n,hasFailed:l,isLinkWithHistory:p}=t,m=e.ownerId;if(l){if(o.isDev)throw new Error("Не удалось загрузить диалог");return[(0,r._)((function*(){return{type:"Noop"}}))]}n&&((0,i.insertConvos)(e,n.items||[]),(0,i.insertPeers)(e,{apiUsers:n.profiles||[],apiGroups:n.groups||[],apiContacts:n.contacts||[]}));const f=e.convos.get(s);if(!f){if(o.isDev)throw new Error("Диалог не был найден");return[(0,r._)((function*({router:e}){return e.replace({kind:"MainRoute"}),{type:"Noop"}}))]}const g="ChatConvo"===f.kind&&void 0===f.members&&d.canReadMembers(f)&&!e.locks.getConversationMembers.has(s);g&&e.locks.getConversationMembers.add(s);const v="ChatConvo"===f.kind&&f.acl.canSeeInviteLink;return[g&&a.isChatPeerId(s)&&(h=(0,r._)((function*(){return{type:"LoadChatMembers",peerId:s}})),function(){return h.apply(this,arguments)}),v&&a.isChatPeerId(s)&&(u=(0,r._)((function*({api:e}){try{return{type:"UserOpenedConvoProfile_InviteLinksCompleted",peerId:s,isLinkWithHistory:p,response:yield e.fetch("messages.getInviteLink",{peer_id:s,visible_messages_count:p?c.VISIBLE_MESSAGES_COUNT:0,reset:0,group_id:(0,i.getOwnerGroupId)(m)},{retries:1})}}catch(e){}return{type:"Noop"}})),function(e){return u.apply(this,arguments)})]}case"UserOpenedConvoProfile_InviteLinksCompleted":{const{peerId:s,response:{link:r},isLinkWithHistory:a}=t,o=e.convos.get(s);return o&&"ChatConvo"===o.kind&&r?(d.replaceInviteLinks(o,(0,n._)({},o.inviteLinks,a?{withHistory:r}:{noHistory:r})),[]):[]}default:(0,o.exhaustivenessCheck)(t)}var u,h}},475881:(e,t,s)=>{s.d(t,{handler:()=>c});var r=s(11010),n=s(185327),a=s(777634),o=s(89131),i=s(991792),d=s(453934);const c=(e,t)=>{switch(t.type){case"UserPlayedMessage":{const{cmid:s,peerId:o}=t,d=e.convos.get(o),c=d&&n.findMessageByCmid(d,s),l=e.ownerId;return"Normal"===(null==c?void 0:c.kind)&&a.canChangeMessagePlayedStatus(c)?[(0,r._)((function*({api:e}){try{return{type:"UserPlayedMessage_RequestCompleted",hasFailed:1!==(yield e.fetch("messages.markAsPlayed",{peer_id:o,cmid:s,group_id:(0,i.getOwnerGroupId)(l)},{retries:1})),cmid:s,peerId:o}}catch(e){return{type:"UserPlayedMessage_RequestCompleted",hasFailed:!0,cmid:s,peerId:o}}}))]:[]}case"UserPlayedMessage_RequestCompleted":if(!t.hasFailed){const{cmid:s,peerId:r}=t,o=e.convos.get(r),i=o&&(0,d.castDraft)(n.findMessageByCmid(o,s));if("Normal"!==(null==i?void 0:i.kind)||!a.canChangeMessagePlayedStatus(i))return[];i.isPlayed=!0}return[];default:(0,o.exhaustivenessCheck)(t)}}},807331:(e,t,s)=>{s.d(t,{handler:()=>n});var r=s(89131);const n=(e,t)=>{if("UserProfileInfo_Update"===t.type){const{user:s,profileInfo:r}=t;return r&&(e.viewer.profileInfo=r),s&&e.peers.set(s.id,s),[]}(0,r.exhaustivenessCheck)(t.type)}},957046:(e,t,s)=>{s.d(t,{handler:()=>o});var r=s(11010),n=s(89131),a=s(991792);const o=(e,t)=>{switch(t.type){case"UserReadAllReactions":{const{peerId:n}=t;if(e.locks.readAllReactions.has(n))return[];e.locks.readAllReactions.add(n);const i=(0,a.getOwnerGroupId)(e.ownerId),d=e.convos.get(n);let c=[];var s;if(d)c=Array.from(null!=(s=d.unreadReactions)?s:[]),d.unreadReactions.clear();return[(o=(0,r._)((function*({api:e}){try{const t=yield e.fetch("messages.markReactionsAsRead",{peer_id:n,cmids:c.join(","),group_id:i});return{type:"UserReadAllReactions_RequestCompleted",peerId:n,hasFailed:1!==t,unreadReactions:c}}catch(e){return{type:"UserReadAllReactions_RequestCompleted",peerId:n,hasFailed:!0,unreadReactions:c}}})),function(e){return o.apply(this,arguments)})]}case"UserReadAllReactions_RequestCompleted":{const{hasFailed:s,peerId:r,unreadReactions:n}=t;if(e.locks.readAllReactions.delete(r),!s)return[];const a=e.convos.get(r);return a&&(a.unreadReactions=new Set([...a.unreadReactions,...n])),[]}default:return(0,n.exhaustivenessCheck)(t)}var o}},262641:(e,t,s)=>{s.d(t,{handler:()=>i});var r=s(11010),n=s(89131),a=s(83062),o=s(839963);const i=(e,t)=>{switch(t.type){case"UserReadPost":{const{cmid:s,channelId:r}=t,n=e.channels.get(r);if(!n)return[];if(s<=n.inReadCmid)return[];o.readUntil(n,s),a.refreshChannels(e.organisers,n);const i=e.channelReadQueues.has(r);return e.channelReadQueues.set(r,n.inReadCmid),i?[]:[d(r)]}case"UserReadPost_ThrottleTimedOut":{const{channelId:n}=t,a=e.channelReadQueues.get(n);return a?[(s=(0,r._)((function*({api:e}){try{yield e.fetch("channels.markAsRead",{channel_id:n,last_read_cmid:a})}catch(e){}return{type:"UserReadPost_RequestCompleted",channelId:n,readUntilCmid:a}})),function(e){return s.apply(this,arguments)})]:[]}case"UserReadPost_RequestCompleted":{const{channelId:s,readUntilCmid:r}=t,n=e.channelReadQueues.get(s);return n?r>=n?(e.channelReadQueues.delete(s),[]):[d(s)]:[]}default:return(0,n.exhaustivenessCheck)(t)}var s};function d(e){return t=(0,r._)((function*(){return yield(0,n.sleep)(300),{type:"UserReadPost_ThrottleTimedOut",channelId:e}})),function(){return t.apply(this,arguments)};var t}},328079:(e,t,s)=>{s.d(t,{handler:()=>i});var r=s(11010),n=s(999504),a=s(89131),o=s(927411);const i=(e,t)=>{switch(t.type){case"UserReorderedFolders":{const{order:a}=t;return e.locks.reorderFolders?[]:(e.locks.reorderFolders=!0,n.reorderFolders(e.organisers.folders,a),[(s=(0,r._)((function*({api:e}){try{return{type:"UserReorderedFolders_ReorderRequestCompleted",hasFailed:1!==(yield e.fetch("messages.reorderFolders",{folder_ids:a.join(",")})),order:a}}catch(e){let t;return e instanceof o.IApi.RequestError&&(t=e.code),{type:"UserReorderedFolders_ReorderRequestCompleted",hasFailed:!0,error:t,order:a}}})),function(e){return s.apply(this,arguments)})])}case"UserReorderedFolders_ReorderRequestCompleted":{const{hasFailed:s}=t;if(e.locks.reorderFolders=!1,s){if(t.error);else if(a.isDev)throw new Error("Не удалось изменить порядок папок");return[]}return[]}default:(0,a.exhaustivenessCheck)(t)}var s}},863536:(e,t,s)=>{s.d(t,{VISIBLE_MESSAGES_COUNT:()=>d,handler:()=>c});var r=s(11010),n=s(434788),a=s(89131),o=s(185327),i=s(991792);const d=250,c=(e,t)=>{switch(t.type){case"UserRequestChatInvitationLink":{const{peerId:n,isLinkWithHistory:a}=t,o=e.ownerId;return[(s=(0,r._)((function*({api:e}){try{const t=yield e.fetch("messages.getInviteLink",{peer_id:n,reset:0,visible_messages_count:a?d:0,group_id:(0,i.getOwnerGroupId)(o)},{retries:1});return{type:"UserRequestChatInvitationLink_RequestCompleted",hasFailed:!t.link,link:t.link,isLinkWithHistory:a,peerId:n}}catch(e){return{type:"UserRequestChatInvitationLink_RequestCompleted",hasFailed:!0,isLinkWithHistory:a,peerId:n}}})),function(e){return s.apply(this,arguments)})]}case"UserRequestChatInvitationLink_RequestCompleted":{const{peerId:s,link:r,isLinkWithHistory:a,hasFailed:i}=t,d=e.convos.get(s);return!i&&d&&"ChatConvo"===d.kind&&r?(o.replaceInviteLinks(d,(0,n._)({},d.inviteLinks,a?{withHistory:r}:{noHistory:r})),[]):[]}case"UserResetChatInvitationLink":{const{peerId:s}=t,n=e.ownerId;return[function(){var e=(0,r._)((function*({api:e}){try{const t=yield e.fetch("messages.getInviteLink",{peer_id:s,reset:1,visible_messages_count:d,group_id:(0,i.getOwnerGroupId)(n)},{retries:1}),r=yield e.fetch("messages.getInviteLink",{peer_id:s,reset:0,visible_messages_count:0,group_id:(0,i.getOwnerGroupId)(n)},{retries:1});return{type:"UserResetChatInvitationLink_RequestCompleted",hasFailed:!t.link||!r.link,links:{withHistory:t.link,noHistory:r.link},peerId:s}}catch(e){return{type:"UserResetChatInvitationLink_RequestCompleted",hasFailed:!0,peerId:s,links:{}}}}));return function(t){return e.apply(this,arguments)}}()]}case"UserResetChatInvitationLink_RequestCompleted":{const{peerId:s,links:r,hasFailed:n}=t,a=e.convos.get(s);return n||"ChatConvo"!==(null==a?void 0:a.kind)?[]:r.noHistory&&r.withHistory?(o.replaceInviteLinks(a,r),[]):[]}default:return(0,a.exhaustivenessCheck)(t)}var s}},741497:(e,t,s)=>{s.d(t,{handler:()=>u});var r=s(11010),n=s(89131),a=s(95154),o=s(839963),i=s(86144),d=s(168465),c=s(54965),l=s(991792);const u=(e,t)=>{switch(t.type){case"UserScrolledChannelHistory":{const{channelId:o,direction:i,startCmid:d,possibleSkipped:c}=t,l=e.channels.get(o);if(!l)return[];if(e.locks.getChannelHistory.has(o))return[];e.locks.getChannelHistory.add(o);let u,h=Math.min(a.POSTS_PER_PAGE,c||a.POSTS_PER_PAGE)+2;switch(i){case"backward":u=-1;break;case"forward":u=1-h;break;case"around":h=a.POSTS_PER_PAGE,u=-Math.floor(h/2),l.inReadCmid===d&&(u=Math.max(-l.unreadCount,u));break;default:(0,n.exhaustivenessCheck)(i)}return[(s=(0,r._)((function*({api:e}){try{const t=yield e.fetch("channels.getHistory",{channel_id:o,start_cmid:Math.max(d,1),count:h,offset:u,extended:1},{retries:5});let s,r;switch(i){case"backward":s=h===t.items.length,r=!0;break;case"around":{const e=t.items.filter((({cmid:e})=>e<=d)).length;s=e===h+u;const n=t.items.length-e;r=n===-u;break}case"forward":s=!0,r=h===t.items.length;break;default:(0,n.exhaustivenessCheck)(i)}return{type:"UserScrolledChannelHistory_RequestSucceed",channelId:o,response:t,hasMoreBackward:s,hasMoreForward:r}}catch(e){return{type:"UserScrolledChannelHistory_RequestFailed",channelId:o}}})),function(e){return s.apply(this,arguments)})]}case"UserScrolledChannelHistory_RequestSucceed":{const{channelId:s,response:r,hasMoreBackward:n,hasMoreForward:a}=t;e.locks.getChannelHistory.delete(s);const u=e.channels.get(s);if(!u)return[];const h=[];return r.items.reverse().forEach(((t,s,r)=>{const{post:o,reactions:l}=(0,c.fromApiPost)(t);l.forEach((t=>{e.reactions.set(t.id,t)})),0===s&&o.cmid>1&&n&&h.push({kind:"GapNode",fromCmid:i.resolveCmid(1),toCmid:i.resolveCmid(o.cmid-1)}),h.push({kind:"Node",item:o});const p=d.lastCmid(u.history);s===r.length-1&&void 0!==p&&a&&o.cmid<p&&h.push({kind:"GapNode",fromCmid:i.resolveCmid(o.cmid+1),toCmid:i.resolveCmid(p)})})),o.insertPosts(u,h),(0,l.insertPeers)(e,{apiUsers:r.profiles||[],apiGroups:r.groups||[],apiContacts:[]}),[]}case"UserScrolledChannelHistory_RequestFailed":{const{channelId:s}=t;return e.locks.getChannelHistory.delete(s),[]}default:return(0,n.exhaustivenessCheck)(t)}var s}},527600:(e,t,s)=>{s.d(t,{handler:()=>l});var r=s(11010),n=s(89131),a=s(185327),o=s(777634),i=s(95154),d=s(991792),c=s(481186);const l=(e,t)=>{switch(t.type){case"UserScrolledConvoHistory":{const{peerId:c,direction:l,startCmid:h,possibleSkipped:p}=t,m=e.ownerId,f=e.convos.get(c);if(!f)return[];if("end"===l||"around"===l){if(1===e.locks.convosCleanup.get(c)&&a.cleanup(f),"end"===l)return[]}const g=u(c,h);if(e.locks.getHistory.has(g))return[];e.locks.getHistory.add(g);let v,C=Math.min(i.MESSAGES_PER_PAGE,p||i.MESSAGES_PER_PAGE)+2;switch(l){case"backward":v=-1;break;case"forward":v=1-C;break;case"around":C=i.MESSAGES_PER_PAGE,v=-Math.floor(C/2),f.inReadBy===h&&(v=Math.max(-f.unreadCount,v));break;default:(0,n.exhaustivenessCheck)(l)}return[(s=(0,r._)((function*({api:e,logger:t}){try{var s,r;const a=yield e.fetch("messages.getHistory",{peer_id:c,start_cmid:h,count:C,offset:v,extended:1,group_id:(0,d.getOwnerGroupId)(m)},{retries:5});let i,u;switch(l){case"backward":i=C===a.items.length,u=!0;break;case"around":{const e=a.items.filter((({conversation_message_id:e})=>o.resolveCmid(e)<=h)).length;i=e===C+v;const t=a.items.length-e;u=t===-v;break}case"forward":i=!0,u=C===a.items.length;break;default:(0,n.exhaustivenessCheck)(l)}return t.info("load convo history, has more: ",i,u,l," cmids: start ",h,"boundaries: ",null==(s=a.items[0])?void 0:s.conversation_message_id,null==(r=a.items[a.items.length-1])?void 0:r.conversation_message_id),{type:"UserScrolledConvoHistory_RequestSucceed",response:a,peerId:c,startCmid:h,hasMoreBackward:i,hasMoreForward:u}}catch(e){return{type:"UserScrolledConvoHistory_RequestFailed",peerId:c,startCmid:h}}})),function(e){return s.apply(this,arguments)})]}case"UserScrolledConvoHistory_RequestSucceed":{const{peerId:s,startCmid:r,response:n,hasMoreBackward:o,hasMoreForward:i}=t;e.locks.getHistory.delete(u(s,r));const l=e.convos.get(s);if(!l)return[];const h=n.items.map((e=>(0,c.fromApiMessage)(e).message));return a.insertMessages(l,h,{backward:o,forward:i}),(0,d.insertPeers)(e,{apiUsers:n.profiles||[],apiGroups:n.groups||[],apiContacts:[]}),[]}case"UserScrolledConvoHistory_RequestFailed":{const{peerId:s,startCmid:r}=t;return e.locks.getHistory.delete(u(s,r)),[]}default:(0,n.exhaustivenessCheck)(t)}var s};function u(e,t){return`${e}-${t}`}},688088:(e,t,s)=>{s.d(t,{handler:()=>a});var r=s(11010),n=s(89131);const a=(e,t)=>{switch(t.type){case"UserSeenHelpHint":return e.helpHints.delete(t.hintId),[(s=(0,r._)((function*({api:e}){try{return{type:"UserSeenHelpHint_RequestCompleted",hasFailed:1!==(yield e.fetch("account.hideHelpHint",{hint_id:t.hintId},{retries:1}))}}catch(e){return{type:"UserSeenHelpHint_RequestCompleted",hasFailed:!0}}})),function(e){return s.apply(this,arguments)})];case"UserSeenHelpHint_RequestCompleted":return[];default:(0,n.exhaustivenessCheck)(t)}var s}},722723:(e,t,s)=>{s.d(t,{handler:()=>d});var r=s(11010),n=s(89131),a=s(185327),o=s(83062),i=s(991792);const d=(e,t,s)=>{switch(t.type){case"UserSeenMessage":{const{cmid:s,peerId:r}=t,n=e.convos.get(r);if(!n)return[];const i=a.findMessageByCmid(n,s);if(!i)return[];const d=n.inReadBy,l=n.unreadReactions.has(s);i.isOut||a.readInUntil(n,s),a.readReactions(n,s),o.refresh(e.organisers,n);const u=e.readQueues.get(r);return u?(u.inReadBy=n.inReadBy,l&&u.reactions.add(s),[]):(e.readQueues.set(r,{inReadBy:n.inReadBy,reactions:l?new Set([s]):new Set}),[c(r,d)])}case"UserSeenMessage_ThrottleTimedOut":{const{peerId:n,prevInReadBy:a}=t;if(!e.convos.get(n))return e.readQueues.delete(n),[];const o=e.readQueues.get(n);if(!o)return[];const c=[];for(let e of o.reactions)if(c.push(e),o.reactions.delete(e),100===c.length)break;const u=o.inReadBy,h=e.ownerId,p=a<u,m=!1!==s.vkm_reactions&&c.length>0;return p||m?[(l=(0,r._)((function*({api:e}){try{yield e.fetchMany([p&&{method:"messages.markAsRead",params:{peer_id:n,up_to_cmid:u,mark_conversation_as_read:1,group_id:(0,i.getOwnerGroupId)(h)}},m&&{method:"messages.markReactionsAsRead",params:{peer_id:n,cmids:c.join(","),group_id:(0,i.getOwnerGroupId)(h)}}])}catch(e){}return{type:"UserSeenMessage_RequestCompleted",peerId:n,readUntilCmid:u}})),function(e){return l.apply(this,arguments)})]:d(e,{type:"UserSeenMessage_RequestCompleted",peerId:n,readUntilCmid:u},s)}case"UserSeenMessage_RequestCompleted":{const{peerId:s,readUntilCmid:r}=t;if(!e.convos.get(s))return[];const n=e.readQueues.get(s);return n?n.inReadBy<=r&&0===n.reactions.size?(e.readQueues.delete(s),[]):[c(s,r)]:[]}default:return(0,n.exhaustivenessCheck)(t)}var l};function c(e,t){return s=(0,r._)((function*(){return yield(0,n.sleep)(500),{type:"UserSeenMessage_ThrottleTimedOut",prevInReadBy:t,peerId:e}})),function(){return s.apply(this,arguments)};var s}},416947:(e,t,s)=>{s.d(t,{handler:()=>i});var r=s(11010),n=s(89131),a=s(86144),o=s(839963);const i=(e,t)=>{switch(t.type){case"UserSeenPost":{const{cmid:s,channelId:r}=t,n=e.channels.get(r);if(!n)return[];const i=o.findPostByCmid(n,s),c="Node"===(null==i?void 0:i.kind)&&i.item;if(!c)return[];const l=0===e.seenPostsStatsQueues.posts.size&&0===e.seenPostsStatsQueues.reposts.size&&!e.locks.seenPostsStatsSend,u=(t,s,r)=>{e.seenPosts[r].has(t)||e.seenPosts[r].set(t,new Set);const n=e.seenPosts[r].get(t);var a;n&&!n.has(s)&&(n.add(s),e.seenPostsStatsQueues[r].has(t)||e.seenPostsStatsQueues[r].set(t,new Set),null==(a=e.seenPostsStatsQueues[r].get(t))||a.add(s),n.size>=60&&e.seenPosts[r].set(t,new Set(Array.from(n).slice(-30))))};if(u(r,s,"posts"),c.attaches.wall&&o.isChannelId(c.attaches.wall.authorId)){u(o.resolveId(c.attaches.wall.authorId),a.resolveCmid(c.attaches.wall.id),"reposts")}return[l&&(0!==e.seenPostsStatsQueues.posts.size||0!==e.seenPostsStatsQueues.reposts.size)&&d()]}case"UserSeenPost_ThrottleTimedOut":{e.locks.seenPostsStatsSend=!0;const t=[];e.seenPostsStatsQueues.posts.forEach(((e,s)=>{t.push(...c(s,e))})),e.seenPostsStatsQueues.posts=new Map;const n=[];return e.seenPostsStatsQueues.reposts.forEach(((e,t)=>{n.push(...l(t,e))})),e.seenPostsStatsQueues.reposts=new Map,[(s=(0,r._)((function*({api:e}){try{yield e.fetch("stats.trackEvents",{events:JSON.stringify([{e:"view_post",post_ids:t,repost_ids:n}])})}catch(e){}return{type:"UserSeenPost_RequestCompleted"}})),function(e){return s.apply(this,arguments)})]}case"UserSeenPost_RequestCompleted":return 0===e.seenPostsStatsQueues.posts.size&&0===e.seenPostsStatsQueues.reposts.size?(e.locks.seenPostsStatsSend=!1,[]):[d()];default:return(0,n.exhaustivenessCheck)(t)}var s};function d(){return e=(0,r._)((function*(){return yield(0,n.sleep)(2e3),{type:"UserSeenPost_ThrottleTimedOut"}})),function(){return e.apply(this,arguments)};var e}const c=(e,t)=>Array.from(t).map((t=>`${e}_${t}|wall|im_channels|0`)),l=(e,t)=>Array.from(t).map((t=>`${e}_${t}`))},37425:(e,t,s)=>{s.d(t,{handler:()=>i});var r=s(11010),n=s(89131),a=s(185327),o=s(991792);const i=(e,t)=>{switch(t.type){case"UserSetMessageReaction":{const{peerId:s,cmid:n,reactionId:c}=t,l=e.convos.get(s);if(!l)return[];const u=a.findMessageByCmid(l,n);if(!u||"Normal"!==u.kind)return[];const h=u.reactionId,p=e.ownerId;return d(u,c,e.ownerId),[(i=(0,r._)((function*({api:e}){try{return{type:"UserSetMessageReaction_RequestCompleted",hasFailed:1!==(yield e.fetch("messages.sendReaction",{cmid:n,peer_id:s,reaction_id:c,group_id:(0,o.getOwnerGroupId)(p)})),cmid:n,peerId:s,reactionId:c,prevReactionId:h}}catch(e){return{type:"UserSetMessageReaction_RequestCompleted",hasFailed:!0,cmid:n,peerId:s,reactionId:c,prevReactionId:h}}})),function(e){return i.apply(this,arguments)})]}case"UserSetMessageReaction_RequestCompleted":{const{hasFailed:s,peerId:r,cmid:n,prevReactionId:o}=t;if(!s)return[];const i=e.convos.get(r);if(!i)return[];const c=a.findMessageByCmid(i,n);return c&&"Normal"===c.kind?(d(c,o,e.ownerId),[]):[]}case"UserUnsetMessageReaction":{const{peerId:n,cmid:i}=t,c=e.convos.get(n);if(!c)return[];const l=a.findMessageByCmid(c,i);if(!l||"Normal"!==l.kind||!l.reactionId)return[];const u=l.reactionId,h=e.ownerId;return d(l,void 0,e.ownerId),[(s=(0,r._)((function*({api:e}){try{return{type:"UserUnsetMessageReaction_RequestCompleted",hasFailed:1!==(yield e.fetch("messages.deleteReaction",{cmid:i,peer_id:n,group_id:(0,o.getOwnerGroupId)(h)})),cmid:i,peerId:n,reactionId:u}}catch(e){return{type:"UserUnsetMessageReaction_RequestCompleted",hasFailed:!0,cmid:i,peerId:n,reactionId:u}}})),function(e){return s.apply(this,arguments)})]}case"UserUnsetMessageReaction_RequestCompleted":{const{hasFailed:s,peerId:r,cmid:n,reactionId:o}=t;if(!s)return[];const i=e.convos.get(r);if(!i)return[];const c=a.findMessageByCmid(i,n);return c&&"Normal"===c.kind?(d(c,o,e.ownerId),[]):[]}default:(0,n.exhaustivenessCheck)(t)}var s,i};function d(e,t,s){const r=e.reactionId;if(e.reactionId=t,r){const t=e.reactions.get(r);if(!t&&n.isDev)throw new Error("Реакция не найдена в списке реакций сообщения");t&&(t.count<=1?e.reactions.delete(r):(t.count-=1,t.peerIds.delete(s)))}if(t){const r=e.reactions.get(t);r?(r.count+=1,r.peerIds=new Set([s,...r.peerIds])):e.reactions.set(t,{reactionId:t,count:1,peerIds:new Set([s])})}}},166358:(e,t,s)=>{s.d(t,{handler:()=>i});var r=s(11010),n=s(999504),a=s(89131),o=s(991792);const i=(e,t)=>{switch(t.type){case"UserUpdatedFolder":{const{folderId:s,name:r,addPeerIds:a,removePeerIds:i}=t;if(e.locks.updateFolder.has(s))return[];if(function(e,t){if(new Set([...e].filter((e=>t.has(e)))).size)return!0;return!1}(a,i))throw new Error("Peer id не может одновременно находиться в списке на добавление и на удаление");e.locks.updateFolder.add(s);const c=e.organisers.folders.find((e=>e.id===s));if(!c)return[];const l=(0,o.getConvosByIds)(e,Array.from(i)),u=(0,o.getConvosByIds)(e,Array.from(a));return r&&n.setName(c,r),(0,o.removeConvosFromFolder)(e,c.id,l),(0,o.addConvosToFolder)(e,c.id,u),[d(s,r,a,i)]}case"UserUpdatedFolder_UpdateRequestCompleted":{const{hasFailed:s,folderId:r}=t;if(e.locks.updateFolder.delete(r),s&&a.isDev)throw new Error("Не удалось изменить папку");return[]}default:(0,a.exhaustivenessCheck)(t)}};function d(e,t,s,n){return a=(0,r._)((function*({api:r}){let a=!1;const o={folder_id:e};t&&(o.name=t),s.size&&(o.add_included_peer_ids=[...s].join(",")),n.size&&(o.remove_included_peer_ids=[...n].join(","));try{a=1!==(yield r.fetch("messages.updateFolder",o))}catch(e){a=!0}return{type:"UserUpdatedFolder_UpdateRequestCompleted",hasFailed:a,folderId:e,addPeerIds:s,removePeerIds:n,name:t}})),function(e){return a.apply(this,arguments)};var a}},296078:(e,t,s)=>{s.d(t,{handler:()=>a});var r=s(11010),n=s(89131);const a=(e,t,s)=>{switch(t.type){case"VideoMessageShapesGetById":{var a;const{shapeId:n}=t;return e.locks.getVideoMessageShapesById.has(n)||((null==(a=e.videoMessageShapes)?void 0:a.has(n))||!s.vkm_video_messages_shapes)?[]:(e.locks.getVideoMessageShapesById.add(n),[(i=(0,r._)((function*({api:e,storage:t}){const s=t.get("videomessage-shapes");s&&(s.expiresAt=0);try{const t=yield e.fetch("messages.getVideoMessageShapesByIds",{ids:n.toString()});return{type:"VideoMessageShapesGetById__RequestCompleted",shapeId:n,response:t,hasFailed:!Boolean(t)}}catch(e){return{type:"VideoMessageShapesGetById__RequestCompleted",shapeId:n,response:null,hasFailed:!0}}})),function(e){return i.apply(this,arguments)})])}case"VideoMessageShapesGetById__RequestCompleted":{const{response:s,shapeId:r}=t;if(e.locks.getVideoMessageShapesById.delete(r),!s)return[];const n=s.shapes.reduce(((e,t)=>(e.set(t.id,t.raw_path),e)),new Map);var o;return e.videoMessageShapes=new Map([...null!=(o=e.videoMessageShapes)?o:[],...n]),[]}default:return(0,n.exhaustivenessCheck)(t)}var i}},378002:(e,t,s)=>{s.d(t,{createStore:()=>o});var r=s(136517),n=s(89131),a=s(733818);function o(e,t,s=a.initial,o,d,c){let l=!1;const u=n.isDev&&(0,r.devTools)();let h=[],[p,m]=s(t,o,d,c);u&&u.init(p);const f=s=>{if(!l)throw new Error("Стор еще не был активирован. Нужно вызвать store.start().");const[r,n]=(0,a.reducer)(p,s,t);u&&u.send(s,r);const o=p!==r;if(p=r,i(f,n,e),o)for(const e of h)e(r)};return{start:()=>{l||(l=!0,i(f,m,e))},dispatch:f,subscribe:e=>(h.push(e),()=>{h=h.filter((t=>t!==e))}),featureFlags:t,getState:()=>p}}function i(e,t,s){0!==t.length&&setTimeout((()=>{for(const r of t)"function"==typeof r&&r(s).then(e).catch((e=>{s.logger.error("Необработанная ошибка редьюсера",e)}))}))}},136517:(e,t,s)=>{function r(){return"undefined"!=typeof window&&"__REDUX_DEVTOOLS_EXTENSION__"in window?window.__REDUX_DEVTOOLS_EXTENSION__.connect({serialize:{options:{map:!0,set:!0}}}):null}s.d(t,{devTools:()=>r})},733818:(e,t,s)=>{s.d(t,{initial:()=>Ae,reducer:()=>Pe});var r=s(11010),n=s(434788),a=s(453934),o=s(991792),i=s(89131),d=s(83062),c=s(498928),l=s(999504),u=s(452788),h=s(185327),p=s(96190),m=s(777634),f=s(400681),g=s(559360),v=s(839963),C=s(86144),_=s(821551),y=s(709646),k=s(882670),I=s(95154),M=s(597990),R=s(273971),S=s(109424),w=s(722723),b=s(733835),E=s(500156),U=s(664061),A=s(490469),P=s(526025),T=s(708807),N=s(959630),F=s(203677),q=s(382379),x=s(397384),O=s(192241),L=s(475881),D=s(688088),B=s(598801),G=s(115804),H=s(427418),z=s(395911),V=s(791175),K=s(623022),j=s(666840),W=s(61448),$=s(694598),Q=s(166358),Y=s(351447),J=s(328079),X=s(741497),Z=s(708315),ee=s(541222),te=s(863536),se=s(339962),re=s(735130),ne=s(584781),ae=s(12190),oe=s(416947),ie=s(262641),de=s(261740),ce=s(807331),le=s(464474),ue=s(967819),he=s(29064),pe=s(939903),me=s(623267),fe=s(43109),ge=s(601289),ve=s(695247),Ce=s(296078),_e=s(573610),ye=s(228153),ke=s(37425),Ie=s(38872),Me=s(637467),Re=s(978758),Se=s(553977),we=s(972284),be=s(446869),Ee=s(527600),Ue=s(957046);const Ae=(e,t,s,n)=>{const a=p.resolveId(t),o=s?p.resolveId(s):void 0;if(!p.isUserPeerId(a))throw Error("Viewer может быть только пользователем");if(void 0!==o&&!p.isUserPeerId(o)&&!p.isGroupPeerId(o))throw Error("Owner может быть только пользователем или группой");const i=(0,M.fromApiProfileType)(n);return[{convoConn:{status:"loading",pts:0},channelConn:{status:"running",ts:0},viewer:{id:a,profileType:i,settings:{ctrSubmit:!1,soundNotifications:!0,browserNotifications:!1,showRecommendations:!0,countOnlyNotMuted:!1,autoUnarchive:!0,transcriptAutoShow:!0,theme:"system",verticalFoldersView:!1,messageReactionAnimation:!0,businessNotify:!1,push:y.VIEWER_DEFAULT_PUSH_SETTINGS,teacherVerification:!1,messageActionsContextMenu:!1},profileInfo:{id:a},accounts:[]},ownerId:p.resolveId(),organisers:d.empty(),channels:new Map([[v.resolveId(0),{kind:"Channel",id:v.resolveId(0),name:"",activity:"",adminLevel:0,isVerified:!1,photos:{},inReadCmid:C.resolveCmid(0),unreadCount:0,isArchived:!1,isMuted:!1,notificationsDisabledUntil:0,majorSortId:0,minorSortId:0,membersCount:0,isMember:!1,canSendDonut:!1,pending:{},locks:{loading:!1,cleanUp:0},history:{confirmed:[],pending:[]}}]]),convos:new Map([[p.resolveId(),{kind:"UserConvo",peerId:p.resolveId(),unreadCount:0,majorSortId:0,minorSortId:0,inReadBy:m.resolveCmid(0),outReadBy:m.resolveCmid(0),isNew:!1,folderIds:new Set,isMarkedUnread:!1,isArchived:!1,canWrite:{allowed:!1,reason:"unknown"},push:{mode:"everything",disabledUntil:0},unreadExpireables:new Set,unreadReactions:new Set,entrypoint:null,history:{confirmed:[],pending:[]}}]]),composerDrafts:{},channelComposerDrafts:{},readQueues:new Map,seenPosts:{posts:new Map,reposts:new Map},seenPostsStatsQueues:{posts:new Map,reposts:new Map},channelReadQueues:new Map,peers:new Map([[p.resolveId(),{kind:"User",id:p.resolveId(),firstName:"...",firstNameGen:"...",firstNameAcc:"...",lastName:"...",lastNameGen:"...",lastNameAcc:"...",sex:"unknown",lastSeen:{isVisible:!1,platform:"other"},isVerified:!1,canCall:!0,followersCount:0,canChangeFriendship:!1,canMessage:!1,friendship:"unfamiliar",isBlacklisted:!1,isBlacklistedByMe:!1,isDeactivated:!1,canInviteToChats:!1}]]),onlines:new Set,typings:new Map,convosSearchIndex:_.create(),locks:{getConversations:{all:!1,unread:!1,archive:!1,messageRequest:!1},getChannels:{all:!1,unread:!1},hideFilter:{all:!1,unread:!1,chats:!1,archive:!1,messageRequest:!1,businessNotify:!1},getHistory:new Set,getConversationMembers:new Set,getConversationInfo:new Set,sendQueue:new Map,edit:new Set,convosCleanup:new Map,channelsCleanup:new Map,updateFriendshipOrMembership:new Set,convoActions:new Set,messageActions:new Set,channelActions:new Set,channelPostActions:new Set,settings:new Set,contactList:!1,newFolder:!1,deleteFolder:new Set,updateFolder:new Set,reorderFolders:!1,getChannelHistory:new Set,changeMessageRequest:new Set,getImportantUsers:!1,getPostCommentsHistory:new Set,likeActions:new Set,commentActions:new Set,getVideoMessageShapesById:new Set,loadStickers:new Set,seenPostsStatsSend:!1,invalidateMessageReactions:!1,loadStickersKeywords:!1,loadStickerPacks:!1,readAllReactions:new Set},hiddenPinnedMessages:new Map,helpHints:new Set,stickers:new Map,stickersKeywords:{},contacts:{items:new Map,contacts:new Map,hasMore:!0},importantMessages:{messages:new Map,hasMore:!0},hiddenBotKeyboards:new Set,reactions:new Map,messageReactions:new Map,importantUsers:null,videoMessageShapes:null,activeCallsCount:0,messageReactedPeers:new Map},[()=>Promise.resolve({type:"InitialData",ownerId:o}),(0,r._)((function*({api:t,storage:s}){if(!e.vkm_video_messages_shapes)return{type:"Noop"};s.identify(a);const r=yield function(e){return Fe.apply(this,arguments)}({api:t,storage:s});return{type:"LoadVideoMessageShapes_RequestCompleted",videoMessageShapes:r}})),(0,r._)((function*({storage:t}){return e.vkm_reactions?(t.identify(a),{type:"InvalidateMessageReactions"}):{type:"Noop"}}))]]};function Pe(e,t,s){if("TemporaryHackForResync"===t.type)return Ae(s,e.viewer.id,e.ownerId,"edu"===e.viewer.profileType?2:0);const n=(0,a.createDraft)(e);let o;switch(t.type){case"Noop":o=[];break;case"InitialData":case"InitialData_RequestCompleted":case"InitialData_ChannelsReadyForUse":o=Te(n,t,s);break;case"LoadVideoMessageShapes_RequestCompleted":o=Ne(n,t,s);break;case"EngineBatchReceived":case"EngineBatchReceived_TypingsTimedOut":case"UpdateMessageRequestsCounter":case"UpdateMessageRequestsCounter_RequestCompleted":o=E.handler(n,t,s);break;case"ChannelEngineBatchReceived":o=U.handler(n,t,s);break;case"QueueBatchReceived":o=O.handler(n,t,s);break;case"MoreConvosNeeded":case"MoreConvosNeeded_RequestCompleted":o=F.handler(n,t,s);break;case"MoreChannelsNeeded":case"MoreChannelsNeeded_RequestCompleted":o=q.handler(n,t,s);break;case"CacheUpdateReceived":o=x.handler(n,t,s);break;case"UserSeenMessage":case"UserSeenMessage_ThrottleTimedOut":case"UserSeenMessage_RequestCompleted":o=w.handler(n,t,s);break;case"UserHitSend":case"UserHitSend_RequestCompleted":case"UserHitResendAllFailedMessages":case"ResendAllFailedMessages":case"UserHitResendFailedMessage":case"UserHitSendWidget":o=R.handler(n,t,s);break;case"UserHitEdit":case"UserHitEdit_RequestCompleted":o=S.handler(n,t,s);break;case"UserOpenedConvo":case"UserClosedConvo":case"UserOpenedConvo_ConvoRequestCompleted":case"UserOpenedConvo_StickersKeywordsRequestCompleted":case"UserOpenedConvo_StickerPacksRequestCompleted":o=b.handler(n,t,s);break;case"LoadStickers":case"LoadStickers_RequestCompleted":o=ye.handler(n,t,s);break;case"UserChangedFriendship":case"UserChangedFriendship_RequestCompleted":o=T.handler(n,t,s);break;case"UserChangedGroupMembership":case"UserChangedGroupMembership_RequestCompleted":o=N.handler(n,t,s);break;case"UserChangedSetting":case"UserChangedSetting_RequestCompleted":o=A.handler(n,t,s);break;case"SettingThemeUpdated":case"SettingThemeUpdated_RequestCompleted":o=P.handler(n,t,s);break;case"UserPlayedMessage":case"UserPlayedMessage_RequestCompleted":o=L.handler(n,t,s);break;case"UserSeenHelpHint":case"UserSeenHelpHint_RequestCompleted":o=D.handler(n,t,s);break;case"UserChangedConvo":case"UserChangedConvo_RequestCompleted":case"UserPinMessage":case"UserPinMessage_RequestCompleted":case"UserUnpinMessage":case"UserUnpinMessage_RequestCompleted":case"UserChangedMute":case"UserChangedMute_RequestCompleted":case"UserChangedBusinessNotify":case"UserChangedBusinessNotify_RequestCompleted":o=B.handler(n,t,s);break;case"UserChangedMessage":case"UserChangedMessage_RequestCompleted":case"UserDeleteMessage":case"UserDeleteMessage_RequestCompleted":case"UserDeleteFailedMessage":case"UserDeleteAllFailedMessage":case"UserRestoreMessage":case"UserRestoreMessage_RequestCompleted":o=G.handler(n,t,s);break;case"LoadContactList":case"LoadContactList_RequestCompleted":o=H.handler(n,t,s);break;case"UserHideFilter":case"UserHideFilter_Completed":case"UserUndoHideFilter":case"UserActualizeHideFilter":o=V.handler(n,t,s);break;case"UserAcceptedChatMessageRequest":case"UserRejectedMessageRequest":case"UserAcceptedChatMessageRequest_RequestCompleted":case"UserRejectedChatMessageRequest_RequestCompleted":o=z.handler(n,t,s);break;case"UserChangedChatTitle":case"UserChangedChatDescription":case"UserChangedChatTitle_RequestCompleted":case"UserChangedChatDescription_RequestCompleted":case"UserRemovedChatPhoto":case"UserSetChatPhoto":case"UserRemovedChatPhoto_RequestCompleted":case"UserChangedChatSettings":case"UserChangedChatSettings_RequestCompleted":o=K.handler(n,t,s);break;case"UserOpenedConvoProfile":case"UserOpenedConvoProfile_ConvoRequestCompleted":case"UserOpenedConvoProfile_InviteLinksCompleted":o=j.handler(n,t,s);break;case"LoadImportantMessages":case"LoadImportantMessages_RequestCompleted":case"UserClosedImportantMessages":o=W.handler(n,t,s);break;case"UserCreatedFolder":case"UserCreatedFolder_CreateRequestCompleted":o=$.handler(n,t,s);break;case"UserUpdatedFolder":case"UserUpdatedFolder_UpdateRequestCompleted":o=Q.handler(n,t,s);break;case"UserDeletedFolder":case"UserDeletedFolder_DeleteRequestCompleted":o=Y.handler(n,t,s);break;case"UserReorderedFolders":case"UserReorderedFolders_ReorderRequestCompleted":o=J.handler(n,t,s);break;case"UserScrolledChannelHistory":case"UserScrolledChannelHistory_RequestSucceed":case"UserScrolledChannelHistory_RequestFailed":o=X.handler(n,t,s);break;case"UserOpenedChannel":case"UserClosedChannel":case"UserOpenedChannel_ChannelRequestCompleted":o=Z.handler(n,t,s);break;case"UserChangedChatMember":case"UserChangedChatMember_RequestCompleted":o=ee.handler(n,t,s);break;case"UserRequestChatInvitationLink":case"UserRequestChatInvitationLink_RequestCompleted":case"UserResetChatInvitationLink":case"UserResetChatInvitationLink_RequestCompleted":o=te.handler(n,t,s);break;case"LoadChatMembers":case"LoadChatMembers_RequestComplete":o=se.handler(n,t,s);break;case"LoadChatInfo":case"LoadChatInfo_RequestComplete":o=re.handler(n,t,s);break;case"UserChangedChannel":case"UserChangedChannel_RequestCompleted":o=ne.handler(n,t,s);break;case"UserChangedChannelPost":case"UserChangedChannelPost_RequestCompleted":o=ae.handler(n,t,s);break;case"UserSeenPost":case"UserSeenPost_ThrottleTimedOut":case"UserSeenPost_RequestCompleted":o=oe.handler(n,t,s);break;case"UserReadPost":case"UserReadPost_ThrottleTimedOut":case"UserReadPost_RequestCompleted":o=ie.handler(n,t,s);break;case"LoadImportantUsers":case"LoadImportantUsers_RequestCompleted":o=de.handler(n,t,s);break;case"UserLoadedCommentsHistory":case"UserLoadedCommentsHistory_RequestSucceed":case"UserLoadedCommentsHistory_RequestFailed":o=le.handler(n,t,s);break;case"ChannelsOnboardingDone":case"ChannelsOnboardingDone_RequestSucceeded":case"ChannelsOnboardingDone_RequestFailed":o=ue.handler(n,t,s);break;case"UserChangedComposerDraft":case"UserClearedComposerDraft":case"ComposerDraftsUpdateNeeded":case"ActualizeComposerDraft":case"ActualizeComposerDraft_RequestCompleted":o=he.handler(n,t,s);break;case"ResetUpdatesCounter":case"ResetUpdatesCounter_RequestCompleted":o=pe.handler(n,t,s);break;case"UserProfileInfo_Update":o=ce.handler(n,t,s);break;case"UserChangedMessageAttachment":case"UserChangedMessageAttachment_RequestCompleted":o=me.handler(n,t,s);break;case"UserDeleteComment":case"UserDeleteComment_RequestCompleted":case"UserRestoreComment":case"UserRestoreComment_RequestCompleted":o=ge.handler(n,t,s);break;case"UserLoadedLikes":case"UserLoadedLikes_RequestCompleted":case"UserChangedLike":case"UserChangedLike_RequestCompleted":o=fe.handler(n,t,s);break;case"UserChangedBrowserNotifications":case"UserChangedBrowserNotifications_RequestCompleted":o=ve.handler(n,t,s);break;case"UserSetMessageReaction":case"UserSetMessageReaction_RequestCompleted":case"UserUnsetMessageReaction":case"UserUnsetMessageReaction_RequestCompleted":o=ke.handler(n,t,s);break;case"ImportContact":o=Se.handler(n,t,s);break;case"VideoMessageShapesGetById":case"VideoMessageShapesGetById__RequestCompleted":o=Ce.handler(n,t,s);break;case"UserChangedPostAttachment":case"UserChangedPostAttachment_RequestCompleted":o=_e.handler(n,t,s);break;case"PollConvoReactions":case"PollConvoReactions_RequestSucceed":o=Ie.handler(n,t,s);break;case"UserChangedChannelComposerDraft":case"UserClearedChannelComposerDraft":o=Me.handler(n,t,s);break;case"UserHitPostSend":case"UserHitPostSend_RequestCompleted":o=Re.handler(n,t,s);break;case"InvalidateMessageReactions":case"InvalidateMessageReactions_RequestCompleted":o=we.handler(n,t,s);break;case"UserChangedPushSetting":case"UserChangedPushSetting_RequestCompleted":o=be.handler(n,t,s);break;case"UserScrolledConvoHistory":case"UserScrolledConvoHistory_RequestSucceed":case"UserScrolledConvoHistory_RequestFailed":o=Ee.handler(n,t,s);break;case"UserReadAllReactions":case"UserReadAllReactions_RequestCompleted":o=Ue.handler(n,t,s);break;default:(0,i.exhaustivenessCheck)(t)}n.convos.set(p.resolveId(),h.safeGet(e.convos,p.resolveId())),n.peers.set(p.resolveId(),p.safeGet(e.peers,p.resolveId())),n.channels.set(v.resolveId(0),v.safeGet(e.channels,v.resolveId(0)));const d=(0,a.finishDraft)(n);var c;if(e.hiddenPinnedMessages!==d.hiddenPinnedMessages&&o.push((c=(0,r._)((function*({storage:e}){return e.set("hidden-pinned-messages",Array.from(d.hiddenPinnedMessages.entries()).reduce(((e,[t,s])=>(e[t]=s,e)),{})),{type:"Noop"}})),function(e){return c.apply(this,arguments)})),e.hiddenBotKeyboards!==d.hiddenBotKeyboards&&o.push((0,r._)((function*({storage:e}){return e.set("hidden-bot-keyboards",d.hiddenBotKeyboards),{type:"Noop"}}))),d.organisers.filters.businessNotify.isHidden&&"Noop"!==t.type&&"UserUndoHideFilter"!==t.type&&"visible"===document.visibilityState){const e=d.organisers.filters.businessNotify.unreadCount;o.push((0,r._)((function*(){return 0===e?{type:"Noop"}:{type:"UserUndoHideFilter",kind:"businessNotify"}})))}return[d,o]}const Te=(e,t,s)=>{switch(t.type){case"InitialData":{const{ownerId:s}=t,a=s?(0,o.getOwnerGroupId)(s):0,i=e.viewer.id;return 0===i?[]:[(b=(0,r._)((function*({storage:e}){var t;return e.identify(i),{type:"SettingThemeUpdated",value:null!=(t=e.get("theme"))?t:"system"}})),function(e){return b.apply(this,arguments)}),(w=(0,r._)((function*({engine:e,api:t,storage:s,stats:r}){var o,d,c,l;const u=yield t.fetch("messages.getLongPollServer",{need_pts:1,lp_version:e.version,group_id:a},{retries:1/0,usePrefetch:!0});if(!u.pts)throw new Error("Отсутствует pts");e.connect((0,n._)({},u,{pts:u.pts}));const[h,p,m,v,C,_,k,M,R,S]=yield t.fetchMany([{method:"messages.getConversations",params:{count:I.CONVOS_PER_PAGE,group_id:a,extended:1}},{method:"messages.getConversationsById",params:{peer_ids:i.toString(),group_id:a,extended:1}},{method:"messages.getFolders",params:{}},{method:"users.get",params:{}},0!==a&&{method:"groups.getById",params:{group_ids:String(a)}},{method:"account.getCounters",params:{filter:"all"}},{method:"account.getInfo",params:{fields:I.API_GET_INFO_FIELDS.join(",")}},{method:"account.getHelpHints",params:{categories:"im"}},{method:"account.getMulti",params:{fields:"profile_type,photo_100"}},{method:"account.getProfileInfo",params:{}}],{retries:1/0,timeout:2e4,usePrefetch:!0}),w=null==C||null==(o=C.groups)?void 0:o[0],b=v[0];if(!b)throw new Error("Не удалось получить текущего пользователя");var E,U,A,P,T,N,F;return s.identify(i),r.init(),{type:"InitialData_RequestCompleted",responseViewer:b,responseMultiAccount:R,responseGroup:w,responseConvos:h,responseProfileInfo:S,responseViewerConvo:p,hasMoreConvos:h.items.length>=I.CONVOS_PER_PAGE,folders:m,activeCallsCount:_.calls||0,unreadCount:{messages:_.messages||0,messagesUnmuted:_.messages_unread_unmuted||0,archive:_.messages_archive_unread||0,archiveMentions:_.messages_archive_mentions_count||0,archiveTotal:_.messages_archive||0,messageRequest:_.message_requests||0,businessNotify:_.business_notify||0,businessNotifyTotal:_.business_notify_all||0,channelsTotal:(null==(d=_.channels)?void 0:d.total_count)||0,folders:_.messages_folders||[]},convoLp:{pts:u.pts},hiddenPinnedMessages:s.get("hidden-pinned-messages"),hiddenBotKeyboards:s.get("hidden-bot-keyboards"),composerDrafts:f.validateRequiredFields(s.get("drafts")||{}),channelComposerDrafts:g.validateRequiredFields(s.get("channels-drafts")||{}),businessNotifyManuallyHidden:!!s.get("business-notify-manually-hidden"),userSettings:{ctrSubmit:Boolean(k.messages_multiline_input),soundNotifications:null==(E=s.get("settings-sound-notifications-on"))||E,browserNotifications:null!=(U=s.get("settings-browser-notifications-on"))&&U,showRecommendations:!Boolean(k.messages_recommendation_list_hidden),countOnlyNotMuted:Boolean(k.show_only_not_muted_messages),autoUnarchive:Boolean(k.messages_auto_unarchive),transcriptAutoShow:Boolean(k.messages_transcript_auto_show),theme:null!=(A=s.get("theme"))?A:"system",verticalFoldersView:null!=(P=s.get("folders-view-vertical"))&&P,messageReactionAnimation:null==(T=s.get("message-reactions-animation"))||T,businessNotify:Boolean(k.business_notify_enabled),push:null!=(N=s.get("settings-push"))?N:y.VIEWER_DEFAULT_PUSH_SETTINGS,teacherVerification:Boolean("1"===(null==(c=null==(l=k.settings)?void 0:l.find((e=>"messages_show_banner_teacher_verification"===e.name)))?void 0:c.value)),messageActionsContextMenu:null!=(F=s.get("settings-message-actions-context-menu"))&&F},helpHints:M.items.reduce(((e,t)=>(e.add(t.id),e)),new Set)}})),function(e){return w.apply(this,arguments)})]}case"InitialData_RequestCompleted":{var a;e.convoConn={status:"running",pts:t.convoLp.pts},e.activeCallsCount=t.activeCallsCount,e.hiddenPinnedMessages=new Map(Object.entries(t.hiddenPinnedMessages||{}).map((([e,t])=>[p.resolveId(parseInt(e)),m.resolveCmid(t)]))),e.hiddenBotKeyboards=t.hiddenBotKeyboards||new Set,e.composerDrafts=t.composerDrafts,e.channelComposerDrafts=t.channelComposerDrafts;const i=(0,o.insertConvos)(e,t.responseConvos.items);(0,o.insertConvos)(e,t.responseViewerConvo.items),e.organisers.filters.businessNotify.isHidden=!!t.businessNotifyManuallyHidden,c.push(e.organisers.filters,"all",i,t.hasMoreConvos),0===t.unreadCount.archiveTotal&&c.push(e.organisers.filters,"archive",[],!1),0===t.unreadCount.messageRequest&&c.push(e.organisers.filters,"messageRequest",[],!1),c.updateCounters(e.organisers.filters,{unread:t.unreadCount.messages,unreadUnmuted:t.unreadCount.messagesUnmuted,headerNotMutedUnread:0,archive:t.unreadCount.archive,archiveMentions:t.unreadCount.archiveMentions,archiveTotal:t.unreadCount.archiveTotal,messageRequests:t.unreadCount.messageRequest,businessNotify:t.unreadCount.businessNotify,businessNotifyTotal:t.unreadCount.businessNotifyTotal}),(0,o.insertFolders)(e,t.folders.items),null==(a=t.unreadCount.folders)||a.forEach((t=>{l.setUnreadCounters(e.organisers.folders,l.resolveId(t.folder_id),t.total_count,t.unmuted_count)})),u.updateCounters(e.organisers.channelFilters,{unread:t.unreadCount.channelsTotal,archiveTotal:0}),(0,o.insertPeers)(e,{apiUsers:[...t.responseConvos.profiles||[]],apiGroups:[...t.responseConvos.groups||[]],apiContacts:[...t.responseConvos.contacts||[]]}),e.viewer.profileInfo=(0,M.fromApiViewerProfileInfo)(t.responseProfileInfo);const{user:d}=(0,k.fromApiUser)(t.responseViewer);e.peers.set(d.id,d),e.viewer.id=d.id,e.viewer.accounts=t.responseMultiAccount.items.map(M.fromApiViewerAccount);const h=t.responseGroup?(0,k.fromApiGroup)(t.responseGroup):void 0;return h&&e.peers.set(h.id,h),e.ownerId=h?h.id:d.id,t.userSettings&&(e.viewer.settings=t.userSettings),e.helpHints=t.helpHints,e.convoConn.status="running",[(S=(0,r._)((function*({engine:e}){return{type:"EngineBatchReceived",variant:{kind:"FromEngine",next:yield e.poll()}}})),function(e){return S.apply(this,arguments)}),(R=(0,r._)((function*({api:e,queue:t}){const s=yield e.fetch("queue.subscribe",{queue_ids:`onlfriends_${d.id},accountcounters_${d.id}`},{retries:1/0});return t.connect((0,n._)({user_id:p.toRealId(d.id)},s)),{type:"QueueBatchReceived",next:yield t.poll()}})),function(e){return R.apply(this,arguments)}),(_=(0,r._)((function*(){return{type:"LoadImportantUsers"}})),function(){return _.apply(this,arguments)}),(C=(0,r._)((function*({api:e,channelEngine:t}){if(!t||!s.me_channels)return{type:"Noop"};try{const[s,r]=yield e.fetchSeq([{method:"channels.getLongPollServer",params:{}},{method:"channels.get",params:{count:I.CHANNELS_PER_PAGE,extended:1}}],{retries:1/0});return t.connect(s),{type:"InitialData_ChannelsReadyForUse",channelLpTS:s.ts,channelsGetResponse:r}}catch(e){return{type:"Noop"}}})),function(e){return C.apply(this,arguments)})]}case"InitialData_ChannelsReadyForUse":{var i,d,h;e.channelConn={status:"running",ts:t.channelLpTS};const s=(0,o.insertChannels)(e,{apiChannels:t.channelsGetResponse.items||[],apiGroups:t.channelsGetResponse.groups||[]}),n=((null==(i=t.channelsGetResponse.items)?void 0:i.length)||0)>=I.CHANNELS_PER_PAGE;return u.push(e.organisers.channelFilters,"all",s,n),(0,o.insertPeers)(e,{apiUsers:[...(null==(d=t.channelsGetResponse)?void 0:d.profiles)||[]],apiGroups:[...(null==(h=t.channelsGetResponse)?void 0:h.groups)||[]],apiContacts:[]}),[(v=(0,r._)((function*({channelEngine:e}){return e?{type:"ChannelEngineBatchReceived",variant:{kind:"FromChannelEngine",next:yield e.poll()}}:{type:"Noop"}})),function(e){return v.apply(this,arguments)})]}default:return[]}var v,C,_,R,S,w,b},Ne=(e,t)=>{var s,r;return"LoadVideoMessageShapes_RequestCompleted"===t.type?(e.videoMessageShapes=null!=(r=null==(s=t.videoMessageShapes)?void 0:s.shapes.reduce(((e,{id:t,raw_path:s})=>(e.set(t,s),e)),new Map))?r:new Map,[]):[]};function Fe(){return(Fe=(0,r._)((function*({api:e,storage:t}){const s=t.get("videomessage-shapes"),r=Math.round((new Date).getTime()/1e3),a=s&&s.expiresAt>r;let o=null;if(a)o=s.response;else try{var i;o=yield e.fetch("messages.getVideoMessageShapes",{client_version:null!=(i=null==s?void 0:s.response.version)?i:0},{retries:3})}catch(e){}const d=o?(0,n._)({},o,{shapes:[...(null==s?void 0:s.response.shapes)||[],...o.shapes]}):null;return!a&&d&&t.set("videomessage-shapes",{response:d,expiresAt:r+86400}),d}))).apply(this,arguments)}},812081:(e,t,s)=>{s.d(t,{initConfig:()=>n});var r=s(453934);function n(){(0,r.enableMapSet)(),(0,r.setAutoFreeze)(!1)}},923562:(e,t,s)=>{e.exports=s.p+"75cd10bdd2be82e03611.js"}}]);try{stManager.done("dist/d44a3dadec967cfec01768a41c432826.464990057b2c4f343a58.js")}catch(e){}