"use strict";(self.webpackChunkvk=self.webpackChunkvk||[]).push([[86164],{402622:(e,t,o)=>{o.d(t,{Icon16Videocam:()=>i});var i=(0,o(825028).makeIcon)("Icon16Videocam","videocam_16","0 0 16 16",'<symbol xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" id="videocam_16"><path fill-rule="evenodd" d="M1.772 4.865C1.5 5.4 1.5 6.1 1.5 7.5v1c0 1.4 0 2.1.272 2.635a2.5 2.5 0 0 0 1.093 1.092C3.4 12.5 4.1 12.5 5.5 12.5h2c1.4 0 2.1 0 2.635-.273a2.5 2.5 0 0 0 1.092-1.092C11.5 10.6 11.5 9.9 11.5 8.5v-1c0-1.4 0-2.1-.273-2.635a2.5 2.5 0 0 0-1.092-1.093C9.6 3.5 8.9 3.5 7.5 3.5h-2c-1.4 0-2.1 0-2.635.272a2.5 2.5 0 0 0-1.093 1.093Zm10.95 1.487 1.876-1.25a.58.58 0 0 1 .902.482v4.832a.58.58 0 0 1-.902.483l-1.875-1.25a.5.5 0 0 1-.223-.417V6.768a.5.5 0 0 1 .223-.416Z" clip-rule="evenodd" /></symbol>',16,16,!1,void 0)},647605:(e,t,o)=>{o.d(t,{Icon24ErrorCircleOutline:()=>i});var i=(0,o(825028).makeIcon)("Icon24ErrorCircleOutline","error_circle_outline_24","0 0 24 24",'<symbol xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" id="error_circle_outline_24"><path fill-rule="evenodd" d="M4.929 4.929A9.971 9.971 0 0 1 12 2a9.972 9.972 0 0 1 7.071 2.929A9.972 9.972 0 0 1 22 12a9.972 9.972 0 0 1-2.929 7.071A9.972 9.972 0 0 1 12 22a9.972 9.972 0 0 1-7.071-2.929A9.972 9.972 0 0 1 2 12a9.972 9.972 0 0 1 2.929-7.071ZM12 3.8a8.172 8.172 0 0 0-5.798 2.402A8.172 8.172 0 0 0 3.8 12a8.17 8.17 0 0 0 2.402 5.798A8.171 8.171 0 0 0 12 20.2a8.172 8.172 0 0 0 5.798-2.402A8.172 8.172 0 0 0 20.2 12a8.171 8.171 0 0 0-2.402-5.798A8.172 8.172 0 0 0 12 3.8ZM13 16a1 1 0 1 1-2 0 1 1 0 0 1 2 0Zm-1-9a.9.9 0 0 1 .9.9v5.2a.9.9 0 0 1-1.8 0V7.9A.9.9 0 0 1 12 7Z" clip-rule="evenodd" /></symbol>',24,24,!1,void 0)},564444:(e,t,o)=>{o.d(t,{Icon24MenuOutline:()=>i});var i=(0,o(825028).makeIcon)("Icon24MenuOutline","menu_outline_24","0 0 24 24",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" id="menu_outline_24"><path fill="currentColor" d="M21 11H3a1 1 0 1 0 0 2h18a1 1 0 1 0 0-2zm0-7H3a1 1 0 0 0 0 2h18a1 1 0 1 0 0-2zM3 20h18a1 1 0 1 0 0-2H3a1 1 0 1 0 0 2z" /></symbol>',24,24,!1,void 0)},432483:(e,t,o)=>{o.d(t,{Icon24MoreHorizontal:()=>i});var i=(0,o(825028).makeIcon)("Icon24MoreHorizontal","more_horizontal_24","0 0 24 24",'<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="more_horizontal_24"><g fill="none" fill-rule="evenodd"><path d="M24 0H0v24h24z" /><path fill="currentColor" d="M18 10c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2Zm-6 4c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2Zm-6 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2Z" /></g></symbol>',24,24,!1,void 0)},611695:(e,t,o)=>{o.d(t,{Icon24NarrativeActiveOutline:()=>i});var i=(0,o(825028).makeIcon)("Icon24NarrativeActiveOutline","narrative_active_outline_24","0 0 24 24",'<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="narrative_active_outline_24"><path fill="currentColor" d="M14.298 1.435c.732.17 1.377.543 1.891 1.092.521.556.825 1.145 1.151 2.298l.79 2.944a1 1 0 1 1-1.931.518l-.72-2.69-.113-.401c-.215-.729-.377-1.024-.636-1.302a1.726 1.726 0 0 0-.887-.512c-.37-.086-.707-.078-1.445.1l-.405.104L6.866 4.96c-.854.228-1.254.394-1.51.583l-.06.047-.134.119c-.26.243-.43.539-.512.886-.093.4-.076.763.148 1.638l2.723 10.17.113.401c.215.729.377 1.024.636 1.302.244.26.54.43.887.512.401.093.745.076 1.607-.14a1 1 0 1 1 .487 1.94c-1.148.288-1.805.32-2.549.147a3.726 3.726 0 0 1-1.891-1.092c-.521-.556-.825-1.145-1.151-2.298L2.922 8.963c-.355-1.324-.405-2.027-.22-2.823a3.722 3.722 0 0 1 .93-1.728l.183-.182.179-.157c.496-.412 1.077-.685 2.091-.973l.263-.072 5.128-1.374c1.323-.355 2.026-.405 2.822-.22zM18.368 11c2 0 3.632 1.592 3.632 3.567 0 1.91-.772 2.851-3.78 5.134l-1.328 1.007c-.527.4-1.257.4-1.784 0l-1.328-1.007C10.772 17.418 10 16.476 10 14.567 10 12.592 11.631 11 13.632 11c.829 0 1.595.224 2.282.66l.086.057.086-.057a4.174 4.174 0 0 1 2.036-.653z" /></symbol>',24,24,!1,void 0)},752198:(e,t,o)=>{o.d(t,{Icon24Write:()=>i});var i=(0,o(825028).makeIcon)("Icon24Write","write_24","0 0 24 24",'<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="write_24"><g fill="none" fill-rule="evenodd"><path d="M0 0h24v24H0z" /><path fill="currentColor" d="m14.188 6.273 3.54 3.54-8.624 8.622a6.674 6.674 0 0 1-2.77 1.664l-2.903.886a.334.334 0 0 1-.416-.416l.886-2.902a6.674 6.674 0 0 1 1.664-2.771l8.623-8.623Zm1.061-1.06 1.769-1.77a1.5 1.5 0 0 1 2.121 0l1.418 1.419a1.5 1.5 0 0 1 0 2.121L18.79 8.752l-3.54-3.54Z" /></g></symbol>',24,24,!1,void 0)},523087:(e,t,o)=>{o.d(t,{Icon36Add:()=>i});var i=(0,o(825028).makeIcon)("Icon36Add","add_36","0 0 36 36",'<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36" id="add_36"><g fill="none" fill-rule="evenodd"><path d="M0 0h36v36H0z" /><path fill="currentColor" d="M19.5 19.5v9a1.5 1.5 0 0 1-3 0v-9h-9a1.5 1.5 0 0 1 0-3h9v-9a1.5 1.5 0 0 1 3 0v9h9a1.5 1.5 0 0 1 0 3h-9Z" /></g></symbol>',36,36,!1,void 0)},922574:(e,t,o)=>{var i;o.d(t,{BatchOperationType:()=>i}),function(e){e.Add="add",e.Delete="delete"}(i||(i={}))},693982:(e,t,o)=>{function i(e){const t=e.match(/^([a-z_]+)([0-9\-_]+)$/);if(!t)return null;const[,o,i]=t;return{objectType:o,objectId:i}}o.d(t,{getElementLikeButtonCount:()=>n,getElementLikeButtonIcon:()=>d,getElementLikeButtonLabel:()=>h,likePostObjectId:()=>r,likeReplyObjectId:()=>s,parseLikeObjectId:()=>i});const r=e=>`wall${e}`,s=e=>`wall_reply${e}`;var a;const n=e=>null!=(a=null==e?void 0:e.querySelector(".like_button_count, ._like_button_count"))?a:void 0;var l;const d=e=>null!=(l=null==e?void 0:e.querySelector(".like_button_icon, ._like_button_icon"))?l:void 0;var c;const h=e=>null!=(c=e.querySelector(".like_button_label, ._like_button_label"))?c:void 0},234514:(e,t,o)=>{o.d(t,{LikeButtonTypes:()=>i});const i={like:"like",share:"share",views:"views",comment:"comment"}},533919:(e,t,o)=>{o.d(t,{highlightModule:()=>c});var i=o(145637),r=o(10645),s=o(438221),a=o(795558),n=o(321850);let l,d;function c(e){const t=document.getElementById(e.module);if(!t||!t.classList.contains("module"))return;window.cur.__narrowBarForceNotFixed=!0;const o=e.speed?e.speed:300;(0,s.scrollToY)((0,a.getXY)(t)[1]-100,o);const c=()=>{l&&(l.hideTT(),(0,s.enableBodyScroll)(),delete window.cur.__narrowBarForceNotFixed,(0,r.updateNarrow)(),e.onClose&&e.onClose())};l=new i.default(t,e.text,{highlight:!0,width:250,offset:[0,-17],side:"bottom",withCloseButton:!0,onBGClick:c,onCloseButtonClick:c}),l.show(),(0,s.disableBodyScroll)(),e.autoCancelDelay&&(d=setTimeout((()=>{c(),d=null}),e.autoCancelDelay),(0,n.pushNavDestroy)((()=>{d&&clearTimeout(d)})))}},687437:(e,t,o)=>{o.d(t,{PROFILE_MEDIA_NARROW_BLOCK_ID:()=>i});const i="profile_media_narrow_block"},898298:(e,t,o)=>{o.d(t,{isIntentPreviewHidden:()=>l,isIntentPreviewInActionStatusBar:()=>n,isIntentPreviewUseCurrent:()=>d,isVariantHidden:()=>s,isVariantInActionStatusBar:()=>r,parsePreviewVariant:()=>h,previewVisibilityIntentForVariant:()=>c,previewVisibilityUseCurrent:()=>a});var i=o(580151);const r=e=>e===i.PreviewVariantActionStatusBar,s=e=>e===i.PreviewVariantHidden,a={kind:"useCurrent"},n=e=>e.kind===i.PreviewVariantActionStatusBar,l=e=>e.kind===i.PreviewVariantHidden,d=e=>"useCurrent"===e.kind,c=e=>e?{kind:e}:a,h=e=>i.PreviewVariants.includes(e)?e:void 0},580151:(e,t,o)=>{o.d(t,{PreviewVariantActionStatusBar:()=>i,PreviewVariantHidden:()=>r,PreviewVariants:()=>s});const i="action_status_bar",r="hidden",s=[i,r]},682951:(e,t,o)=>{o.d(t,{REACTIONS_COUNTS_RESPONSE_FIELD:()=>l,SIZE_128:()=>n,SIZE_32:()=>r,SIZE_40:()=>s,SIZE_96:()=>a,SUPPORTED_OBJECT_TYPES:()=>i,WK_SECTION_PREFIX_REACTIONS:()=>d});const i={wall:"wall",wall_reply:"wall_reply"},r={width:32,height:32},s={width:40,height:40},a={width:96,height:96},n={width:128,height:128},l="reactions_counts",d="reactions"},109454:(e,t,o)=>{o.d(t,{isReactionsFullUpdatePayload:()=>a,reactionsCountsOnlyUpdatePayload:()=>n,reactionsCountsUpdatePayload:()=>s});var i=o(434788),r=o(900641);const s=(e,t)=>(0,i._)({kind:r.PayloadKindFull},e,{reactionIdState:{reactionId:t.id}}),a=e=>e.kind===r.PayloadKindFull,n=e=>(0,i._)({kind:r.PayloadKindCountsOnly},e)},900641:(e,t,o)=>{o.d(t,{PayloadKindCountsOnly:()=>i,PayloadKindFull:()=>r});const i="counts_only",r="counts_with_current_reaction"},999237:(e,t,o)=>{o.d(t,{triggerReactionsUpdate:()=>n});var i=o(693982),r=o(682951),s=o(505426),a=o(109454);const n=(e,t,o,n)=>{const l=(0,i.parseLikeObjectId)(e);l&&l.objectType===r.SUPPORTED_OBJECT_TYPES.wall&&l.objectId?(0,s.emitEvent)(s.WallDataEvents.post_reactions_counts_update,function(e,t,o,i){const r={counts:e,isFromWkLayer:null==t?void 0:t.isFromWkLayer,isPrimaryLikeButtonClick:null==t?void 0:t.isPrimaryLikeButtonClick,isQueueUpdate:null==t?void 0:t.isQueueUpdate,isUserAction:t.isUserAction,postFullId:o.objectId,previewVisibility:t.previewVisibility,reactionIdState:i?{reactionId:i.id}:void 0,suggestSubscribe:t.suggestSubscribe};return i?(0,a.reactionsCountsUpdatePayload)(r,i):(0,a.reactionsCountsOnlyUpdatePayload)(r)}(t,n,l,o)):l&&l.objectType===r.SUPPORTED_OBJECT_TYPES.wall_reply&&l.objectId?(0,s.emitEvent)(s.WallDataEvents.reply_reactions_counts_update,{counts:t,replyFullId:l.objectId,reactionIdState:o?{reactionId:o.id}:void 0}):console.warn("Unsupported reactions object update",e)}},386342:(e,t,o)=>{o.d(t,{NarrativeBox:()=>E});var i=o(785893),r=o(667294),s=o(29271),a=o(400469),n=o(10781),l=o(704703),d=o(444402),c=o(910434),h=o(630892),v=o(584356),u=o(664988),p=o(816328),_=o(95432),g=o(827652),m=o(247563),w=o(365035),f=o(432483),y=o(564444),C=o(858069),S=o(931917),x=o(816511),N=o(400856),b=o(126116),k=o(832550);class E extends r.Component{render(){const{narratives:e,onClose:t,boxData:o,title:a,showNarrativeNumber:n}=this.props,{isLoad:d,draggingNarrativeRawId:h}=this.state,v=e.length<o.count,u=this.canEdit(),{actionButtons:_,footerBefore:g}=this.getBoxActionButtons();return(0,i.jsxs)(x.ModalBox,{className:"NarrativeBox",children:[(0,i.jsx)(N.ModalHeader,{onClose:()=>t(),closeAriaLabel:s.getLang("global_close"),indicator:n&&o.count>0?o.count:void 0,children:a||s.getLang("stories_narratives_title")}),(0,i.jsx)("div",{className:"NarrativeBox__body",children:(0,i.jsx)("div",{className:"NarrativeBox__scrollContainer",ref:this.scrollContainerRef,children:(0,i.jsxs)("div",{className:"NarrativeBox__scrollInner",children:[(0,i.jsxs)("div",{className:"NarrativeBox__list",ref:this.gridRef,children:[u&&(0,i.jsxs)(r.Fragment,{children:[(0,i.jsx)(l.NarrativeRowCreation,{onClick:this.onCreateNarrativeClick},"create"),e.map((e=>(0,i.jsx)(m.NarrativeRow,{className:w.BOX_ITEM_DRAGGABLE_CLASS,narrative:e,onClick:t=>this.onNarrativeClick(t,e),aside:(0,i.jsxs)("div",{className:"NarrativeBox__aside",children:[e.rawId===h&&(0,i.jsx)("div",{className:"NarrativeBox__action NarrativeBox__action--more",children:(0,i.jsx)(f.Icon24MoreHorizontal,{})}),e.rawId!==h&&(0,i.jsx)(p.default,{position:"b",align:"center",trigger:"hover",data:this.getNarrativeItemActions(e),children:(0,i.jsx)("div",{className:"NarrativeBox__action NarrativeBox__action--more",children:(0,i.jsx)(f.Icon24MoreHorizontal,{})})}),(0,i.jsx)("div",{className:"NarrativeBox__action NarrativeBox__action--burger",children:(0,i.jsx)(y.Icon24MenuOutline,{})})]})},e.rawId)))]}),!u&&(0,i.jsx)(r.Fragment,{children:e.map((e=>(0,i.jsx)(m.NarrativeRow,{narrative:e,onClick:t=>this.onNarrativeClick(t,e),aside:(0,i.jsx)("div",{className:"NarrativeBox__aside",children:(0,i.jsx)(p.default,{position:"b",align:"right",trigger:"hover",data:this.getNarrativeItemActions(e),children:(0,i.jsx)("div",{className:"NarrativeBox__action NarrativeBox__action--more",children:(0,i.jsx)(f.Icon24MoreHorizontal,{})})})})},e.rawId)))})]}),d&&(0,i.jsx)("div",{className:"NarrativeBox__loader",children:(0,i.jsx)(c.default,{})},"loader"),v&&(0,i.jsx)("div",{className:"NarrativeBox__sentinel",ref:this.sentinelRef})]})})}),(0,i.jsx)(b.ModalFooter,{before:g,actionButtons:_})]})}canEdit(){const{type:e,onSave:t,onReorder:o,onRemove:i}=this.props;return e===a.BoxType.edit&&Boolean(t)&&Boolean(o)&&Boolean(i)}componentDidMount(){this.initSorter(),this.observeNarrativeScrollIfNeeded(),this.props.refreshCoordinates()}componentWillUnmount(){this.deInitSorter(),this.unObserveNarrativeScrollIfNeeded()}editNarrative(e){const{boxData:t}=this.props;(0,C.sendNarrativeAnalytic)(C.NarrativeAnalyticEventType.clickToEditNarrative,e,this.props.navScreen),S.Ranges.isUserId(t.ownerId)?this.openNarrativeEditorBox(e):window.open(`https://${location.hostname}${location.pathname}?act=narrative_edit&nid=${e.id}`)}shareNarrative(e){g.Likes.share(`narrative${e.rawId}`),(0,C.sendNarrativeAnalytic)(C.NarrativeAnalyticEventType.shareNarrative,e,this.props.navScreen)}bookmarkNarrative(e){const{onBookmark:t}=this.props;(0,_.bookmark)(e.ownerId,e.id,"narrative",e.bookmarkHash,e.isBookmarked),(0,C.sendNarrativeAnalytic)(C.NarrativeAnalyticEventType.addToBookmarks,e,this.props.navScreen),t(e)}removeNarrative(e){var t,o;null==(o=(t=this.props).onRemove)||o.call(t,e)}observeNarrativeScrollIfNeeded(){const{narratives:e,boxData:t}=this.props;if(e.length<t.count){const e=this.scrollContainerRef.current,t=this.sentinelRef.current;if(!t)return;this.observer=new IntersectionObserver((e=>{e.forEach((e=>{e.intersectionRatio>0&&this.loadViewers()}))}),{threshold:[0],root:e,rootMargin:"0px 0px 480px 0px"}),this.observer.observe(t)}}unObserveNarrativeScrollIfNeeded(){this.observer&&this.observer.disconnect()}loadViewers(){const{loadMore:e}=this.props,{isLoad:t}=this.state;t||(this.setState({isLoad:!0}),e().finally((()=>{this.setState({isLoad:!1})})))}initSorter(){var e,t;const{boxData:o}=this.props;if(!this.canEdit())return;const i=null==(e=this.scrollContainerRef)?void 0:e.current,r=null==(t=this.gridRef)?void 0:t.current;if(!r||!i)return;const s={dragThreshold:0,wrapNode:i,onDragFinish:()=>{this.setState({draggingNarrativeRawId:""})},onDragStart:e=>{const t=this.getNarrativeIdByEl(e);this.setState({draggingNarrativeRawId:`${o.ownerId}_${t}`})},onReorder:e=>{const t=this.getNarrativeIdByEl(e),o=Array.from(r.querySelectorAll(`.${w.BOX_ITEM_DRAGGABLE_CLASS}`));if(1===o.length)return;let i=0,s=0;const a=o.findIndex((e=>this.getNarrativeIdByEl(e)===t));o[a-1]&&(i=this.getNarrativeIdByEl(o[a-1])),o[a+1]&&(s=this.getNarrativeIdByEl(o[a+1])),this.saveReorder(t,s,i)}};this.sorter=new d.default(r,"",s)}saveReorder(e,t,o){const{boxData:i,onReorder:r}=this.props;if(!r)return;const a=i.ownerId;window.ajax.post("al_stories.php",{act:"narratives_reorder",narrative_id:e,before_narrative_id:t,after_narrative_id:o,hash:i.reorderHash,owner_id:a},{onDone:()=>{var t;const{narratives:o}=this.props,i=null==(t=this.gridRef)?void 0:t.current;if(!i)return;const s=Array.from(i.querySelectorAll(`.${w.BOX_ITEM_DRAGGABLE_CLASS}`)),n=[];s.forEach((e=>{const t=this.getNarrativeIdByEl(e),i=o.find((e=>e.id===t));i&&n.push(i)})),(0,C.sendNarrativeAnalytic)(C.NarrativeAnalyticEventType.changeSort,{ownerId:a,id:e},this.props.navScreen),r(n)},onFail:e=>((0,v.showDoneBox)(e||s.getLang("global_error")),!0)})}getNarrativeIdByEl(e){return(0,u.intval)(e.getAttribute("data-id"))}deInitSorter(){this.sorter&&this.sorter.destroy()}constructor(e){super(e),this.getBoxActionButtons=()=>{const{onClose:e,boxData:t,type:o}=this.props,r=[(0,i.jsx)(k.Button,{mode:"primary",size:"m",onClick:()=>e(),children:s.getLang("global_close")},"close")];let n;if(o===a.BoxType.edit&&t.userId===t.ownerId){const o=t.ownerDomain||`id${t.userId}`,r=()=>{e(),(0,_.showWiki)({w:"stories"})};n=(0,i.jsx)(k.Button,{size:"m",mode:"tertiary",href:`${o}?w=stories`,onClick:r,children:s.getLang("stories_archive")})}return{actionButtons:r,footerBefore:n}},this.onNarrativeClick=(e,t)=>{if(e.ctrlKey||e.metaKey)return;e.preventDefault(),e.stopPropagation();const o=this.props.list?this.props.list:`narrative${t.ownerId}_${t.id}`;(0,n.showNarrative)(t.ownerId,t.id,0,o,{trackCode:this.props.trackCode,source:this.props.source})},this.onCreateNarrativeClick=()=>{const{boxData:e,navScreen:t}=this.props,o=e.ownerId;if((0,C.sendNarrativeAnalytic)(C.NarrativeAnalyticEventType.createNarrative,{ownerId:o},t),S.Ranges.isUserId(o))return void this.openNarrativeEditorBox();const i=e.ownerDomain?e.ownerDomain:"club"+-o;window.open(`https://${location.hostname}/${i}?act=narrative_create`)},this.openNarrativeEditorBox=e=>{const{onSave:t,boxData:o,onClose:i,navScreen:r}=this.props;if(!t)return;let s=[];(null==e?void 0:e.stories.length)&&(s=[...e.stories]);const a={narrative:e,selectedStories:s,publishHash:o.publishHash,onSave:e=>{t(e),i()},navScreen:r};(0,h.showNarrativeEditorBox)(o.ownerId,a)},this.getNarrativeItemActions=e=>{const t=[];if(this.canEdit())t.push({text:s.getLang("global_edit"),onClick:()=>this.editNarrative(e)}),t.push({text:s.getLang("stories_share"),onClick:()=>this.shareNarrative(e)}),t.push({separator:!0}),t.push({text:s.getLang("global_delete"),onClick:()=>this.removeNarrative(e)});else{const o=e.isBookmarked?s.getLang("global_remove_from_bookmarks"):s.getLang("global_add_to_bookmarks");t.push({text:o,onClick:()=>this.bookmarkNarrative(e)}),t.push({text:s.getLang("stories_share"),onClick:()=>this.shareNarrative(e)})}return t},this.state={isLoad:!1,draggingNarrativeRawId:""},this.scrollContainerRef=(0,r.createRef)(),this.gridRef=(0,r.createRef)(),this.sentinelRef=(0,r.createRef)()}}E.defaultProps={type:a.BoxType.view,showNarrativeNumber:!0}},400469:(e,t,o)=>{var i;o.d(t,{BoxType:()=>i}),function(e){e[e.view=0]="view",e[e.edit=1]="edit"}(i||(i={}))},24237:(e,t,o)=>{o.d(t,{NarrativeChooseBox:()=>C});var i=o(434788),r=o(785893),s=o(667294),a=o(816511),n=o(400856),l=o(126116),d=o(832550),c=o(29271),h=o(659397),v=o(625533),u=o(704703),p=o(247563),_=o(584356),g=o(630892),m=o(10781),w=o(922574),f=o(858069),y=o(931917);class C extends s.Component{getDoneText(e){const t=e.filter((e=>e.op===w.BatchOperationType.Add)).length;if(t>1)return c.getLang("stories_saved_in_narratives_text");if(1===t)return c.getLang("stories_saved_in_narrative_text");{const t=e.filter((e=>e.op===w.BatchOperationType.Delete)).length;if(t>1)return c.getLang("stories_deleted_in_narratives_text");if(1===t)return c.getLang("stories_deleted_in_narrative_text")}return c.getLang("stories_settings_saved")}getDiffOperations(e,t,o){const i=[];return Object.keys(t).forEach((t=>{o[t]||i.push({op:w.BatchOperationType.Add,story_id:e,narrative_id:Number(t)})})),Object.keys(o).forEach((o=>{t[o]||i.push({op:w.BatchOperationType.Delete,story_id:e,narrative_id:Number(o)})})),i}getSelectedNarrativeIdsMap(e,t){return t.reduce(((t,o)=>(o.stories.find((t=>t.id===e))&&(t[o.id]=!0),t)),{})}render(){const{onClose:e,narratives:t,boxData:o}=this.props,{selectedNarrativeIds:i}=this.state,s=t.length<o.count;return(0,r.jsxs)(a.ModalBox,{className:"NarrativeChooseBox",children:[(0,r.jsx)(n.ModalHeader,{onClose:e,closeAriaLabel:c.getLang("global_close"),children:c.getLang("stories_narrative_choosing")}),(0,r.jsx)("div",{className:"NarrativeChooseBox__body",children:(0,r.jsxs)(v.default,{className:"NarrativeChooseBox__list",itemHeight:80,loadMore:this.loadMore,hasMore:s,children:[(0,r.jsx)(u.NarrativeRowCreation,{onClick:this.onCreateNarrativeClick,clickable:!0,size:50},"create"),t.map((e=>(0,r.jsx)(p.NarrativeRow,{narrative:e,onClick:()=>this.onCheckboxClick(e),size:50,noBorder:!0,clickable:!0,aside:(0,r.jsx)("div",{className:(0,h.classNames)("NarrativeChooseBox__checkbox",{"NarrativeChooseBox__checkbox--checked":i[e.id]})})},e.rawId)))]})}),(0,r.jsx)(l.ModalFooter,{actionButtons:this.getBoxActionButtons()})]})}constructor(e){super(e),this.loadMore=()=>{const{loadMore:e,story:t}=this.props,{selectedNarrativeIds:o}=this.state;return e().then(((e=[])=>{this.setState({selectedNarrativeIds:(0,i._)({},o,this.getSelectedNarrativeIdsMap(t.id,e))})}))},this.onCheckboxClick=e=>{const{selectedNarrativeIds:t}=this.state,o=(0,i._)({},t);o[e.id]?delete o[e.id]:o[e.id]=!0,this.setState({selectedNarrativeIds:o})},this.getBoxActionButtons=()=>{const{onClose:e,story:t,narratives:o}=this.props,{isLoad:i,selectedNarrativeIds:s}=this.state,a=this.getSelectedNarrativeIdsMap(t.id,o),n=this.getDiffOperations(t.id,s,a);return[(0,r.jsx)(d.Button,{size:"m",mode:"tertiary",onClick:()=>e(),children:c.getLang("global_close")},"close"),(0,r.jsx)(d.Button,{mode:"primary",size:"m",disabled:!n.length,onClick:this.save,loading:i,children:c.getLang("global_save")},"save")]},this.save=()=>{const{story:e,narratives:t,boxData:o,onClose:i,onSave:r,navScreen:s}=this.props,{selectedNarrativeIds:a}=this.state,n=this.getSelectedNarrativeIdsMap(e.id,t),l=this.getDiffOperations(e.id,a,n),d=Boolean(Object.keys(a).length),h=o.ownerId;this.setState({isLoad:!0}),window.ajax.post("al_stories.php",{act:"batch_edit",owner_id:h,operations:JSON.stringify(l),hash:o.editHash},{onDone:()=>{r(d),i(),(0,f.sendNarrativeAnalytic)(f.NarrativeAnalyticEventType.addStoryToNarrative,{ownerId:h},s),(0,_.showDoneBox)(this.getDoneText(l))},onFail:e=>((0,_.showDoneBox)(e||c.getLang("global_error")),!0),hideProgress:()=>{this.setState({isLoad:!1})}})},this.onCreateNarrativeClick=()=>{const{story:e,narratives:t,onSave:o,onClose:i,boxData:r,navScreen:s}=this.props,a=r.ownerId;if(y.Ranges.isUserId(a)){const r=this.getSelectedNarrativeIdsMap(e.id,t);let n=Boolean(Object.keys(r).length);const l={selectedStories:[e],onSave:()=>{n=!0},onClose:()=>{o(n),i()},navScreen:s};return(0,g.showNarrativeEditorBox)(a,l),void(0,f.sendNarrativeAnalytic)(f.NarrativeAnalyticEventType.createNarrative,{ownerId:a},s)}const n=r.ownerDomain?r.ownerDomain:"club"+-r.ownerId;window.nav.go(`${n}?act=narrative_create&story_id=${e.id}`)},this.onNarrativeClick=(e,t)=>{e.ctrlKey||e.metaKey||((0,m.showNarrative)(t.ownerId,t.id,0,`narrative${t.ownerId}_${t.id}`),e.preventDefault(),e.stopPropagation())},this.state={isLoad:!1,selectedNarrativeIds:this.getSelectedNarrativeIdsMap(e.story.id,e.narratives)}}}},983647:(e,t,o)=>{o.d(t,{MAX_THUMB_HEIGHT:()=>p,MAX_THUMB_WIDTH:()=>_,NarrativeCoverCropper:()=>g});var i=o(785893),r=o(667294),s=o(29271),a=o(352699),n=o(514986),l=o(970978),d=o(230059),c=o(816511),h=o(400856),v=o(398310),u=o(832550);const p=604,_=468;class g extends r.Component{getCropForTagger(e){const{coverWidth:t,coverHeight:o}=this.props;let i;if(e){let r=Math.round(e.width*t),s=Math.round(e.height*o);if(Math.abs(s-r)>1)return i;s=r,i={top:Math.round(e.y*o),left:Math.round(e.x*t),width:r,height:s}}return i}getCropForSaving(e){const{coverWidth:t,coverHeight:o}=this.props;return{y:e.top/o,x:e.left/t,width:e.width/t,height:e.height/o}}render(){const{onClose:e,coverUrl:t,coverHeight:o,coverWidth:r,thumbHeight:n,thumbWidth:l,crop:d}=this.props,{isLoading:p}=this.state;return(0,i.jsxs)(c.ModalBox,{className:"NarrativeCoverCropper",children:[(0,i.jsx)(h.ModalHeader,{onClose:e,closeAriaLabel:s.getLang("global_close"),children:s.getLang("stories_cover_cropper_title")}),(0,i.jsxs)("div",{className:"NarrativeCoverCropper__inner",children:[(0,i.jsxs)("div",{className:"NarrativeCoverCropper__info",children:[(0,i.jsx)("div",{children:s.getLang("stories_cover_cropper_info_1")}),(0,i.jsx)("div",{children:s.getLang("stories_cover_cropper_info_2")})]}),(0,i.jsx)("div",{className:"NarrativeCoverCropper__frame",children:(0,i.jsx)(a.PhotoAreaSelector,{className:"NarrativeCoverCropper__tagger",imgSrc:t,imgHeight:o,imgWidth:r,previewHeight:n,previewWidth:l,minHeight:75,minWidth:75,isSquare:!0,preview100:!0,cropRect:this.getCropForTagger(d),onCropUpdated:this.onCropUpdate})}),(0,i.jsxs)(v.ButtonLayout,{children:[(0,i.jsx)(u.Button,{loading:p,mode:"primary",size:"m",onClick:this.onSaveCrop,children:s.getLang("stories_cover_next")}),(0,i.jsx)(u.Button,{disabled:p,mode:"secondary",size:"m",onClick:e,children:s.getLang("stories_cover_back")})]})]})]})}constructor(e){super(e),this.onSaveCrop=()=>{const{onSave:e,onClose:t,coverUrl:o}=this.props,i=this.crop;i&&(this.setState({isLoading:!0}),(0,d.getCroppedImage)(o,i.left,i.top,i.width,i.height).then((t=>e(this.getCropForSaving(i),t.src))).then(t).catch((e=>{this.setState({isLoading:!1}),(0,n.showFastBox)(s.getLang("global_error"),e||s.getLang("global_unknown_error")),console.error(e),(0,l.logError)(new Error("error with onSaveCrop"+(e?`: ${e}`:"")))})))},this.onCropUpdate=e=>{this.crop=e},this.state={isLoading:!1}}}},16344:(e,t,o)=>{o.d(t,{NarrativeCreateLiteBox:()=>m});var i=o(785893),r=o(667294),s=o(29271),a=o(82161),n=o(365035),l=o(40138),d=o(535902),c=o(725296),h=o(816511),v=o(400856),u=o(629932),p=o(126116),_=o(832550),g=o(86894);class m extends r.Component{render(){const{onClose:e,ownerName:t,stories:o}=this.props,{name:r,coverStory:a}=this.state,c=null==a?void 0:a.preview;return(0,i.jsxs)(h.ModalBox,{children:[(0,i.jsx)(v.ModalHeader,{onClose:e,closeAriaLabel:s.getLang("global_close"),children:s.getLang("stories_creating_narrative")}),(0,i.jsxs)("div",{className:"NarrativeCreateLiteBox__inner",children:[(0,i.jsx)("div",{className:"NarrativeCreateLiteBox__title",children:s.getLang("groups_edit_narrative_title")}),(0,i.jsx)(g.Input,{type:"text",value:r,onChange:this.onNameChange,placeholder:s.getLang("stories_enter_name"),maxLength:n.NARRATIVE_MAX_TITLE_LENGTH,getRef:this.nameInputRef,autoFocus:!0}),(0,i.jsx)("div",{className:"NarrativeCreateLiteBox__title",children:s.getLang("groups_edit_narrative_preview")}),(0,i.jsx)("div",{className:"NarrativeCreateLiteBox__text",children:s.getLang("groups_edit_narrative_pin_text")}),(0,i.jsxs)("div",{className:"NarrativeCreateLiteBox__previews",children:[(0,i.jsxs)("div",{className:"NarrativeCreateLiteBox__previewWrapper",children:[(0,i.jsx)("div",{className:"NarrativeCreateLiteBox__previewTitle",children:s.getLang("stories_narrative_preview_block_title")}),(0,i.jsxs)("div",{className:"NarrativeCreateLiteBox__smallPreview",children:[(0,i.jsx)(l.NarrativeItemPreviewCover,{cover:c}),(0,i.jsx)("span",{className:"NarrativeCreateLiteBox__smallPreviewName",children:(0,i.jsx)(u.TextClamp,{lines:2,children:r||s.getLang("stories_narrative_name_full")})})]})]}),(0,i.jsxs)("div",{className:"NarrativeCreateLiteBox__previewWrapper NarrativeCreateLiteBox__previewWrapper--snippet",children:[(0,i.jsx)("div",{className:"NarrativeCreateLiteBox__previewTitle",children:s.getLang("stories_narrative_preview_feed_title")}),(0,i.jsx)(d.NarrativeSnippet,{className:"NarrativeCreateLiteBox__snippet",ownerName:t,coverUrl:c,title:r,storyCount:o.length})]})]})]}),(0,i.jsx)(p.ModalFooter,{actionButtons:this.getBoxActionButtons()})]})}constructor(e){super(e),this.onNameChange=e=>{const t=e.target.value,o=(0,a.trim)(t)?t:"";this.setState({name:o})},this.getBoxActionButtons=()=>{const{isLoad:e}=this.state;return[(0,i.jsx)(_.Button,{size:"m",mode:"primary",onClick:this.save,loading:e,children:s.getLang("groups_edit_narrative_publish")},"publish")]},this.save=()=>{const{isLoad:e}=this.state;let{name:t=""}=this.state;e||(t=(0,a.trim)(t),t?(this.setState({isLoad:!0}),this.props.onSave(t).catch((()=>{this.setState({isLoad:!1})}))):(0,c.notaBene)(this.nameInputRef.current))},this.state={isLoad:!1,name:"",coverStory:e.stories[0]},this.nameInputRef=(0,r.createRef)()}}},378839:(e,t,o)=>{o.d(t,{NarrativeEditor:()=>y});var i=o(785893),r=o(667294),s=o(29271),a=o(399133),n=o(816511),l=o(400856),d=o(832550),c=o(725296),h=o(584356),v=o(382483),u=o(317130),p=o(82161),_=o(880660),g=o(90729),m=o(796822),w=o(858069),f=o(501977);class y extends r.Component{componentDidMount(){var e,t;null==(t=(e=this.props).refreshCoordinates)||t.call(e)}render(){const{appearance:e}=this.props;return e===a.EditorViewType.box?(0,i.jsx)(n.ModalBox,{children:(0,i.jsxs)("div",{className:"NarrativeEditor",children:[(0,i.jsx)(l.ModalHeader,{onClose:()=>this.close(),closeAriaLabel:s.getLang("global_close"),children:this.getBoxTitle()}),(0,i.jsx)("div",{className:"NarrativeEditor__modalBody",children:this.renderInner()})]})}):(0,i.jsx)("div",{className:"NarrativeEditor NarrativeEditor--page",children:this.renderInner()})}renderInner(){const{storyIds:e,storyMap:t,onStoryLinkUpdate:o,isEditingLinksAvailable:r,linkData:s,appearance:n,loadMore:l,hasMore:d,coverUploadConfig:c,ownerId:h}=this.props,{name:p,selectedStoryIds:_,cover:w,section:f}=this.state,y=this.getSelectedStories(),C=(null==w?void 0:w.url)||"";return(0,i.jsxs)("div",{className:"NarrativeEditor__inner",children:[f===a.EditorSectionType.main&&(0,i.jsxs)(m.NarrativeEditorSection,{appearance:n,actionFooterButtons:this.getFooterButtons(),children:[(0,i.jsx)(u.NarrativeEditorDataPanel,{className:"NarrativeEditor__dataPanel",coverUrl:C,name:p,selectedStoriesCount:_.length,onNameChange:this.onNameChange,onSubmit:this.save,onCoverClick:this.openCoverSelection,ref:this.dataPanelRef}),(0,i.jsx)(v.NarrativeEditorStoriesTabPanel,{appearance:n,onSelectedStoriesUpdate:this.onSelectedStoriesUpdate,storyIds:e,loadMore:l,hasMore:d,selectedStoryIds:_,storyMap:t,linkData:s,isEditingLinksAvailable:r,onStoryLinkUpdate:o})]}),f===a.EditorSectionType.cover&&(0,i.jsx)(g.NarrativeEditorCoverSection,{ownerId:h,appearance:n,cover:w,stories:y,onSave:this.confirmCover,coverUploadConfig:c,storyMap:t})]})}getBoxTitle(){const{type:e}=this.props,{section:t}=this.state;return t===a.EditorSectionType.cover?s.getLang("stories_choose_cover_title"):e===a.EditorModeType.create?s.getLang("stories_creating_narrative"):s.getLang("stories_editing_narrative")}getPublishDoneHtml(e,t,o){const{getPublishDoneHTML:i}=this.props;if(i)return i(e,t,o);const[r,n]=e.split("_"),l=`if (!event.metaKey && !event.ctrlKey) { showNarrative(${Number(r)}, ${Number(n)}, 0, 'narrative${e}'); return false; }`;return`\n      <div class="top_result_header">\n        ${(o===a.EditorModeType.create?s.getLang("stories_narrative_created"):s.getLang("stories_narrative_edited")).replace("{name}",`<a href="/narrative${e}" onclick="${l}">${(0,p.clean)(t)}</a>`)}\n      </div>\n      <a href="#" class="link" onclick="window.Likes.share('narrative${e}'); return false;">${s.getLang("stories_manage_share_narrative")}</a>\n    `}getSelectedStories(){return this.state.selectedStoryIds.map((e=>this.props.storyMap[e]))}componentWillUnmount(){this.revokeCustomUrls()}revokeCustomUrls(){const{cover:e}=this.state;e&&(0,f.isCustomCover)(e)&&[e.url,e.customPhotoOriginalUrl].forEach((e=>{(null==e?void 0:e.startsWith("blob:"))&&URL.revokeObjectURL(e)}))}constructor(e){super(e),this.onSelectedStoriesUpdate=(e=[])=>{const{storyMap:t}=this.props,{cover:o}=this.state,i=null==o?void 0:o.coverStoryId,r={selectedStoryIds:e};if((null==o?void 0:o.customPhotoId)||i&&e.includes(i))e.length||(r.cover=null);else{const o=e[0];e[0]?r.cover={url:t[o].preview,coverStoryId:o}:r.cover=null}this.setState(r)},this.openCoverSelection=()=>{const{cover:e}=this.state;((null==e?void 0:e.coverStoryId)||(null==e?void 0:e.customPhotoId))&&this.setState({section:a.EditorSectionType.cover})},this.confirmCover=e=>{const{cover:t}=this.state;this.setState({cover:e||t,section:a.EditorSectionType.main})},this.onNameChange=e=>{const t=e.target.value,o=(0,p.trim)(t)?t:"";this.setState({name:o})},this.close=(e,t)=>{const{ownerId:o,narrativeRawId:i,navScreen:r}=this.props;if(!e){let e="";i&&([,e]=i.split("_")),(0,w.sendNarrativeAnalytic)(w.NarrativeAnalyticEventType.close,{ownerId:o,id:Number(e)},r)}this.props.close(t)},this.onSave=e=>{this.props.onSave(e)},this.getFooterButtons=()=>{const{type:e}=this.props,{selectedStoryIds:t,loading:o}=this.state;return[(0,i.jsx)(d.Button,{size:"m",mode:"tertiary",onClick:()=>this.close(!1),disabled:o,children:s.getLang("global_cancel")},"close"),(0,i.jsx)(d.Button,{loading:o,size:"m",mode:"primary",onClick:this.save,disabled:0===t.length,children:e===a.EditorModeType.edit?s.getLang("global_save"):s.getLang("stories_create_narrative")},"save")]},this.save=()=>{const{publishHash:e,editHash:t,type:o,navScreen:i,ownerId:r}=this.props,{cover:n,loading:l}=this.state,d=this.getSelectedStories();let{name:v=""}=this.state,{narrativeRawId:u}=this.props;if(l)return;if(v=(0,p.trim)(v),!v)return void(this.dataPanelRef.current&&(0,c.notaBene)(this.dataPanelRef.current.getInputEl()));if(!(null==n?void 0:n.coverStoryId)&&!(null==n?void 0:n.customPhotoId))return;let g="publish_narrative",m=e;o===a.EditorModeType.edit&&(g="edit_narrative",m=t);const f={act:g,owner_id:r,title:v,hash:m,story_ids:(0,_.prepareStoriesForPublishing)(d)};if(u){const[,e]=u.split("_");f.narrative_id=e}n.customPhotoId&&(f.custom_cover_photo_id=n.customPhotoId),n.coverStoryId&&(f.cover_story_id=n.coverStoryId),n.crop&&(f.crop_y=n.crop.y,f.crop_x=n.crop.x,f.crop_height=n.crop.height,f.crop_width=n.crop.width),window.ajax.post("al_stories.php",f,{onDone:e=>{u||(u=`${r}_${e}`);const t=this.getPublishDoneHtml(u,v,o);this.onSave(u),this.close(!0,(()=>(0,h.showDoneBox)(t))),(0,w.sendNarrativeAnalytic)(o===a.EditorModeType.edit?w.NarrativeAnalyticEventType.editNarrative:w.NarrativeAnalyticEventType.publishNarrative,{ownerId:Number(r),id:Number(e)},i)},onFail:e=>((0,h.showDoneBox)(e||s.getLang("global_error")),!0),hideProgress:()=>{this.setState({loading:!1})}}),this.setState({loading:!0})};let t=e.cover,o=e.selectedStoryIds[0];!t&&o&&(t={url:e.storyMap[o].preview,coverStoryId:o}),this.state={tabKey:e.activeTabKey,name:e.name,selectedStoryIds:e.selectedStoryIds,cover:t,loading:!1,section:a.EditorSectionType.main},this.dataPanelRef=(0,r.createRef)()}}y.defaultProps={name:"",type:a.EditorModeType.create,activeTabKey:a.EditorTabKey.selected,isEditingLinksAvailable:!1,appearance:a.EditorViewType.page}},399133:(e,t,o)=>{var i,r,s,a;o.d(t,{EditorModeType:()=>i,EditorSectionType:()=>a,EditorTabKey:()=>r,EditorViewType:()=>s}),function(e){e[e.create=0]="create",e[e.edit=1]="edit"}(i||(i={})),function(e){e.all="all",e.selected="selected"}(r||(r={})),function(e){e.box="box",e.page="page"}(s||(s={})),function(e){e.main="main",e.cover="cover"}(a||(a={}))},969420:(e,t,o)=>{o.d(t,{NarrativeEditorAllTab:()=>v});var i=o(785893),r=o(667294),s=o(399133),a=o(450443),n=o(278980),l=o(365035),d=o(659397),c=o(970978),h=o(910434);class v extends r.Component{render(){const{stories:e,selectedStoriesMap:t,className:o,onToggleCheck:r,isEditingLinksAvailable:s,onStoryLinkUpdate:l,linkData:c}=this.props,{isLoading:v}=this.state;let u;return(0,i.jsxs)("div",{className:(0,d.classNames)("NarrativeEditorAllTab ScrollContainer",o),ref:this.tabRef,children:[(0,i.jsx)(a.StoryArchivePreviewGrid,{className:"NarrativeEditorAllTab__grid",children:e.map((e=>{let o=!1;const a=new Date(1e3*e.time).toDateString();return u&&a===u||(u=a,o=!0),(0,i.jsx)("div",{className:"NarrativeEditorAllTab__story",children:(0,i.jsx)(n.StoryArchivePreview,{story:e,checked:!!t[e.id],selectable:this.isSelectable(e),onToggleCheck:r,onStoryLinkUpdate:l,isEditingLinksAvailable:s,linkData:c,needShowDate:o})},e.rawId)}))}),v&&(0,i.jsx)("div",{className:"NarrativeEditorAllTab__loader",children:(0,i.jsx)(h.default,{})})]})}isSelectable(e){const{selectedStoriesMap:t}=this.props,o=Object.keys(t).length;return!e.isUnavailable&&!!(o<l.MAX_NARRATIVE_STORIES||t[e.id])}componentDidMount(){this.isMount=!0,this.initScrollListener()}componentWillUnmount(){this.isMount=!1,this.deInitScrollContainer()}initScrollListener(){const e=this.getScrollContainer(),t=this.getTabEl();e&&t&&e.addEventListener("scroll",this.onScroll,!0)}deInitScrollContainer(){var e;null==(e=this.getScrollContainer())||e.removeEventListener("scroll",this.onScroll)}getScrollContainer(){const{appearance:e}=this.props;return e===s.EditorViewType.box?this.getTabEl():window}getTabEl(){var e;return null==(e=this.tabRef)?void 0:e.current}constructor(e){super(e),this.tabRef=(0,r.createRef)(),this.onScroll=()=>{const{hasMore:e}=this.props;e&&this.checkLoading()},this.checkLoading=(0,d.throttle)((()=>{const{loadMore:e,hasMore:t}=this.props,{isLoading:o}=this.state,i=this.getScrollContainer(),r=this.getTabEl();if(!t||!r)return;if(o||!this.isMount)return;let s;s=i instanceof HTMLElement?r.scrollTop+r.clientHeight>=r.scrollHeight-l.SCROLL_LOADING_MORE_GAP:window.innerHeight+l.SCROLL_LOADING_MORE_GAP>=r.getBoundingClientRect().bottom,s&&(this.setState({isLoading:!0}),e().catch((e=>{console.error(e),(0,c.logError)(e)})).finally((()=>{this.setState({isLoading:!1})})))}),l.SCROLL_THROTTLE_DELAY),this.state={isLoading:!1}}}v.defaultProps={isEditingLinksAvailable:!1,hasMore:!1}},90729:(e,t,o)=>{o.d(t,{NarrativeEditorCoverSection:()=>b});var i=o(434788),r=o(785893),s=o(667294),a=o(399133),n=o(659397),l=o(450443),d=o(278980),c=o(29271),h=o(832550),v=o(796822),u=o(641185),p=o(953908),_=o(377992),g=o(445706),m=o(481665),w=o(729838),f=o(514986),y=o(630892),C=o(404145),S=o(970978),x=o(983647),N=o(501977);class b extends s.Component{render(){const{className:e,appearance:t,stories:o}=this.props,{customCover:i,checkedCoverId:s,showDropArea:h,isModalOpen:p}=this.state;return(0,r.jsxs)(v.NarrativeEditorSection,{className:(0,n.classNames)("NarrativeEditorCoverSection",e),appearance:t,actionFooterButtons:this.getFooterButtons(),children:[(0,r.jsxs)("div",{className:"ScrollContainer",ref:this.scrollContainerRef,children:[(0,r.jsx)("div",{className:"NarrativeEditorCoverSection__hint StoryGridHint",children:c.getLang("stories_choose_cover_hint")}),(0,r.jsxs)(l.StoryArchivePreviewGrid,{className:"NarrativeEditorCoverSection__grid",children:[(0,r.jsx)("div",{className:"NarrativeEditorCoverSection__create",children:(0,r.jsx)(u.StoryLoadFile,{text:c.getLang("stories_upload_narrative_cover"),onFilesLoad:this.onFilesLoad})}),i&&(0,r.jsx)(m.StoryCustomCoverPreview,{uploadingStatus:i.status,coverUrl:i.customPhotoOriginalUrl,checked:i.id===s,uploadingPercent:i.percent,onToggleCheck:this.selectCustomCover,retryUpload:this.uploadCover}),o.map((e=>(0,r.jsx)("div",{className:"NarrativeEditorCoverSection__story",children:(0,r.jsx)(d.StoryArchivePreview,{story:e,checked:s===e.rawId,selectable:!0,onToggleCheck:this.toggleCheck})},e.rawId)))]})]}),h&&!p&&t===a.EditorViewType.box&&(0,r.jsx)(_.UploadDropBoxArea,{}),h&&!p&&t===a.EditorViewType.page&&(0,r.jsx)(g.UploadDropPageArea,{})]})}getThumbSizes(e,t){const o=e/t;let i,r;return e>=t?(i=Math.min(e,x.MAX_THUMB_WIDTH),r=Math.floor(i/o),r>x.MAX_THUMB_HEIGHT&&(r=x.MAX_THUMB_HEIGHT,i=Math.floor(r*o))):(r=Math.min(t,x.MAX_THUMB_HEIGHT),i=Math.floor(r*o),i>x.MAX_THUMB_WIDTH&&(i=x.MAX_THUMB_WIDTH,r=Math.floor(i/o))),[i,r]}saveCustomPhotoIfNeeded(){const{ownerId:e,coverUploadConfig:t}=this.props,{checkedCoverId:o}=this.state,r=this.getCoverById(o);return r?(0,N.needSavePhoto)(r)?new Promise(((o,s)=>{window.ajax.post("al_stories.php",{act:"save_narrative_cover",owner_id:e,upload_response:r.uploadResponse,hash:t.hash},{onDone:e=>{const{customCover:t}=this.state;if(!this.isMount||!t)return void s();const r=(0,i._)({},t,{customPhotoId:e});o(r)},onFail:e=>(console.error(e),s(e),!0)})})):Promise.resolve(r):Promise.reject()}componentDidMount(){this.isMount=!0;const e=this.getDragAndDropContainer();e&&(e.addEventListener("drop",this.onDragDrop),e.addEventListener("dragenter",this.onDragEnter),e.addEventListener("dragover",this.onDragEnter),e.addEventListener("dragleave",this.onDragLeave))}componentWillUnmount(){this.isMount=!1,null!=this.dragLeaveTimeout&&clearTimeout(this.dragLeaveTimeout);const e=this.getDragAndDropContainer();e&&(e.removeEventListener("drop",this.onDragDrop),e.removeEventListener("dragenter",this.onDragEnter),e.removeEventListener("dragover",this.onDragEnter),e.removeEventListener("dragleave",this.onDragLeave))}getDragAndDropContainer(){return this.props.appearance===a.EditorViewType.box?window.boxLayerWrap:document.body}getScrollContainer(){return this.props.appearance===a.EditorViewType.box?this.scrollContainerRef.current:document.documentElement}buildCovers(e){const{cover:t,stories:o}=e;let r;t&&(0,N.isCustomCover)(t)&&(r=(0,i._)({id:N.CustomCoverId},t));return[o.map((e=>(null==t?void 0:t.coverStoryId)===e.id?(0,i._)({id:e.rawId},t):{id:e.rawId,url:e.preview,coverStoryId:e.id})),r]}getCoverById(e){return e===N.CustomCoverId?this.state.customCover:this.state.covers.find((t=>t.id===e))}getCoverOriginalUrl(e){const{storyMap:t}=this.props;let o="";if((0,N.isSelectableCustomCover)(e))o=e.customPhotoOriginalUrl;else if(e.coverStoryId){var i;o=null==(i=t[e.coverStoryId])?void 0:i.originalPreviewUrl}return o}constructor(e){var t;super(e),this.scrollContainerRef=(0,s.createRef)(),this.isMount=!1,this.isCropSubmitted=!1,this.onFilesLoad=e=>{this.file=e[0],this.file&&this.uploadCover()},this.uploadCover=()=>{if(!this.file)return;const e=this.file,{coverUploadConfig:t}=this.props,o=new w.UploadPhoto(t,this.onUploadCoverProgress);o.validate(e).then((()=>{if(!this.isMount)return;const t=URL.createObjectURL(e),r={id:N.CustomCoverId,url:t,customPhotoOriginalUrl:t,percent:0,status:N.CoverUploadStatus.uploading};return this.setState({customCover:r}),o.upload(e).then((e=>{if(!this.isMount)return;const t=JSON.stringify(e);this.setState({customCover:(0,i._)({},r,{percent:100,status:N.CoverUploadStatus.uploaded,uploadResponse:t}),checkedCoverId:N.CustomCoverId})}))})).catch((e=>{if(!this.isMount)return;let t=this.state.customCover;t&&(t=(0,i._)({},t,{percent:0,status:N.CoverUploadStatus.failed})),console.error(e),e=(0,n.isObject)(e)?e.text:String(e),(0,f.showFastBox)(c.getLang("global_error"),e||c.getLang("global_unknown_error")),(0,S.logError)(new Error("error with uploadCover"+(e?`: ${e}`:""))),this.setState({customCover:t})}))},this.onUploadCoverProgress=(e,t)=>{const o=Math.min(e/t*100,90);this.setState((e=>{let t=e.customCover;return t?{customCover:(0,i._)({},t,{percent:o})}:null}))},this.selectCustomCover=()=>{this.setState({checkedCoverId:N.CustomCoverId})},this.toggleCheck=e=>{this.setState({checkedCoverId:e.rawId})},this.openCropper=()=>{const{checkedCoverId:e}=this.state,t=this.getCoverById(e);if(!t)return;const o=this.getCoverOriginalUrl(t);o&&(0,C.loadImage)(o).then((e=>{if(!this.isMount)return;const i=e.width,r=e.height,[s,a]=this.getThumbSizes(i,r);this.setState({isModalOpen:!0}),(0,y.showNarrativeCropCoverBox)({coverUrl:o,coverHeight:r,coverWidth:i,thumbHeight:a,thumbWidth:s,crop:t.crop,onSave:this.onCropSave,onClose:this.onCropClose})})).catch((e=>{console.error(e),e=String(e),(0,f.showFastBox)(c.getLang("global_error"),e||c.getLang("global_unknown_error")),(0,S.logError)(new Error("error with cover openCropper"+(e?`: ${e}`:"")))}))},this.onCropSave=(e,t)=>this.saveCustomPhotoIfNeeded().then((o=>{this.isCropSubmitted=!0;const{covers:r}=this.state;(0,N.isSelectableCustomCover)(o)?this.setState({customCover:(0,i._)({},o,{url:t,crop:e})}):this.setState({covers:r.map((r=>r.id===o.id?(0,i._)({},o,{url:t,crop:e}):r))})})),this.onCropClose=()=>{const{onSave:e}=this.props,{checkedCoverId:t}=this.state;this.setState({isModalOpen:!1});const o=this.getCoverById(t);o&&this.isCropSubmitted&&e({url:o.url,coverStoryId:o.coverStoryId,customPhotoOriginalUrl:o.customPhotoOriginalUrl,customPhotoId:o.customPhotoId,crop:o.crop})},this.getFooterButtons=()=>{const{onSave:e}=this.props,{customCover:t}=this.state;return[(0,r.jsx)(h.Button,{size:"m",mode:"tertiary",onClick:()=>e(),children:c.getLang("global_cancel")},"close"),(0,r.jsx)(h.Button,{size:"m",mode:"primary",onClick:this.openCropper,disabled:(null==t?void 0:t.status)===N.CoverUploadStatus.uploading,children:c.getLang("stories_narrative_cover_next_step")},"save")]},this.onDragEnter=e=>{var t,o,i,r;("file"===(null==(t=null==e||null==(o=e.dataTransfer)?void 0:o.items[0])?void 0:t.kind)||(null==e||null==(i=e.dataTransfer)||null==(r=i.types)?void 0:r.includes("Files")))&&(clearTimeout(this.dragLeaveTimeout),delete this.dragLeaveTimeout,this.setState({showDropArea:!0})),(0,p.cancelEvent)(e)},this.onDragLeave=e=>{clearTimeout(this.dragLeaveTimeout),this.dragLeaveTimeout=setTimeout((()=>{delete this.dragLeaveTimeout,this.setState({showDropArea:!1})}),100),(0,p.cancelEvent)(e)},this.onDragDrop=e=>{var t,o;this.onDragLeave(e),(null==e||null==(t=e.dataTransfer)||null==(o=t.files)?void 0:o.length)&&this.onFilesLoad(Array.from(e.dataTransfer.files));const i=this.getScrollContainer();i&&i.scrollTo({top:0,behavior:"smooth"}),(0,p.cancelEvent)(e)};const[o,a]=this.buildCovers(e);let l=null==(t=o[0])?void 0:t.id;if(e.cover){const t=e.cover.customPhotoId,o=e.cover.coverStoryId;l=t?N.CustomCoverId:o?e.storyMap[o].rawId:e.stories[0].rawId}this.state={showDropArea:!1,covers:o,customCover:a,checkedCoverId:l,isModalOpen:!1}}}},501977:(e,t,o)=>{var i;function r(e){return Boolean(e.customPhotoId||e.uploadResponse)}function s(e){return Boolean(e.customPhotoId)}function a(e){return e.uploadResponse&&!e.customPhotoId}function n(e){const t={url:e.coverUrl,crop:e.coverCrop};return e.customCover?(t.customPhotoId=e.customCover.photoId,t.customPhotoOriginalUrl=e.customCover.originalPhotoUrl):t.coverStoryId=e.coverStoryId,t}o.d(t,{CoverUploadStatus:()=>i,CustomCoverId:()=>l,getPreparedCover:()=>n,isCustomCover:()=>s,isSelectableCustomCover:()=>r,needSavePhoto:()=>a}),function(e){e[e.uploaded=0]="uploaded",e[e.uploading=1]="uploading",e[e.failed=2]="failed"}(i||(i={}));const l="custom"},317130:(e,t,o)=>{o.d(t,{NarrativeEditorDataPanel:()=>v});var i=o(785893),r=o(667294),s=o(29271),a=o(659397),n=o(40138),l=o(365035),d=o(953908),c=o(301230),h=o(752198);class v extends r.Component{render(){const{name:e,onNameChange:t,selectedStoriesCount:o,coverUrl:r,onCoverClick:d,className:c}=this.props,v=0===o;let u="";return v||(u=s.getLang("stories_choose_cover")),(0,i.jsxs)("div",{className:(0,a.classNames)("NarrativeEditorDataPanel",c),children:[(0,i.jsxs)("div",{className:"NarrativeEditorDataPanel__preview",children:[(0,i.jsx)(n.NarrativeItemPreviewCover,{className:(0,a.classNames)("NarrativeEditorDataPanel__cover",{"NarrativeEditorDataPanel__cover--active":!v}),onClick:d,cover:r,title:u,extra:!v&&(0,i.jsx)("div",{className:"NarrativeEditorDataPanel__pencil",children:(0,i.jsx)(h.Icon24Write,{})})}),(0,i.jsx)("span",{className:(0,a.classNames)("NarrativeEditorDataPanel__name",{"NarrativeEditorDataPanel__name--empty":!e}),children:e||s.getLang("stories_narrative_name_full")})]}),(0,i.jsxs)("div",{className:"NarrativeEditorDataPanel__form",children:[(0,i.jsx)("span",{className:"NarrativeEditorDataPanel__nameLabel",children:s.getLang("stories_narrative_name")}),(0,i.jsx)("input",{className:"NarrativeEditorDataPanel__nameInput",value:e,onChange:t,onKeyDown:this.onKeyDown,type:"text",placeholder:s.getLang("stories_enter_name"),maxLength:l.NARRATIVE_MAX_TITLE_LENGTH,ref:this.nameInputRef,autoFocus:!0}),o>0&&(0,i.jsx)("span",{className:"NarrativeEditorDataPanel__selectedStoryCount",children:s.getLang("stories_selected_count",o)})]})]})}constructor(e){super(e),this.getInputEl=()=>this.nameInputRef&&this.nameInputRef.current,this.onKeyDown=e=>{e.keyCode===d.KEY.ENTER&&(e.ctrlKey||e.metaKey&&c.browser.mac)&&this.props.onSubmit()},this.nameInputRef=(0,r.createRef)()}}},893445:(e,t,o)=>{o.d(t,{NarrativeEditorFooter:()=>a});var i=o(785893),r=o(659397),s=o(126116);const a=({appearance:e,actionButtons:t})=>(0,i.jsx)("div",{className:(0,r.classNames)("NarrativeEditorFooter",`NarrativeEditorFooter--${e}`),children:(0,i.jsx)(s.ModalFooter,{actionButtons:t})})},796822:(e,t,o)=>{o.d(t,{NarrativeEditorSection:()=>n});var i=o(785893),r=o(667294),s=o(893445),a=o(682615);class n extends r.Component{render(){const{className:e,children:t,appearance:o,actionFooterButtons:r}=this.props;return(0,i.jsxs)("div",{className:(0,a.classNames)("NarrativeEditorSection",e),ref:this.scrollContainerRef,children:[(0,i.jsx)("div",{className:"NarrativeEditorSection__body",children:t}),Boolean(r)&&(0,i.jsx)(s.NarrativeEditorFooter,{appearance:o,actionButtons:r})]})}getSectionEl(){var e;return null==(e=this.scrollContainerRef)?void 0:e.current}constructor(...e){super(...e),this.scrollContainerRef=(0,r.createRef)()}}},468706:(e,t,o)=>{o.d(t,{NarrativeEditorSelectedTab:()=>v});var i=o(785893),r=o(667294),s=o(399133),a=o(450443),n=o(278980),l=o(682615),d=o(365035),c=o(444402);const h="NarrativeEditorSelectedTab__storyPreview";class v extends r.Component{render(){const{stories:e,selectedStoriesMap:t,className:o,isEditingLinksAvailable:r,onStoryLinkUpdate:s,linkData:d,onToggleCheck:c}=this.props,{draggingStoryRawId:v}=this.state;return(0,i.jsx)("div",{className:(0,l.classNames)("NarrativeEditorSelectedTab ScrollContainer",o),ref:this.tabRef,children:(0,i.jsx)(a.StoryArchivePreviewGrid,{ref:this.gridContainerRef,children:e.map((e=>(0,i.jsx)("div",{className:"NarrativeEditorSelectedTab__story",children:(0,i.jsx)(n.StoryArchivePreview,{className:h,story:e,draggable:!0,isDragged:e.rawId===v,checked:!!t[e.id],selectable:this.isSelectable(e),onToggleCheck:c,onStoryLinkUpdate:s,isEditingLinksAvailable:r,linkData:d})},e.rawId)))})})}isSelectable(e){const{selectedStoriesMap:t}=this.props,o=Object.keys(t).length;return!e.isUnavailable&&!!(o<d.MAX_NARRATIVE_STORIES||t[e.rawId])}componentDidMount(){const{onReorder:e,appearance:t}=this.props,o=this.getGridContainer(),i={dragThreshold:0,onDragFinish:()=>{this.setState({draggingStoryRawId:""})},onDragStart:e=>{const t=e.querySelector(`.${h}`);if(!t)return;const o=t.dataset.id;this.setState({draggingStoryRawId:o})},onReorder:()=>{const{stories:t}=this.props,o=document.querySelectorAll(`.${h}`),i=[];o.forEach((e=>{const o=e.getAttribute("data-id"),r=t.find((e=>e.rawId===o));r&&i.push(r.id)})),e(i)}};o&&(t===s.EditorViewType.box&&(i.wrapNode=this.getTabEl()),this.sorter=new c.default(o,"",i))}componentWillUnmount(){this.sorter&&this.sorter.destroy()}getTabEl(){var e;return null==(e=this.tabRef)?void 0:e.current}getGridContainer(){var e,t;return null==(e=this.gridContainerRef)||null==(t=e.current)?void 0:t.getGridContainer()}constructor(e){super(e),this.gridContainerRef=(0,r.createRef)(),this.tabRef=(0,r.createRef)(),this.state={draggingStoryRawId:""}}}},382483:(e,t,o)=>{o.d(t,{NarrativeEditorStoriesTabPanel:()=>u});var i=o(434788),r=o(785893),s=o(667294),a=o(399133),n=o(29271),l=o(425308),d=o(468706),c=o(969420),h=o(682615),v=o(365035);class u extends s.Component{render(){const{selectedStoryIds:e,appearance:t,isEditingLinksAvailable:o,linkData:i,onStoryLinkUpdate:s,loadMore:v,hasMore:u}=this.props,{tabKey:p}=this.state,_=this.getSelectedStoriesMap(),g=this.getAllStories();return(0,r.jsxs)("div",{className:"NarrativeEditorStoriesTabPanel",children:[(0,r.jsxs)(l.default,{className:"NarrativeEditorStoriesTabPanel__tabs",onTabClick:this.onTabClick,active:p,disabledTabMap:{[a.EditorTabKey.selected]:!e.length},children:[(0,r.jsxs)("span",{children:[n.getLang("stories_narrative_editor_selected_tab"),e.length>0&&(0,r.jsx)("span",{className:"Tabs__desc",children:e.length})]},a.EditorTabKey.selected),(0,r.jsx)("span",{children:n.getLang("stories_narrative_editor_all_tab")},a.EditorTabKey.all)]}),p===a.EditorTabKey.selected&&(0,r.jsx)(d.NarrativeEditorSelectedTab,{className:(0,h.classNames)("NarrativeEditorSelectPanel__grid",`NarrativeEditorSelectPanel__grid--${t}`),appearance:t,stories:this.getSelectedTabStories(),onReorder:this.onReorder,onToggleCheck:this.onStorySelectToggle,selectedStoriesMap:_,onStoryLinkUpdate:s,isEditingLinksAvailable:o,linkData:i}),p===a.EditorTabKey.all&&(0,r.jsx)(c.NarrativeEditorAllTab,{className:(0,h.classNames)("NarrativeEditorSelectPanel__grid",`NarrativeEditorSelectPanel__grid--${t}`),appearance:t,stories:g,loadMore:v,hasMore:u,onToggleCheck:this.onStorySelectToggle,selectedStoriesMap:_,onStoryLinkUpdate:s,isEditingLinksAvailable:o,linkData:i})]})}getSelectedTabStories(){return this.state.selectedTabStoryIds.map((e=>this.props.storyMap[e]))}getAllStories(){return this.props.storyIds.map((e=>this.props.storyMap[e]))}getSelectedStoriesMap(){return this.props.selectedStoryIds.reduce(((e,t)=>(e[t]=this.props.storyMap[t],e)),{})}constructor(e){super(e),this.onTabClick=(e,t)=>{this.setState({tabKey:t,selectedTabStoryIds:[...this.props.selectedStoryIds]})},this.onReorder=e=>{const{onSelectedStoriesUpdate:t}=this.props,o=this.getSelectedStoriesMap(),i=e.filter((e=>o[e]));this.setState({selectedTabStoryIds:e}),t(i)},this.onStorySelectToggle=e=>{const{selectedStoryIds:t,onSelectedStoriesUpdate:o}=this.props,{tabKey:r,selectedTabStoryIds:s}=this.state,n=this.getSelectedStoriesMap();if(!(Object.keys(n).length>=v.MAX_NARRATIVE_STORIES)||n[e.id]){if(!s.length)return this.setState({selectedTabStoryIds:[e.id]}),void o([e.id]);if(n[e.id]){o(t.filter((t=>t!==e.id)))}else{let t=[];const l=(0,i._)({},n,{[e.id]:e});if(r===a.EditorTabKey.selected)t=s.filter((e=>l[e]));else if(r===a.EditorTabKey.all){if(s.includes(e.id))t=s.filter((e=>l[e]));else{t=[...s,e.id].filter((e=>l[e])),this.setState({selectedTabStoryIds:[...s,e.id]})}}o(t)}}},this.state={tabKey:e.selectedStoryIds.length?a.EditorTabKey.selected:a.EditorTabKey.all,selectedTabStoryIds:[...e.selectedStoryIds]}}}u.defaultProps={isEditingLinksAvailable:!1}},40138:(e,t,o)=>{o.d(t,{NarrativeItemPreviewCover:()=>a});var i=o(785893),r=o(667294),s=o(682615);const a=(0,r.memo)((({title:e,onClick:t,cover:o,href:a,className:n="",extra:l,noBorder:d=!1,isDraft:c=!1,size:h=58})=>{const v=o?{backgroundImage:`url(${o})`}:{},u=(0,s.classNames)("NarrativeItemPreviewCover",`NarrativeItemPreviewCover--size${h}`,n,{"NarrativeItemPreviewCover--noBorder":d,"NarrativeItemPreviewCover--isDraft":c}),p=(0,i.jsx)("div",{className:"NarrativeItemPreviewCover__image",style:v,title:e||void 0,children:l});return(0,i.jsxs)(r.Fragment,{children:[a&&(0,i.jsx)("a",{href:a,className:u,onClick:t,children:p}),!a&&(0,i.jsx)("div",{className:u,onClick:t,children:p})]})}))},247563:(e,t,o)=>{o.d(t,{NarrativeRow:()=>c});var i=o(785893),r=o(667294),s=o(40138),a=o(222122),n=o(659397),l=o(29271),d=o(611695);const c=(0,r.memo)((({narrative:e,aside:t,onClick:o,className:c,clickable:h,size:v,noBorder:u})=>{const p=!e.storiesCount,_=p?"":`/narrative${e.ownerId}_${e.id}`;let g,m,w,f;return p?(g=(0,i.jsx)(s.NarrativeItemPreviewCover,{isDraft:!0,extra:(0,i.jsx)(d.Icon24NarrativeActiveOutline,{}),size:v}),m=(0,i.jsxs)(r.Fragment,{children:[l.getLang("groups_narrative_box_stories_count",e.storiesCount),(0,i.jsx)("span",{className:"dvd"}),(0,i.jsx)("span",{children:l.getLang("stories_narratives_draft")})]})):(g=(0,i.jsx)(s.NarrativeItemPreviewCover,{onClick:o,size:v,cover:e.coverUrl,href:_,noBorder:u}),m=(0,i.jsx)("span",{children:l.getLang("groups_narrative_box_stories_count",e.storiesCount)})),h?w=o:p||(f=o),(0,i.jsx)("div",{className:(0,n.classNames)("NarrativeRow NarrativeListItem",c,{"NarrativeRow--clickable":h}),"data-id":e.id,onClick:w,children:(0,i.jsx)(a.NarrativeRowBase,{className:"NarrativeRow__inner",href:_,onClick:f,preview:g,id:e.id,title:e.title,subtitle:m,size:v,aside:t})})}))},222122:(e,t,o)=>{o.d(t,{NarrativeRowBase:()=>l});var i=o(434788),r=o(820224),s=o(785893),a=o(667294),n=o(659397);const l=(0,a.memo)((e=>{var{id:t,title:o,subtitle:a,preview:l,aside:d,href:c,onClick:h,className:v="",size:u=58}=e,p=(0,r._)(e,["id","title","subtitle","preview","aside","href","onClick","className","size"]);const _=Boolean(h||c);let g;return o=(0,n.decodeHTMLEntities)(o),g=c?(0,s.jsx)("a",{href:c,className:"NarrativeRowBase__title",onClick:h,children:o}):(0,s.jsx)("span",{className:"NarrativeRowBase__title",onClick:h,children:o}),(0,s.jsxs)("div",(0,i._)({className:(0,n.classNames)("NarrativeRowBase",`NarrativeRowBase--previewSize${u}`,v,{"NarrativeRowBase--clickable":_})},p,{children:[(0,s.jsx)("div",{className:"NarrativeRowBase__preview",children:l}),(0,s.jsxs)("div",{className:"NarrativeRowBase__inner",children:[(0,s.jsxs)("div",{className:"NarrativeRowBase__main",children:[(0,s.jsx)("div",{className:"NarrativeRowBase__title",children:g}),a&&(0,s.jsx)("div",{className:"NarrativeRowBase__subtitle",children:a})]}),d&&(0,s.jsx)("div",{className:"NarrativeRowBase__aside",children:d})]})]}))}))},704703:(e,t,o)=>{o.d(t,{NarrativeRowCreation:()=>c});var i=o(434788),r=o(785893),s=o(667294),a=o(222122),n=o(29271),l=o(659397),d=o(376175);const c=(0,s.memo)((({onClick:e,clickable:t=!1,size:o=58})=>{const s=n.getLang("stories_create_new_narrative"),c=(0,r.jsx)("div",{className:(0,l.classNames)("NarrativeRowCreation__preview",`NarrativeRowCreation__preview--size${o}`),children:(0,r.jsx)(d.Icon28AddOutline,{})});return(0,r.jsx)("div",(0,i._)({className:(0,l.classNames)("NarrativeRowCreation NarrativeListItem",{"NarrativeRowCreation--clickable":t})},{nodrag:"true"},{children:(0,r.jsx)(a.NarrativeRowBase,{className:"NarrativeRowCreation__inner",title:s,onClick:e,preview:c,size:o})}))}))},535902:(e,t,o)=>{o.d(t,{NarrativeSnippet:()=>a});var i=o(785893),r=o(29271),s=o(659397);const a=e=>{const{className:t,coverUrl:o,title:a,ownerName:n,storyCount:l}=e;return(0,i.jsx)("div",{className:(0,s.classNames)("NarrativeSnippet",t),children:(0,i.jsxs)("div",{className:"NarrativeSnippet__inner",children:[(0,i.jsx)("div",{className:"NarrativeSnippet__cover",children:(0,i.jsx)("div",{className:"NarrativeSnippet__image",style:{backgroundImage:`url(${o})`}})}),(0,i.jsxs)("div",{className:"NarrativeSnippet__info",children:[(0,i.jsx)("div",{className:(0,s.classNames)("NarrativeSnippet__title",{"NarrativeSnippet__title--empty":!a}),children:a||r.getLang("stories_narrative_name_full")}),(0,i.jsx)("span",{className:"NarrativeSnippet__author",children:n}),(0,i.jsxs)("span",{className:"NarrativeSnippet__description",children:[(0,i.jsx)("span",{children:r.getLang("global_type_narrative")}),(0,i.jsx)("span",{className:"dvd"}),(0,i.jsx)("span",{children:r.getLang("global_narrative_stories_count",l)})]})]})]})})}},278980:(e,t,o)=>{o.d(t,{StoryArchivePreview:()=>u});var i=o(785893),r=o(667294),s=o(682615),a=o(29271),n=o(630892),l=o(970978),d=o(672948),c=o(331533),h=o(402622),v=o(910434);class u extends r.PureComponent{componentDidUpdate(e,t){const{story:o,isDragged:i}=this.props,{isHovered:r}=this.state;o.videoUrl&&(i||(!t.isHovered&&r?this.playVideo():t.isHovered&&!r&&this.pauseVideo()),!e.isDragged&&i&&this.pauseVideo(),e.isDragged&&!i&&r&&this.playVideo())}componentWillUnmount(){this.cleanVideoPlayTimeout(),this.cleanVideoPauseTimeout(),this.cleanVideoLoaderTimeout()}playVideo(e=!1){null!=this.videoPauseDelayTimeout&&this.cleanVideoPauseTimeout();const t=()=>{delete this.videoPlayDelayTimeout,this.videoRef.current&&(this.videoRef.current.muted=!0,this.videoRef.current.play().then((()=>{var e;if(this.hideLoader(),this.setState({canPlayVideo:!0}),this.needPauseAfterLoading)return null==(e=this.videoRef.current)||e.pause(),void(this.needPauseAfterLoading=!1)})).catch((e=>{this.hideLoader(),console.error(e),(0,l.logError)(e)})))};e?t():null==this.videoPlayDelayTimeout&&(this.videoLoaderTimeout=setTimeout((()=>{this.setState({isLoading:!0})}),800),this.setState({preloadVideo:!0}),this.videoPlayDelayTimeout=setTimeout((()=>{t()}),200))}pauseVideo(e=!1){null!=this.videoPlayDelayTimeout&&this.cleanVideoPlayTimeout();const t=()=>{if(delete this.videoPauseDelayTimeout,this.hideLoader(),this.state.canPlayVideo){var e;const t=null==(e=this.videoRef)?void 0:e.current;null==t||t.pause()}else this.needPauseAfterLoading=!0};e?t():null==this.videoPauseDelayTimeout&&(this.videoPauseDelayTimeout=setTimeout((()=>{t()}),200))}cleanVideoPlayTimeout(){this.videoPlayDelayTimeout&&(clearTimeout(this.videoPlayDelayTimeout),delete this.videoPlayDelayTimeout)}cleanVideoPauseTimeout(){this.videoPauseDelayTimeout&&(clearTimeout(this.videoPauseDelayTimeout),delete this.videoPauseDelayTimeout)}cleanVideoLoaderTimeout(){this.videoLoaderTimeout&&(clearTimeout(this.videoLoaderTimeout),delete this.videoLoaderTimeout)}hideLoader(){this.state.isLoading&&this.setState({isLoading:!1}),this.cleanVideoLoaderTimeout()}render(){const{story:e,checked:t,selectable:o,draggable:r,className:n,isEditingLinksAvailable:l,needShowDate:u}=this.props,{preloadVideo:p,canPlayVideo:_,isLoading:g}=this.state,m=Boolean(e.videoUrl),w=new Date(1e3*e.time);return(0,i.jsx)("div",{className:(0,s.classNames)("StoryArchivePreview","StoryPreviewContainer",n,{"StoryArchivePreview--video":m,"StoryArchivePreview--checked":t}),onClick:this.onToggleCheck,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,"data-id":e.rawId,children:(0,i.jsxs)("div",{className:"StoryArchivePreview__wrapper",children:[m&&(0,i.jsxs)(i.Fragment,{children:[p&&(0,i.jsx)("video",{className:(0,s.classNames)("StoryArchivePreview__media",{"StoryArchivePreview__media--hidden":!_}),src:e.videoUrl,ref:this.videoRef,controls:!1,preload:"metadata",loop:!0,playsInline:!0}),!_&&(0,i.jsx)("img",{className:"StoryArchivePreview__media",src:e.preview,alt:""})]}),!m&&(0,i.jsx)("img",{className:"StoryArchivePreview__media",src:e.preview,alt:""}),u&&(0,i.jsxs)("div",{className:"StoryArchivePreview__date",children:[(0,i.jsx)("div",{className:"StoryArchivePreview__day",children:w.getDate()}),(0,i.jsx)("div",{className:"StoryArchivePreview__month",children:(0,i.jsx)(c.InnerHTML,{children:a.getLang("months_sm_of")[w.getMonth()+1]})})]}),r&&!u&&(0,i.jsx)("div",{className:"StoryArchivePreview__draggableIcon"}),o&&(0,i.jsx)("div",{className:(0,s.classNames)("StoryArchivePreview__select",{"StoryArchivePreview__select--on":t})}),(l||e.videoUrl)&&(0,i.jsx)("div",{className:"StoryArchivePreview__footer",children:(0,i.jsxs)("div",{className:"StoryArchivePreview__footerInner",children:[e.videoUrl&&(0,i.jsxs)("div",{className:"StoryArchivePreview__play",children:[(0,i.jsx)(h.Icon16Videocam,{}),(0,i.jsx)("span",{className:"StoryArchivePreview__playTime",children:(0,d.formatTime)(e.duration||0)})]}),l&&(0,i.jsx)("div",{className:"StoryArchivePreview__linkBtn",onClick:e=>this.onLinkButtonClick(e),children:e.linkUrl?a.getLang("stories_edit_link"):a.getLang("stories_add_link")})]})}),g&&(0,i.jsx)("div",{className:"StoryArchivePreview__loader",children:(0,i.jsx)(v.default,{size:24,strokeWidth:3,color:"#fff"})})]})})}constructor(e){super(e),this.videoRef=(0,r.createRef)(),this.needPauseAfterLoading=!1,this.onLinkButtonClick=e=>{const{story:t,onStoryLinkUpdate:o,linkData:i,isDragged:r}=this.props;r||((0,n.showStoryLinkEditorBox)({story:t,onStoryLinkUpdate:o,linkData:i}),e.stopPropagation())},this.onMouseEnter=()=>{this.setState({isHovered:!0})},this.onMouseLeave=()=>{this.setState({isHovered:!1})},this.onToggleCheck=()=>{const{onToggleCheck:e,story:t,isDragged:o}=this.props;!o&&e&&e(t)},this.state={isHovered:!1,preloadVideo:!1,canPlayVideo:!1,isLoading:!1}}}u.defaultProps={checked:!1,selectable:!1,draggable:!1,isDragged:!1,className:"",isEditingLinksAvailable:!1,onToggleCheck:()=>{},onStoryLinkUpdate:()=>{},linkData:[]}},450443:(e,t,o)=>{o.d(t,{StoryArchivePreviewGrid:()=>a});var i=o(785893),r=o(667294),s=o(682615);class a extends r.Component{getGridContainer(){return this.gridContainerRef.current}render(){const{className:e,children:t,isScrolling:o}=this.props;return(0,i.jsx)("div",{className:(0,s.classNames)("StoryArchivePreviewGrid",e,{"StoryArchivePreviewGrid--scrolling":o}),children:(0,i.jsx)("div",{className:"StoryArchivePreviewGrid__inner",ref:this.gridContainerRef,children:t})})}constructor(...e){super(...e),this.gridContainerRef=(0,r.createRef)()}}a.defaultProps={className:""}},481665:(e,t,o)=>{o.d(t,{StoryCustomCoverPreview:()=>c});var i=o(785893),r=o(667294),s=o(659397),a=o(230601),n=o(647605),l=o(29271),d=o(501977);class c extends r.PureComponent{render(){const{checked:e,coverUrl:t,onToggleCheck:o,uploadingStatus:r,uploadingPercent:c,retryUpload:h}=this.props,v=r===d.CoverUploadStatus.uploaded,u=r===d.CoverUploadStatus.uploading,p=r===d.CoverUploadStatus.failed,_=v;return(0,i.jsxs)("div",{className:(0,s.classNames)("StoryCustomCoverPreview StoryPreviewContainer",{"StoryCustomCoverPreview--empty":u||p}),onClick:()=>{_&&o()},children:[v&&(0,i.jsx)("div",{className:"StoryCustomCoverPreview__coverFrame",children:(0,i.jsx)("div",{className:"StoryCustomCoverPreview__coverWrap",children:(0,i.jsx)("img",{src:t,className:"StoryCustomCoverPreview__cover",alt:""})})}),u&&(0,i.jsx)(a.StoryProgressSpinner,{percent:c}),p&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.Icon24ErrorCircleOutline,{}),(0,i.jsx)("span",{className:"StoryCustomCoverPreview__errorText",children:l.getLang("stories_upload_error_text")}),(0,i.jsx)("div",{className:"StoryCustomCoverPreview__repeat",onClick:h,children:l.getLang("stories_upload_repeat")})]}),_&&(0,i.jsx)("div",{className:(0,s.classNames)("StoryCustomCoverPreview__select",{"StoryCustomCoverPreview__select--on":e})})]})}constructor(e){super(e)}}c.defaultProps={uploadingStatus:d.CoverUploadStatus.uploaded}},783412:(e,t,o)=>{o.d(t,{StoryLinkEditorBox:()=>f});var i=o(785893),r=o(667294),s=o(29271),a=o(82161),n=o(514986),l=o(725296),d=o(970978),c=o(584356),h=o(816511),v=o(400856),u=o(685371),p=o(833314),_=o(622284),g=o(126116),m=o(832550),w=o(86894);class f extends r.Component{componentDidUpdate(e,t){t.needErrorStatus!==this.state.needErrorStatus&&this.state.needErrorStatus&&setTimeout((()=>{this.setState({needErrorStatus:!1})}),3e3)}render(){const{onClose:e,linkData:t}=this.props,{linkType:o,link:r,needShowHint:a,needErrorStatus:n,isSaving:l,isDeleting:d}=this.state,c=this.isEditMode()?s.getLang("stories_edit_link_title"):s.getLang("stories_add_link_title");return(0,i.jsxs)(h.ModalBox,{children:[(0,i.jsx)(v.ModalHeader,{onClose:e,closeAriaLabel:s.getLang("global_close"),children:c}),(0,i.jsxs)(u.ModalBody,{insetLevel:1,children:[(0,i.jsx)(p.FormItem,{mode:"horizontal",topAlign:"right",topWidth:"s",top:s.getLang("stories_link_label_url"),status:n?"error":"default",children:(0,i.jsx)(_.TextTooltip,{text:s.getLang("stories_upload_link_format"),placement:"top",appearance:"neutral",shown:a,width:200,children:(0,i.jsx)(w.Input,{value:r,onChange:this.onChangeLink,onKeyUp:this.onKeyUpLink,autoFocus:!0,getRef:this.inputRef})})}),(0,i.jsx)(p.FormItem,{mode:"horizontal",topAlign:"right",topWidth:"s",top:s.getLang("stories_link_label_text"),children:(0,i.jsx)(w.Select,{options:t.items,value:o,onChange:this.onChangeLinkType})})]}),(0,i.jsx)(g.ModalFooter,{before:this.isEditMode()?(0,i.jsx)(m.Button,{loading:d,mode:"tertiary",size:"m",onClick:this.onDelete,children:s.getLang("stories_delete_link")},"delete"):void 0,actionButtons:[(0,i.jsx)(m.Button,{mode:"tertiary",size:"m",onClick:()=>e(),children:s.getLang("global_cancel")},"close"),(0,i.jsx)(m.Button,{loading:l,mode:"primary",size:"m",onClick:this.onSave,children:this.isEditMode()?s.getLang("global_save"):s.getLang("stories_add_link")},"save")]})]})}isEditMode(){return Boolean(this.props.story.linkUrl)}isLinkValid(e){if(e.length<2)return!1;if(!e.startsWith("http://")&&!e.startsWith("https://"))return!1;if(!e.match(/^[a-z0-9\/\-._:%=?&@#]+$/i))return!1;try{new URL(e)}catch(e){return!1}return!0}edit(e="",t="",o=!0,i){const{onStoryLinkUpdate:r,onClose:a,story:n,linkData:h}=this.props;window.ajax.post("al_stories.php",{act:"edit_link",story_raw_id:n.rawId,link_url:e,link_text:t,hash:h.editHash},{onDone:()=>{a(),r(n.rawId,e,t)},onFail:e=>{(0,c.showDoneBox)(e||s.getLang("global_unknown_error"));const t="Link saving error in StoryLinkEditor"+(e?": "+e:"");return(0,d.logError)(new Error(t)),!0},showProgress:()=>{o?this.setState({isSaving:!0}):this.setState({isDeleting:!0}),(0,l.lockButton)(i)},hideProgress:()=>{var e;i&&(null==(e=(0,c.curBox)())||e.hide(),(0,l.unlockButton)(i));o?this.setState({isSaving:!1}):this.setState({isDeleting:!1})}})}delete(e){this.edit("","",!1,e)}constructor(e){super(e),this.inputRef=(0,r.createRef)(),this.onChangeLink=e=>{let t=(0,a.trim)(e.target.value);this.setState({link:t,needShowHint:!this.isLinkValid(t)})},this.onKeyUpLink=()=>{const{link:e}=this.state;this.setState({needShowHint:!this.isLinkValid(e)})},this.onChangeLinkType=e=>{this.setState({linkType:String(e.target.value)})},this.onSave=()=>{const{linkData:e}=this.props,{linkType:t}=this.state;let{link:o}=this.state;var i,r;if(o=(0,a.trim)(o),!this.isLinkValid(o))return null==(i=this.inputRef)||null==(r=i.current)||r.focus(),void this.setState({needShowHint:!0,needErrorStatus:!0});e.needShowHint?(0,n.showFastBox)(s.getLang("stories_saving_link"),s.getLang("stories_link_editing_warning"),s.getLang("global_save"),(e=>{this.edit(o,t,!0,e)}),s.getLang("global_cancel")):this.edit(o,t)},this.onDelete=()=>{const{linkData:e}=this.props;e.needShowHint?(0,n.showFastBox)(s.getLang("stories_deleting_link"),s.getLang("stories_link_deleting_warning"),s.getLang("global_delete"),(e=>{this.delete(e)}),s.getLang("global_cancel")):this.delete()},this.state={link:e.story.linkUrl||"",linkType:e.story.linkType||e.linkData.items[0].value,needShowHint:!1,needErrorStatus:!1,isSaving:!1,isDeleting:!1}}}},641185:(e,t,o)=>{o.d(t,{StoryLoadFile:()=>s});var i=o(785893),r=o(523087);const s=({text:e,multiple:t=!1,onFilesLoad:o})=>(0,i.jsxs)("div",{className:"StoryLoadFile StoryPreviewContainer",children:[(0,i.jsx)(r.Icon36Add,{}),(0,i.jsx)("span",{className:"StoryLoadFile__text",children:e}),(0,i.jsx)("input",{type:"file",className:"StoryLoadFile__input",multiple:t,onChange:e=>{const t=e.currentTarget.files;t&&o(Array.from(t))}})]})},230601:(e,t,o)=>{o.d(t,{StoryProgressSpinner:()=>n});var i=o(785893),r=o(667294);const s=3,a=2*Math.PI*22,n=(0,r.memo)((({percent:e=60,width:t=24,height:o=24})=>{const r=(a-s)*e/100+s;return(0,i.jsx)("svg",{className:"StoryProgressSpinner",width:t,height:o,viewBox:"0 0 50 50",children:(0,i.jsx)("circle",{cx:"25",cy:"25",r:22,stroke:"#fff",fill:"none",strokeWidth:"6",strokeMiterlimit:"10",strokeDashoffset:"0",strokeDasharray:`${r},${a}`,strokeLinecap:"round"})})}))},377992:(e,t,o)=>{o.d(t,{UploadDropBoxArea:()=>s});var i=o(785893),r=o(29271);const s=()=>(0,i.jsx)("div",{className:"UploadDropBoxArea",children:(0,i.jsx)("div",{className:"UploadDropBoxArea__inner",children:(0,i.jsx)("div",{className:"UploadDropBoxArea__text",children:r.getLang("stories_narrative_cover_drop_hint")})})})},445706:(e,t,o)=>{o.d(t,{UploadDropPageArea:()=>a});var i=o(785893),r=o(29271),s=o(120773);const a=()=>(0,i.jsx)(s.WithPortal,{children:(0,i.jsx)("div",{className:"UploadDropPageArea",children:(0,i.jsxs)("div",{className:"UploadDropPageArea__inner",children:[(0,i.jsx)("div",{className:"UploadDropPageArea__image"}),(0,i.jsx)("div",{className:"UploadDropPageArea__text",children:r.getLang("stories_drop_page_area_label")})]})})})},365035:(e,t,o)=>{o.d(t,{ADMIN_STORY_VIEW_MODULE:()=>s,BOX_ITEM_DRAGGABLE_CLASS:()=>u,EMOJI_REACTIONS_ARR:()=>n,INIT_MAX_FEEDBACK_STORIES_COUNT:()=>c,LONG_PRESS_DELAY_MS:()=>r,MAX_FEEDBACK_STORIES_SLICE_COUNT:()=>d,MAX_NARRATIVE_STORIES:()=>h,NARRATIVE_MAX_TITLE_LENGTH:()=>v,QUESTION_SELECT_MODE:()=>l,SCROLL_LOADING_MORE_GAP:()=>_,SCROLL_THROTTLE_DELAY:()=>p,STORIES_MANAGE_MODULE:()=>i,StickerTypes:()=>a});const i="stories_manage",r=200,s="admin_story_view",a={hashtag:1,mention:2,question:3,place:4,music:5,storyReply:6,owner:7,link:8,marketItem:9,post:10,poll:11,sticker:12,app:13,situationalTheme:14,playlist:15,videoButton:16},n=[{code:"f09f9882",name:"face_with_tears_of_happiness"},{code:"f09f988d",name:"smiling_face_with_heart_eyes"},{code:"f09f918df09f8fbf",name:"thumbs_up"},{code:"f09f98ad",name:"loud_crying_face"},{code:"f09f98b1",name:"face_screaming_in_fear"},{code:"e298ba",name:"smiling_face"}],l={PUBLIC:0,AUTHOR_ONLY:1,ANONYMOUS:3},d=50,c=10,h=100,v=23,u="NarrativeBox__draggable",p=34,_=400},880660:(e,t,o)=>{o.d(t,{highlightNarrativeBlock:()=>g,prepareStoriesForPublishing:()=>p,updateNarrativeBlock:()=>_,updateNarrativeSnippetsFromQueueByPost:()=>m});var i=o(795558),r=o(584356),s=o(533919),a=o(29271),n=o(664988),l=o(687437),d=o(964262),c=o(970978),h=o(839470),v=o(931917);const u="NarrativeSnippet";function p(e){return e.map((e=>e.id)).join(",")}function _(e=!1){const t=(0,n.intval)(window.cur.oid);if(window.cur.narrativeBlock)window.ajax.post("al_stories.php",{act:"get_narrative_block",owner_id:t},{onDone:e=>{const t=(0,n.intval)(window.cur.oid),o=document.getElementById(`narratives_module${t}_wrapper`);if(o)if(e)(0,i.domReplaceEl)(o,e),window.cur.narrativeBlock&&window.cur.narrativeBlock.destroy(),window.NarrativeBlock&&(window.cur.narrativeBlock=new window.NarrativeBlock);else{const e=o.parentElement;(null==e?void 0:e.children.length)&&(null==e?void 0:e.children.length)>1?o.remove():null==e||e.remove(),window.cur.narrativeBlock&&window.cur.narrativeBlock.destroy(),delete window.cur.narrativeBlock}(0,d.removeStoryList)(`narratives${t}`)}});else if(v.Ranges.isUserId(t)&&"profile"===window.cur.module){const e=document.getElementById(l.PROFILE_MEDIA_NARROW_BLOCK_ID),o=!e;window.ajax.post("al_stories.php",{act:"get_narrative_block",owner_id:t,need_wrap_block:(0,n.intval)(o)},{onDone:o=>{if(e)e.insertAdjacentHTML("afterbegin",o);else{const e=document.getElementById("narrow_column");if(!e)return;e.insertAdjacentHTML("beforeend",o)}window.cur.narrativeBlock&&window.cur.narrativeBlock.destroy(),window.NarrativeBlock&&(window.cur.narrativeBlock=new window.NarrativeBlock,window.cur.narrativeBlock.showOnboardTooltipIfNeeded()),(0,d.removeStoryList)(`narratives${t}`)}})}else e&&function(e){window.boxQueue.hideAll();const t=document.querySelector("#box_layer_wrap"),o=document.querySelector("#box_loader");window.nav.reload({onDone:()=>{e&&e()},showProgress:()=>{(0,i.show)(t),(0,i.show)(o),(0,r.boxRefreshCoords)(o)},hideProgress:()=>{(0,i.hide)(t),(0,i.hide)(o)}})}((()=>{window.cur.needNarrativeOnboard=!0}))}function g(e){if(!e)return;const t=`narratives_module${window.vk.id}`;(0,s.highlightModule)({module:t,text:a.getLang("stories_narrative_block_onboarding_text"),onClose:()=>{delete window.cur.needNarrativeOnboard,window.ajax.post("al_index.php",{act:"hide_feature_tt",hash:e,type:"profile_narrative"})},autoCancelDelay:1e4,speed:600})}function m(e){if(!window.vk.id)return;if(!(0,h.partConfigEnabled)("update_private_snippets_by_queue"))return;const t=Array.from(e.querySelectorAll(`.${u}`));if(!t.length)return;const o=[];t.forEach((e=>{if(!window.vk.id||!e.dataset.needUpdate)return;const t=e.dataset.narrativeRawId;t&&o.push({narrative_raw_id:t,snippet_type:e.dataset.snippetType,from:e.dataset.from})})),o.length&&window.ajax.post("al_stories.php",{act:"get_narrative_snippets",narrative_snippets:JSON.stringify(o)},{onDone:e=>{t.forEach((t=>{t.dataset.narrativeRawId&&e[t.dataset.narrativeRawId]&&(t.outerHTML=e[t.dataset.narrativeRawId])}))},onFail:()=>((0,c.logError)(new Error("Fail: updateNarrativeSnippetFromQueueByPost")),!0)})}},516091:(e,t,o)=>{function i(e,t=!1){return new Promise(((o,i)=>{window.ajax.post("al_stories.php",{act:e.boxAct,owner_id:e.ownerId,start_from:e.startFrom,track_code:e.trackCode},{loader:!e.narratives.length&&!t,onDone:(e,t,i)=>{o([e,t,i])},onFail:e=>(i(e),!0)})}))}function r(e){return i(e).then((([t,,o])=>{var i;return e.narratives=(null==(i=e.narratives)?void 0:i.concat(t))||t,e.startFrom=o,t}))}function s(e={}){return i(a(e),!0)}function a(e={}){return{narratives:e.narratives?e.narratives:[],boxData:e.boxData,boxAct:"get_recommended_narratives",trackCode:e.trackCode,list:e.list,source:e.source}}function n(e){return window.stManager.add(e)}o.d(t,{addStatic:()=>n,fetchRecommendedNarrativesBoxData:()=>s,getRecommendedNarrativesStore:()=>a,load:()=>i,loadMoreNarratives:()=>r})},833723:(e,t,o)=>{o.d(t,{SIMPLE_BOX_WIDTH:()=>i,SMALL_BOX_WIDTH:()=>s,WIDE_BOX_WIDTH:()=>r});const i=560,r=638,s=450},630892:(e,t,o)=>{o.r(t),o.d(t,{fetchRecommendedNarrativesBoxData:()=>c.fetchRecommendedNarrativesBoxData,showNarrativeBox:()=>i.showNarrativeBox,showNarrativeChooseBox:()=>r.showNarrativeChooseBox,showNarrativeCreateLiteBox:()=>s.showNarrativeCreateLiteBox,showNarrativeCropCoverBox:()=>a.showNarrativeCropCoverBox,showNarrativeEditorBox:()=>n.showNarrativeEditorBox,showRecommendedNarrativesBox:()=>l.showRecommendedNarrativesBox,showStoryLinkEditorBox:()=>d.showStoryLinkEditorBox});var i=o(583396),r=o(412504),s=o(207094),a=o(378734),n=o(278212),l=o(373697),d=o(844553),c=o(516091)},583396:(e,t,o)=>{o.d(t,{showNarrativeBox:()=>w});var i=o(434788),r=o(785893),s=o(386342),a=o(400469),n=o(584356),l=o(29271),d=o(725296),c=o(514986),h=o(858069),v=o(516091),u=o(833723),p=o(359639),_=o(667294),g=o(659397);function m({options:e,onClose:t,refreshCoordinates:o,onWasPublishChange:u}){const[g,m]=(0,_.useState)((()=>({narratives:[],ownerId:e.ownerId,boxAct:"get_narrative_box_data"})));(0,_.useEffect)((()=>{(0,v.load)(g,!0).then((([e,t,o])=>{m((r=>(0,i._)({},r,{narratives:e,boxData:t,startFrom:o})))})).catch((o=>{(0,n.showDoneBox)(o||l.getLang("global_error")),t(),null==e.onClose||e.onClose()}))}),[]);const{boxData:w}=g;if(!w)return(0,r.jsx)(p.MessageBoxModalLoader,{refreshCoordinates:o});const f=w.canEdit?a.BoxType.edit:a.BoxType.view;return(0,r.jsx)(s.NarrativeBox,{type:f,boxData:w,narratives:g.narratives,onClose:t,onSave:t=>{null==e.onSave||e.onSave(t),u(!0)},onRemove:t=>{const o={title:l.getLang("global_warning")};(0,c.showFastBox)(o,l.getLang("stories_narrative_remove_warning"),l.getLang("stories_remove_confirm"),(o=>{const r=g.boxData;r&&window.ajax.post("al_stories.php",{act:"remove_narrative",narrative_raw:t.rawId,hash:r.removeHash},{onDone:()=>{(0,h.sendNarrativeAnalytic)(h.NarrativeAnalyticEventType.deleteNarrative,t,e.navScreen),m((e=>e.boxData?(0,i._)({},e,{boxData:(0,i._)({},e.boxData,{count:e.boxData.count-1}),narratives:e.narratives.filter((e=>e.rawId!==t.rawId))}):e)),(0,n.showDoneBox)(l.getLang("stories_deleted_narrative")),null==e.onRemove||e.onRemove()},onFail:e=>((0,n.showDoneBox)(e||l.getLang("global_error")),!0),showProgress:()=>(0,d.lockButton)(o),hideProgress:()=>{(0,n.curBox)().hide(),(0,d.unlockButton)(o)}})}),l.getLang("global_cancel"))},onBookmark:e=>{e.isBookmarked=!e.isBookmarked,m((e=>(0,i._)({},e)))},onReorder:t=>{m((e=>(0,i._)({},e,{narratives:t}))),null==e.onReorder||e.onReorder()},loadMore:()=>(0,v.loadMoreNarratives)(g).then((()=>{m((e=>(0,i._)({},e)))})).catch((e=>{(0,n.showDoneBox)(e||l.getLang("global_error"))})),navScreen:e.navScreen,refreshCoordinates:o})}function w(e){const t={current:!1},o={current:g.noop};(0,p.showMessageBoxModal)((s=>(o.current=s.onClose,(0,r.jsx)(m,(0,i._)({},s,{options:e,onWasPublishChange:e=>{t.current=e}})))),{width:u.SIMPLE_BOX_WIDTH,onShow:()=>{t.current&&o.current()},onDestroy:e.onClose})}},412504:(e,t,o)=>{o.d(t,{showNarrativeChooseBox:()=>p});var i=o(434788),r=o(785893),s=o(584356),a=o(29271),n=o(24237),l=o(516091),d=o(833723),c=o(359639),h=o(667294),v=o(659397);function u({onClose:e,refreshCoordinates:t,options:o,onAfterSavingChange:d}){const[v,u]=(0,h.useState)((()=>({narratives:[],ownerId:o.ownerId,boxAct:"get_narrative_choose_box_data"})));(0,h.useEffect)((()=>{(0,l.load)(v,!0).then((([e,t,o])=>{u((r=>(0,i._)({},r,{narratives:e,boxData:t,startFrom:o})))})).catch((t=>{(0,s.showDoneBox)(t||a.getLang("global_error")),e()}))}),[]);const{boxData:p}=v;return p?(0,r.jsx)(n.NarrativeChooseBox,{story:o.story,narratives:v.narratives,onClose:e,onSave:e=>{d(!0),null==o.onSave||o.onSave(e)},boxData:p,loadMore:()=>(0,l.loadMoreNarratives)(v).then((e=>(u((e=>(0,i._)({},e))),e))).catch((e=>((0,s.showDoneBox)(e||a.getLang("global_error")),[]))),navScreen:o.navScreen}):(0,r.jsx)(c.MessageBoxModalLoader,{refreshCoordinates:t})}function p(e){const t={current:!1},o={current:v.noop};(0,c.showMessageBoxModal)((s=>(o.current=s.onClose,(0,r.jsx)(u,(0,i._)({},s,{options:e,onAfterSavingChange:e=>{t.current=e}})))),{width:d.SIMPLE_BOX_WIDTH,onShow:()=>{t.current&&o.current()},onDestroy:()=>{null==e.onClose||e.onClose(t.current)}})}},207094:(e,t,o)=>{o.d(t,{showNarrativeCreateLiteBox:()=>l});var i=o(434788),r=o(785893),s=o(16344),a=o(359639),n=o(833723);function l(e){const{onSave:t,onClose:o,ownerId:l,ownerName:d,stories:c,publishNarrativeHash:h}=e;(0,a.showMessageBoxModal)((e=>(0,r.jsx)(s.NarrativeCreateLiteBox,(0,i._)({},e,{stories:c,ownerId:l,ownerName:d,publishNarrativeHash:h,onSave:t}))),{width:n.SIMPLE_BOX_WIDTH,onDestroy:o})}},378734:(e,t,o)=>{o.d(t,{showNarrativeCropCoverBox:()=>l});var i=o(434788),r=o(785893),s=o(983647),a=o(359639),n=o(833723);function l(e){const{coverUrl:t,coverHeight:o,coverWidth:l,thumbHeight:d,thumbWidth:c,onClose:h,onSave:v,crop:u}=e;(0,a.showMessageBoxModal)((e=>(0,r.jsx)(s.NarrativeCoverCropper,(0,i._)({},e,{coverUrl:t,coverHeight:o,coverWidth:l,thumbHeight:d,thumbWidth:c,onSave:v,crop:u}))),{width:n.WIDE_BOX_WIDTH,onDestroy:h})}},278212:(e,t,o)=>{o.d(t,{showNarrativeEditorBox:()=>m});var i=o(434788),r=o(785893),s=o(399133),a=o(659397),n=o(584356),l=o(29271),d=o(970978),c=o(378839),h=o(501977),v=o(833723),u=o(516091),p=o(359639),_=o(667294);function g({ownerId:e,options:t,onClose:o,refreshCoordinates:v,onAfterSavingChange:u}){const{narrative:g}=t,[m,w]=(0,_.useState)(t.stories),[f,y]=(0,_.useState)(t.selectedStories||[]),[C,S]=(0,_.useState)(t.storiesCount),[x,N]=(0,_.useState)(t.publishHash),[b,k]=(0,_.useState)(t.editHash),[E,L]=(0,_.useState)(t.linkData),[I,T]=(0,_.useState)(t.isEditingLinksAvailable),[B,D]=(0,_.useState)(t.coverUploadConfig);(0,_.useEffect)((()=>{m&&x&&b&&C&&B||new Promise(((t,o)=>{window.ajax.post("al_stories.php",{act:"get_narrative_editor_data",owner_id:e},{loader:!0,onDone:e=>{w(e.stories),S(e.storiesCount),N(e.publishHash),k(e.editHash),L(e.linkData),T(e.isEditingLinksAvailable),D(e.coverUploadConfig),t(void 0)},onFail:e=>(o(e),!0)})})).catch((e=>{(0,n.showDoneBox)(e||l.getLang("global_error")),(0,d.logError)(e),o()}))}),[]);if(!((null==m?void 0:m.length)&&x&&b&&C&&B))return(0,r.jsx)(p.MessageBoxModalLoader,{refreshCoordinates:v});let P=m.reduce(((e,t)=>(e[t.id]=t,e)),{});P=f.reduce(((e,t)=>(e[t.id]=t,e)),P);const j=m.map((e=>e.id)),A=f.map((e=>e.id)),M=g?s.EditorModeType.edit:s.EditorModeType.create,R=(null==g?void 0:g.title)?(0,a.decodeHTMLEntities)(g.title):"",O=C>m.length,U=g?(0,h.getPreparedCover)(g):void 0;return(0,r.jsx)(c.NarrativeEditor,{ownerId:e,type:M,name:R,narrativeRawId:null==g?void 0:g.rawId,cover:U,selectedStoryIds:A,storyIds:j,hasMore:O,storyMap:P,close:o,loadMore:()=>(null==m?void 0:m.length)?new Promise(((t,o)=>{if(!(null==m?void 0:m.length))return o("empty stories");window.ajax.post("al_stories.php",{act:"get_archive_stories",owner_id:e,offset:m.length},{onDone:(e,i)=>{if(!m)return void o("empty stories after loading");w((t=>[...null!=t?t:[],...e])),S(i);const r=i>m.length;t(r)},onFail:e=>(o(e),!0)})})):Promise.reject("empty stories"),onSave:e=>{null==t.onSave||t.onSave(e),u(!0)},publishHash:x,editHash:b,linkData:E,isEditingLinksAvailable:I,onStoryLinkUpdate:(e,t,o)=>{if(!(null==m?void 0:m.length))return;const r=r=>r.map((r=>r.rawId===e?(0,i._)({},r,{linkUrl:t,linkType:o}):r));w((e=>r(null!=e?e:[]))),y((e=>r(null!=e?e:[])))},appearance:s.EditorViewType.box,navScreen:t.navScreen,coverUploadConfig:B,getPublishDoneHTML:t.getPublishDoneHTML,refreshCoordinates:v})}function m(e,t={}){const o={current:!1};(0,u.addStatic)(["NarrativeEditor.css"]).then((()=>{(0,p.showMessageBoxModal)((s=>(0,r.jsx)(g,(0,i._)({},s,{ownerId:e,options:t,onAfterSavingChange:e=>{o.current=e}}))),{width:v.WIDE_BOX_WIDTH,onDestroy:()=>null==t.onClose?void 0:t.onClose(o.current)})})).catch((e=>{console.error(e),(0,d.logError)(e)}))}},373697:(e,t,o)=>{o.d(t,{showRecommendedNarrativesBox:()=>u});var i=o(434788),r=o(785893),s=o(584356),a=o(29271),n=o(386342),l=o(516091),d=o(833723),c=o(359639),h=o(667294);function v({onClose:e,refreshCoordinates:t,options:o}){const[d,v]=(0,h.useState)((()=>(0,l.getRecommendedNarrativesStore)(o))),{narratives:u,boxData:p}=d,_=(null==u?void 0:u.length)&&null!=p;(0,h.useEffect)((()=>{_||(0,l.load)(d).then((([e,t])=>{v((o=>(0,i._)({},o,{narratives:e,boxData:t})))})).catch((t=>{(0,s.showDoneBox)(t||a.getLang("global_error")),e()}))}),[]);const g=()=>{v((e=>(0,i._)({},e)))};if(!_)return(0,r.jsx)(c.MessageBoxModalLoader,{refreshCoordinates:t});return(0,r.jsx)(n.NarrativeBox,{title:a.getLang("news_fb_block_recommend_narratives"),showNarrativeNumber:!1,boxData:p,narratives:u,loadMore:()=>(0,l.loadMoreNarratives)(d).then((()=>{g()})).catch((e=>{(0,s.showDoneBox)(e||a.getLang("global_error"))})),onClose:e,onBookmark:e=>{e.isBookmarked=!e.isBookmarked,g()},trackCode:d.trackCode,list:d.list,source:d.source,refreshCoordinates:t})}function u(e={}){(0,c.showMessageBoxModal)((t=>(0,r.jsx)(v,(0,i._)({},t,{options:e}))),{width:d.SIMPLE_BOX_WIDTH})}},844553:(e,t,o)=>{o.d(t,{showStoryLinkEditorBox:()=>d});var i=o(434788),r=o(785893),s=o(659397),a=o(783412),n=o(359639),l=o(833723);function d(e){const{story:t,onClose:o,onStoryLinkUpdate:d}=e;let{linkData:c}=e;if(t.linkType&&t.linkText){c.items.find((e=>e.value===t.linkType))||(c=(0,i._)({},c,{items:[...c.items,{value:t.linkType,label:t.linkText}]}))}(0,n.showMessageBoxModal)((e=>(0,r.jsx)(a.StoryLinkEditorBox,(0,i._)({},e,{story:t,onStoryLinkUpdate:d,linkData:(0,s.decodeHTMLEntitiesDeep)(c)}))),{width:l.SMALL_BOX_WIDTH,onDestroy:o})}},505426:(e,t,o)=>{o.d(t,{WallDataEvents:()=>a,emitEvent:()=>h,registerNonGlobalNonUniqueListener:()=>c,registerUniqueListener:()=>d});var i=o(434788),r=o(980602),s=o(212368);const a={post_reactions_counts_update:"wall/post_reactions_counts_update",reply_reactions_counts_update:"wall/reply_reactions_counts_update",post_subscribe_update:"wall/post_subscribe_update"},n=(0,s.makeSharedState)("wall-data",(()=>({emitter:new r.default,keyedListeners:Object.create(null)})),{version:0}),l=(e,t,o)=>{var r,s;const a=n(),l=null==(r=a.keyedListeners)||null==(s=r[e])?void 0:s[t];return l&&a.emitter.removeListener(e,l),((e,t,o)=>{const r=n();return r.emitter.addListener(e,o),r.keyedListeners[e]=(0,i._)({},r.keyedListeners[e],{[t]:o}),()=>{var i,s;r.emitter.removeListener(e,o),(null==(i=r.keyedListeners[e])?void 0:i[t])===o&&(null==(s=r.keyedListeners[e])||delete s[t])}})(e,t,o)},d=(e,t,o)=>l(t,e,o),c=(e,t)=>((e,t)=>{const o=n();return o.emitter.addListener(e,t),()=>{o.emitter.removeListener(e,t)}})(e,t),h=(e,t)=>{n().emitter.emit(e,t)}},228411:(e,t,o)=>{o.d(t,{updateAriaLabelCounter:()=>s});var i=o(29271),r=o(234514);const s=(e,t,o)=>{if(!("number"==typeof t&&e instanceof HTMLElement&&e.classList.contains("PostBottomAction")))return;const s=(e=>{let t;switch(e){case r.LikeButtonTypes.comment:t=i.getLang("likes_comments_N_aria_short","raw");break;case r.LikeButtonTypes.like:t=i.getLang("likes_likes_N_aria_short","raw");break;case r.LikeButtonTypes.share:t=i.getLang("likes_shares_N_aria_short","raw")}return t})(o);if(!s)return;const a=(0,i.langNumeric)(t,s,!1);e.setAttribute("aria-label",a)}},444402:(e,t,o)=>{o.d(t,{default:()=>d});var i=o(438221),r=o(705758),s=o(795558),a=o(82161),n=o(953908);function l(e,t,o){if((0,a.isObject)(t)?o=t:this._dragElClass=t,this.options=(0,a.extend)({dragThreshold:l.DRAG_THRESHOLD_DIST},o),this._contEl=(0,s.ge)(e),this._contEl){this._excludedCount=0;for(let e=0;e<this._contEl.children.length;e++)this._contEl.children[e].getAttribute("nodrag")&&this._excludedCount++;(0,n.addEvent)(this._contEl,"mousedown",this._ev_mousedown_handler=this._onMouseDown.bind(this)),(0,s.setStyle)(this._contEl,"position","relative"),this._inited=!0,this._updateScrollbar=this._initUpdaterScrollbar()}}l.AUTO_SCROLL_DY=10,l.DRAG_THRESHOLD_DIST=0,l.AUTO_SCROLL_DISTANCE_THRESHOLD=300,l.AUTO_SCROLL_GAP=300,l.prototype.destroy=function(){this._inited&&(this._inited=!1,this._deinitEvents(!0))},l.prototype._getParentDragItemEl=function(e){let t,o=e;for(;o&&(t=(0,s.domPN)(o))!==this._contEl;)o=t;return o===this._curPlaceholderEl&&(o=null),o},l.prototype._onKey=function(e){e.keyCode===n.KEY.ESC&&this.isCurrentlyDragging()&&this._onMouseUp()},l.prototype._onMouseDown=function(e){if(this._disabled||0!=e.button||this._curDragEl||(0,s.attr)(e.target,"nodrag")||this._dragElClass&&!(0,s.domClosest)(this._dragElClass,e.target))return;let t=e.target;for(;t&&t!==window.document;){if((0,a.intval)((0,s.domData)(t,"nodrag")))return;t=(0,s.domPN)(t)}const o=this._getParentDragItemEl(e.target);if(!o||(0,s.attr)(o,"nodrag"))return;if((0,s.re)((0,s.geByClass1)("ui_gridsorter_placeholder"),this._contEl),this._contInfo=this._contInfo||{prevSize:(0,s.getSize)(this._contEl)},this._ensureGridIsActual(),this._grid.length<=1)return;const i=window.getComputedStyle(o),r=(0,s.getXY)(o);this._initial={candidateEl:o,x:e.clientX,y:e.clientY,itemMargin:{x:parseInt(i.marginLeft),y:parseInt(i.marginTop)},shift:{x:e.pageX-r[0],y:e.pageY-r[1]}},(0,n.addEvent)(document,"mousemove",this._ev_mousemove_handler=this._onMouseMove.bind(this)),(0,n.addEvent)(document,"mouseup",this._ev_mouseup_handler=this._onMouseUp.bind(this)),(0,n.addEvent)(document,"keydown",this._ev_keydown_handler=this._onKey.bind(this)),cur.cancelClick=!1,(0,n.cancelEvent)(e)},l.prototype._dist=function(e){return Math.abs(e.clientX-this._initial.x)+Math.abs(e.clientY-this._initial.y)},l.prototype._onMouseUp=function(e){const t=this._curDragEl;let o=!e;if(this._curDragEl){this._curDragEl=null,(0,s.removeClass)(t,"ui_gridsorter_moveable_notrans"),this._curOverCell||(this._curOverCell={el:this._curPlaceholderEl,pos:(0,s.getXY)(this._curPlaceholderEl),size:(0,s.getSize)(this._curPlaceholderEl)});const i=this._curOverCell.pos,r=this._curOverCell.el,a=this._grid[this._curDragCellIndex],l=a&&a.size;(0,s.gpeByClass)("_ape_item_list",t)&&(i[0]+=20,i[1]+=20),l&&this._isShiftToLeft&&(i[1]-=l[1]-this._curOverCell.size[1]),setTimeout((()=>{if(o){for(let e=0,t=this._grid.length;e<t;e++){const t=this._grid[e];t.dirty&&this._setPos(t.el,{left:0,top:0})}this._setPos(t,this._initialCurDragPos)}else this._setPos(t,{left:i[0],top:i[1]})})),setTimeout((()=>{if((0,s.re)(this._curPlaceholderEl),(0,s.removeClass)(this._contEl,"ui_gridsorter_cont"),this.options.dragCls&&(0,s.removeClass)(t,this.options.dragCls),!this._inited)return;let e;if(o){let e=this._grid.length;for(let t=0;t<e;t++){const e=this._grid[t];e.dirty&&this._setPos(e.el,{left:null,top:null})}this._setPos(t,{left:null,top:null,width:null,height:null})}else{let o;e=this._isShiftToLeft?(0,s.domNS)(r):r,this._contEl.insertBefore(t,e);let i=-1,a=this._initial.hasInlineSize;this._setPos(t,{left:null,top:null}),a||(0,s.setStyle)(t,{width:null,height:null});let n=this._grid.length;for(let e=0;e<n;e++){const n=this._grid[e];(n.dirty||n.el===t)&&(this._setPos(n.el,{left:null,top:null}),a||(0,s.setStyle)(n.el,{width:null,height:null}),n.pos=this._calcElementPos(n.el),n.dirty=!1),n.el===t?o=e:n.el===r&&(i=e)}if(i>=0){const e=this._grid.splice(o,1);this._grid.splice(i,0,e[0])}}(0,s.removeClass)(t,"ui_gridsorter_moveable"),this._curOverCell=this._curPlaceholderEl=null,o&&this.update(),this.options.onDragFinish&&this.options.onDragFinish(t),r!==t&&!o&&this.options.onReorder&&this.options.onReorder(t,e,(0,s.domPS)(t))}),210),e&&this._dist(e)>5&&((0,n.cancelEvent)(e),cur.cancelClick=!0)}this._updateScrollbar(),this._deinitEvents(),t&&this._overEl&&this.options.onDragLeave&&this.options.onDragLeave(this._overEl,t),o||t&&this._overEl&&this.options.onDragDrop&&(o=this.options.onDragDrop(this._overEl,t)),this._overEl=null},l.prototype._deinitEvents=function(e){e&&(this._onMouseUp(),(0,n.removeEvent)(this._contEl,"mousedown",this._ev_mousedown_handler)),clearTimeout(this._autoScrollTO),this._autoScrollTO=!1,this._ev_mousemove_handler&&(0,n.removeEvent)(document,"mousemove",this._ev_mousemove_handler),this._ev_mouseup_handler&&(0,n.removeEvent)(document,"mouseup",this._ev_mouseup_handler),this._ev_keydown_handler&&(0,n.removeEvent)(document,"keydown",this._ev_keydown_handler)},l.prototype._setPos=function(e,t){this.options.noPosTransform||!this._hasTranslateFeauture&&!(this._hasTranslateFeauture=window.getComputedStyle(e).getPropertyValue("transform"))?(0,s.setStyle)(e,(0,a.extend)({transform:null},t)):null===t.left||null===t.top?(0,s.setStyle)(e,{transform:null,top:null,left:null}):(0,s.setStyle)(e,{transform:"translate("+t.left+"px, "+t.top+"px)",top:null,pos:null})},l.prototype._recalc=function(){const e=this._curDragEl,t=this._curOverCell.el;if(this._initGrid(),t===e){let t=this._grid.length;for(let o=0;o<t;o++){const t=this._grid[o];t.el!==e&&t.dirty&&(t.dirty=!1,this._setPos(t.el,{left:null,top:null}))}return}let o=0,i=!1,r=!1,s=this._grid.length;for(let o=0;o<s;o++){const r=this._grid[o];if(r.el===e){i=!0;break}if(r.el===t){i=!1;break}}this._isShiftToLeft=i;let a=i?0:this._grid.length-1,n=i?this._grid.length:-1,l=i?1:-1,d=[0,0];for(;a!==n;a+=l){const s=this._grid[a];if(2!==o)if(s.el!==e){if(s.el===t&&o++,1===o||2===o){let e=0,t=0;i?(e=r.pos[0]+d[0],t=r.pos[1]+d[1],d[0]+=s.size[0]-r.size[0],d[1]+=s.size[1]-r.size[1]):(d[0]+=r.size[0]-s.size[0],d[1]+=r.size[1]-s.size[1],e=r.pos[0]+d[0],t=r.pos[1]+d[1]),this._setPos(s.el,{left:e-s.pos[0],top:t-s.pos[1]}),s.dirty=!0}else s.dirty&&(this._setPos(s.el,{left:null,top:null}),s.dirty=!1);r=s}else o++,r=s;else s.dirty&&(this._setPos(s.el,{left:null,top:null}),s.dirty=!1),r=s}},l.prototype.disable=function(){this._disabled=!0},l.prototype.enable=function(){this._disabled=!1,this._initGrid(!0)},l.prototype.update=function(){this._disabled||this._initGrid(!0)},l.prototype._ensureGridIsActual=function(){this._initGrid()},l.prototype._needGridUpdate=function(){if(!this._grid)return 1;this._contInfo.prevSize=this._contInfo.prevSize||(0,s.getSize)(this._contEl);let e=0,t=this._contEl.children.length-this._excludedCount-(0,a.intval)(!!this._curPlaceholderEl);if(t!==this._grid.length)e=t>this._grid.length?2:1,this._contInfo.prevSize=(0,s.getSize)(this._contEl);else{let t=(0,s.getSize)(this._contEl),o=this._contInfo.prevSize;(Math.abs(o[0]-t[0])>5||Math.abs(o[1]-t[1])>5)&&(e=1),this._contInfo.prevSize=t}return e},l.prototype._initGrid=function(e){let t=e?1:this._needGridUpdate();if(!t)return;1===t&&(this._grid=[],this._contInfo&&(delete this._contInfo.pos,delete this._contInfo.size));let o=this._grid?this._grid[this._grid.length-1]:null;this._grid=this._grid||[];let i,r=!!o,a=this._contEl.children;if(!a.length)return;let n=this._getItemMargins();for(let e=this._curDragEl?this._grid.length:0,t=a.length;e<t;e++){let t=a[e];o&&t===o.el?r=!1:r||t===this._curPlaceholderEl||t.getAttribute("nodrag")||(i=(0,s.getSize)(t),i[0]+=n[0],i[1]+=n[1],this._grid.push({el:t,size:i,pos:this._calcElementPos(t)}))}},l.prototype._getRelativeMousePos=function(e){let t=this._getContPos(),o=this._getContShift();return{left:e.clientX-t[0]-o[0],top:e.clientY-t[1]-o[1]}},l.prototype._updateDraggablePosition=function(e){if(!this._curDragEl)return;let t=this._getRelativeMousePos(e),o=this._getItemShift(),i=this._getContShift(),r=this._getContSize(),a=t.top-this._initial.shift.y-o[1]+i[1];this.options.limitBottomMove&&(a=Math.min(a,r[1]+30)),(0,s.hasClass)(this._contEl,"_ape_item_list")&&(a+=this._contEl.scrollTop),this._setPos(this._curDragEl,{left:t.left-this._initial.shift.x-o[0]+i[0],top:a}),window.AudioPage&&window.AudioPage.onUpdateDraggablePosition&&window.AudioPage.onUpdateDraggablePosition()},l.prototype._getContShift=function(){if(this._contInfo=this._contInfo||{},!this._contInfo.shift){let e=window.getComputedStyle(this._contEl);this._contInfo.shift=[parseFloat(e.paddingLeft),parseFloat(e.paddingTop)]}return this._contInfo.shift},l.prototype._getContSize=function(){return this._contInfo=this._contInfo||{},this._contInfo.size=(0,s.getSize)(this._contEl),this._contInfo.size},l.prototype._getContPos=function(){return this._contInfo=this._contInfo||{},this._contInfo.pos=(0,s.getXY)(this._contEl),this._contInfo.pos[1]-=(0,i.scrollGetY)(),this._contInfo.pos},l.prototype._getItemShift=function(){if(this._contInfo=this._contInfo||{},!this._contInfo.itemShift){let e=window.getComputedStyle((0,s.domFC)(this._contEl));this._contInfo.itemShift=[parseFloat(e.marginLeft),parseFloat(e.marginTop)]}return this._contInfo.itemShift},l.prototype._getItemMargins=function(){if(this._contInfo=this._contInfo||{},!this._contInfo.itemMargins){let e=window.getComputedStyle((0,s.domFC)(this._contEl));this._contInfo.itemMargins=[parseFloat(e.marginLeft)+parseFloat(e.marginRight),parseFloat(e.marginTop)+parseFloat(e.marginBottom)]}return this._contInfo.itemMargins},l.prototype._calcElementPos=function(e){let t=this._getContShift(),o=this._getItemShift();return[e.offsetLeft-t[0]-o[0],e.offsetTop-t[1]-o[1]]},l.prototype.isCurrentlyDragging=function(){return!!this._curDragEl},l.prototype._initUpdaterScrollbar=function(){return(0,r.throttle)((e=>{const t=this.options.wrapNode||e;let o=(0,s.data)(t,"sb");o&&o.update(!1,!0)}),500)},l.prototype._onMouseMove=function(e){const t=()=>this.options.wrapNode?this.options.wrapNode.scrollTop:(0,i.scrollGetY)(),o=e=>{this.options.wrapNode?this.options.wrapNode.scrollTop=e:(0,i.scrollToY)(e,0,!1,!0)};if(this._curDragEl){this._ensureGridIsActual(),!e&&(e={clientX:this._lastMousePos.x,clientY:this._lastMousePos.y}),this._lastMousePos={x:e.clientX,y:e.clientY},this._updateDraggablePosition(e);let r=this._getContSize(),a=this._getRelativeMousePos(e),n=!1;if((0,s.hasClass)(this._contEl,"_ape_item_list")&&(a.top+=this._contEl.scrollTop),a.left>0&&a.left<r[0]&&a.top>0&&a.top<r[1]){let e=0,t=this._grid.length-1,o=50;for(;o;){let i=e+Math.floor((t-e)/2);const r=this._grid[i];if(a.left>r.pos[0]&&a.top>r.pos[1]&&a.left<r.pos[0]+r.size[0]&&a.top<r.pos[1]+r.size[1]){n=r;break}if(e===t)break;a.top<r.pos[1]||a.left<r.pos[0]&&a.top<r.pos[1]+r.size[1]?t=t===i?t-1:i:e=e===i?e+1:i,o--}}else{let e,t,o,i=this._grid.length,r=999999;for(let s=0;s<i;s++){const i=this._grid[s];t=a.left-(i.pos[0]+i.size[0]/2),o=a.top-(i.pos[1]+i.size[1]/2);const n=t*t+o*o;r>n&&(r=n,e=i)}n=e}!n||this._curOverCell&&this._curOverCell.el===n.el||(this._curOverCell=n,this._recalc());{let r,a,n,l,d=0;if(this.options.wrapNode)r=l=this.options.wrapNode,a=(0,s.getSize)(r),n=(0,s.getXY)(r),n[1]-=(0,i.scrollGetY)(),d=e.clientY;else{let t=window,o=document.documentElement,i=document.body,r=t.innerWidth||o.clientWidth||i.clientWidth,s=t.innerHeight||o.clientHeight||i.clientHeight;l=t.bodyNode,a=[r,s],n=[0,0],d=e.clientY}let c=Math.max(20,a[1]/10),h=n[1]+c-d,v=c-(n[1]+a[1]-d);if(v>0||h>0){let e=Math.min(1,h/c),i=Math.min(1,v/c);this._autoScrollTO||(this._autoScrollTO=setTimeout((()=>{this._autoScrollTO=!1;let r=t();o(r+16*(e>0?-e:i)),r!==l.scrollTop&&(this._updateScrollbar(l),this._onMouseMove())}),20))}}if(this.options.onDragOverElClass){let t=e.target;(0,s.hasClass)(t,this.options.onDragOverElClass)||(t=(0,s.gpeByClass)(this.options.onDragOverElClass,t))?this._overEl!==t&&(this._overEl&&this.options.onDragLeave&&this.options.onDragLeave(this._overEl,this._curDragEl),this.options.onDragEnter&&this.options.onDragEnter(t,this._curDragEl),this._overEl=t):(this._overEl&&this.options.onDragLeave&&this.options.onDragLeave(this._overEl,this._curDragEl),this._overEl=null)}}else if(this._dist(e)>this.options.dragThreshold){this._curDragEl=this._initial.candidateEl;let t=this._grid.length;for(let e=0;e<t;e++)if(this._grid[e].el===this._curDragEl){this._curDragCellIndex=e;break}this.options.dragCls&&(0,s.addClass)(this._curDragEl,this.options.dragCls);const o=(0,s.getSize)(this._curDragEl),i=(0,s.getXY)(this._curDragEl),r=window.getComputedStyle(this._curDragEl),a=this._getContPos();this._initial.hasInlineSize=!(!this._curDragEl.style.width&&!this._curDragEl.style.height),(0,s.setStyle)(this._curDragEl,{width:o[0],height:o[1]}),this._initialCurDragPos={left:i[0]-a[0],top:i[1]-a[1]-document.body.scrollTop},this._curPlaceholderEl=(0,s.ce)("div",{className:"ui_gridsorter_placeholder"}),(0,s.setStyle)(this._curPlaceholderEl,{width:o[0]+parseFloat(r.marginLeft)+parseFloat(r.marginRight),height:o[1]+parseFloat(r.marginTop)+parseFloat(r.marginBottom)}),this._contEl.insertBefore(this._curPlaceholderEl,this._curDragEl),(0,s.addClass)(this._curDragEl,"ui_gridsorter_moveable"),(0,s.addClass)(this._curDragEl,"ui_gridsorter_moveable_notrans"),(0,s.addClass)(this._contEl,"ui_gridsorter_cont"),this._onMouseMove(e),this._updateDraggablePosition(e),this.options.onDragStart&&this.options.onDragStart(this._curDragEl)}(0,n.cancelEvent)(e)};const d=l},145637:(e,t,o)=>{o.d(t,{ON_BOARDING_BG_RECT_ID:()=>l,default:()=>h});var i=o(795558),r=o(953908),s=o(438221),a=o(23087),n=o(84543);const l="onboarding_bg_rect",d="page_header_cont",c="onboarding";class h{initOnboardingBG(){if(!window.onboardingBG){let e='\n<div id="onboarding_layout">\n  <svg id="onboarding_bg_header" width="100%" height="49px">\n    <rect id="onboarding_bg_rect" class="GroupOnboardingBg" x="0" y="0" width="100%" height="100%" fill-opacity="0.8" fill="#000"></rect>\n  </svg>\n  <svg id="onboarding_bg" width="100%" height="100%">\n  <defs>\n    <mask id="mask" x="0" y="0" width="100%" height="100%">\n      <rect x="0" y="0" width="100%" height="100%" fill="#fff"></rect>\n      <rect id="onboarding_bg_clip" class="GroupOnboardingBgClip" x="0" y="0" width="0" height="0" fill="#000" rx="8" ry="8"></rect>\n    </mask>\n  </defs>\n  <rect id="onboarding_bg_rect" class="GroupOnboardingBg" x="0" y="42" width="100%" height="100%" mask="url(#mask)" fill-opacity="0.8"></rect>\n  </svg>\n</div>\n      ',t=(0,i.se)(e);(0,i.domInsertBefore)(t,window.layerBG),window.onboardingBGHeader=(0,i.ge)("onboarding_bg_header"),window.onboardingBG=(0,i.ge)("onboarding_bg"),window.onboardingBGRect=(0,i.ge)(l),window.onboardingBGClip=(0,i.ge)("onboarding_bg_clip"),window.cur.destroy.push((()=>{(0,i.hide)(window.onboardingBG),(0,i.hide)(window.onboardingBGHeader),(0,i.removeClass)((0,i.ge)(d),c),this.hideDarkness=!0,this.hideTT(),delete window.onboardingBG,delete window.onboardingBGHeader,delete window.onboardingBGRect,delete window.onboardingBGClip,this.opts.onBGClick&&(0,r.removeEvent)(window.onboardingBG,"click",this.opts.onBGClick)}))}this.opts.onBGClick&&(0,r.addEvent)(window.onboardingBG,"click",this.opts.onBGClick)}showTT(){const[,e]=(0,i.getXY)(this.el);this.tt=new n.ElementTooltip(this.el,this.ttParams),this.opts.highlight&&(this.addDarkness(),this.addHighlight()),this.tt.show();const t=this.tt.getContent();(0,a.isElementInViewport)(this.el)&&(0,a.isElementInViewport)(t)||(0,s.scrollToY)(e-42-this.ttParams.scrollOffset)}hideTT(){this.tt&&(this.tt.destroy(),this.removeDarkens(),this.hideDarkness&&((0,r.removeEvent)(window,"scroll"),(0,r.removeEvent)(window,"resize")),this.opts.onBGClick&&window.onboardingBG&&(0,r.removeEvent)(window.onboardingBG,"click",this.opts.onBGClick),this.opts.onHide&&this.opts.onHide())}addHighlight(){window.onboardingBGClip&&(this.highlightElement(),(0,r.addEvent)(window,"scroll",this.onScrollTT.bind(this)),(0,r.addEvent)(window,"resize",this.onResizeTT.bind(this)))}highlightElement(){let e=this.el.offsetWidth,t=this.el.offsetHeight,o=(0,i.getXY)(this.el);(0,i.attr)(window.onboardingBGClip,"width",e+this.border[1]+this.border[3]),(0,i.attr)(window.onboardingBGClip,"height",t+this.border[0]+this.border[2]),(0,i.attr)(window.onboardingBGClip,"x",o[0]-this.border[1]),(0,i.attr)(window.onboardingBGClip,"y",o[1]-this.border[0])}onResizeTT(){this.setDartToFullWidth(),this.highlightElement()}onScrollTT(){let e=this.getPageHeight();window.onboardingBG.height!=e&&this.setDartToFullHeight()}setDartToFullHeight(){(0,i.attr)(window.onboardingBG,"height",this.getPageHeight())}setDartToFullWidth(){(0,i.attr)(window.onboardingBG,"width",this.getPageWidth()),(0,i.attr)(window.onboardingBGHeader,"width",this.getPageWidth())}addDarkness(){(0,i.isVisible)(window.onboardingBG)||(this.setDartToFullHeight(),this.setDartToFullWidth(),(0,i.show)(window.onboardingBG),(0,i.isVisible)(window.onboardingBGHeader)||((0,i.show)(window.onboardingBGHeader),(0,i.addClass)((0,i.ge)(d),c)))}removeDarkens(){this.hideDarkness&&((0,i.hide)(window.onboardingBG),(0,i.hide)(window.onboardingBGHeader),(0,i.removeClass)((0,i.ge)(d),c))}ttOnHide(){this.hideTT()}show(){setTimeout(this.showTT.bind(this),1e3)}getPageWidth(){const e=document.documentElement,t=document.body;return Math.max(t.scrollWidth,e.scrollWidth,t.offsetWidth,e.offsetWidth,t.clientWidth,e.clientWidth)}getPageHeight(){const e=document.documentElement,t=document.body;return Math.max(t.scrollHeight,e.scrollHeight,t.offsetHeight,e.offsetHeight,t.clientHeight,e.clientHeight)}constructor(e,t,o={}){this.el=e,this.text=t,this.hideDarkness=!0,this.oldColor=!1;var i;let r={autoShow:!1,noAutoHideOnWindowClick:null==(i=o.noAutoHideOnWindowClick)||i,content:t instanceof HTMLElement?t:`${t}`,cls:`feature_intro_tt tutorial_tip_tt ${(()=>{var e;const t=null!=(e=o.class)?e:"";return o.tooltipWhite?t:t+" feature_intro_blue_tt"})()}`,appendToParent:!0,onHide:this.ttOnHide.bind(this),scrollOffset:o.scrollOffset||0,align:o.align||n.ElementTooltip.ALIGN_CENTER};o.side&&(r.forceSide=o.side),o.offset&&(r.offset=o.offset),o.width&&(r.width=o.width),o.shift&&(r.centerShift=o.shift),o.border?this.border=o.border:this.border=[10,10,10,10],o.ttOnHide&&(r.onHide=o.ttOnHide),o.withCloseButton&&(r.withCloseButton=o.withCloseButton,r.onCloseButtonClick=o.onCloseButtonClick),o.align&&(r.align=o.align),this.ttParams=r,this.opts=o,this.initOnboardingBG()}}},23087:(e,t,o)=>{function i(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}o.d(t,{isElementInViewport:()=>i})},827652:(e,t,o)=>{o.d(t,{Likes:()=>S});var i=o(434788),r=o(795558),s=o(953908),a=o(320422),n=o(82161),l=o(893106),d=o(95432),c=o(664988),h=o(514986),v=o(29271),u=o(693982),p=o(234514),_=o(682951),g=o(898298),m=o(999237),w=o(878021),f=o(228411),y=o(362246),C=o(944615);const S={toggle(e,t,o,i){if((0,s.cancelEvent)(t),(0,c.isObject)(window.cur)&&(0,c.isFunction)(cur.viewAsBox))return cur.viewAsBox();if(vk.widget&&!vk.id)return window.Widgets.oauth();const a=(0,r.hasClass)(e,"active");(0,r.addClass)(e,"animate"),this.clientUpdate(o,p.LikeButtonTypes.like,a?-1:1,!a);const n=o.match(/^(video)(?!(_comment))(.*)/)?(0,y.getVideoTrackCode)():void 0,l={act:a?"a_do_unlike":"a_do_like",object:o,hash:i,list:cur.pvListId,wall:2,from:this._getReference(o),from_widget:vk.widget?1:0,track_code:n},d=()=>((0,r.toggleClass)(e,"active",a),this.clientUpdate(o,p.LikeButtonTypes.like,a?1:-1,a),!1);window.ajax.post("like.php",l,{onDone:t=>{if(t.unauth_action_box)return d(),void w.UnauthActionBox.show(t.unauth_action_box);this.update(o,t);const i=o.match(/^(wall|market)(.*)/);i&&cur.onLike&&cur.onLike(e,i[1],i[2],a)},onFail:d});(0,c.intval)((0,r.domData)(e,"count"))>0?S.showLikes(e,o,{fast:!0}):e.tt&&e.tt.destroy&&e.tt.destroy()},_getReference:e=>cur.pvShown?"photo_viewer":e===cur.wallLayer?"wkview":window.mvcur&&window.mvcur.mvShown?"videoview":cur.wallType?"feed"===cur.wallType?"news"===cur.section?`feed_${cur.subsection?cur.subsection:cur.section}`:"recommended"===cur.section?"feed_recommended"+("recent"!==cur.subsection?"_"+cur.subsection:""):(0,n.inArray)(cur.section,["friends","groups","videos","photos"])?"feed_"+(cur.subsection?"_"+cur.subsection:""):`feed_${cur.section}`:"top"===cur.wallType?"wall_top":"wall_"+(cur.onepost?"one":(cur.wallType||"").indexOf("full_")?"page":"full"):cur.module,share(e,t={},o=void 0){if(vk.widget&&!vk.id)return window.Widgets.oauth();if((0,c.isObject)(window.cur)&&(0,c.isFunction)(cur.viewAsBox))return cur.viewAsBox();if(window.cur){const e=(0,C.getTrackCodeFromPost)(o);window.cur.shareButtonTrackCode=e}const{objectType:r,objectId:s}=(0,u.parseLikeObjectId)(e);(vk.widget?window.showBox:h.showBox)("like.php",(0,i._)({act:"publish_box",object:e,from_widget:vk.widget?1:0},t),{onDone:(e,t)=>{t.unauth_action_box&&(e.hide(),w.UnauthActionBox.show(t.unauth_action_box))},stat:[window.jsc("web/page.js"),"page.css",window.jsc("web/wide_dd.js"),"wide_dd.css",window.jsc("web/sharebox.js")]}),"wall"===r&&window.Wall&&window.Wall.triggerAdPostStat(s,"share_post"),cur.RpcMethods&&(cur.RpcMethods.likeFullUpdate=t=>S.update(e,window.cleanObj(t)))},clientUpdate(e,t,o,i){const s=this._getButtonsByType(e,t);if(!s.length)return;const a=(0,c.intval)((0,r.domData)(s[0],"count"))+o;this._updateDom(e,t,a,i),this.updateExternalIndex(e,{type:t,count:a,isActive:i})},update(e,t){if(!isNaN(parseInt(t.like_num))){const o=(0,c.isUndefined)(t.like_my)?void 0:!!(0,c.intval)(t.like_my);this._updateDom(e,p.LikeButtonTypes.like,t.like_num,o,t.like_title),this.updateExternalIndex(e,{type:p.LikeButtonTypes.like,count:t.like_num,isActive:o})}if(!isNaN(parseInt(t.share_num))){const o=(0,c.isUndefined)(t.share_my)?void 0:!!(0,c.intval)(t.share_my);this._updateDom(e,p.LikeButtonTypes.share,t.share_num,o,t.share_title),this.updateExternalIndex(e,{type:p.LikeButtonTypes.share,count:t.share_num})}if((0,n.isNumeric)(t.views_num)&&this._updateDom(e,p.LikeButtonTypes.views,t.views_num,void 0,t.views_title),(0,n.isNumeric)(t.comment_num)&&this._updateDom(e,p.LikeButtonTypes.comment,t.comment_num),t[_.REACTIONS_COUNTS_RESPONSE_FIELD]){const o=!!t.isQueueUpdate;(0,m.triggerReactionsUpdate)(e,t[_.REACTIONS_COUNTS_RESPONSE_FIELD],void 0,{isQueueUpdate:o,isUserAction:!1,previewVisibility:g.previewVisibilityUseCurrent})}},updateComments(e,t){this.update(e,{comment_num:t})},_updateDom(e,t,o,i,s){const a=this._getButtonsByType(e,t),d=t===p.LikeButtonTypes.views;if(!(null==a?void 0:a.length))return;let h="";d?h=o:o>0&&(h=vk.widget?(0,n.formatCount)(o):(0,v.langNumeric)(o,"%s",!0)),d||(o=(0,c.intval)(o));for(let e=0;e<a.length;e++){const n=a[e];if((0,r.hasClass)(n,"no_counter"))continue;const v=d?a[e]:(0,u.getElementLikeButtonCount)(a[e]);var _;if((0,l.animateCount)(v,h,{str:"auto",noWrapWidth:!d,noSpaceIfEmpty:!0}),(0,r.toggleClass)(n,"empty",o<=0),"boolean"==typeof i&&(0,r.toggleClass)(n,"active",i),(0,r.attr)(a[e],"data-count",o),(0,f.updateAriaLabelCounter)(n,o,t),d)null==n||null==n.closest||null==(_=n.closest(".like_views"))||_.setAttribute("title",s||"");const g=a[e].tt;if(g){const e=(0,r.domByClass)(g.container,"_content"),a=(0,r.domByClass)(g.container,"_value"),l=(0,r.domByClass)(g.container,"_title"),d=(0,c.intval)((0,r.val)(a));(0,r.val)(a,o),s&&(0,r.val)(l,s),(0,c.isObject)(g)&&(g.likeInvalidated=!0),(d!==o&&d<7||!1===s)&&(t===p.LikeButtonTypes.like?n.needReinitLikesTT=!0:t===p.LikeButtonTypes.share&&(n.needReinitShareTT=!0)),t===p.LikeButtonTypes.like&&(0,r.toggleClass)(e,"me_hidden",!i),!1===s&&g.destroy&&g.destroy()}}},_getButtonsByType:(e,t)=>(0,r.domQuery)(`._like_${e} ._${t}, ._like_${e} [data-like-button-type="${t}"]`),showLikes(e,t,o={}){if(!e||!(e instanceof HTMLElement)||e.postDontShowLikes)return;if(vk.widget&&vk.show_external_auth_box)return;let i=o.views?{views:1}:o.share?{published:1}:{};o.listId&&(i.list=o.listId),o.like_hash&&(i.like_hash=o.like_hash),o.like_stats_params&&Object.assign(i,o.like_stats_params);const s=!!(0,r.geByClass1)("share",(0,r.gpeByClass)("like_wrap",e));let l=document.body,d=!1;const h=getComputedStyle(e),v=(0,c.intval)(h.getPropertyValue("padding-left").replace("px","")),p=(0,c.intval)(h.getPropertyValue("padding-top").replace("px","")),_=(0,u.getElementLikeButtonIcon)(e);let g=40;"wpost"===o.from&&(g=24);const m=[g-(0,r.getSize)(_)[0]/2-v,10-p];let w=o.cl||"";if(o.share)w+="likes_tt_share";else if(w+="likes_tt_like","widget_community"===o.from)m[0]=6;else if("wcomments"===o.from||"widget_comments"===cur.wallType){const t=16,o=10;m[0]=(0,r.getSize)(e)[0]+t-(0,r.getSize)(_)[0]/2-o}else"photo_carousel"===o.from&&(m[1]=10);if(!!(null==o?void 0:o.isFromReactionsPreview)){const t=e.querySelector("._ReactionsPreview__itemsContainer");if(t){const e=t.querySelector(".ReactionsPreviewItem"),o=(0,r.getXYRect)(e,!1),i=(o.width||0)/2;let s=i;l=t;o.left+o.width/2>window.innerWidth/2&&(d=!0,s=t.offsetWidth-i),m[0]=-s+g}}let f,y;o.share?(f="needReinitLikesTT",y="resetLikesTTTimer"):(f="needReinitShareTT",y="resetShareTTTimer"),clearTimeout(e[y]),(0,a.showTooltip)(e,{url:"/like.php",params:(0,n.extend)({act:"a_get_stats",object:t,has_share:s?1:""},i),appendEl:l,slide:15,shift:m,ajaxdt:o.fast?0:100,showdt:o.fast?0:400,hidedt:200,dir:"auto",checkLeft:!0,needLeft:d,reverseOffset:80,noZIndex:!0,hasover:!0,tip:{over:()=>{S.showLikes(e,t,o)}},typeClass:"like_tt",className:w,onHide:()=>{clearTimeout(e[y]),e[f]&&(e[y]=setTimeout((()=>{delete e[f],e.tt&&e.tt.destroy&&e.tt.destroy()}),200))}})},showShare:function(e,t,o){S.showLikes(e,t,(0,n.extend)(o,{share:1}))},updateViews:(e,t)=>{vk.widget&&vk.show_external_auth_box||window.ajax.post("like.php",{act:"a_get_stats",object:e,views:1},{cache:1,onDone(t,o){const i=(0,r.ce)("div",{innerHTML:o});S._updateDom(e,p.LikeButtonTypes.views,t,void 0,i.innerText||i.textContent)}})},makeTemplate(e,t){if(!e)return"";(t=(0,n.extend)({buttons_prepend:"",object_raw:"",likes_count:"",liked:!1,share_count:"",shared:"",views_count:"",share_opts:{},like_opts:{},class_name:"",like_cont_class:"",like_class_name:"",[_.REACTIONS_COUNTS_RESPONSE_FIELD]:"",reactions_class_name:""},t)).like_active=t.liked?"active":"",t.share_active=t.shared?"active":"",t.comment_active="",t.likes_formatted_count=t.likes_count>0?(0,v.langNumeric)(t.likes_count,"%s",!0):"",t.share_formatted_count=t.share_count>0?(0,v.langNumeric)(t.share_count,"%s",!0):"",t.share_opts=this._convertOptsToString(t.share_opts),t.like_opts=this._convertOptsToString(t.like_opts),t.like_class_name+=t.likes_count>0?"":" empty",t.share_class_name=t.share_count>0?"":"empty";const o=t[_.REACTIONS_COUNTS_RESPONSE_FIELD],i=!!o&&Object.values(o).some((e=>!!e));return t.reactions_class_name+=i?"":" PostBottomAction--empty",(0,r.rs)(e,t)},_convertOptsToString:e=>JSON.stringify(e).replace(/\"/g,"'"),updateExternalIndex(e,t={}){const{objectType:o,objectId:i}=(0,u.parseLikeObjectId)(e);switch(o){case"photo":if(!cur.pvShown||!cur.pvCurPhoto||cur.pvCurPhoto.id!==i)return;const e=cur.pvListId,o=cur.pvIndex,r=cur.pvData[e][o];t.type===p.LikeButtonTypes.like?(r.likes=t.count,r.liked=t.isActive,cur.pvCommsLikes[r.id][1]=t.count):t.type===p.LikeButtonTypes.share&&(r.shares=t.count);break;case"video":if(window.mvcur&&window.mvcur.mvShown&&window.mvcur.videoRaw===i&&t.type===p.LikeButtonTypes.like){const e=window.Videoview.getMvData();e.likes=t.count,void 0!==t.isActive&&(e.liked=t.isActive,window.Videoview.playerOnLiked(t.isActive),window.Videoview.recache())}break;case"clip":t.type===p.LikeButtonTypes.like&&window.Videoview.playerOnLiked(t.isActive)}},showLikesList(e,t){cur.viewAsBox||(0,r.hasClass)((0,r.gpeByClass)("like_btn",e),"no_counter")||(0,d.showWiki)({w:"likes/"+(0,n.clean)(t)},!1,!1,{queue:1})},showSharesList(e,t){cur.viewAsBox||(0,r.hasClass)((0,r.gpeByClass)("like_btn",e),"no_counter")||(0,d.showWiki)({w:"shares/"+(0,n.clean)(t)},!1,!1,{queue:1})}}}}]);try{stManager.done("dist/042057405aa14bdcd56cdbc164d834ff.b75f832c5b26cb096b9c.js")}catch(e){}